<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
  </style>
  <title>amavisd-milter(8)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">amavisd-milter(8)</td>
    <td class="head-vol">System Manager's Manual</td>
    <td class="head-rtitle">amavisd-milter(8)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="selflink" href="#NAME">NAME</a></h1>
<b class="Nm" title="Nm">amavisd-milter</b> &#x2014;
  <span class="Nd" title="Nd">sendmail milter for amavisd-new</span>
<h1 class="Sh" title="Sh" id="SYNOPSIS"><a class="selflink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<table class="Nm">
  <tr>
    <td><b class="Nm" title="Nm">amavisd-milter</b></td>
    <td>[<span class="Op"><b class="Fl" title="Fl">-fhv</b></span>]
      [<span class="Op"><b class="Fl" title="Fl">-d</b>
      <var class="Ar" title="Ar">debug-level</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-D</b>
      <var class="Ar" title="Ar">delivery-care-of</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-m</b>
      <var class="Ar" title="Ar">max-conns</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-M</b>
      <var class="Ar" title="Ar">max-wait</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-p</b>
      <var class="Ar" title="Ar">pidfile</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-P</b></span>]
      [<span class="Op"><b class="Fl" title="Fl">-q</b>
      <var class="Ar" title="Ar">backlog</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-s</b>
      <var class="Ar" title="Ar">socket</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-t</b>
      <var class="Ar" title="Ar">timeout</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-S</b>
      <var class="Ar" title="Ar">socket</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-T</b>
      <var class="Ar" title="Ar">timeout</var></span>]
      [<span class="Op"><b class="Fl" title="Fl">-w</b>
      <var class="Ar" title="Ar">directory</var></span>]</td>
  </tr>
</table>
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="selflink" href="#DESCRIPTION">DESCRIPTION</a></h1>
The <b class="Nm" title="Nm">amavisd-milter</b> is a sendmail milter (mail
  filter) for <b class="Sy" title="Sy">amavisd-new</b> 2.4.3 and above and
  <b class="Sy" title="Sy">sendmail</b> 8.13 and above (limited support for 8.12
  is provided).
<div class="Pp"></div>
Instead of older <b class="Sy" title="Sy">amavis-milter</b> helper program, full
  <b class="Sy" title="Sy">amavisd-new</b> functionality is available, including
  adding spam and virus information header fields, modifying Subject, adding
  address extensions and removing certain recipients from delivery while
  delivering the same message to the rest.
<div class="Pp"></div>
For more information you can visit amavisd-milter website:
<div class="Pp"></div>
<div class="Bd" style="margin-left: 5.00ex;">
<pre class="Li">
http://amavisd-milter.sourceforge.net/
</pre>
</div>
<div class="Pp"></div>
and SourceForge project:
<div class="Pp"></div>
<div class="Bd" style="margin-left: 5.00ex;">
<pre class="Li">
http://sourceforge.net/projects/amavisd-milter
</pre>
</div>
<h2 class="Ss" title="Ss" id="Options"><a class="selflink" href="#Options">Options</a></h2>
The options are as follows:
<dl class="Bl-tag">
  <dt class="It-tag"><a class="selflink" href="#d"><b class="Fl" title="Fl" id="d">-d</b></a>
    <var class="Ar" title="Ar">debug-level</var></dt>
  <dd class="It-tag">Set the debug level to
      <b class="Sy" title="Sy">debug-level</b>. Debugging traces become more
      verbose as the debug level increases. Maximum is 9.</dd>
  <dt class="It-tag"><a class="selflink" href="#D"><b class="Fl" title="Fl" id="D">-D</b></a>
    <var class="Ar" title="Ar">delivery-care-of</var></dt>
  <dd class="It-tag">Set AM.PDP request attribute delivery_care_of to
      <b class="Sy" title="Sy">client</b> (default) or
      <b class="Sy" title="Sy">server</b>. When
      <b class="Sy" title="Sy">client</b> method is used then
      <b class="Sy" title="Sy">amavisd-milter</b> is responsible to forward the
      message to recipients. This method doesn't allow personalized header or
      body modification.
    <div class="Pp"></div>
    When <b class="Sy" title="Sy">server</b> method is used then
      <b class="Sy" title="Sy">amavisd-new</b> is responsible to forward the
      message to recipients and can provide personalized header and body
      modification. $forward_method in amavisd.conf must point to some place
      willing to accept mail without further checking in
      <b class="Sy" title="Sy">amavisd-new</b>.</dd>
  <dt class="It-tag"><a class="selflink" href="#f"><b class="Fl" title="Fl" id="f">-f</b></a></dt>
  <dd class="It-tag">Run <b class="Nm" title="Nm">amavisd-milter</b> in the
      foreground (i.e. do not daemonize). Print debug messages to the
    terminal.</dd>
  <dt class="It-tag"><a class="selflink" href="#h"><b class="Fl" title="Fl" id="h">-h</b></a></dt>
  <dd class="It-tag">Print help page and exit.</dd>
  <dt class="It-tag"><a class="selflink" href="#m"><b class="Fl" title="Fl" id="m">-m</b></a>
    <var class="Ar" title="Ar">max-conns</var></dt>
  <dd class="It-tag">Maximum concurrent <b class="Sy" title="Sy">amavisd</b>
      connections (default 0 - unlimited number of connections). It must agree
      with the $max_servers entry in amavisd.conf.</dd>
  <dt class="It-tag"><a class="selflink" href="#M"><b class="Fl" title="Fl" id="M">-M</b></a>
    <var class="Ar" title="Ar">max-wait</var></dt>
  <dd class="It-tag">Maximum wait for connection to
      <b class="Sy" title="Sy">amavisd</b> in seconds (default 300 = 5 minutes).
      It must be less then sending MTA timeout for a response to the final
      &quot;.&quot; that terminates a message on sending MTA.
      <b class="Sy" title="Sy">sendmail</b> has default value 1 hour,
      <b class="Sy" title="Sy">postfix</b> 10 minutes and
      <b class="Sy" title="Sy">qmail</b> 20 minutes. We suggest to use less than
      10 minutes.</dd>
  <dt class="It-tag"><a class="selflink" href="#p"><b class="Fl" title="Fl" id="p">-p</b></a>
    <var class="Ar" title="Ar">pidfile</var></dt>
  <dd class="It-tag">Use this pid file (default
      /var/run/amavis/amavisd-milter.pid).</dd>
  <dt class="It-tag"><a class="selflink" href="#P"><b class="Fl" title="Fl" id="P">-P</b></a></dt>
  <dd class="It-tag">When <b class="Sy" title="Sy">amavisd-new</b> fails mail
      will be passed through unchecked.</dd>
  <dt class="It-tag"><a class="selflink" href="#q"><b class="Fl" title="Fl" id="q">-q</b></a>
    <var class="Ar" title="Ar">backlog</var></dt>
  <dd class="It-tag">Sets the incoming socket backlog used by
      <a class="Xr" title="Xr">listen(2)</a>. If it is not set or set to zero,
      the operating system default is used.</dd>
  <dt class="It-tag"><a class="selflink" href="#s"><b class="Fl" title="Fl" id="s">-s</b></a>
    <var class="Ar" title="Ar">socket</var></dt>
  <dd class="It-tag">Communication socket between
      <b class="Sy" title="Sy">sendmail</b> and
      <b class="Nm" title="Nm">amavisd-milter</b> (default
      /var/lib/amavis/amavisd-milter.sock). The protocol spoken over this socket
      is <b class="Sy" title="Sy">MILTER</b> (Mail FILTER). It must agree with
      the INPUT_MAIL_FILTER entry in sendmail.mc
    <div class="Pp"></div>
    The <var class="Ar" title="Ar">socket</var> should be in
      &quot;proto:address&quot; format:
    <ul class="Bl-bullet Bl-compact">
      <li class="It-bullet"><b class="Sy" title="Sy">{unix|local}:/path/to/file</b>
          - A named pipe.</li>
      <li class="It-bullet"><b class="Sy" title="Sy">inet:port@{hostname|ip-address}</b>
          - An IPV4 socket.</li>
      <li class="It-bullet"><b class="Sy" title="Sy">inet6:port@{hostname|ip-address}</b>
          - An IPV6 socket.</li>
    </ul>
  </dd>
  <dt class="It-tag"><a class="selflink" href="#S"><b class="Fl" title="Fl" id="S">-S</b></a>
    <var class="Ar" title="Ar">socket</var></dt>
  <dd class="It-tag">Communication socket between
      <b class="Nm" title="Nm">amavisd-milter</b> and
      <b class="Sy" title="Sy">amavisd-new</b> (default
      /var/lib/amavis/amavisd.sock). The protocol spoken over this socket is
      <b class="Sy" title="Sy">AM.PDP</b> (AMavis Policy Delegation Protocol).
      It must agree with the $unix_socketname entry in amavisd.conf.
    <div class="Pp"></div>
    The <var class="Ar" title="Ar">socket</var> should be in
      &quot;proto:address&quot; format:
    <ul class="Bl-bullet Bl-compact">
      <li class="It-bullet"><b class="Sy" title="Sy">{unix|local}:/path/to/file</b>
          - A named pipe.</li>
    </ul>
  </dd>
  <dt class="It-tag"><a class="selflink" href="#t"><b class="Fl" title="Fl" id="t">-t</b></a>
    <var class="Ar" title="Ar">timeout</var></dt>
  <dd class="It-tag"><b class="Sy" title="Sy">sendmail</b> connection timeout in
      seconds (default 600 = 10 minutes). It must agree with the
      INPUT_MAIL_FILTER entry in sendmail.mc and must be greater than or equal
      to the <b class="Sy" title="Sy">amavisd-new</b> connection timeout. When
      you use other milters (especially time-consuming), the timeout must be
      sufficient to process message in all milters.</dd>
  <dt class="It-tag"><a class="selflink" href="#T"><b class="Fl" title="Fl" id="T">-T</b></a>
    <var class="Ar" title="Ar">timeout</var></dt>
  <dd class="It-tag"><b class="Sy" title="Sy">amavisd-new</b> connection timeout
      in seconds (default 600 = 10 minutes). This timeout must be sufficient for
      message processing in <b class="Sy" title="Sy">amavisd-new</b>. It's
      usually a good idea to adjust them to the same value as
      <b class="Sy" title="Sy">sendmail</b> connection timeout.</dd>
  <dt class="It-tag"><a class="selflink" href="#v"><b class="Fl" title="Fl" id="v">-v</b></a></dt>
  <dd class="It-tag">Report the version number and exit.</dd>
  <dt class="It-tag"><a class="selflink" href="#w"><b class="Fl" title="Fl" id="w">-w</b></a>
    <var class="Ar" title="Ar">directory</var></dt>
  <dd class="It-tag">Set working directory (default /var/lib/amavis/tmp).</dd>
</dl>
<h2 class="Ss" title="Ss" id="Limited_support_for_sendmail_8.12"><a class="selflink" href="#Limited_support_for_sendmail_8.12">Limited
  support for sendmail 8.12</a></h2>
<ul class="Bl-bullet Bl-compact">
  <li class="It-bullet"><b class="Fn" title="Fn">smfi_addheader</b>() is used
      instead of <b class="Fn" title="Fn">smfi_insheader</b>() for
      <code class="Li">insheader</code> and <code class="Li">addheader</code>
      AM.PDP responses. This works well with
      <b class="Sy" title="Sy">amavisd-new</b> 2.4.3 or newer.</li>
  <li class="It-bullet"><b class="Fn" title="Fn">smfi_progress</b>() isn't
      called when <b class="Sy" title="Sy">amavisd-milter</b> wait for
      <b class="Sy" title="Sy">amavisd-new</b> communication socket.</li>
  <li class="It-bullet">AM.PDP response <code class="Li">quarantine</code> isn't
      implemented.</li>
</ul>
<h1 class="Sh" title="Sh" id="FILES"><a class="selflink" href="#FILES">FILES</a></h1>
<dl class="Bl-tag">
  <dt class="It-tag"><i class="Em" title="Em">/var/run/amavis/amavisd-milter.pid</i></dt>
  <dd class="It-tag">The default process-id file.</dd>
  <dt class="It-tag"><i class="Em" title="Em">/var/lib/amavis/amavisd-milter.sock</i></dt>
  <dd class="It-tag">The default <b class="Sy" title="Sy">sendmail</b>
      communication socket.</dd>
  <dt class="It-tag"><i class="Em" title="Em">/var/lib/amavis/amavisd.sock</i></dt>
  <dd class="It-tag">Th default <b class="Sy" title="Sy">amavisd-new</b>
      communication socket.</dd>
  <dt class="It-tag"><i class="Em" title="Em">/var/lib/amavis/tmp</i></dt>
  <dd class="It-tag">The default working directory.</dd>
</dl>
<h1 class="Sh" title="Sh" id="POLICY_BANK"><a class="selflink" href="#POLICY_BANK">POLICY
  BANK</a></h1>
When remote client is authenticated, <b class="Sy" title="Sy">amavisd-milter</b>
  forward this information to <b class="Sy" title="Sy">amavisd-new</b> through
  AM.PDP request attribute <b class="Sy" title="Sy">policy_bank</b>:
<dl class="Bl-tag">
  <dt class="It-tag"><b class="Sy" title="Sy">SMTP_AUTH</b></dt>
  <dd class="It-tag">Indicate that the remote client is authenticated.</dd>
  <dt class="It-tag"><b class="Sy" title="Sy">SMTP_AUTH_&lt;MECH&gt;</b></dt>
  <dd class="It-tag">Remote client authentication mechanism.</dd>
  <dt class="It-tag"><b class="Sy" title="Sy">SMTP_AUTH_&lt;MECH&gt;_&lt;BITS&gt;</b></dt>
  <dd class="It-tag">The number of bits used for the key of the symmetric cipher
      when authentication mechanism use it.</dd>
</dl>
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="selflink" href="#EXAMPLES">EXAMPLES</a></h1>
<h2 class="Ss" title="Ss" id="Configuring_amavisd-new"><a class="selflink" href="#Configuring_amavisd-new">Configuring
  amavisd-new</a></h2>
In amavisd.conf file change protocol and socket settings to:
<div class="Pp"></div>
<div class="Bd" style="margin-left: 5.00ex;">
<pre class="Li">
$protocol = &quot;AM.PDP&quot;;                      # Use AM.PDP protocol 
$unix_socketname = &quot;$MYHOME/amavisd.sock&quot;; # Listen on Unix socket 
### $inet_socket_port = 10024;             # Don't listen on TCP port
</pre>
</div>
<div class="Pp"></div>
Then (re)start amavisd daemon.
<h2 class="Ss" title="Ss" id="Configuring_sendmail"><a class="selflink" href="#Configuring_sendmail">Configuring
  sendmail</a></h2>
To the sendmail.mc file add the following entries:
<div class="Pp"></div>
<div class="Bd" style="margin-left: 5.00ex;">
<pre class="Li">
define(`confMILTER_MACROS_ENVFROM', 
	confMILTER_MACROS_ENVFROM`, r, b') 
INPUT_MAIL_FILTER(`amavisd-milter', 
	`S=local:/var/lib/amavis/amavisd-milter.sock, 
	F=T, T=S:10m;R:10m;E:10m')
</pre>
</div>
<div class="Pp"></div>
Then rebuild your sendmail.cf file, install it (usually to
  /etc/mail/sendmail.cf) and (re)start sendmail daemon.
<h2 class="Ss" title="Ss">Running
  <b class="Nm" title="Nm">amavisd-milter</b></h2>
This example assume that <b class="Sy" title="Sy">amavisd-new</b> is running as
  user <b class="Sy" title="Sy">amavis</b>. It must agree with the entry
  $daemon_user in amavisd.conf.
<div class="Pp"></div>
First create working directory:
<div class="Pp"></div>
<div class="Bd" style="margin-left: 5.00ex;">
<pre class="Li">
mkdir /var/lib/amavis/tmp 
chmod 750 /var/lib/amavis/tmp 
chown amavis /var/lib/amavis/tmp
</pre>
</div>
<div class="Pp"></div>
Then start <b class="Nm" title="Nm">amavisd-milter</b> as non-priviledged user
  amavis:
<div class="Pp"></div>
<div class="D1"><code class="Li">su - amavis -c
  &quot;<b class="Nm" title="Nm">amavisd-milter</b>
  <b class="Fl" title="Fl">-w</b>
  <var class="Ar" title="Ar">/var/lib/amavis/tmp</var>&quot;</code></div>
<h2 class="Ss" title="Ss" id="Limiting_maximum_concurrent_connections_to_amavisd"><a class="selflink" href="#Limiting_maximum_concurrent_connections_to_amavisd">Limiting
  maximum concurrent connections to amavisd</a></h2>
To limit concurrent connections to 4 and fail after 10 minutes (10*60 secs) of
  waiting run <b class="Nm" title="Nm">amavisd-milter</b> with this options:
<div class="Pp"></div>
<div class="D1"><code class="Li">su - amavis -c
  &quot;<b class="Nm" title="Nm">amavisd-milter</b>
  <b class="Fl" title="Fl">-w</b>
  <var class="Ar" title="Ar">/var/lib/amavis/tmp</var>
  <b class="Fl" title="Fl">-m</b> <var class="Ar" title="Ar">4</var>
  <b class="Fl" title="Fl">-M</b>
  <var class="Ar" title="Ar">600</var>&quot;</code></div>
<h2 class="Ss" title="Ss" id="Troubleshooting"><a class="selflink" href="#Troubleshooting">Troubleshooting</a></h2>
For troubleshooting run <b class="Nm" title="Nm">amavisd-milter</b> on the
  foreground and set debug level to appropriate level:
<div class="Pp"></div>
<div class="D1"><code class="Li">su - amavis -c
  &quot;<b class="Nm" title="Nm">amavisd-milter</b>
  <b class="Fl" title="Fl">-w</b>
  <var class="Ar" title="Ar">/var/lib/amavis/tmp</var>
  <b class="Fl" title="Fl">-f</b> <b class="Fl" title="Fl">-d</b>
  <var class="Ar" title="Ar">level</var>&quot;</code></div>
<div class="Pp"></div>
where debug levels are:
<dl class="Bl-tag" style="margin-left: 7.80ex;">
  <dt class="It-tag" style="margin-left: -7.80ex;">1</dt>
  <dd class="It-tag">Not errors but unexpected states (connection abort
    etc).</dd>
  <dt class="It-tag" style="margin-left: -7.80ex;">2</dt>
  <dd class="It-tag">Main states in message processing.</dd>
  <dt class="It-tag" style="margin-left: -7.80ex;">3</dt>
  <dd class="It-tag">All <b class="Nm" title="Nm">amavisd-milter</b> debug
      messages.</dd>
  <dt class="It-tag" style="margin-left: -7.80ex;">4-9</dt>
  <dd class="It-tag">Milter communication debugging (smfi_setdbg 1-6).</dd>
</dl>
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="selflink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<div class="Bd" style="margin-left: 0.00ex;">
<pre class="Li">
http://amavisd-milter.sourceforge.net 
http://www.ijs.si/software/amavisd/ 
http://www.milter.org/developers 
http://www.sendmail.org
</pre>
</div>
<h1 class="Sh" title="Sh" id="AUTHORS"><a class="selflink" href="#AUTHORS">AUTHORS</a></h1>
This manual page was written by Petr Rehor &lt;rx@rx.cz&gt; and is based on
  Jerzy Sakol &lt;jerzy.sakol@commgraf.pl&gt; initial work.
<h1 class="Sh" title="Sh" id="BUGS"><a class="selflink" href="#BUGS">BUGS</a></h1>
A community mailing lists are available at:
<div class="Pp"></div>
<div class="Bd" style="margin-left: 5.00ex;">
<pre class="Li">
http://sourceforge.net/mail/?group_id=138169
</pre>
</div>
<div class="Pp"></div>
Enhancements, requests and problem reports are welcome.
<div class="Pp"></div>
If you run into problems first check the users mailing list archive before
  asking questions on the list. It's highly likely somebody has already come
  across the same problem and it's been solved.</div>
<table class="foot">
  <tr>
    <td class="foot-date">Januar 23, 2006</td>
    <td class="foot-os">Linux 4.12.14-300.fc26.x86_64</td>
  </tr>
</table>
</body>
</html>
