<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 19:08:25 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>amavisd-milter(8) BSD System Manager&rsquo;s Manual
amavisd-milter(8)</p>

<p style="margin-top: 1em">NAME <br>
amavisd-milter &acirc; sendmail milter for amavisd-new</p>

<p style="margin-top: 1em">SYNOPSIS <br>
amavisd-milter [-fhv] [-d debug-level] [-D delivery-care-of]
[-m max-conns] [-M max-wait] [-p pidfile] [-P] [-q backlog]
[-s socket] [-t timeout] [-S socket] [-T timeout] <br>
[-w directory]</p>

<p style="margin-top: 1em">DESCRIPTION <br>
The amavisd-milter is a sendmail milter (mail filter) for
amavisd-new 2.4.3 and above and sendmail 8.13 and above
(limited support for 8.12 is provided).</p>

<p style="margin-top: 1em">Instead of older amavis-milter
helper program, full amavisd-new functionality is available,
including adding spam and virus information header fields,
modifying Subject, adding <br>
address extensions and removing certain recipients from
delivery while delivering the same message to the rest.</p>

<p style="margin-top: 1em">For more information you can
visit amavisd-milter website:</p>


<p style="margin-top: 1em">http://amavisd-milter.sourceforge.net/</p>

<p style="margin-top: 1em">and SourceForge project:</p>


<p style="margin-top: 1em">http://sourceforge.net/projects/amavisd-milter</p>

<p style="margin-top: 1em">Options <br>
The options are as follows:</p>

<p style="margin-top: 1em">-d debug-level <br>
Set the debug level to debug-level. Debugging traces become
more verbose as the debug level increases. Maximum is 9.</p>

<p style="margin-top: 1em">-D delivery-care-of <br>
Set AM.PDP request attribute delivery_care_of to client
(default) or server. When client method is used then
amavisd-milter is responsible to forward the message to
recip&acirc; <br>
ients. This method doesn&rsquo;t allow personalized header
or body modification.</p>

<p style="margin-top: 1em">When server method is used then
amavisd-new is responsible to forward the message to
recipients and can provide personalized header and body
modification. $forward_method <br>
in amavisd.conf must point to some place willing to accept
mail without further checking in amavisd-new.</p>

<p style="margin-top: 1em">-f Run amavisd-milter in the
foreground (i.e. do not daemonize). Print debug messages to
the terminal.</p>

<p style="margin-top: 1em">-h Print help page and exit.</p>

<p style="margin-top: 1em">-m max-conns <br>
Maximum concurrent amavisd connections (default 0 -
unlimited number of connections). It must agree with the
$max_servers entry in amavisd.conf.</p>

<p style="margin-top: 1em">-M max-wait <br>
Maximum wait for connection to amavisd in seconds (default
300 = 5 minutes). It must be less then sending MTA timeout
for a response to the final &quot;.&quot; that terminates a
<br>
message on sending MTA. sendmail has default value 1 hour,
postfix 10 minutes and qmail 20 minutes. We suggest to use
less than 10 minutes.</p>

<p style="margin-top: 1em">-p pidfile <br>
Use this pid file (default
/var/run/amavis/amavisd-milter.pid).</p>

<p style="margin-top: 1em">-P When amavisd-new fails mail
will be passed through unchecked.</p>

<p style="margin-top: 1em">-q backlog <br>
Sets the incoming socket backlog used by listen(2). If it is
not set or set to zero, the operating system default is
used.</p>

<p style="margin-top: 1em">-s socket <br>
Communication socket between sendmail and amavisd-milter
(default /var/lib/amavis/amavisd-milter.sock). The protocol
spoken over this socket is MILTER (Mail FILTER). It <br>
must agree with the INPUT_MAIL_FILTER entry in
sendmail.mc</p>

<p style="margin-top: 1em">The socket should be in
&quot;proto:address&quot; format: <br>
&Acirc;&middot; {unix|local}:/path/to/file - A named pipe.
<br>
&Acirc;&middot; inet:port@{hostname|ip-address} - An IPV4
socket. <br>
&Acirc;&middot; inet6:port@{hostname|ip-address} - An IPV6
socket.</p>

<p style="margin-top: 1em">-S socket <br>
Communication socket between amavisd-milter and amavisd-new
(default /var/lib/amavis/amavisd.sock). The protocol spoken
over this socket is AM.PDP (AMavis Policy Delega&acirc; <br>
tion Protocol). It must agree with the $unix_socketname
entry in amavisd.conf.</p>

<p style="margin-top: 1em">The socket should be in
&quot;proto:address&quot; format: <br>
&Acirc;&middot; {unix|local}:/path/to/file - A named
pipe.</p>

<p style="margin-top: 1em">-t timeout <br>
sendmail connection timeout in seconds (default 600 = 10
minutes). It must agree with the INPUT_MAIL_FILTER entry in
sendmail.mc and must be greater than or equal to the <br>
amavisd-new connection timeout. When you use other milters
(especially time-consuming), the timeout must be sufficient
to process message in all milters.</p>

<p style="margin-top: 1em">-T timeout <br>
amavisd-new connection timeout in seconds (default 600 = 10
minutes). This timeout must be sufficient for message
processing in amavisd-new. It&rsquo;s usually a good idea to
<br>
adjust them to the same value as sendmail connection
timeout.</p>

<p style="margin-top: 1em">-v Report the version number and
exit.</p>

<p style="margin-top: 1em">-w directory <br>
Set working directory (default /var/lib/amavis/tmp).</p>

<p style="margin-top: 1em">Limited support for sendmail
8.12 <br>
&Acirc;&middot; smfi_addheader() is used instead of
smfi_insheader() for insheader and addheader AM.PDP
responses. This works well with amavisd-new 2.4.3 or newer.
<br>
&Acirc;&middot; smfi_progress() isn&rsquo;t called when
amavisd-milter wait for amavisd-new communication socket.
<br>
&Acirc;&middot; AM.PDP response quarantine isn&rsquo;t
implemented.</p>

<p style="margin-top: 1em">FILES <br>
/var/run/amavis/amavisd-milter.pid <br>
The default process-id file.</p>


<p style="margin-top: 1em">/var/lib/amavis/amavisd-milter.sock
<br>
The default sendmail communication socket.</p>

<p style="margin-top: 1em">/var/lib/amavis/amavisd.sock
<br>
Th default amavisd-new communication socket.</p>

<p style="margin-top: 1em">/var/lib/amavis/tmp <br>
The default working directory.</p>

<p style="margin-top: 1em">POLICY BANK <br>
When remote client is authenticated, amavisd-milter forward
this information to amavisd-new through AM.PDP request
attribute policy_bank:</p>

<p style="margin-top: 1em">SMTP_AUTH <br>
Indicate that the remote client is authenticated.</p>

<p style="margin-top: 1em">SMTP_AUTH_&lt;MECH&gt; <br>
Remote client authentication mechanism.</p>


<p style="margin-top: 1em">SMTP_AUTH_&lt;MECH&gt;_&lt;BITS&gt;
<br>
The number of bits used for the key of the symmetric cipher
when authentication mechanism use it.</p>

<p style="margin-top: 1em">EXAMPLES <br>
Configuring amavisd-new <br>
In amavisd.conf file change protocol and socket settings
to:</p>

<p style="margin-top: 1em">$protocol = &quot;AM.PDP&quot;;
# Use AM.PDP protocol <br>
$unix_socketname = &quot;$MYHOME/amavisd.sock&quot;; #
Listen on Unix socket <br>
### $inet_socket_port = 10024; # Don&rsquo;t listen on TCP
port</p>

<p style="margin-top: 1em">Then (re)start amavisd
daemon.</p>

<p style="margin-top: 1em">Configuring sendmail <br>
To the sendmail.mc file add the following entries:</p>


<p style="margin-top: 1em">define(&lsquo;confMILTER_MACROS_ENVFROM&rsquo;,
<br>
confMILTER_MACROS_ENVFROM&lsquo;, r, b&rsquo;) <br>
INPUT_MAIL_FILTER(&lsquo;amavisd-milter&rsquo;, <br>
&lsquo;S=local:/var/lib/amavis/amavisd-milter.sock, <br>
F=T, T=S:10m;R:10m;E:10m&rsquo;)</p>

<p style="margin-top: 1em">Then rebuild your sendmail.cf
file, install it (usually to /etc/mail/sendmail.cf) and
(re)start sendmail daemon.</p>

<p style="margin-top: 1em">Running amavisd-milter <br>
This example assume that amavisd-new is running as user
amavis. It must agree with the entry $daemon_user in
amavisd.conf.</p>

<p style="margin-top: 1em">First create working
directory:</p>

<p style="margin-top: 1em">mkdir /var/lib/amavis/tmp <br>
chmod 750 /var/lib/amavis/tmp <br>
chown amavis /var/lib/amavis/tmp</p>

<p style="margin-top: 1em">Then start amavisd-milter as
non-priviledged user amavis:</p>

<p style="margin-top: 1em">su - amavis -c
&quot;amavisd-milter -w /var/lib/amavis/tmp&quot;</p>

<p style="margin-top: 1em">Limiting maximum concurrent
connections to amavisd <br>
To limit concurrent connections to 4 and fail after 10
minutes (10*60 secs) of waiting run amavisd-milter with this
options:</p>

<p style="margin-top: 1em">su - amavis -c
&quot;amavisd-milter -w /var/lib/amavis/tmp -m 4 -M
600&quot;</p>

<p style="margin-top: 1em">Troubleshooting <br>
For troubleshooting run amavisd-milter on the foreground and
set debug level to appropriate level:</p>

<p style="margin-top: 1em">su - amavis -c
&quot;amavisd-milter -w /var/lib/amavis/tmp -f -d
level&quot;</p>

<p style="margin-top: 1em">where debug levels are:</p>

<p style="margin-top: 1em">1 Not errors but unexpected
states (connection abort etc).</p>

<p style="margin-top: 1em">2 Main states in message
processing.</p>

<p style="margin-top: 1em">3 All amavisd-milter debug
messages.</p>

<p style="margin-top: 1em">4-9 Milter communication
debugging (smfi_setdbg 1-6).</p>

<p style="margin-top: 1em">SEE ALSO <br>
http://amavisd-milter.sourceforge.net <br>
http://www.ijs.si/software/amavisd/ <br>
http://www.milter.org/developers <br>
http://www.sendmail.org</p>

<p style="margin-top: 1em">AUTHORS <br>
This manual page was written by Petr Rehor &lt;rx@rx.cz&gt;
and is based on Jerzy Sakol &lt;jerzy.sakol@commgraf.pl&gt;
initial work.</p>

<p style="margin-top: 1em">BUGS <br>
A community mailing lists are available at:</p>


<p style="margin-top: 1em">http://sourceforge.net/mail/?group_id=138169</p>

<p style="margin-top: 1em">Enhancements, requests and
problem reports are welcome.</p>

<p style="margin-top: 1em">If you run into problems first
check the users mailing list archive before asking questions
on the list. It&rsquo;s highly likely somebody has already
come across the same problem and <br>
it&rsquo;s been solved.</p>

<p style="margin-top: 1em">BSD Januar 23, 2006 BSD</p>
<hr>
</body>
</html>
