<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
  </style>
  <title>NBD-CLIENT(8)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">NBD-CLIENT(8)</td>
    <td class="head-vol"></td>
    <td class="head-rtitle">NBD-CLIENT(8)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="selflink" href="#NAME">NAME</a></h1>
nbd-client - connect to a server running nbd-server(1), to use its exported
  block device
<h1 class="Sh" title="Sh" id="SYNOPSIS"><a class="selflink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<b>nbd-client</b> <b></b><i>host</i><b></b> [ <b></b><i>port</i><b></b> ]
  <b></b> <i>nbd-device</i><b></b> [ <b>-connections </b><i>num</i><b></b> ] [
  <b>-sdp</b> ] [ <b>-swap</b> ] [ <b>-persist</b> ] [ <b>-nofork</b> ] [
  <b>-systemd-mark</b> ] [ <b>-block-size </b><i>block size</i><b></b> ] [
  <b>-timeout </b> <i>seconds</i><b></b> ] [ <b>-name </b><i>name</i><b></b> ] [
  <b>-certfile </b><i>certfile</i><b></b> ] [ <b>-keyfile
  </b><i>keyfile</i><b></b> ] [ <b>-cacertfile </b><i>cacertfile</i><b></b> ] [
  <b>-tlshostname </b><i>hostname</i><b></b> ]
<div style="height: 1.00em;">&#x00A0;</div>
<div style="height: 1.00em;">&#x00A0;</div>
<b>nbd-client</b> <b>-unix </b><i>path</i><b></b>
  <b></b><i>nbd-device</i><b></b> [ <b>-connections </b><i>num</i><b></b> ] [
  <b>-sdp</b> ] [ <b>-swap</b> ] [ <b>-persist</b> ] [ <b>-nofork</b> ] [
  <b>-systemd-mark</b> ] [ <b>-block-size </b><i>block size</i><b></b> ] [
  <b>-timeout </b> <i>seconds</i><b></b> ] [ <b>-name </b><i>name</i><b></b> ]
<div style="height: 1.00em;">&#x00A0;</div>
<div style="height: 1.00em;">&#x00A0;</div>
<b>nbd-client</b> <b></b><i>nbd-device</i><b></b>
<div style="height: 1.00em;">&#x00A0;</div>
<div style="height: 1.00em;">&#x00A0;</div>
<b>nbd-client</b> <b>-d </b><i>nbd-device</i><b></b>
<div style="height: 1.00em;">&#x00A0;</div>
<div style="height: 1.00em;">&#x00A0;</div>
<b>nbd-client</b> <b>-c </b><i>nbd-device</i><b></b>
<div style="height: 1.00em;">&#x00A0;</div>
<div style="height: 1.00em;">&#x00A0;</div>
<b>nbd-client</b> <b>-l </b><i>host</i><b></b> [ <b>port</b> ]
<div style="height: 1.00em;">&#x00A0;</div>
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="selflink" href="#DESCRIPTION">DESCRIPTION</a></h1>
With <b>nbd-client</b>, you can connect to a server running <b>nbd-server</b>,
  thus using raw diskspace from that server as a blockdevice on the local
  client.
<div class="Pp"></div>
To do this, support from the Linux Kernel is necessary, in the form of the
  Network Block Device (NBD). When you have that, either in the kernel, or as a
  module, you can connect to an NBD server and use its exported file through a
  block special file with major mode 43.
<div class="Pp"></div>
Optionally, long options can also be specified with two leading dashes.
<h1 class="Sh" title="Sh" id="OPTIONS"><a class="selflink" href="#OPTIONS">OPTIONS</a></h1>
The following options are supported:
<dl class="Bl-tag">
  <dt class="It-tag"><b>-block-size </b><i>block size</i><b></b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-b</b></dt>
  <dd class="It-tag">Use a blocksize of &quot;block size&quot;. Default is 1024;
      allowed values are either 512, 1024, 2048 or 4096</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-connections </b><i>num</i><b></b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-C</b></dt>
  <dd class="It-tag">Use <i>num</i> connections to the server, to allow speeding
      up request handling, at the cost of higher resource usage on the server.
      Use of this option requires kernel support available first with Linux
    4.9.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>host</b></dt>
  <dd class="It-tag">The hostname or IP address of the machine running
      <b>nbd-server</b>. Since 2.9.15, the NBD utilities support IPv6.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-timeout </b><i>seconds</i><b></b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-t</b></dt>
  <dd class="It-tag">Set the connection timeout to &quot;seconds&quot;. For this
      to work, you need a kernel with support for the NBD_SET_TIMEOUT ioctl;
      this was introduced into Linus' tree on 2007-10-11, and will be part of
      kernel 2.6.24.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>port</b></dt>
  <dd class="It-tag">The TCP port on which <b>nbd-server</b> is running at the
      server.
    <div style="height: 1.00em;">&#x00A0;</div>
    The port number defaults to 10809, the IANA-assigned port number for the NBD
      protocol.
    <div style="height: 1.00em;">&#x00A0;</div>
    Previous versions of the nbd tools supported an older version of the
      negotiation protocol known as &quot;oldstyle&quot;. This protocol version
      is no longer supported as of version 3.11 of the nbd support tools.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>nbd-device</b></dt>
  <dd class="It-tag">The block special file (<i>/dev</i> entry) which this
      nbd-client should connect to, specified as a full path.
    <div style="height: 1.00em;">&#x00A0;</div>
    When the mode is used wherein no hostname or export name is specified,
      nbd-client will look up the necessary configuration in the <i>nbdtab</i>
      file. For more information, see nbdtab(5).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-check</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-c</b></dt>
  <dd class="It-tag">Check whether the specified nbd device is connected.
    <div style="height: 1.00em;">&#x00A0;</div>
    If the device is connected, nbd-client will exit with an exit state of 0 and
      print the PID of the nbd-client instance that connected it to stdout.
    <div style="height: 1.00em;">&#x00A0;</div>
    If the device is not connected or does not exist (for example because the
      nbd module was not loaded), nbd-client will exit with an exit state of 1
      and not print anything on stdout.
    <div style="height: 1.00em;">&#x00A0;</div>
    If an error occurred, nbd-client will exit with an exit state of 2, and not
      print anything on stdout either.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-disconnect</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-d</b></dt>
  <dd class="It-tag">Disconnect the specified nbd device from the server</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-list</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-l</b></dt>
  <dd class="It-tag">Ask the server for a list of available exports. If the
      server is exporting over IPv6 as well as over IPv4, this will list all
      exports twice; otherwise, it should list them all only once.
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that this option <b>only</b> works with nbd-server processes running
      version 3.1 or above, and must be enabled in server configuration (with
      the &quot;allowlist&quot; option) before it can be used.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-persist</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-p</b></dt>
  <dd class="It-tag">When this option is specified, nbd-client will immediately
      try to reconnect an nbd device if the connection ever drops unexpectedly
      due to a lost server or something similar.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-sdp</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-S</b></dt>
  <dd class="It-tag">Connect to the server using the Socket Direct Protocol
      (SDP), rather than IP. See nbd-server(5) for details.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-swap</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-s</b></dt>
  <dd class="It-tag">Specifies that this NBD device will be used as swapspace.
      This option attempts to prevent deadlocks by performing mlockall() and
      adjusting the oom-killer score at an appropriate time. It does not however
      guarantee that such deadlocks can be avoided.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-systemd-mark</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-m</b></dt>
  <dd class="It-tag">The systemd init system requires that processes which
      should not be killed at shutdown time be marked appropriately by replacing
      the first letter of their argv[0] with an '@' sign.
    <div style="height: 1.00em;">&#x00A0;</div>
    This option will cause nbd-client to do so.
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that this only works if nbd-client is run from an initrd; i.e., systemd
      will ignore such a mark if run from a systemd unit file or from the
      command line.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-nofork</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-n</b></dt>
  <dd class="It-tag">Specifies that the NBD client should not detach and
      daemonize itself. This is mostly useful for debugging.
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that nbd-client will still fork once to trigger an update to the device
      node's partition table. It is not possible to disable this.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-name</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-N</b></dt>
  <dd class="It-tag">Specifies the name of the export that we want to use. If
      not specified, nbd-client will ask for a &quot;default&quot; export, if
      one exists on the server.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-unix</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-u</b></dt>
  <dd class="It-tag">Connect to the server over a unix domain socket at
      <i>path</i>, rather than to a server over a TCP socket. The server must be
      listening on the given socket.</dd>
</dl>
<h2 class="Ss" title="Ss" id="TLS_SUPPORT"><a class="selflink" href="#TLS_SUPPORT">TLS
  SUPPORT</a></h2>
Enabling any of the TLS-related options causes the client to use the
  NBD_OPT_STARTTLS command to upgrade the connection to TLS. Since negotiating
  TLS support from userspace for a kernel socket would be very involved (if
  passing keys to kernel space were even possible, which it isn't), the way this
  is implemented is that the nbd-client process creates a socketpair, one side
  of which it hands to the kernel, and the other side of which is handed to an
  encrypting/decrypting proxy. This has the effect that all communication will
  be encrypted before being sent over the wire; however, doing so is not safe in
  combination with swapping over an NBD device:
<div class="Pp"></div>
In order to free memory by swapping, the kernel needs to be sure that the write
  to the nbd device has finalized. For this, it needs to be able to receive an
  NBD_CMD_WRITE reply which informs it that the write has completed successfully
  and that the memory may be released. Receiving data over the network, however,
  requires that the kernel <b>allocate</b> memory first, which is impossible if
  we're low on memory (a likely situation when trying to swap). This is likely
  to cause a deadlock when we're low on memory and there are high amounts of
  network traffic.
<div class="Pp"></div>
To remedy this situation, the kernel sets the PF_MEMALLOC option on the nbd
  socket; when low on memory, it will throw away all packets except for those
  destined to a socket with that option set, relying on the normal TCP
  retransmit system to ensure that data is not lost. This avoids the deadlock
  described above.
<div class="Pp"></div>
However, the PF_MEMALLOC option is set on the socket that is connected to the
  nbd device, not the encrypted socket connected to the encrypting/decrypting
  proxy. As such, when using TLS, the PF_MEMALLOC option is not set on the
  socket that actually receives data from the network, which means that the
  deadlock reappears.
<div class="Pp"></div>
For this reason, if the <b>-swap</b> option is used when TLS is in use,
  nbd-client will issue an appropriate warning.
<dl class="Bl-tag">
  <dt class="It-tag"><b>-certfile </b><i>file</i><b></b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-F</b></dt>
  <dd class="It-tag">Use the specified file as the client certificate for TLS
      authentication to the server.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-keyfile </b><i>file</i><b></b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-K</b></dt>
  <dd class="It-tag">Use the specified file as the private key for the client
      cerificate.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-cacertfile </b><i>file</i><b></b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-A</b></dt>
  <dd class="It-tag">Use the specified file as the CA certificate for TLS
      authentication to the server.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-tlshostname </b><i>hostname</i><b></b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-H</b></dt>
  <dd class="It-tag">Use the specified hostname for the TLS context. If not
      specified, the hostname used to connect to the server will be used.</dd>
</dl>
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="selflink" href="#EXAMPLES">EXAMPLES</a></h1>
Some examples of nbd-client usage:
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">To connect to a server running on port 2000 at host
      &quot;server.domain.com&quot;, using the client's block special file
      &quot;/dev/nbd0&quot;:
    <div style="height: 1.00em;">&#x00A0;</div>
     <b>nbd-client server.domain.com 2000</b> <b>/dev/nbd0</b></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">To connect to a server running on port 2001 at host
      &quot;swapserver.domain.com&quot;, using the client's block special file
      &quot;/dev/nbd1&quot;, for swap purposes:
    <div style="height: 1.00em;">&#x00A0;</div>
     <b>nbd-client swapserver.domain.com 2001 /dev/nbd1</b> <b>-swap</b></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">To disconnect the above connection again (after making sure
      the block special file is not in use anymore):
    <div style="height: 1.00em;">&#x00A0;</div>
     <b>nbd-client -d /dev/nbd1</b></dd>
</dl>
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="selflink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
nbd-server (1).
<h1 class="Sh" title="Sh" id="AUTHOR"><a class="selflink" href="#AUTHOR">AUTHOR</a></h1>
The NBD kernel module and the NBD tools have been written by Pavel Macheck
  (pavel@ucw.cz).
<div class="Pp"></div>
The kernel module is now maintained by Paul Clements
  (Paul.Clements@steeleye.com), while the userland tools are maintained by
  Wouter Verhelst (wouter@debian.org)
<div class="Pp"></div>
This manual page was written by Wouter Verhelst (&lt;wouter@debian.org&gt;) for
  the Debian GNU/Linux system (but may be used by others). Permission is granted
  to copy, distribute and/or modify this document under the terms of the GNU
  General Public License, version 2, as published by the Free Software
  Foundation.</div>
<table class="foot">
  <tr>
    <td class="foot-date">$</td>
    <td class="foot-os"></td>
  </tr>
</table>
</body>
</html>
