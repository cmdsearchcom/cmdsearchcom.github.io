<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 19:11:20 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>FWKNOPD(8) Fwknop Server FWKNOPD(8)</p>

<p style="margin-top: 1em">NAME <br>
fwknopd - Firewall Knock Operator Daemon</p>

<p style="margin-top: 1em">SYNOPSIS <br>
fwknopd [options]</p>

<p style="margin-top: 1em">DESCRIPTION <br>
fwknopd is the server component for the FireWall Knock
Operator, and is responsible for monitoring and processing
Single Packet Authorization (SPA) packets that are generated
by <br>
fwknop clients, modifying a firewall or ACL policy to allow
the desired access after authenticating and decrypting a
valid SPA packet (in that order), and removing access after
a <br>
configurable timeout.</p>

<p style="margin-top: 1em">The main application of this
program is to conceal services such as SSH with an
additional layer of security in order to make the
exploitation of vulnerabilities (both 0-day and <br>
unpatched code) much more difficult. In addition, services
that are concealed in this fashion naturally cannot be
scanned for with Nmap or Shodan.</p>

<p style="margin-top: 1em">The main configuration for
fwknopd is maintained within two files: fwknopd.conf and
access.conf. The default location for these files is
determined at package configuration <br>
(typically /etc/fwknop). The configuration variables within
these files are described below.</p>

<p style="margin-top: 1em">Additional information may be
found in the tutorial &acirc;Single Packet Authorization: A
Comprehensive Guide to Strong Service Concealment with
fwknop&acirc; available online (see: <br>

http://www.cipherdyne.org/fwknop/docs/fwknop-tutorial.html).</p>

<p style="margin-top: 1em">COMMAND-LINE OPTIONS <br>
-i, --interface=&lt;interface&gt; <br>
Manually specify interface on which to sniff, e.g. &acirc;-i
eth0&acirc;. This option is not usually needed because the
&acirc;PCAP_INTF&acirc; keyword in the fwknopd.conf file
defines the sniffing <br>
interface.</p>

<p style="margin-top: 1em">-f, --foreground <br>
Run fwknopd in the foreground instead of becoming a daemon.
When run in the foreground, message that would go to the log
would instead be sent to stderr. This mode is usually <br>
used when testing and/or debugging.</p>

<p style="margin-top: 1em">--fw-list <br>
List only firewall rules that any running fwknopd daemon has
created and then exit.</p>

<p style="margin-top: 1em">-a,
--access-file=&lt;access-file&gt; <br>
Specify the location of the access.conf file. If this option
is not given, fwknopd will use the compile-time default
location (typically /etc/fwknop/access.conf).</p>


<p style="margin-top: 1em">--access-folder=&lt;access-folder&gt;
<br>
Specify the location of the access.conf folder. If this
option is given, rather than load a single access.conf file,
all the .conf files in the given folders are processed.</p>

<p style="margin-top: 1em">-c, --config=&lt;config-file&gt;
<br>
Specify the location of the fwknopd.conf file. If this
option is not given, fwknopd will use the default location
(typically /etc/fwknop/fwknopd.conf.</p>

<p style="margin-top: 1em">-C, --packet-limit=&lt;n&gt;
<br>
Specify the number of candidate SPA packets to process and
exit when this limit is reached.</p>

<p style="margin-top: 1em">-d,
--digest-file=&lt;digest-file&gt; <br>
Specify the location of the digest.cache file. If this
option is not given, fwknopd will use the compile-time
default location (typically /var/fwknop/digest.cache).</p>

<p style="margin-top: 1em">-D, --dump-config <br>
Dump the configuration values that fwknopd derives from the
/etc/fwknop/fwknopd.conf (or override files) and
/etc/fwknop/access.conf on stderr.</p>

<p style="margin-top: 1em">--dump-serv-err-codes <br>
Dump all possible fwknopd error codes to stdout and exit.
This option is rarely needed in practice, and was added to
assist with test coverage.</p>


<p style="margin-top: 1em">--fault-injection-tag=&lt;tag&gt;
<br>
This option is only used for fault injection testing when
fwknop is compiled to support the libfiu library (see:
http://blitiri.com.ar/p/libfiu/). Under normal circumstances
<br>
this option is not used, and any packaged version of fwknop
will not have code compiled in so this capability is not
enabled at run time. It is documented here for <br>
completeness. version of fwknop will not have code compiled
in to enable this capability at run time. It is documented
here for completeness.</p>

<p style="margin-top: 1em">-A, --afl-fuzzing <br>
Instruct fwknopd to acquire SPA packets directly from stdin
in support of fuzzing operations from the American Fuzzy Lop
(AFL) fuzzer written by Michal Zalewski. This <br>
requires that fwknop is compiled with the
--enable-afl-fuzzing argument to the configure script as
this allows encryption/digest short circuiting in a manner
necessary for <br>
AFL to function properly. The benefit of this strategy is
that AFL can fuzz the SPA packet decoding routines
implemented by libfko.</p>

<p style="margin-top: 1em">--fw-list-all <br>
List all firewall rules including those that have nothing to
do with fwknopd.</p>

<p style="margin-top: 1em">--fw-flush <br>
Flush any firewall rules created by a running fwknopd
process. This option allows the used to easily delete
fwknopd firewall rules without having to wait for them to be
timed <br>
out.</p>

<p style="margin-top: 1em">-K, --kill <br>
Kill the current fwknopd process. This provides a quick and
easy way to stop fwknopd without having to look in the
process table.</p>

<p style="margin-top: 1em">--exit-parse-config <br>
Parse config files (/etc/fwknop/fwknopd.conf, and
/etc/fwknop/access.conf) and then exit. This provides a way
to test whether the config files are properly structured
without <br>
having to start processing network traffic.</p>

<p style="margin-top: 1em">--exit-parse-digest-cache <br>
Parse the digest cache file /var/fwknop/digest.cache and
exit. This validates the structure of the digest cache file
without having to start processing network traffic. Note
<br>
that the standard configuration files are also parsed in
this mode.</p>

<p style="margin-top: 1em">-l, --locale=&lt;locale&gt; <br>
Set/override the system default locale setting.</p>

<p style="margin-top: 1em">--no-ipt-check-support <br>
Disable the usage of the iptables -C option. This is not
normally needed, and is only useful on older Linux
distributions where iptables does not have -C support.</p>

<p style="margin-top: 1em">-O,
--override-config=&lt;file&gt; <br>
Override config variable values that are normally read from
the /etc/fwknop/fwknopd.conf file with values from the
specified file. Multiple override config files can be given
<br>
as a comma-separated list.</p>

<p style="margin-top: 1em">--key-gen <br>
Have fwknopd generate both Rijndael and HMAC keys that can
be used for SPA packet encryption and authentication. These
keys are derived from /dev/urandom and then base64 <br>
encoded before being printed to stdout, and are meant to be
manually included in a stanza within the
/etc/fwknop/access.conf file. Such keys are generally more
secure than <br>
passphrases.</p>

<p style="margin-top: 1em">--key-gen-file=&lt;file&gt; <br>
Write generated keys to the specified file. Note that the
file is overwritten if it already exists. If this option is
not given, then --key-gen writes the keys to stdout.</p>

<p style="margin-top: 1em">--key-len=&lt;length&gt; <br>
Specify the number of bytes for a generated Rijndael key.
The maximum size is currently 128 bytes.</p>

<p style="margin-top: 1em">--hmac-key-len=&lt;length&gt;
<br>
Specify the number of bytes for a generated HMAC key. The
maximum size is currently 128 bytes.</p>

<p style="margin-top: 1em">-p, --pid-file=&lt;pid-file&gt;
<br>
Specify the location of the fwknopd.pid file. If this option
is not given, fwknopd will use the compile-time default
location (typically /var/fwknop/fwknopd.pid).</p>

<p style="margin-top: 1em">-P, --pcap-filter=&lt;filter&gt;
<br>
Specify a Berkeley packet filter statement on the fwknopd
command line. This overrides the value of the PCAP_FILTER
variable taken from the /etc/fwknop/fwknopd.conf file.</p>

<p style="margin-top: 1em">--pcap-file=&lt;pcap-file&gt;
<br>
This option instructs fwknopd to read packet data from a
pcap file instead of sniffing an interface directly. This
mode is usually used for debugging purposes, and will <br>
disable SPA packet age checking unless it is manually
enabled in the /etc/fwknop/fwknopd.conf file.</p>

<p style="margin-top: 1em">--pcap-any-direction <br>
Allow fwknopd to sniff SPA packets regardless of whether
they are received on the sniffing interface or sent from the
sniffing interface. In the later case, this can be <br>
useful to have fwknopd sniff SPA packets that are forwarded
through a system and destined for a different network. If
the sniffing interface is the egress interface for such <br>
packets (and hence SPA packets are sent by this interface
instead of received), then this option will need to used in
order for fwknopd to see them. The default is to only <br>
sniff packets that are received on the sniffing interface.
Note that this setting is independent of promiscuous
mode.</p>

<p style="margin-top: 1em">-R, --restart <br>
Restart the currently running fwknopd processes. This option
will preserve the command line options that were supplied to
the original fwknopd process but will force fwknopd <br>
to re-read the fwknopd.conf and /etc/fwknop/access.conf
files. This will also force a flush of the current
&acirc;FWKNOP&acirc; iptables chain(s).</p>

<p style="margin-top: 1em">--rotate-digest-cache <br>
Rotate the digest cache file by renaming it to
&acirc;&lt;name&gt;-old&acirc;, and starting a new one. The
digest cache file is typically found in
/var/fwknop/digest.cache.</p>

<p style="margin-top: 1em">-r, --run-dir=&lt;path&gt; <br>
Specify the directory where fwknopd writes run time state
files. The default is /var.</p>

<p style="margin-top: 1em">-S, --status <br>
Display the status of any fwknopd processes that may or not
be running. If there is an existing fwknopd process then 0
is returned for the exit status and 1 is returned <br>
otherwise.</p>

<p style="margin-top: 1em">--syslog-enable <br>
Allow messages to be sent to syslog even if the foreground
mode is set.</p>

<p style="margin-top: 1em">-t, --test <br>
Run fwknopd in test mode. This instructs fwknopd to acquire
and process SPA packets, but not manipulate firewall rules
or execute commands that are provided by SPA clients. <br>
This option is mostly useful for the fuzzing tests in the
test suite to ensure broad code coverage under adverse
conditions.</p>

<p style="margin-top: 1em">-U, --udp-server <br>
Run fwknopd in UDP server mode so that SPA packets are
acquired via a UDP socket directly without having to use
libpcap. See the discussion of the
&acirc;ENABLE_UDP_SERVER&acirc; <br>
configuration variable below for more information.</p>

<p style="margin-top: 1em">-v, --verbose <br>
Run fwknopd in verbose mode. This can option can be
specified multiple times to increase the verbosity of the
output to the system log file (or to the screen if running
in <br>
the foreground).</p>

<p style="margin-top: 1em">-h, --help <br>
Display usage information and exit.</p>

<p style="margin-top: 1em">-V, --Version <br>
Display version information and exit.</p>

<p style="margin-top: 1em">FWKNOPD CONFIG AND ACCESS
VARIABLES <br>
fwknopd references the /etc/fwknop/fwknopd.conf file for
configuration variables to define operational parameters
(what network interface and port to sniff, what features to
<br>
enable/disable, etc.). The fwknopd.conf file does not define
any access control directives or set any encryption or
authentication keys.</p>

<p style="margin-top: 1em">The access control directives
are contained in the /etc/fwknop/access.conf file. Access
control directives define encryption keys and level of
access that is granted to an fwknop <br>
client that has generated the appropriate encrypted SPA
message.</p>

<p style="margin-top: 1em">FWKNOPD.CONF VARIABLES <br>
This section list the more prominent configuration variables
used by fwknopd. You will want to make sure to check these
to make sure they have appropriate values, but sensible <br>
defaults are provided for most systems. See the
/etc/fwknop/fwknopd.conf file for additional details.</p>

<p style="margin-top: 1em">PCAP_INTF &lt;interface&gt; <br>
Specify the ethernet interface on which fwknopd will sniff
packets.</p>

<p style="margin-top: 1em">ENABLE_PCAP_PROMISC &lt;Y/N&gt;
<br>
By default fwknopd puts the pcap interface into promiscuous
mode. Set this to &acirc;N&acirc; to disable that behavior
(non-promiscuous).</p>

<p style="margin-top: 1em">PCAP_FILTER &lt;pcap filter
spec&gt; <br>
Define the filter used for PCAP modes; fwknopd defaults to
UDP port 62201. However, if an fwknop client uses the
--rand-port option to send the SPA packet over a random
port, <br>
then this variable should be updated to something like
&acirc;udp dst portrange 10000-65535&acirc;.</p>

<p style="margin-top: 1em">ENABLE_SPA_PACKET_AGING
&lt;Y/N&gt; <br>
This instructs fwknopd to not honor SPA packets that have an
old time stamp. The value for &acirc;old&acirc; is defined
by the &acirc;MAX_SPA_PACKET_AGE&acirc; variable. If
&acirc;ENABLE_SPA_PACKET_AGING&acirc; <br>
is set to &acirc;N&acirc;, fwknopd will not use the client
time stamp at all.</p>

<p style="margin-top: 1em">MAX_SPA_PACKET_AGE
&lt;seconds&gt; <br>
Defines the maximum age (in seconds) that an SPA packet will
be accepted. This requires that the client system is in
relatively close time synchronization with the fwknopd <br>
server system (NTP is good). The default age is 120 seconds
(two minutes).</p>

<p style="margin-top: 1em">ENABLE_DIGEST_PERSISTENCE
&lt;Y/N&gt; <br>
Track digest sums associated with previous SPA packets
processed by fwknopd. This allows digest sums to remain
persistent across executions of fwknopd. The default is
&acirc;Y&acirc;. If <br>
set to &acirc;N&acirc;, fwknopd will not check incoming SPA
packet data against any previously save digests. It is a
good idea to leave this feature on to reduce the possibility
of being <br>
vulnerable to a replay attack.</p>

<p style="margin-top: 1em">RULES_CHECK_THRESHOLD
&lt;count&gt; <br>
Defines the number of times firewall rule expiration times
must be checked before a &quot;deep&quot; check is run. This
allows fwknopd to remove rules that contain a proper
exp&lt;time&gt; <br>
even if a third party program added them instead of fwknopd.
The default value for this variable is 20, and this
typically results in this check being run every two seconds
<br>
or so. To disable this type of checking altogether, set this
variable to zero.</p>

<p style="margin-top: 1em">ENABLE_IPT_FORWARDING
&lt;Y/N&gt; <br>
Allow SPA clients to request access to services through an
iptables firewall instead of just to it (i.e. access through
the FWKNOP_FORWARD chain instead of the INPUT chain).</p>

<p style="margin-top: 1em">ENABLE_IPT_LOCAL_NAT &lt;Y/N&gt;
<br>
Allow SPA clients to request access to a local socket via
NAT. This still puts an ACCEPT rule into the FWKNOP_INPUT
chain, but a different port is translated via DNAT rules
<br>
to the real one. So, the user would do &acirc;ssh -p
&lt;port&gt;&acirc; to access the local service (see the
--NAT-local and --NAT-rand-port on the fwknop client command
line).</p>

<p style="margin-top: 1em">ENABLE_IPT_SNAT &lt;Y/N&gt; <br>
Set this to &acirc;Y&acirc; to enable a corresponding SNAT
rule. By default, if forwarding access is enabled (see the
&acirc;ENABLE_IPT_FORWARDING&acirc; variable above), then
fwknopd creates DNAT <br>
rules for incoming connections, but does not also complement
these rules with SNAT rules at the same time. In some
situations, internal systems may not have a route back out
<br>
for the source address of the incoming connection, so it is
necessary to also apply SNAT rules so that the internal
systems see the IP of the internal interface where fwknopd
<br>
is running.</p>

<p style="margin-top: 1em">SNAT_TRANSLATE_IP
&lt;ip_address&gt; <br>
Specify the IP address for SNAT. This functionality is only
enabled when &acirc;ENABLE_IPT_SNAT&acirc; is set to
&acirc;Y&acirc; and by default SNAT rules are built with the
MASQUERADE target (since <br>
then the internal IP does not have to be defined here in the
/etc/fwknop/fwknopd.conf file), but if you want fwknopd to
use the SNAT target, you must also define an IP <br>
address with the &acirc;SNAT_TRANSLATE_IP&acirc; variable.
Note that this variable is generally deprecated in favor of
the &acirc;FORCE_SNAT&acirc; variable in the
/etc/fwknop/access.conf file which <br>
enables per-stanza control over the SNAT IP.</p>

<p style="margin-top: 1em">ENABLE_IPT_OUTPUT &lt;Y/N&gt;
<br>
Add ACCEPT rules to the FWKNOP_OUTPUT chain. This is usually
only useful if there are no state tracking rules to allow
connection responses out and the OUTPUT chain has a <br>
default-drop stance.</p>

<p style="margin-top: 1em">MAX_SNIFF_BYTES &lt;bytes&gt;
<br>
Specify the the maximum number of bytes to sniff per frame.
1500 is the default.</p>

<p style="margin-top: 1em">FLUSH_IPT_AT_INIT &lt;Y/N&gt;
<br>
Flush all existing rules in the fwknop chains at fwknopd
start time. The default is &acirc;Y&acirc;.</p>

<p style="margin-top: 1em">FLUSH_IPT_AT_EXIT &lt;Y/N&gt;
<br>
Flush all existing rules in the fwknop chains when fwknopd
is stopped or otherwise exits cleanly. The default is
&acirc;Y&acirc;.</p>

<p style="margin-top: 1em">EXIT_AT_INTF_DOWN &lt;Y/N&gt;
<br>
When fwknopd is sniffing an interface, if the interface is
administratively downed or unplugged, fwknopd will cleanly
exit and an assumption is made that any process <br>
monitoring infrastructure like systemd or upstart will
restart it. However, if fwknopd is not being monitored by
systemd, upstart, or anything else, this behavior can be
<br>
disabled with the &acirc;EXIT_AT_INTF_DOWN&acirc; variable.
If disabled, fwknopd will try to recover when a downed
interface comes back up.</p>

<p style="margin-top: 1em">ENABLE_RULE_PREPEND &lt;Y/N&gt;
<br>
For systems running iptables or firewalld, have fwknopd
insert new SPA rules at the beginning of the relevant chain
(such as &acirc;FWKNOP_INPUT&acirc;) instead of appending
them to the <br>
end of the chain. This causes newly created rules to have
precedence over older ones.</p>

<p style="margin-top: 1em">ENABLE_NAT_DNS &lt;Y/N&gt; <br>
Allow fwknopd to resolve hostnames in NAT access
messages.</p>

<p style="margin-top: 1em">GPG_HOME_DIR &lt;path&gt; <br>
If GPG keys are used instead of a Rijndael symmetric key,
this is the default GPG keys directory. Note that each
access stanza in /etc/fwknop/access.conf can specify its own
<br>
GPG directory to override this default. If not set here or
in an access.conf stanza, then the $HOME/.gnupg directory of
the user running fwknopd (most likely root).</p>

<p style="margin-top: 1em">GPG_EXE &lt;path&gt; <br>
Specify the path to GPG, and defaults to /usr/bin/gpg if not
set.</p>

<p style="margin-top: 1em">LOCALE &lt;locale&gt; <br>
Set the locale (via the LC_ALL variable). This can be set to
override the default system locale.</p>

<p style="margin-top: 1em">ENABLE_SPA_OVER_HTTP &lt;Y/N&gt;
<br>
Allow fwknopd to acquire SPA data from HTTP requests
(generated with the fwknop client in --HTTP mode). Note that
when this is enabled, the &acirc;PCAP_FILTER&acirc; variable
would need <br>
to be updated to sniff traffic over TCP/80 connections and a
web server should be running on the same server as
fwknopd.</p>

<p style="margin-top: 1em">ENABLE_X_FORWARDED_FOR
&lt;Y/N&gt; <br>
Allows fwknopd to use the X-Forwarded-for header from a
captured SPA packet over HTTP as the source IP. This can
happen when using SPA through an HTTP proxy.</p>

<p style="margin-top: 1em">ENABLE_TCP_SERVER &lt;Y/N&gt;
<br>
Enable the fwknopd TCP server. This is a &quot;dummy&quot;
TCP server that will accept TCP connection requests on the
specified TCPSERV_PORT. If set to &quot;Y&quot;, fwknopd
will fork off a <br>
child process to listen for, and accept incoming TCP
request. This server only accepts the request. It does not
otherwise communicate. This is only to allow the incoming
SPA <br>
over TCP packet which is detected via PCAP. The connection
is closed after 1 second regardless. Note that fwknopd still
only gets its data via pcap, so the filter defined by <br>
PCAP_FILTER needs to be updated to include this TCP
port.</p>

<p style="margin-top: 1em">TCPSERV_PORT &lt;port&gt; <br>
Set the port number that the &acirc;dummy&acirc; TCP server
listens on. This server is only spawned when
&acirc;ENABLE_TCP_SERVER&acirc; is set to
&acirc;Y&acirc;.</p>

<p style="margin-top: 1em">ENABLE_UDP_SERVER &lt;Y/N&gt;
<br>
Enable the fwknopd UDP server. This instructs fwknopd to
acquire SPA packets via a UDP socket directly without having
to use libpcap. When this mode is enabled, fwknop should
<br>
be compiled with --enable-udp-server (passed to the
configure script) so that libpcap can be removed as a
dependency. As one would expect, when the UDP server is
used, no <br>
incoming packets are ever acknowledged by fwknopd and
therefore collecting SPA packets in this mode is a good
alternative to sniffing the wire directly.</p>

<p style="margin-top: 1em">UDPSERV_PORT &lt;port&gt; <br>
Set the port number that the UDP server listens on. This
server is only spawned when &acirc;ENABLE_UDP_SERVER&acirc;
is set to &acirc;Y&acirc;.</p>

<p style="margin-top: 1em">PCAP_DISPATCH_COUNT
&lt;count&gt; <br>
Sets the number of packets that are processed when the
pcap_dispatch() call is made. The default is zero, since
this allows fwknopd to process as many packets as possible
in <br>
the corresponding callback where the SPA handling routine is
called for packets that pass a set of prerequisite checks.
However, if fwknopd is running on a platform with an <br>
old version of libpcap, it may be necessary to change this
value to a positive non-zero integer. More information can
be found in the pcap_dispatch(3) man page.</p>

<p style="margin-top: 1em">PCAP_LOOP_SLEEP
&lt;microseconds&gt; <br>
Sets the number of microseconds to passed as an argument to
usleep() in the pcap loop. The default is 10000, or 1/10th
of a second.</p>

<p style="margin-top: 1em">ENABLE_PCAP_ANY_DIRECTION
&lt;Y/N&gt; <br>
Controls whether fwknopd is permitted to sniff SPA packets
regardless of whether they are received on the sniffing
interface or sent from the sniffing interface. In the later
<br>
case, this can be useful to have fwknopd sniff SPA packets
that are forwarded through a system and destined for a
different network. If the sniffing interface is the egress
<br>
interface for such packets, then this variable will need to
be set to &quot;Y&quot; in order for fwknopd to see them.
The default is &quot;N&quot; so that fwknopd only looks for
SPA packets that <br>
are received on the sniffing interface (note that this is
independent of promiscuous mode).</p>

<p style="margin-top: 1em">SYSLOG_IDENTITY &lt;identity&gt;
<br>
Override syslog identity on message logged by fwknopd. The
defaults are usually ok.</p>

<p style="margin-top: 1em">SYSLOG_FACILITY &lt;facility&gt;
<br>
Override syslog facility. The &acirc;SYSLOG_FACILITY&acirc;
variable can be set to</p>

<p style="margin-top: 1em">ENABLE_DESTINATION_RULE
&lt;Y/N&gt; <br>
Controls whether fwknopd will set the destination field on
the firewall rule to the destination address specified on
the incoming SPA packet. This is useful for interfaces <br>
with multiple IP addresses hosting separate services. If
&acirc;ENABLE_IPT_OUTPUT&acirc; is set to &acirc;Y&acirc;,
the source field of the firewall rule is set. FORWARD and
SNAT rules are not <br>
affected however, DNAT rules will also have their
destination field set. The default is &acirc;N&acirc;, which
sets the destination field to 0.0.0.0/0 (any).</p>

<p style="margin-top: 1em">FWKNOP_RUN_DIR &lt;path&gt; <br>
Specify the directory where fwknopd writes run time state
files. The default is /var.</p>

<p style="margin-top: 1em">ACCESS.CONF VARIABLES <br>
This section describes the access control directives in the
/etc/fwknop/access.conf file. Theses directives define
encryption and authentication keys, and the level of access
<br>
that is granted to fwknop clients that have generated an
appropriate encrypted and authenticated SPA packet.</p>

<p style="margin-top: 1em">The access.conf variables
described below provide the access directives for the SPA
packets with a source (or embedded request) IP that matches
an address or network range <br>
defined by the &acirc;SOURCE&acirc; variable. All variables
following &acirc;SOURCE&acirc; apply to the source stanza.
Each &acirc;SOURCE&acirc; directive starts a new stanza.</p>

<p style="margin-top: 1em">SOURCE
&lt;IP,..,IP/NET,..,NET/ANY&gt; <br>
This defines the source address from which the SPA packet
will be accepted. The string &acirc;ANY&acirc; is also
accepted if a valid SPA packet should be honored from any
source IP. <br>
Every authorization stanza in /etc/fwknop/access.conf
definition must start with the &acirc;SOURCE&acirc; keyword.
Networks should be specified in CIDR notation (e.g.
&acirc;192.168.10.0/24&acirc;), <br>
and individual IP addresses can be specified as well. Also,
multiple IP&acirc;s and/or networks can be defined as a
comma separated list (e.g.
&acirc;192.168.10.0/24,10.1.1.123&acirc;)</p>

<p style="margin-top: 1em">DESTINATION
&lt;IP,..,IP/NET,..,NET/ANY&gt; <br>
This defines the destination address for which the SPA
packet will be accepted. The string &acirc;ANY&acirc; is
also accepted if a valid SPA packet should be honored to any
destination <br>
IP. Networks should be specified in CIDR notation (e.g.
&acirc;192.168.10.0/24&acirc;), and individual IP addresses
can be specified as well. Also, multiple IP&acirc;s and/or
networks can be <br>
defined as a comma separated list (e.g.
&acirc;192.168.10.0/24,10.1.1.123&acirc;)</p>

<p style="margin-top: 1em">OPEN_PORTS
&lt;proto/port&gt;,...,&lt;proto/port&gt; <br>
Define a set of ports and protocols (tcp or udp) that will
be opened if a valid knock sequence is seen. If this entry
is not set, fwknopd will attempt to honor any proto/port
<br>
request specified in the SPA data (unless of it matches any
&acirc;RESTRICT_PORTS&acirc; entries). Multiple entries are
comma-separated.</p>

<p style="margin-top: 1em">RESTRICT_PORTS
&lt;proto/port&gt;,...,&lt;proto/port&gt; <br>
Define a set of ports and protocols (tcp or udp) that are
explicitly not allowed regardless of the validity of the
incoming SPA packet. Multiple entries are
comma-separated.</p>

<p style="margin-top: 1em">KEY &lt;passphrase&gt; <br>
Define the symmetric key used for decrypting an incoming SPA
packet that is encrypted by the fwknop client with Rijndael.
The actual encryption key that is used is derived <br>
from the standard PBKDF1 algorithm. This variable is
required for all SPA packets unless GnuPG is used instead
(see the GPG variables below).</p>

<p style="margin-top: 1em">KEY_BASE64 &lt;base64 encoded
passphrase&gt; <br>
Same as the KEY option above, but specify the symmetric key
as a base64 encoded string. This allows non-ascii characters
to be included in the base64-decoded key.</p>

<p style="margin-top: 1em">HMAC_KEY &lt;key&gt; <br>
Specify the HMAC key for authenticated encryption of SPA
packets. This supports both Rijndael and GPG encryption
modes, and is applied according to the <br>
encrypt-then-authenticate model.</p>

<p style="margin-top: 1em">HMAC_KEY_BASE64 &lt;base64
encoded key&gt; <br>
Specify the HMAC key as a base64 encoded string. This allows
non-ascii characters to be included in the base64-decoded
key.</p>

<p style="margin-top: 1em">FW_ACCESS_TIMEOUT
&lt;seconds&gt; <br>
Define the length of time access will be granted by fwknopd
through the firewall after a valid knock sequence from a
source IP address. If &acirc;FW_ACCESS_TIMEOUT&acirc; is not
set then <br>
the default timeout of 30 seconds will automatically be
set.</p>

<p style="margin-top: 1em">%include &lt;file&gt; <br>
Have fwknopd import an additional access.conf file. This
allows more access stanzas to be defined in other locations
in the filesystem, and this can be advantageous in some <br>
scenarios by letting non-privileged users define their own
encryption and authentication keys for SPA operations. This
way, users do not need write access to the main <br>
/etc/fwknop/access.conf file to change keys around or define
new ones.</p>

<p style="margin-top: 1em">%include_folder
&lt;directory&gt; <br>
Similarly to the %include option above, the %include_folder
directive has fwknopd import all .conf files from the
specified directory. There is also command line support for
<br>
this via the access-folder option.</p>

<p style="margin-top: 1em">ENCRYPTION_MODE &lt;mode&gt;
<br>
Specify the encryption mode when AES is used. The default is
CBC mode, but other modes can be selected such as OFB and
CFB. In general, it is recommended to not use this <br>
variable and leave it as the default. Note that the string
&acirc;legacy&acirc; can be specified in order to generate
SPA packets with the old initialization vector strategy used
by <br>
versions of fwknop before 2.5. With the 2.5 release, fwknop
uses PBKDF1 for key derivation.</p>

<p style="margin-top: 1em">HMAC_DIGEST_TYPE &lt;digest
algorithm&gt; <br>
Specify the digest algorithm for incoming SPA packet
authentication. Must be one of MD5, SHA1, SHA256, SHA384,
SHA512, SHA3_256, or SHA3_512. This is an optional field,
and <br>
if not specified then fwknopd defaults to using SHA256 if
the access stanza requires an HMAC.</p>

<p style="margin-top: 1em">ACCESS_EXPIRE &lt;MM/DD/YYYY&gt;
<br>
Defines an expiration date for the access stanza in
MM/DD/YYYY format. All SPA packets that match an expired
stanza will be ignored. This parameter is optional.</p>

<p style="margin-top: 1em">ACCESS_EXPIRE_EPOCH
&lt;seconds&gt; <br>
Defines an expiration date for the access stanza as the
epoch time, and is useful if a more accurate expiration time
needs to be given than the day resolution offered by the
<br>
ACCESS_EXPIRE variable above. All SPA packets that match an
expired stanza will be ignored. This parameter is
optional.</p>

<p style="margin-top: 1em">ENABLE_CMD_EXEC &lt;Y/N&gt; <br>
This instructs fwknopd to accept complete commands that are
contained within an authorization packet. Any such command
will be executed on the fwknopd server as the user <br>
specified by the &acirc;CMD_EXEC_USER&acirc; or as the user
that started fwknopd if that is not set.</p>

<p style="margin-top: 1em">ENABLE_CMD_SUDO_EXEC &lt;Y/N&gt;
<br>
sudo provides a powerful means of restricting the sets of
commands that users can execute via the
&acirc;sudoers&acirc; file. By enabling this feature (and in
&acirc;ENABLE_CMD_EXEC&acirc; mode), <br>
all incoming commands from valid SPA packets will be
prefixed by &acirc;/path/to/sudo -u &lt;user&gt; -g
&lt;group&gt;&acirc; where the path to sudo is set by the
&acirc;SUDO_EXE&acirc; variable, &acirc;&lt;user&gt;&acirc;
is <br>
set by the &acirc;CMD_SUDO_EXEC_USER&acirc; variable
(default is &acirc;root&acirc; if not set), and
&acirc;&lt;group&gt;&acirc; is set by
&acirc;CMD_SUDO_EXEC_GROUP&acirc; (default is also
&acirc;root&acirc; if not set).</p>

<p style="margin-top: 1em">CMD_EXEC_USER &lt;username&gt;
<br>
Specify the user (via setuid) that will execute a command
contained within a SPA packet. If this variable is not
given, fwknopd will execute the command as the user it is
<br>
running as (most likely root). Setting this to a non-root
user such as &acirc;nobody&acirc; is highly recommended if
elevated permissions are not needed.</p>

<p style="margin-top: 1em">CMD_SUDO_EXEC_USER
&lt;username&gt; <br>
Specify the user (via &acirc;sudo -u &lt;user&gt;&acirc;)
that will execute a command contained within a SPA packet.
If this variable is not given, fwknopd will assume the
command should be <br>
executed as root.</p>

<p style="margin-top: 1em">CMD_EXEC_GROUP &lt;groupname&gt;
<br>
Specify the group (via setgid) that will execute a command
contained within a SPA packet. If this variable is not
given, fwknopd will execute the command as the user it is
<br>
running as (most likely root). Setting this to a non-root
user such as &acirc;nobody&acirc; is highly recommended if
elevated permissions are not needed.</p>

<p style="margin-top: 1em">CMD_SUDO_EXEC_GROUP
&lt;groupname&gt; <br>
Specify the group (via &acirc;sudo -g &lt;group&gt;&acirc;)
that will execute a command contained within a SPA packet.
If this variable is not given, fwknopd will assume the
command should be <br>
executed as root.</p>

<p style="margin-top: 1em">CMD_CYCLE_OPEN &lt;command&gt;
<br>
Specify a command open/close cycle to be executed upon
receipt of a valid SPA packet. This directive sets the
initial command, and is meant to be used in conjunction with
the <br>
&acirc;CMD_CYCLE_CLOSE&acirc; variable below. The main
application of this feature is to allow fwknopd to interact
with firewall or ACL&acirc;s that are not natively
supported, and facilitate <br>
the same access model as for the main supported firewalls
such as iptables. That is, a command is executed to open the
firewall or ACL, and then a corresponding close command <br>
is executed after a timer expires. Both the
&acirc;CMD_CYCLE_OPEN&acirc; and
&acirc;CMD_CYCLE_CLOSE&acirc; variables support special
substitution strings to allow values to be taken from the
SPA <br>
payload and used on the command line of the executed
command. These strings begin with a &acirc;$&acirc;
character, and include &acirc;$IP&acirc; (the allow IP
decrypted from the SPA payload), <br>
&acirc;$SRC&acirc; (synonym for &acirc;$IP&acirc;) ,
&acirc;$PKT_SRC&acirc; (the source IP in the network layer
header of the SPA packet), &acirc;$DST&acirc; (the
destination IP), &acirc;$PORT&acirc; (the allow port), and
&acirc;$PROTO&acirc; <br>
(the allow protocol), &acirc;$TIMEOUT&acirc; (set the client
timeout if specified).</p>

<p style="margin-top: 1em">CMD_CYCLE_CLOSE &lt;command&gt;
<br>
Specify the close command that corresponds to the open
command set by the &acirc;CMD_CYCLE_OPEN&acirc; variable
described above. The same string substitutions such as
&acirc;$IP&acirc;, &acirc;$PORT&acirc;, and <br>
&acirc;$PROTO&acirc; are supported. In addition, the special
value &acirc;NONE&acirc; can be set to allow no close
command to be executed after the open command. This might be
handy in certain <br>
situations where, say, indefinite access is desired and
allowed.</p>

<p style="margin-top: 1em">CMD_CYCLE_TIMER &lt;seconds&gt;
<br>
Set the number of seconds after which the close command set
in &acirc;CMD_CYCLE_CLOSE&acirc; will be executed. This
defines the open/close timer interval.</p>

<p style="margin-top: 1em">SUDO_EXE &lt;path&gt; <br>
Define the path to the sudo binary. Default is
&acirc;/usr/bin/sudo&acirc;.</p>

<p style="margin-top: 1em">REQUIRE_USERNAME
&lt;username&gt; <br>
Require a specific username from the client system as
encoded in the SPA data. This variable is optional and if
not specified, the username data in the SPA data is
ignored.</p>

<p style="margin-top: 1em">REQUIRE_SOURCE_ADDRESS
&lt;Y/N&gt; <br>
Force all SPA packets to contain a real IP address within
the encrypted data. This makes it impossible to use the -s
command line argument on the fwknop client command line,
<br>
so either -R has to be used to automatically resolve the
external address (if the client behind a NAT) or the client
must know the external IP and set it via the -a
argument.</p>

<p style="margin-top: 1em">REQUIRE_SOURCE_ADDRESS
&lt;Y/N&gt; <br>
Synonym for &acirc;REQUIRE_SOURCE_ADDRESS&acirc;.</p>

<p style="margin-top: 1em">FORCE_NAT &lt;IP&gt;
&lt;PORT&gt; <br>
For any valid SPA packet, force the requested connection to
be NAT&acirc;d through to the specified (usually internal)
IP and port value. This is useful if there are multiple <br>
internal systems running a service such as SSHD, and you
want to give transparent access to only one internal system
for each stanza in the access.conf file. This way, <br>
multiple external users can each directly access only one
internal system per SPA key.</p>

<p style="margin-top: 1em">FORCE_SNAT &lt;IP&gt; <br>
For any valid SPA packet, add an SNAT rule in addition to
any DNAT rule created with a corresponding (required)
FORCE_NAT variable. This is analogous to
&acirc;SNAT_TRANSLATE_IP&acirc; <br>
from the /etc/fwknop/fwknopd.conf file except that it is per
access stanza and overrides any value set with
&acirc;SNAT_TRANSLATE_IP&acirc;. This is useful for
situations where an <br>
incoming NAT&acirc;d connection may be otherwise
unanswerable due to routing constraints (i.e. the system
receiving the SPA authenticated connection has a default
route to a <br>
different device than the SPA system itself).</p>

<p style="margin-top: 1em">FORCE_MASQUERADE &lt;Y/N&gt;
<br>
This is similar to the &acirc;FORCE_SNAT&acirc; variable,
except that it is not necessary to also specify an IP
address for SNAT rules because the MASQUERADE target is used
instead.</p>

<p style="margin-top: 1em">FORWARD_ALL &lt;Y/N&gt; <br>
In NAT scenarios, control whether all traffic is forwarded
through the fwknopd system as opposed to just forwarding
connections to specific services as requested by the <br>
fwknop client.</p>

<p style="margin-top: 1em">DISABLE_DNAT &lt;Y/N&gt; <br>
Control whether DNAT rules are created in FORCE_NAT
scenarios. This is mainly used in conjunction with the
FORWARD_ALL variable to allow fwknopd to act essentially as
an SPA <br>
gateway. I.e., the fwknop client is used to gain access via
SPA to the broader Internet after being granted an IP via
DHCP, but prior to sending the SPA packet all traffic is
<br>
blocked by default to the Internet.</p>

<p style="margin-top: 1em">GPG_DECRYPT_ID &lt;keyID&gt;
<br>
Define a GnuPG key ID to use for decrypting SPA messages
that have been encrypted by an fwknop client. This keyword
is required for authentication that is based on GPG keys.
<br>
The GPG key ring on the client must have imported and signed
the fwknopd server key, and vice versa. It is ok to use a
sensitive personal GPG key on the client, but each <br>
fwknopd server should have its own GPG key that is generated
specifically for fwknop communications. The reason for this
is that the decryption password for the server key <br>
must be placed within the /etc/fwknop/access.conf file for
fwknopd to function (it has to be able to decrypt SPA
messages that have been encrypted with the server&acirc;s
public <br>
key). For more information on using fwknop with GnuPG keys,
see the following link:
&acirc;http://www.cipherdyne.org/fwknop/docs/gpghowto.html&acirc;.</p>

<p style="margin-top: 1em">GPG_DECRYPT_PW &lt;decrypt
password&gt; <br>
Specify the decryption password for the gpg key defined by
the &acirc;GPG_DECRYPT_ID&acirc; above. This is a required
field for gpg-based authentication.</p>

<p style="margin-top: 1em">GPG_ALLOW_NO_PW &lt;Y/N&gt; <br>
Allow fwknopd to leverage a GnuPG key pair that does not
have an associated password. While this may sound like a
controversial deployment mode, in automated environments it
<br>
makes sense because &quot;there is usually no way to store a
password more securely than on the secret keyring
itself&quot; according to: <br>

&acirc;http://www.gnupg.org/faq/GnuPG-FAQ.html#how-can-i-use-gnupg-in-an-automated-environment&acirc;.
Using this feature and removing the passphrase from a GnuPG
key pair is useful in <br>
some environments where libgpgme is forced to use gpg-agent
and/or pinentry to collect a passphrase.</p>

<p style="margin-top: 1em">GPG_REQUIRE_SIG &lt;Y/N&gt; <br>
With this setting set to Y, fwknopd check all GPG-encrypted
SPA messages for a signature (signed by the sender&acirc;s
key). If the incoming message is not signed, the decryption
<br>
process will fail. If not set, the default is Y.</p>

<p style="margin-top: 1em">GPG_DISABLE_SIG &lt;Y/N&gt; <br>
Disable signature verification for incoming SPA messages.
This is not a recommended setting, and the default is N.</p>

<p style="margin-top: 1em">GPG_IGNORE_SIG_VERIFY_ERROR
&lt;Y/N&gt; <br>
Setting this will allow fwknopd to accept incoming
GPG-encrypted packets that are signed, but the signature did
not pass verification (i.e. the signer key was expired,
etc.). <br>
This setting only applies if the GPG_REQUIRE_SIG is also set
to Y.</p>

<p style="margin-top: 1em">GPG_REMOTE_ID
&lt;keyID,...,keyID&gt; <br>
Define a list of gpg key ID&acirc;s that are required to
have signed any incoming SPA message that has been encrypted
with the fwknopd server key. This ensures that the <br>
verification of the remote user is accomplished via a strong
cryptographic mechanism. Signature verification is enabled
by default, and can only be disabled if <br>
&acirc;GPG_DISABLE_SIG&acirc; is set to Y (not a recommended
setting). Separate multiple entries with a comma.</p>

<p style="margin-top: 1em">GPG_FINGERPRINT_ID
&lt;keyID,...,keyID&gt; <br>
Specify a set of full-length GnuPG key fingerprints instead
of the shorter key identifiers set with the
&acirc;GPG_REMOTE_ID&acirc; variable. Here is an example
fingerprint for one of <br>
the fwknop test suite keys:
00CC95F05BC146B6AC4038C9E36F443C6A3FAD56.</p>

<p style="margin-top: 1em">GPG_HOME_DIR &lt;path&gt; <br>
Define the path to the GnuPG directory to be used by the
fwknopd server. If this keyword is not specified within
/etc/fwknop/access.conf then fwknopd will default to using
<br>
the /root/.gnupg directory for the server key(s) for
incoming SPA packets handled by the matching access.conf
stanza.</p>

<p style="margin-top: 1em">GPG_EXE &lt;path&gt; <br>
Define the path to the GnuPG executable. If this keyword is
not specified within /etc/fwknop/access.conf then fwknopd
will default to using /usr/bin/gpg.</p>

<p style="margin-top: 1em">FILES <br>
/etc/fwknop/fwknopd.conf <br>
The main configuration file for fwknop.</p>

<p style="margin-top: 1em">/etc/fwknop/access.conf <br>
Defines all knock sequences and access control
directives.</p>

<p style="margin-top: 1em">DEPENDENCIES <br>
fwknopd requires libfko which is normally included with both
source and binary distributions, and is a dedicated library
developed by the fwknop project.</p>

<p style="margin-top: 1em">For packet sniffing, fwknopd
currently requires libpcap, but future versions will
(optionally) remove this as a dependency.</p>

<p style="margin-top: 1em">For GPG functionality, GnuPG
must also be correctly installed and configured along with
the libgpgme library.</p>

<p style="margin-top: 1em">To take advantage of all of the
authentication and access management features of the fwknopd
daemon/service a functioning iptables, ipfw, or pf firewall
is required on the <br>
underlying operating system.</p>

<p style="margin-top: 1em">DIAGNOSTICS <br>
fwknopd can be run in debug mode by combining the -f,
--foreground and the -v, --verbose command line options.
This will disable daemon mode execution, and print verbose
<br>
information to the screen on stderr as packets are
received.</p>

<p style="margin-top: 1em">The most comprehensive way to
gain diagnostic information on fwknopd is to run the test
suite test-fwknop.pl script located in the test/ directory
in the fwknop sources. The test <br>
suite runs sends fwknop through a large number of run time
tests, has valgrind support, validates both SPA encryption
and HMAC results against OpenSSL, and even has its own built
<br>
in fuzzer for SPA communications.</p>

<p style="margin-top: 1em">SEE ALSO <br>
fwknopd(8), iptables(8), pf(4), pfctl(8), ipfw(8), gpg(1),
libfko documentation.</p>

<p style="margin-top: 1em">More information on Single
Packet Authorization can be found in the paper &acirc;Single
Packet Authorization with fwknop&acirc; available at
http://www.cipherdyne.org/fwknop/docs/SPA.html. A <br>
comprehensive tutorial on fwknop operations and theory can
be found at
http://www.cipherdyne.org/fwknop/docs/fwknop-tutorial.html.
This tutorial also includes information about <br>
the design of fwknop that may be worth reading for those
interested in why fwknop is different from other SPA
implementations.</p>

<p style="margin-top: 1em">fwknop uses the git versioning
system as its source code repository along with Github for
tracking of issues and milestones:</p>

<p style="margin-top: 1em">$ git clone
https://github.com/mrash/fwknop.git fwknop.git</p>

<p style="margin-top: 1em">Additional commentary on Single
Packet Authorization can be found via Michael Rash&acirc;s
Twitter feed: http://twitter.com/michaelrash,
@michaelrash</p>

<p style="margin-top: 1em">AUTHORS <br>
The primary developers of fwknop are Michael Rash (project
creator) &lt;mbr@cipherdyne.org&gt;, Damien Stuart
&lt;dstuart@dstuart.org&gt;, and Jonathan Bennett
&lt;jbennett@incomsystems.biz&gt;.</p>

<p style="margin-top: 1em">CONTRIBUTORS <br>
This &acirc;C&acirc; version of fwknop was derived from the
original Perl-based version on which many people who are
active in the open source community have contributed. See
the CREDITS <br>
file in the fwknop sources, or visit
https://github.com/mrash/fwknop/blob/master/CREDITS to view
the online list of contributors. A few contributors deserve
to be singled out <br>
including: Franck Joncourt, Max Kastanas, Vlad Glagolev,
Sean Greven, Hank Leininger, Fernando Arnaboldi, and Erik
Gomez.</p>

<p style="margin-top: 1em">The phrase &acirc;Single Packet
Authorization&acirc; was coined by MadHat and Simple Nomad
at the BlackHat Briefings of 2005.</p>

<p style="margin-top: 1em">BUGS <br>
Send bug reports to dstuart@dstuart.org or
mbr@cipherdyne.org, or open a new issue on Github (see
https://github.com/mrash/fwknop.git). Suggestions and/or
comments are always <br>
welcome as well. Additional information may be found in the
fwknop mailing list archives (see:
https://lists.sourceforge.net/lists/listinfo/fwknop-discuss).</p>

<p style="margin-top: 1em">DISTRIBUTION <br>
fwknopd is distributed under the GNU General Public License
(GPL v2+), and the latest version may be downloaded from
http://www.cipherdyne.org.</p>

<p style="margin-top: 1em">Fwknop Server 06/08/2016
FWKNOPD(8)</p>
<hr>
</body>
</html>
