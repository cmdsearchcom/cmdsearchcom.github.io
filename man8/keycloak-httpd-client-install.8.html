<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 19:12:42 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>keycloak-httpd-client-install(1) General Commands Manual
keycloak-httpd-client-install(1)</p>

<p style="margin-top: 1em">NAME <br>
keycloak-httpd-client-install - Tools to configure Apache
HTTPD as Keycloak client</p>

<p style="margin-top: 1em">SYNOPSIS <br>
keycloak-httpd-client-install [-h] [--no-root-check] [-v]
[-d] [--show-traceback] [--log-file LOG_FILE] --app-name
APP_NAME [--force] [--permit-insecure-transport]
[--tls-verify] <br>
[--template-dir TEMPLATE_DIR] [--httpd-dir HTTPD_DIR] -r
KEYCLOAK_REALM -s KEYCLOAK_SERVER_URL [-a
root-admin|realm-admin|anonymous] [-u
KEYCLOAK_ADMIN_USERNAME] -p KEY&acirc; <br>
CLOAK_ADMIN_PASSWORD [--keycloak-admin-realm
KEYCLOAK_ADMIN_REALM] [--initial-access-token
INITIAL_ACCESS_TOKEN] [--client-originate-method
descriptor|registration] [--mel&acirc; <br>
lon-key-file MELLON_KEY_FILE] [--mellon-cert-file
MELLON_CERT_FILE] [--mellon-hostname MELLON_HOSTNAME]
[--mellon-https-port MELLON_HTTPS_PORT] [--mellon-root
MELLON_ROOT] <br>
[--mellon-endpoint MELLON_ENDPOINT] [--mellon-entity-id
MELLON_ENTITY_ID] [--mellon-idp-attr-name
MELLON_IDP_ATTR_NAME] [--mellon-organization-name
MELLON_ORGANIZATION_NAME] <br>
[--mellon-organization-display-name
MELLON_ORGANIZATION_DISPLAY_NAME] [--mellon-organization-url
MELLON_ORGANIZATION_URL] [-l MELLON_PROTECTED_LOCATIONS]</p>

<p style="margin-top: 1em">Configure mod_auth_mellon as
Keycloak client</p>

<p style="margin-top: 1em">OPTIONS <br>
-h, --help <br>
show this help message and exit</p>

<p style="margin-top: 1em">--no-root-check <br>
permit running by non-root (default: False)</p>

<p style="margin-top: 1em">-v, --verbose <br>
be chatty (default: False)</p>

<p style="margin-top: 1em">-d, --debug <br>
turn on debug info (default: False)</p>

<p style="margin-top: 1em">--show-traceback <br>
exceptions print traceback in addition to error message
(default: False)</p>

<p style="margin-top: 1em">--log-file LOG_FILE <br>
log file pathname (default:
/var/log/python-keycloak-httpd-client/keycloak-httpd-client-install.log)</p>

<p style="margin-top: 1em">--app-name APP_NAME <br>
name of the web app being protected by mellon (default:
None)</p>

<p style="margin-top: 1em">--force <br>
forcefully override safety checks (default: False)</p>

<p style="margin-top: 1em">--permit-insecure-transport <br>
Normally secure transport such as TLS is required, defeat
this check (default: False)</p>

<p style="margin-top: 1em">--tls-verify <br>
TLS certificate verification for requests to the server. May
be one of case insenstive [true, yes, on] to enable, [false,
no, off] to disable. Or the pathname to a OpenSSL <br>
CA bundle to use. (default: True)</p>

<p style="margin-top: 1em">Program Configuration:</p>

<p style="margin-top: 1em">--template-dir TEMPLATE_DIR <br>
Template location (default:
/usr/share/keycloak-httpd-client/templates)</p>

<p style="margin-top: 1em">--httpd-dir HTTPD_DIR <br>
Template location (default: /etc/httpd)</p>

<p style="margin-top: 1em">Keycloak IdP:</p>

<p style="margin-top: 1em">-r, --keycloak-realm
KEYCLOAK_REALM <br>
realm name (default: None)</p>

<p style="margin-top: 1em">-s, --keycloak-server-url
KEYCLOAK_SERVER_URL <br>
Keycloak server URL (default: None)</p>

<p style="margin-top: 1em">-a, --keycloak-auth-role
root-admin|realm-admin|anonymous <br>
authenticating as what type of user (default:
root-admin)</p>

<p style="margin-top: 1em">-u, --keycloak-admin-username
KEYCLOAK_ADMIN_USERNAME <br>
admin user name (default: admin)</p>

<p style="margin-top: 1em">-p, --keycloak-admin-password
KEYCLOAK_ADMIN_PASSWORD <br>
admin password (use - to read from stdin) (default:
None)</p>

<p style="margin-top: 1em">--keycloak-admin-realm
KEYCLOAK_ADMIN_REALM <br>
realm admin belongs to (default: master)</p>

<p style="margin-top: 1em">--initial-access-token
INITIAL_ACCESS_TOKEN <br>
realm initial access token for client registeration
(default: None)</p>

<p style="margin-top: 1em">--client-originate-method
descriptor|registration <br>
select Keycloak method for creating SAML client (default:
descriptor)</p>

<p style="margin-top: 1em">Mellon SP:</p>

<p style="margin-top: 1em">--mellon-key-file
MELLON_KEY_FILE <br>
certficate key file (default: None)</p>

<p style="margin-top: 1em">--mellon-cert-file
MELLON_CERT_FILE <br>
certficate file (default: None)</p>

<p style="margin-top: 1em">--mellon-hostname
MELLON_HOSTNAME <br>
Machine&rsquo;s fully qualified host name</p>

<p style="margin-top: 1em">--mellon-https-port
MELLON_HTTPS_PORT <br>
SSL/TLS port on mellon-hostname</p>

<p style="margin-top: 1em">--mellon-root MELLON_ROOT <br>
Common root ancestor for all mellon endpoints</p>

<p style="margin-top: 1em">--mellon-endpoint
MELLON_ENDPOINT <br>
Used to form the MellonEndpointPath, e.g.
{mellon_root}/{mellon_endpoint} (default: mellon)</p>

<p style="margin-top: 1em">--mellon-entity-id
MELLON_ENTITY_ID <br>
SP SAML Entity ID (default:
{mellon_http_url}/{mellon_root}/{mellon_endpoint_path}/metadata)</p>

<p style="margin-top: 1em">--mellon-idp-attr-name
MELLON_IDP_ATTR_NAME <br>
Name of the attribute Mellon adds which will contain the IdP
entity id (default:
{mellon_http_url}/{mellon_root}/{mellon_endpoint_path}/metadata)</p>

<p style="margin-top: 1em">--mellon-organization-name
MELLON_ORGANIZATION_NAME <br>
Add SAML OrganizationName to SP metadata (default: None)</p>


<p style="margin-top: 1em">--mellon-organization-display-name
MELLON_ORGANIZATION_DISPLAY_NAME <br>
Add SAML OrganizationDisplayName to SP metadata (default:
None)</p>

<p style="margin-top: 1em">--mellon-organization-url
MELLON_ORGANIZATION_URL <br>
Add SAML OrganizationURL to SP metadata (default: None)</p>

<p style="margin-top: 1em">-l, --mellon-protected-locations
MELLON_PROTECTED_LOCATIONS <br>
Web location to protect with Mellon. May be specified
multiple times (default: [])</p>

<p style="margin-top: 1em">DESCRIPTION <br>
keycloak-httpd-client-install will configure a node running
Apache with mod_auth_mellon as SAML Service Provider (SP)
utilizing a Keycloak server as an Identity
Provider(IdP).</p>

<p style="margin-top: 1em">Authentication Levels and
Permissions</p>

<p style="margin-top: 1em">The tool is capable of range of
configuration steps. But the extent of those operations may
be circumscribed by the privilege level (authorization) the
tool is run with. The <br>
privilege level is determined by the --keycloak-auth-role
command line option which may be one of:</p>

<p style="margin-top: 1em">root-admin: The Keycloak
installation has a super realm normally called master which
is the container for all realms hosted by the Keycloak
instance. A user with administration <br>
priviliges in the master realm can perform all operations on
all realms hosted by the instance. Think of such a user as a
root user or root admin.</p>

<p style="margin-top: 1em">realm-admin: Each subordinate
realm in the Keycloak instance may have it&rsquo;s own
administrator(s) whose privileges are restricted exclusively
to that realm.</p>

<p style="margin-top: 1em">anonymous: The tool does not
authenticate as a user and hence no priviliges are granted.
Any privilege is granted by virtue of an initial access
token passed in via the -ini&acirc; <br>
tial-access-token command line option. Think of an initial
access token as a one time password scoped to a specific
realm. The initial access token must be generated by an
admin&acirc; <br>
istrator with sufficient priviliges on the realm and given
to the user of the tool. The priviliges conferred by the
initial access token are limited to registering the client
in <br>
the realm utilizing the Keycloak client registration
service.</p>

<p style="margin-top: 1em">Selecting which authencation
role will be used is determined by a combination of the
--keycloak-auth-role option and the --keycloak-admin-realm
option. When the authentication <br>
role is one of root-admin or realm-admin the tool will
authenticate as a user in a specific realm, the
--keycloak-admin-realm option declares the realm the
administrator will <br>
authenticate to. For the root-admin role this is typically
the master realm. For the realm-admin role this would be
realm the tool is registrating the client in.</p>

<p style="margin-top: 1em">Determining which authentication
role to use</p>

<p style="margin-top: 1em">In general the principle of
least privilige should apply. Grant to the tool the least
privilige necessary to perform the required action. In oder
of least privilige to greatest <br>
privilige the following operations are possible under the
defined authentication roles:</p>

<p style="margin-top: 1em">anonymous</p>

<p style="margin-top: 1em">* Can register the client using
only the Keycloak client registration service. The tool
cannot determine a prori if the client already exists in the
realm nor can it <br>
adjust any configuration options on the client.</p>

<p style="margin-top: 1em">* The realm must pre-exist.</p>

<p style="margin-top: 1em">realm-admin</p>

<p style="margin-top: 1em">* Can enumerate the existing
clients in the realm to determine if a conflict would
occur.</p>

<p style="margin-top: 1em">* Can delete a pre-existing
client and replace it with the new client definition if the
--force option is supplied.</p>

<p style="margin-top: 1em">* Can modify the clients
configuration.</p>

<p style="margin-top: 1em">* Can use either the client
registration service or the REST API to create the
client.</p>

<p style="margin-top: 1em">* The realm must pre-exist and
contain the realm admin user.</p>

<p style="margin-top: 1em">root-admin</p>

<p style="margin-top: 1em">* Includes all of the priviliged
operation conferred by the realm-admin.</p>

<p style="margin-top: 1em">* Can enumerate existing realms
on the Keycloak instance to verify the existence of the
target realm the client is to be installed in.</p>

<p style="margin-top: 1em">* Can create the target realm if
it does not exist.</p>

<p style="margin-top: 1em">Client creation methods</p>

<p style="margin-top: 1em">Keycloak offers two methods to
add a client to a realm</p>

<p style="margin-top: 1em">* The OpenID Connect client
registration service. Note even though we are registering a
SAML Service Provider (SP) which is not part of OAuth2 nor
OpenID Connect the <br>
client registration service is still capable of registering
a SAML SP client. Selected with --client-originate-method
register.</p>

<p style="margin-top: 1em">* Utilizing the Keycloak REST
API to create and configure the SAML SP client. The Keycloak
REST API utilizes a 2-step process whereby the SP metadata
is sent to the the <br>
Keycloak instance and it returns a client descriptor which
is then used to create the client. Selected with
--client-originate-method descriptor.</p>

<p style="margin-top: 1em">At the time of this writing the
client registration service behaves differently than the
REST API. Advice on which to use is likely to be dependent
upone the Keycloak version. <br>
Note, if anonymous authentication is used in conjunction
with a initial access token then the client registration
service must be used.</p>

<p style="margin-top: 1em">The client registration service
requies the use of an initial access token. For all
authentiction roles an initial access token can be provided
on the command line via the ini&acirc; <br>
tial-access-token option. The initial access token will have
to have been provided by a Keycloak administrator who
pre-creates it. If the authencation role is either
root-admin <br>
or realm-admin the tool has sufficient privilige to obtain
an initial access token on it&rsquo;s behalf negating the
need for a Keycloak admin to supply one externally.</p>

<p style="margin-top: 1em">The client registration service
may be used by the following authentication roles:</p>

<p style="margin-top: 1em">* root-admin</p>

<p style="margin-top: 1em">* realm-admin</p>

<p style="margin-top: 1em">* anonymous (requires use of
--initial-access-token)</p>

<p style="margin-top: 1em">The REST API may be used by the
following authentication roles:</p>

<p style="margin-top: 1em">* root-admin</p>

<p style="margin-top: 1em">* realm-admin</p>

<p style="margin-top: 1em">OPERATION <br>
keycloak-httpd-client-install performs the following
operational steps:</p>

<p style="margin-top: 1em">* Connect to Keycloak
Server.</p>

<p style="margin-top: 1em">A session is established with
the Keycloak server. OAuth2 is used to log in as the admin
user using the --keycloak-admin-username and
--keycloak-admin-password options. <br>
The Keycloak server is identified by the
-keycloak-server-url option. This step is performed first to
assure the remaining steps can complete successfully. A
session is <br>
maintained for efficiency reasons. You may also need to
specify --keycloak-admin-role and --keycloak-admin-realm to
indicate the privilege level you are authenticating <br>
with. An anonymous auth role connects to the Keycloak
service without any authentication.</p>

<p style="margin-top: 1em">* Create directories.</p>

<p style="margin-top: 1em">Files written by
keycloak-httpd-client-install need a destination directory
(see FILES). If the necessary directories are not present
they are created.</p>

<p style="margin-top: 1em">* Set up template
environment</p>

<p style="margin-top: 1em">Many of the files written by
keycloak-httpd-client-install are based on jinga2 templates.
The default template file location can be overridden with
the --template-dir <br>
option.</p>

<p style="margin-top: 1em">* Set up Service Provider X509
Certificiates.</p>

<p style="margin-top: 1em">A SAML SP must have a X509
certificate and key used to sign and optionally encrypt
it&rsquo;s SAML messages sent to the SAML IdP.
keycloak-httpd-client-install can generate a <br>
self-signed certificate for you or you may supply your own
key and certificate via the --mellon-key-file and
--mellon-cert-file options. The files must be in PEM
format.</p>

<p style="margin-top: 1em">* Build Mellon httpd config
file.</p>

<p style="margin-top: 1em">The Mellon HTTPD configuration
file tells mod_auth_mellon where to find things such as
certificates and metadata files as well as what web
resources to protect. It is gen&acirc; <br>
erated from the mellon_httpd.conf template file. (see
FILES). There is one mellon httpd conf file per
application.</p>

<p style="margin-top: 1em">* Build Mellon SP metadata
file.</p>

<p style="margin-top: 1em">The Mellon SP needs to be
registered with the Keycloak IdP. This forms a trust
relationship and provides infomation to the IdP about the
Mellon SP. Registering an SP with <br>
an IdP is done via a SP metadata file. The Mellon SP
metadata also instructs mod_auth_mellon how to operate. The
Mellon SP is generated from the sp_metadata.tpl template
<br>
file.</p>

<p style="margin-top: 1em">* Query realms from Keycloak
server, optionally create new realm.</p>

<p style="margin-top: 1em">Keycloak supports multi-tenancy,
it may serve many IdP&rsquo;s each one specified by a
Keycloak realm. The --keycloak-realm option identifies which
Keycloak realm we will bind <br>
to. The Keycloak realm may already exist on the Keycloak
server, if it does keycloak-httpd-client-install will use
it. If the Keycloak realm does not exist yet it will be <br>
created for you.</p>

<p style="margin-top: 1em">Requires the root-admin auth
role.</p>

<p style="margin-top: 1em">* Query realm clients from
Keycloak server, optionally delete existing.</p>

<p style="margin-top: 1em">SAML SP&rsquo;s are one type of
Keycloak client that can be serviced by the Keycloak realm
IdP. The Mellon SP is a new Keycloak client which needs to
be added to the Keycloak <br>
realm. However we must assure the new client does not
conflict with an existing client on the Keycloak realm. If
the Mellon SP is already registered on the Keycloak realm
<br>
keycloak-httpd-client-install will stop processing and exit
with an error unless the --force option is used. --force
will cause the existing client on the Keycloak realm <br>
to be deleted first so that it can be replaced in the next
step.</p>

<p style="margin-top: 1em">Requires either the root-admin
or realm-admin auth role.</p>

<p style="margin-top: 1em">* Create new SP client in
Keycloak realm.</p>

<p style="margin-top: 1em">The Mellon SP is registered with
the Keycloak realm on the Keycloak server by sending the
Keycloak server the Mellon SP metadata to the Keycloak
server.</p>

<p style="margin-top: 1em">When the client-originate-method
is descriptor either the root-admin or realm-admin auth role
is required. When the client-originate-method is
registration the initial <br>
access token is mandatory for the anonymous auth role and
optional for the root-admin or realm-admin roles.</p>

<p style="margin-top: 1em">* Adjust client
configuration</p>

<p style="margin-top: 1em">Override default Keycloak client
values. This varies by Keycloak release.</p>

<p style="margin-top: 1em">Requires either the root-admin
or realm-admin auth role.</p>

<p style="margin-top: 1em">* Add attributes to be returned
in assertion</p>

<p style="margin-top: 1em">The client is configured to
return necessary attributes. The added attributes are:</p>

<p style="margin-top: 1em">* Groups user is a member
of.</p>

<p style="margin-top: 1em">Requires either the root-admin
or realm-admin auth role.</p>

<p style="margin-top: 1em">* Retrieve IdP metadata from
Keycloak server.</p>

<p style="margin-top: 1em">The Mellon SP needs SAML
metadata that describes the Keycloak IdP. The metadata for
the Keycloak IdP is fetched from the Keycloak server and
stored in a location refer&acirc; <br>
enced in the Mellon SP httpd configuration file. (see
FILES)</p>

<p style="margin-top: 1em">STRUCTURE</p>

<p style="margin-top: 1em">The overarching organization is
the web application. An independent set of Mellon files are
created per application and registered with the Keycloak
server. This permits multiple <br>
indpendent SAML Service Providers and/or protected web
resources to be handled by one Apache instance. When you run
keycloak-httpd-client-install you must supply an application
<br>
name via the --app-name option.</p>

<p style="margin-top: 1em">Within the web application you
may protect via SAML multiple independent web resources
specified via the --mellon-protected-locations /xxx option.
This will cause a:</p>

<p style="margin-top: 1em">&lt;Location&gt; <br>
AuthType Mellon <br>
MellonEnable auth <br>
Require valid-user <br>
&lt;/Location&gt;</p>

<p style="margin-top: 1em">directive to be added to the
Mellon HTTPD configuration file. The Mellon SP parameters
are located at the root of the web application root, each
protected location inherits from <br>
that.</p>

<p style="margin-top: 1em">FILES <br>
Files created by running keycloak-httpd-client-install:</p>


<p style="margin-top: 1em">{httpd-dir}/conf.d/{app-name}_mellon_keycloak_{realm}.conf
<br>
This is the primary Mellon configuration file for the
application. It binds to the Keycloak realm IdP. It is
generated from the mellon_httpd.conf template file.</p>


<p style="margin-top: 1em">{httpd-dir}/saml2/{app-name}.cert
<br>
The Mellon SP X509 certficate file in PEM format.</p>


<p style="margin-top: 1em">{httpd-dir}/saml2/{app-name}.key
<br>
The Mellon SP X509 key file in PEM format.</p>


<p style="margin-top: 1em">{httpd-dir}/saml2/{app-name}_keycloak_{realm}_idp_metadata.xml
<br>
The Keycloak SAML2 IdP metadata file. It is fetched from the
Keycloak server.</p>


<p style="margin-top: 1em">{httpd-dir}/saml2/{app-name}_sp_metadata.xml
<br>
The Mellon SAML2 SP metadata file. It is generated from the
sp_metadata.xml template file.</p>

<p style="margin-top: 1em">Files referenced by
keycloak-httpd-client-install when it runs:</p>


<p style="margin-top: 1em">/usr/share/python-keycloak-httpd-client/templates/*
<br>
jinja2 templates</p>

<p style="margin-top: 1em">Log files:</p>


<p style="margin-top: 1em">/var/log/python-keycloak-httpd-client/keycloak-httpd-client-install.log
<br>
Installation log file</p>

<p style="margin-top: 1em">DEBUGGING</p>

<p style="margin-top: 1em">The --verbose and --debug
options can be used to increase the level of detail emitted
on the console. However, note the log file logs everything
at the DEBUG level so it is usu&acirc; <br>
ally easier to consult the log file when debugging (see
LOGGING)</p>

<p style="margin-top: 1em">LOGGING</p>

<p style="margin-top: 1em">keycloak-httpd-client-install
logs all it&rsquo;s operations to a rotated log file. The
default log file can be overridden with the --log-file
option. Each run of key&acirc; <br>
cloak-httpd-client-install will create a new log file. Any
previous log file will be rotated as a numbered verson
keeping a maximum of 3 previous log files. Logging to the
log <br>
file occurs at the DEBUG level that includes all HTTP
requests and responses, this is useful for debugging.</p>

<p style="margin-top: 1em">TEMPLATES</p>

<p style="margin-top: 1em">Many of the files generated by
keycloak-httpd-client-install are produced via jinja2
templates substituting values determined by
keycloak-httpd-client-install when it runs. The <br>
default template file location can be overridden with the
--template-dir option.</p>

<p style="margin-top: 1em">EXIT STATUS <br>
0: SUCCESS</p>

<p style="margin-top: 1em">1: OPERATION_ERROR</p>

<p style="margin-top: 1em">2: CONFIGURATION_ERROR</p>

<p style="margin-top: 1em">3: INSUFFICIENT_PRIVILEGE</p>

<p style="margin-top: 1em">4: COMMUNICATION_ERROR</p>

<p style="margin-top: 1em">5: ALREADY_EXISTS_ERROR</p>

<p style="margin-top: 1em">AUTHOR <br>
John Dennis &lt;jdennis@redhat.com&gt;</p>


<p style="margin-top: 1em">keycloak-httpd-client-install(1)</p>
<hr>
</body>
</html>
