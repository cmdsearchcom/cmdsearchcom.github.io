<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 19:11:20 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>FWKNOP(8) Fwknop Client FWKNOP(8)</p>

<p style="margin-top: 1em">NAME <br>
fwknop - Firewall Knock Operator</p>

<p style="margin-top: 1em">SYNOPSIS <br>
fwknop -A &lt;&rsquo;proto/ports&rsquo;&gt; -R|-a|-s -D
&lt;&rsquo;host&rsquo;&gt; [options]</p>

<p style="margin-top: 1em">DESCRIPTION <br>
fwknop implements an authorization scheme known as Single
Packet Authorization (SPA) for strong service concealment.
SPA requires only a single packet which is encrypted, <br>
non-replayable, and authenticated via an HMAC in order to
communicate desired access to a service that is hidden
behind a firewall in a default-drop filtering stance. The
main <br>
application of SPA is to use a firewall to drop all attempts
to connect to services such as SSH in order to make the
exploitation of vulnerabilities (both 0-day and unpatched
<br>
code) more difficult. Any service that is concealed by SPA
naturally cannot be scanned for with Nmap. The fwknop
project natively supports four different firewalls: iptables
and <br>
firewalld on Linux systems, pf on OpenBSD, and ipfw on
FreeBSD and Mac OS X.</p>

<p style="margin-top: 1em">SPA is essentially next
generation Port Knocking (PK), but solves many of the
limitations exhibited by PK while retaining its core
benefits. PK limitations include a general <br>
difficulty in protecting against replay attacks, asymmetric
ciphers and HMAC schemes are not usually possible to
reliably support, and it is trivially easy to mount a DoS
attack <br>
against a PK server just by spoofing an additional packet
into a PK sequence as it traverses the network (thereby
convincing the PK server that the client doesn&acirc;t know
the proper <br>
sequence). All of these limitation are solved by SPA. At the
same time, SPA hides services behind a default-drop firewall
policy, acquires SPA data passively (usually via libpcap
<br>
or other means), and implements standard cryptographic
operations for SPA packet authentication and
encryption/decryption.</p>

<p style="margin-top: 1em">This is the manual page for the
fwknop client which is responsible for constructing SPA
packets and sending them over the network. The server side
is implemented by the fwknopd <br>
daemon which sniffs the network for SPA packets and
interacts with the local firewall to allow SPA authenticated
connections. It is recommended to read the fwknopd(8) manual
page <br>
as well. Further detailed information may be found in the
tutorial &acirc;Single Packet Authorization: A Comprehensive
Guide to Strong Service Concealment with fwknop&acirc;
available online <br>
(see:
http://www.cipherdyne.org/fwknop/docs/fwknop-tutorial.html).</p>

<p style="margin-top: 1em">SPA packets generated by fwknop
leverage HMAC for authenticated encryption in the
encrypt-then-authenticate model. Although the usage of an
HMAC is currently optional (enabled <br>
via the --use-hmac command line switch), it is highly
recommended for three reasons: 1) without an HMAC,
cryptographically strong authentication is not possible with
fwknop <br>
unless GnuPG is used, but even then an HMAC should still be
applied, 2) an HMAC applied after encryption protects
against cryptanalytic CBC-mode padding oracle attacks such
as <br>
the Vaudenay attack and related trickery (like the more
recent &quot;Lucky 13&quot; attack against SSL), and 3) the
code required by the fwknopd daemon to verify an HMAC is
much more <br>
simplistic than the code required to decrypt an SPA packet,
so an SPA packet without a proper HMAC isn&acirc;t even sent
through the decryption routines. Reason 3) is why an HMAC
<br>
should still be used even when SPA packets are encrypted
with GnuPG due to the fact that SPA data is not sent through
libgpgme functions unless the HMAC checks out first. GnuPG
<br>
and libgpgme are relatively complex bodies of code, and
therefore limiting the ability of a potential attacker to
interact with this code through an HMAC operation helps to
<br>
maintain a stronger security stance. Generating an HMAC for
SPA communications requires a dedicated key in addition to
the normal encryption key, and both can be generated with
<br>
the --key-gen option.</p>

<p style="margin-top: 1em">fwknop encrypts SPA packets
either with the Rijndael block cipher or via GnuPG and
associated asymmetric cipher. If the symmetric encryption
method is chosen, then as usual the <br>
encryption key is shared between the client and server (see
the fwknopd /etc/fwknop/access.conf file for details). The
actual encryption key used for Rijndael encryption is <br>
generated via the standard PBKDF1 key derivation algorithm,
and CBC mode is set. If the GnuPG method is chosen, then the
encryption keys are derived from GnuPG key rings. SPA <br>
packets generated by fwknop running as a client adhere to
the following format (before encryption and the HMAC is
applied):</p>

<p style="margin-top: 1em">random data (16 digits) <br>
username <br>
timestamp <br>
software version <br>
mode (command mode (0) or access mode (1)) <br>
if command mode =&gt; command to execute <br>
else access mode =&gt; IP,proto,port <br>
message digest (SHA512 / SHA384 / SHA256 / SHA1 / MD5 /
SHA3_256 / SHA3_512)</p>

<p style="margin-top: 1em">Each of the above fields are
separated by a &quot;:&quot; character due to the variable
length of several of the fields, and those that might
contain &quot;:&quot; characters are base64 encoded. The
<br>
message digest (SHA256 by default) is part of the data to be
encrypted and is independent of the HMAC which is appended
to the SPA packet data after encryption. The 16 digits of
<br>
random data (about 53 bits) ensures that no two SPA packets
are identical, and this is in addition to and independent of
using PBKDF1 for key derivation for Rijndael in CBC mode
<br>
(which uses an 8-byte random &quot;salt&quot; value).
Because fwknopd tracks the SHA256 digest of all incoming
valid SPA packets and throws out duplicates, replay attacks
are not feasible <br>
against fwknop. Syslog alerts are generated if a replay is
detected.</p>

<p style="margin-top: 1em">By default, the fwknop client
sends authorization packets over UDP port 62201, but this
can be altered with the --server-port argument (this
requires fwknopd to be configured to <br>
acquire SPA data over the selected port). Also, fwknop can
send the SPA packet over a random port via the --rand-port
argument. See fwknopd(8) for further details. See the <br>
EXAMPLES section for example invocations of the fwknop
client.</p>

<p style="margin-top: 1em">The fwknop client is quite
portable, and is known to run on various Linux distributions
(all major distros and embedded ones such as OpenWRT as
well), FreeBSD, OpenBSD, and <br>
Cygwin on Windows. There is also a library libfko that both
fwknop and fwknopd use for SPA packet encryption/decryption
and HMAC authentication operations. This library can be <br>
used to allow third party applications to use SPA subject to
the terms of the GNU General Public License (GPL v2+).</p>

<p style="margin-top: 1em">REQUIRED ARGUMENTS <br>
These required arguments can be specified via command-line
or from within the ~/.fwknoprc file (see -n, --named-config
option and the FWKNOPRC FILE section below).</p>

<p style="margin-top: 1em">-A, --access=&lt;port list&gt;
<br>
Provide a list of ports and protocols to access on a remote
computer running fwknopd. The format of this list is
&acirc;+&lt;proto&gt;/&lt;port&gt;...&lt;proto&gt;/&lt;port&gt;+&acirc;,
e.g. &acirc;tcp/22,udp/53&acirc;. <br>
NOTE: The vast majority of usages for fwknop require the -A
argument, but sending full commands with the --server-cmd
argument via an SPA packet to be executed by fwknopd <br>
does not require this argument.</p>

<p style="margin-top: 1em">-D,
--destination=&lt;hostname/IP-address&gt; <br>
Direct the fwknop client to authenticate with the fwknopd
daemon/service at the specified destination hostname or IP
address. The connection mode is discovered by the fwknopd
<br>
daemon/service when it decrypts and parses the
authentication packet.</p>

<p style="margin-top: 1em">-R|-a|-s <br>
One of these options (see below) is required to tell the
remote fwknopd daemon what IP should be allowed through the
firewall. It is recommend to use the -R or -a options <br>
instead of -s in order to harden SPA communications against
possible Man-In-The-Middle (MITM) attacks, and on the server
side set REQUIRE_SOURCE_ADDRESS variable in the <br>
/etc/fwknop/access.conf file. Note that the most secure
option is -a so that fwknop does not have to issue any HTTPS
request to https://www.cipherdyne.org/cgi-bin/myip in <br>
order to resolve the externally routable IP address. Using
-a requires that the user already knows what the external IP
is for the network where fwknop is running.</p>

<p style="margin-top: 1em">GENERAL OPTIONS <br>
-h, --help <br>
Print a usage summary message and exit.</p>

<p style="margin-top: 1em">-G, --get-key=&lt;file&gt; <br>
Load an encryption key/password from the specified file. The
key file contains a line for each destination hostname or IP
address, a colon (&quot;:&quot;), optional space and the
<br>
password, followed by a newline. Note that the last line has
to have a terminating newline character. Also note: though
this is a convenience, having a file on your system <br>
with clear text passwords is not a good idea and is not
recommended. Having the fwknop client prompt you for the key
is generally more secure. Note also that if a key is <br>
stored on disk, the fwknop rc file is a more powerful
mechanism for specifying not only the key but other options
as well.</p>

<p style="margin-top: 1em">--stdin <br>
Read the encryption key/password from stdin. This can be
used to send the data via a pipe for example. This command
is similar to --fd 0.</p>

<p style="margin-top: 1em">--fd=&lt;number&gt; <br>
Specify the file descriptor number to read the key/password
from. This command avoids the user being prompted for a
password if none has been found in the user specific <br>
stanza, or none has been supplied on the command line. A
file descriptor set to 0 is similar to the stdin
command.</p>

<p style="margin-top: 1em">--get-hmac-key=&lt;file&gt; <br>
Load an HMAC key/password from the specified file. Similarly
to the format for the --get-key option, the HMAC key file
contains a line for each destination hostname or IP <br>
address, a colon (&quot;:&quot;), optional space and the
password, followed by a newline. Note that the last line has
to have a terminating newline character. Also note: though
this is <br>
a convenience, having a file on your system with clear text
passwords is not a good idea and is not recommended. Having
the fwknop client prompt you for the HMAC key is <br>
generally more secure. Note also that if a key is stored on
disk, the fwknop rc file is a more powerful mechanism for
specifying not only the HMAC key but other options as <br>
well.</p>

<p style="margin-top: 1em">--key-gen <br>
Have fwknop generate both Rijndael and HMAC keys that can be
used for SPA packet encryption and authentication. These
keys are derived from /dev/urandom and then base64 <br>
encoded before being printed to stdout, and are meant to be
included within the &acirc;$HOME/.fwknoprc&acirc; file (or
the file referenced by --get-key). Such keys are generally
more <br>
secure than passphrases that are typed in from the command
line.</p>

<p style="margin-top: 1em">--key-gen-file=&lt;file&gt; <br>
Write generated keys to the specified file. Note that the
file is overwritten if it already exists. If this option is
not given, then --key-gen writes the keys to stdout.</p>

<p style="margin-top: 1em">--key-len=&lt;length&gt; <br>
Specify the number of bytes for a generated Rijndael key.
The maximum size is currently 128 bytes.</p>

<p style="margin-top: 1em">--hmac-key-len=&lt;length&gt;
<br>
Specify the number of bytes for a generated HMAC key. The
maximum size is currently 128 bytes.</p>

<p style="margin-top: 1em">-l, --last-cmd <br>
Execute fwknop with the command-line arguments from the
previous invocation (if any). The previous arguments are
parsed out of the ~/.fwknop.run file.</p>

<p style="margin-top: 1em">-n, --named-config=&lt;stanza
name&gt; <br>
Specify the name of the configuration stanza in the
&acirc;$HOME/.fwknoprc&acirc; file to pull configuration and
command directives. These named stanzas alleviate the need
for <br>
remembering the various command-line arguments for
frequently used invocations of fwknop. See the section
labeled, FWKNOPRC FILE below for a list of the valid
configuration <br>
directives in the .fwknoprc file.</p>

<p style="margin-top: 1em">--key-rijndael=&lt;key&gt; <br>
Specify the Rijndael key on the command line. Since the key
may be visible to utilities such as ps under Unix, this form
should only be used where security is not critical. <br>
Having the fwknop client either prompt you for the key or
acquire via the &acirc;$HOME/.fwknoprc&acirc; file is
generally more secure.</p>


<p style="margin-top: 1em">--key-base64-rijndael=&lt;key&gt;
<br>
Specify the base64 encoded Rijndael key. Since the key may
be visible to utilities such as ps under Unix, this form
should only be used where security is not critical. Having
<br>
the fwknop client either prompt you for the key or acquire
via the &acirc;$HOME/.fwknoprc&acirc; file is generally more
secure.</p>

<p style="margin-top: 1em">--key-base64-hmac=&lt;key&gt;
<br>
Specify the base64 encoded HMAC key. Since the key may be
visible to utilities such as ps under Unix, this form should
only be used where security is not critical. Having the <br>
fwknop client either prompt you for the key or acquire via
the &acirc;$HOME/.fwknoprc&acirc; file is generally more
secure.</p>

<p style="margin-top: 1em">--key-hmac=&lt;key&gt; <br>
Specify the raw HMAC key (not base64 encoded). Since the key
may be visible to utilities such as ps under Unix, this form
should only be used where security is not critical. <br>
Having the fwknop client either prompt you for the key or
acquire via the &acirc;$HOME/.fwknoprc&acirc; file is
generally more secure.</p>

<p style="margin-top: 1em">--rc-file=&lt;file&gt; <br>
Specify path to the fwknop rc file (default is
&acirc;$HOME/.fwknoprc&acirc;).</p>

<p style="margin-top: 1em">--no-rc-file <br>
Perform fwknop client operations without referencing the
&acirc;$HOME/.fwknoprc&acirc; file.</p>

<p style="margin-top: 1em">--no-home-dir <br>
Do not allow the fwknop client to look for the home
directory associated with the user.</p>

<p style="margin-top: 1em">--save-rc-stanza=&lt;stanza
name&gt; <br>
Save command line arguments to the
&acirc;$HOME/.fwknoprc&acirc; stanza specified with the -n
option. If the -n option is omitted, then the stanza name
will default to the destination <br>
server value (hostname or IP) given with the -D
argument.</p>

<p style="margin-top: 1em">--force-stanza <br>
Used with --save-rc-stanza to overwrite all of the variables
for the specified stanza</p>

<p style="margin-top: 1em">--stanza-list <br>
Dump a list of the stanzas found in
&acirc;$HOME/.fwknoprc&acirc;.</p>

<p style="margin-top: 1em">--show-last <br>
Display the last command-line arguments used by fwknop.</p>

<p style="margin-top: 1em">-E,
--save-args-file=&lt;file&gt; <br>
Save command line arguments to a specified file path.
Without this option, and when --no-save-args is not also
specified, then the default save args path is
~/.fwknop.run.</p>

<p style="margin-top: 1em">--no-save-args <br>
Do not save the command line arguments given when fwknop is
executed.</p>

<p style="margin-top: 1em">-T, --test <br>
Test mode. Generate the SPA packet data, but do not send it.
Instead, print a break-down of the SPA data fields, then run
the data through the decryption and decoding process <br>
and print the break-down again. This is primarily a
debugging feature.</p>

<p style="margin-top: 1em">-B, --save-packet=&lt;file&gt;
<br>
Instruct the fwknop client to write a newly created SPA
packet out to the specified file so that it can be examined
off-line.</p>

<p style="margin-top: 1em">-b, --save-packet-append <br>
Append the generated packet data to the file specified with
the -B option.</p>


<p style="margin-top: 1em">--fault-injection-tag=&lt;tag&gt;
<br>
This option is only used for fault injection testing when
fwknop is compiled to support the libfiu library (see:
http://blitiri.com.ar/p/libfiu/). Under normal circumstances
<br>
this option is not used, and any packaged version of fwknop
will not have code compiled in so this capability is not
enabled at run time. It is documented here for <br>
completeness.</p>

<p style="margin-top: 1em">-v, --verbose <br>
Run the fwknop client in verbose mode. This causes fwknop to
print some extra information about the current command and
the resulting SPA data.</p>

<p style="margin-top: 1em">-V, --version <br>
Display version information and exit.</p>

<p style="margin-top: 1em">SPA OPTIONS <br>
--use-hmac <br>
Set HMAC mode for authenticated encryption of SPA
communications. As of fwknop 2.5, this is an optional
feature, but this will become the default in a future
release.</p>

<p style="margin-top: 1em">-a,
--allow-ip=&lt;IP-address&gt; <br>
Specify IP address that should be permitted through the
destination fwknopd server firewall (this IP is encrypted
within the SPA packet itself). This is useful to prevent a
<br>
MITM attack where a SPA packet can be intercepted en-route
and sent from a different IP than the original. Hence, if
the fwknopd server trusts the source address on the SPA <br>
packet IP header then the attacker gains access. The -a
option puts the source address within the encrypted SPA
packet, and so thwarts this attack. The -a option is also
<br>
useful to specify the IP that will be granted access when
the SPA packet itself is spoofed with the --spoof-src
option. Another related option is -R (see below) which <br>
instructs the fwknop client to automatically resolve the
externally routable IP address the local system is connected
to by querying https://www.cipherdyne.org/cgi-bin/myip. <br>
This returns the actual IP address it sees from the calling
system.</p>

<p style="margin-top: 1em">-g, --gpg-encryption <br>
Use GPG encryption on the SPA packet (default if not
specified is Rijndael). Note: Use of this option will also
require a GPG recipient (see --gpg-recipient along with
other <br>
GPG-related options below).</p>


<p style="margin-top: 1em">--hmac-digest-type=&lt;digest&gt;
<br>
Set the HMAC digest algorithm for authenticated encryption
of SPA packets. Choices are: MD5, SHA1, SHA256 (the
default), SHA384, SHA512, SHA3_256, and SHA3_512.</p>

<p style="margin-top: 1em">-N,
--nat-access=&lt;internalIP:forwardPort&gt; <br>
The fwknopd server offers the ability to provide SPA access
through an iptables firewall to an internal service by
interfacing with the iptables NAT capabilities. So, if the
<br>
fwknopd server is protecting an internal network on an
RFC-1918 address space, an external fwknop client can
request that the server port forward an external port to an
<br>
internal IP, i.e. &acirc;+--NAT-access
192.168.10.2,55000+&acirc;. In this case, access will be
granted to 192.168.10.2 via port 55000 to whatever service
is requested via the --access <br>
argument (usually tcp/22). Hence, after sending such an SPA
packet, one would then do &acirc;ssh -p 55000
user@host&acirc; and the connection would be forwarded on
through to the <br>
internal 192.168.10.2 system automatically. Note that the
port &acirc;55000&acirc; can be randomly generated via the
--nat-rand-port argument (described later).</p>

<p style="margin-top: 1em">--nat-local <br>
On the fwknopd server, a NAT operation can apply to the
local system instead of being forwarded through the system.
That is, for iptables firewalls, a connection to, say, <br>
port 55,000 can be translated to port 22 on the local
system. By making use of the --nat-local argument, the
fwknop client can be made to request such access. This means
that <br>
any external attacker would only see a connection over port
55,000 instead of the expected port 22 after the SPA packet
is sent.</p>

<p style="margin-top: 1em">--nat-port <br>
Usually fwknop is used to request access to a specific port
such as tcp/22 on a system running fwknopd. However, by
using the --nat-port argument, it is possible to request
<br>
access to a (again, such as tcp/22), but have this access
granted via the specified port (so, the -p argument would
then be used on the SSH client command line). See the <br>
--nat-local and --nat-access command line arguments to
fwknop for additional details on gaining access to services
via a NAT operation.</p>

<p style="margin-top: 1em">--nat-rand-port <br>
Usually fwknop is used to request access to a specific port
such as tcp/22 on a system running fwknopd. However, by
using the --nat-rand-port argument, it is possible to <br>
request access to a particular service (again, such as
tcp/22), but have this access granted via a random
translated port. That is, once the fwknop client has been
executed <br>
in this mode and the random port selected by fwknop is
displayed, the destination port used by the follow-on client
must be changed to match this random port. For SSH, this
<br>
is accomplished via the -p argument. See the --nat-local and
--nat-access command line arguments to fwknop for additional
details on gaining access to services via a NAT <br>
operation.</p>

<p style="margin-top: 1em">-p, --server-port=&lt;port&gt;
<br>
Specify the port number where fwknopd accepts packets via
libpcap or ulogd pcap writer. By default fwknopd looks for
authorization packets over UDP port 62201.</p>

<p style="margin-top: 1em">-P,
--server-proto=&lt;protocol&gt; <br>
Set the protocol (udp, tcp, http, udpraw, tcpraw, or icmp)
for the outgoing SPA packet. Note: The udpraw, tcpraw, and
icmp modes use raw sockets and thus require root access <br>
to run. Also note: The tcp mode expects to establish a TCP
connection to the server before sending the SPA packet. This
is not normally done, but is useful for compatibility <br>
with the Tor for strong anonymity; see http://tor.eff.org/.
In this case, the fwknopd server will need to be configured
to listen on the target TCP port (which is 62201 by <br>
default).</p>

<p style="margin-top: 1em">-Q, --spoof-src=&lt;IP&gt; <br>
Spoof the source address from which the fwknop client sends
SPA packets. This requires root on the client side access
since a raw socket is required to accomplish this. Note <br>
that the --spoof-user argument can be given in this mode in
order to pass any REQUIRE_USERNAME keyword that might be
specified in /etc/fwknop/access.conf.</p>

<p style="margin-top: 1em">-r, --rand-port <br>
Instruct the fwknop client to send an SPA packet over a
random destination port between 10,000 and 65535. The
fwknopd server must use a PCAP_FILTER variable that is <br>
configured to accept such packets. For example, the
PCAP_FILTER variable could be set to: &acirc;+udp dst
portrange 10000-65535+&acirc;.</p>

<p style="margin-top: 1em">-R, --resolve-ip-https <br>
This is an important option, and instructs the fwknop client
to issue an HTTPS request to a script running on
cipherdyne.org that returns the client&acirc;s IP address
(as seen by <br>
the web server). In some cases, this is needed to determine
the IP address that should be allowed through the firewall
policy at the remote fwknopd server side. This option <br>
is useful if the fwknop client is being used on a system
that is behind an obscure NAT address, and the external
Internet facing IP is not known to the user. The full <br>
resolution URL is: https://www.cipherdyne.org/cgi-bin/myip,
and is accessed by fwknop via wget in --secure-protocol
mode. Note that it is generally more secure to use the -a
<br>
option if the externally routable IP address for the client
is already known to the user since this eliminates the need
for fwknop to issue any sort of HTTPS request.</p>

<p style="margin-top: 1em">--resolve-url &lt;url&gt; <br>
Override the default URL used for resolving the source IP
address. For best results, the URL specified here should
point to a web service that provides just an IP address in
<br>
the body of the HTTP response.</p>

<p style="margin-top: 1em">--resolve-http-only <br>
This option forces the fwknop client to resolve the external
IP via HTTP instead of HTTPS. There are some circumstances
where this might be necessary such as when wget is not <br>
available (or hasn&acirc;t been compiled with SSL support),
but generally this is not recommended since it opens the
possibility of a MITM attack through manipulation of the IP
<br>
resolution HTTP response. Either specify the IP manually
with -a, or use -R and omit this option.</p>

<p style="margin-top: 1em">-w, --wget-cmd=&lt;wget full
path&gt; <br>
Manually set the full path to the wget command. Normally the
configure script finds the wget command, but this option can
be used to specify the path if it is located in a <br>
non-standard place.</p>

<p style="margin-top: 1em">-s, --source-ip <br>
Instruct the fwknop client to form an SPA packet that
contains the special-case IP address &acirc;+0.0.0.0+&acirc;
which will inform the destination fwknopd SPA server to use
the source <br>
IP address from which the SPA packet originates as the IP
that will be allowed through upon modification of the
firewall ruleset. This option is useful if the fwknop client
<br>
is deployed on a machine that is behind a NAT device and the
external IP is not known. However, usage of this option is
not recommended, and either the -a or -R options <br>
should be used instead. The permit-address options -s, -R
and -a are mutually exclusive.</p>

<p style="margin-top: 1em">-S, --source-port=&lt;port&gt;
<br>
Set the source port for outgoing SPA packet.</p>

<p style="margin-top: 1em">--server-resolve-ipv4 <br>
This option forces the fwknop client to only accept an IPv4
address from DNS when a hostname is used for the SPA server.
This is necessary in some cases where DNS may return <br>
both IPv6 and IPv4 addresses.</p>

<p style="margin-top: 1em">-f, --fw-timeout=&lt;seconds&gt;
<br>
Specify the length of time (seconds) that the remote
firewall rule that grants access to a service is to remain
active. The default maintained by fwknopd is 30 seconds, but
<br>
any established connection can be kept open after the
initial accept rule is deleted through the use of a
connection tracking mechanism that may be offered by the
firewall.</p>

<p style="margin-top: 1em">-C, --server-cmd=&lt;command to
execute&gt; <br>
Instead of requesting access to a service with an SPA
packet, the --server-cmd argument specifies a command that
will be executed by the fwknopd server. The command is <br>
encrypted within the SPA packet and sniffed off the wire (as
usual) by the fwknopd server.</p>

<p style="margin-top: 1em">-H,
--http-proxy=&lt;proxy-host&gt;[:port] <br>
Specify an HTTP proxy that the fwknop client will use to
send the SPA packet through. Using this option will
automatically set the SPA packet transmission mode (usually
set <br>
via the --server-proto argument) to &quot;http&quot;. You
can also specify the proxy port by adding
&quot;:&lt;port&gt;&quot; to the proxy host name or ip.</p>

<p style="margin-top: 1em">-m, --digest-type=&lt;digest&gt;
<br>
Specify the message digest algorithm to use in the SPA data.
Choices are: MD5, SHA1, SHA256 (the default), SHA384, and
SHA512, SHA3_256, and SHA3_512.</p>

<p style="margin-top: 1em">-M,
--encryption-mode=&lt;mode&gt; <br>
Specify the encryption mode when AES is used for encrypting
SPA packets. The default is CBC mode, but others can be
chosen such as CFB or OFB as long as this is also <br>
specified in the /etc/fwknop/access.conf file on the server
side via the ENCRYPTION_MODE variable. In general, it is
recommended to not include this argument and let the <br>
default (CBC) apply. Note that the string
&acirc;legacy&acirc; can be specified in order to generate
SPA packets with the old initialization vector strategy used
by versions of fwknop <br>
prior to 2.5. With the 2.5 release, fwknop generates
initialization vectors in a manner that is compatible with
OpenSSL via the PBKDF1 algorithm.</p>

<p style="margin-top: 1em">--time-offset-plus=&lt;time&gt;
<br>
By default, the fwknopd daemon on the server side enforces
time synchronization between the clocks running on client
and server systems. The fwknop client places the local <br>
time within each SPA packet as a time stamp to be validated
by the fwknopd server after decryption. However, in some
circumstances, if the clocks are out of sync and the user
<br>
on the client system does not have the required access to
change the local clock setting, it can be difficult to
construct and SPA packet with a time stamp the server will
<br>
accept. In this situation, the --time-offset-plus option can
allow the user to specify an offset (e.g.
&acirc;60sec&acirc; &acirc;60min&acirc; &acirc;2days&acirc;
etc.) that is added to the local time.</p>


<p style="margin-top: 1em">--time-offset-minus=&lt;time&gt;
<br>
This is similar to the --time-offset-plus option (see
above), but subtracts the specified time offset instead of
adding it to the local time stamp.</p>

<p style="margin-top: 1em">-u,
--user-agent=&lt;user-agent-string&gt; <br>
Set the HTTP User-Agent for resolving the external IP via
-R, or for sending SPA packets over HTTP.</p>

<p style="margin-top: 1em">--use-wget-user-agent <br>
By default when the fwknop client resolves the external IP
with wget via SSL, it sets the User-Agent to
&acirc;Fwknop/&lt;version&gt;&acirc; unless it was already
manually specified with the <br>
--user-agent option mentioned above. However, the
--user-wget-user-agent option lets the default wget
User-Agent string apply without influence from fwknop.</p>

<p style="margin-top: 1em">-U, --spoof-user=&lt;user&gt;
<br>
Specify the username that is included within SPA packet.
This allows the fwknop client to satisfy any non-root
REQUIRE_USERNAME keyword on the fwknopd server (--spoof-src
<br>
mode requires that the fwknop client is executed as
root).</p>

<p style="margin-top: 1em">--icmp-type=&lt;type&gt; <br>
In -P icmp mode, specify the ICMP type value that will be
set in the SPA packet ICMP header. The default is echo
reply.</p>

<p style="margin-top: 1em">--icmp-code=&lt;code&gt; <br>
In -P icmp mode, specify the ICMP code value that will be
set in the SPA packet ICMP header. The default is zero.</p>

<p style="margin-top: 1em">GPG OPTIONS <br>
Note that the usage of GPG for SPA encryption/decryption can
and should involve GPG keys that are signed by each side
(client and server). The basic procedure for this involves
<br>
the following steps after the client key has been
transferred to the server and vice-versa:</p>

<p style="margin-top: 1em">[spaserver]# gpg --import
client.asc <br>
[spaserver]# gpg --edit-key 1234ABCD <br>
Command&gt; sign</p>

<p style="margin-top: 1em">[spaclient]$ gpg --import
server.asc <br>
[spaclient]$ gpg --edit-key ABCD1234 <br>
Command&gt; sign</p>

<p style="margin-top: 1em">More comprehensive information
on this can be found here:
http://www.cipherdyne.org/fwknop/docs/gpghowto.html.</p>

<p style="margin-top: 1em">--gpg-agent <br>
Instruct fwknop to acquire GnuPG key password from a running
gpg-agent instance (if available).</p>

<p style="margin-top: 1em">--gpg-home-dir=&lt;dir&gt; <br>
Specify the path to the GnuPG directory; normally this path
is derived from the home directory of the user that is
running the fwknop client (so the default is ~/.gnupg). <br>
This is useful when a &acirc;root&acirc; user wishes to log
into a remote machine whose sshd daemon/service does not
permit root login.</p>

<p style="margin-top: 1em">--gpg-recipient=&lt;key ID or
Name&gt; <br>
Specify the GnuPG key ID, e.g. &acirc;+1234ABCD+&acirc; (see
the output of &quot;gpg&acirc;list-keys&quot;) or the key
name (associated email address) of the recipient of the
Single Packet Authorization <br>
message. This key is imported by the fwknopd server and the
associated private key is used to decrypt the SPA packet.
The recipient&acirc;s key must first be imported into the
<br>
client GnuPG key ring.</p>

<p style="margin-top: 1em">--gpg-signer-key=&lt;key ID or
Name&gt; <br>
Specify the GnuPG key ID, e.g. &acirc;+ABCD1234+&acirc; (see
the output of &quot;gpg --list-keys&quot;) or the key name
to use when signing the SPA message. The user is prompted
for the associated <br>
GnuPG password to create the signature. This adds a
cryptographically strong mechanism to allow the fwknopd
daemon on the remote server to authenticate who created the
SPA <br>
message.</p>

<p style="margin-top: 1em">--gpg-no-signing-pw <br>
Instruct fwknop to not acquire a passphrase for usage of
GnuPG signing key. This option is provided to make SPA
packet construction easier for client-side operations in
<br>
automated environments where the passphrase for the signing
key has been removed from the GnuPG key ring. However, it is
usually better to leverage gpg-agent instead of using <br>
this option.</p>

<p style="margin-top: 1em">FWKNOPRC FILE <br>
The .fwknoprc file is used to set various parameters to
override default program parameters at runtime. It also
allows for additional named configuration stanzas for
setting <br>
program parameters for a particular invocation.</p>

<p style="margin-top: 1em">The fwknop client will create
this file if it does not exist in the user&acirc;s home
directory. This initial version has some sample directives
that are commented out. It is up to the <br>
user to edit this file to meet their needs.</p>

<p style="margin-top: 1em">The .fwknoprc file contains a
default configuration area or stanza which holds global
configuration directives that override the program defaults.
You can edit this file and <br>
create additional named stanzas that can be specified with
the -n or --named-config option. Parameters defined in the
named stanzas will override any matching default stanza <br>
directives. Note that command-line options will still
override any corresponding .fwknoprc directives.</p>

<p style="margin-top: 1em">There are directives to match
most of the command-line parameters fwknop supports. Here is
the current list of each directive along with a brief
description and its matching <br>
command-line option(s):</p>

<p style="margin-top: 1em">SPA_SERVER
&lt;hostname/IP-address&gt; <br>
Specify the hostname or IP of the destination (fwknopd)
server (-D, --destination).</p>

<p style="margin-top: 1em">ALLOW_IP &lt;IP-address&gt; <br>
Specify the address to allow within the SPA data. Note: This
parameter covers the -a, -s, and -R command-line options.
You can specify a hostname or IP address (the -a <br>
option), specify the word &quot;source&quot; to tell the
fwknopd server to accept the source IP of the packet as the
IP to allow (the -s option), or use the word
&quot;resolve&quot; to have <br>
fwknop resolve the external network IP via HTTP request (the
-R option).</p>

<p style="margin-top: 1em">ACCESS &lt;port list&gt; <br>
Set the one or more protocol/ports to open on the firewall
(-A, --access). The format of this list is
&acirc;+&lt;proto&gt;/&lt;port&gt;...&lt;proto&gt;/&lt;port&gt;+&acirc;,
e.g. &acirc;tcp/22,udp/53&acirc;.</p>

<p style="margin-top: 1em">SPA_SERVER_PORT &lt;port&gt;
<br>
Set the server port to use for sending the SPA packet (-p,
--server-port).</p>

<p style="margin-top: 1em">SPA_SERVER_PROTO
&lt;protocol&gt; <br>
Set the protocol to use for sending the SPA packet (-P,
--server-proto).</p>

<p style="margin-top: 1em">KEY &lt;passphrase&gt; <br>
This is the passphrase that is used for SPA packet
encryption and applies to both Rijndael or GPG encryption
modes. The actual encryption key that is used for Rijndael
is <br>
derived from the PBKDF1 algorithm, and the GPG key is
derived from the specified GPG key ring.</p>

<p style="margin-top: 1em">KEY_BASE64 &lt;base64 encoded
passphrase&gt; <br>
Specify the encryption passphrase as a base64 encoded
string. This allows non-ascii characters to be included in
the base64-decoded key.</p>

<p style="margin-top: 1em">USE_HMAC &lt;Y/N&gt; <br>
Set HMAC mode for authenticated encryption of SPA packets.
This will have fwknop prompt the user for a dedicated HMAC
key that is independent of the encryption key. <br>
Alternatively, the HMAC key can be specified with the
HMAC_KEY or HMAC_KEY_BASE64 directives (see below).</p>

<p style="margin-top: 1em">HMAC_KEY &lt;key&gt; <br>
Specify the HMAC key for authenticated encryption of SPA
packets. This supports both Rijndael and GPG encryption
modes, and is applied according to the <br>
encrypt-then-authenticate model.</p>

<p style="margin-top: 1em">HMAC_KEY_BASE64 &lt;base64
encoded key&gt; <br>
Specify the HMAC key as a base64 encoded string. This allows
non-ascii characters to be included in the base64-decoded
key.</p>

<p style="margin-top: 1em">HMAC_DIGEST_TYPE &lt;digest
algorithm&gt; <br>
Set the HMAC digest algorithm used for authenticated
encryption of SPA packets. Choices are: MD5, SHA1, SHA256
(the default), SHA384, SHA512, SHA3_256, and SHA3_512.</p>

<p style="margin-top: 1em">SPA_SOURCE_PORT &lt;port&gt;
<br>
Set the source port to use for sending the SPA packet (-S,
--source-port).</p>

<p style="margin-top: 1em">FW_TIMEOUT &lt;seconds&gt; <br>
Set the firewall rule timeout value (-f, --fw-timeout).</p>

<p style="margin-top: 1em">RESOLVE_IP_HTTPS &lt;Y/N&gt;
<br>
Set to Y to automatically resolve the externally routable IP
associated with the fwknop client. This is done over SSL via
wget in --secure-protocol mode against the IP <br>
resolution service available at
https://www.cipherdyne.org/cgi-bin/myip.</p>

<p style="margin-top: 1em">RESOLVE_HTTP_ONLY &lt;Y/N&gt;
<br>
When the fwknop client is instructed to resolve the external
client IP, this option can be used to force an HTTP
connection instead of an HTTPS connection when set to Y.
This <br>
option is useful when wget is not installed on the local OS,
or when it is not compiled against an SSL library.</p>

<p style="margin-top: 1em">RESOLVE_URL &lt;url&gt; <br>
Set to a URL that will be used for resolving the source IP
address (--resolve-url).</p>

<p style="margin-top: 1em">WGET_CMD &lt;wget full path&gt;
<br>
Set the full path to the wget command (used for client IP
resolution).</p>

<p style="margin-top: 1em">TIME_OFFSET &lt;time&gt; <br>
Set a value to apply to the timestamp in the SPA packet.
This can be either a positive or negative value
(--time-offset-plus/minus).</p>

<p style="margin-top: 1em">ENCRYPTION_MODE &lt;mode&gt;
<br>
Specify the encryption mode when AES is used. This variable
is a synonym for the -M, --encryption-mode command line
argument. In general, it is recommended to not include <br>
this argument and let the default (CBC) apply. Note that the
string &acirc;legacy&acirc; can be specified in order to
generate SPA packets with the old initialization vector
strategy <br>
used by versions of fwknop prior to 2.5.</p>

<p style="margin-top: 1em">DIGEST_TYPE &lt;digest
algorithm&gt; <br>
Set the SPA message digest type (-m, --digest-type). Choices
are: MD5, SHA1, SHA256 (the default), SHA384, SHA512,
SHA3_256, and SHA3_512.</p>

<p style="margin-top: 1em">USE_GPG &lt;Y/N&gt; <br>
Set to Y to specify the use of GPG for encryption
(--gpg-encryption).</p>

<p style="margin-top: 1em">USE_GPG_AGENT &lt;Y/N&gt; <br>
Set to Y to have fwknop interface with a GPG agent instance
for the GPG key password (--gpg-agent). Agent information
itself is specified with the GPG_AGENT_INFO <br>
environmental variable.</p>

<p style="margin-top: 1em">GPG_SIGNING_PW
&lt;passphrase&gt; <br>
This is the passphrase that is used for signing SPA packet
data in GPG encryption mode, and is a synonym for the KEY
variable (i.e. the signing passphrase can be specified <br>
with the KEY variable instead). The SPA packet is encrypted
with the remote server key and signed with the local client
key.</p>

<p style="margin-top: 1em">GPG_SIGNING_PW_BASE64 &lt;base64
encoded passphrase&gt; <br>
Specify the GPG signing passphrase as a base64 encoded
string. This allows non-ascii characters to be included in
the base64-decoded key.</p>

<p style="margin-top: 1em">GPG_SIGNER &lt;key ID or
Name&gt; <br>
Specify the GPG key name or ID for signing the GPG-encrypted
SPA data (--gpg-signer-key).</p>

<p style="margin-top: 1em">GPG_RECIPIENT &lt;key ID or
Name&gt; <br>
Specify the GPG key name or ID for the recipient of the
GPG-encrypted SPA data (--gpg-recipient-key).</p>

<p style="margin-top: 1em">GPG_HOMEDIR &lt;dir&gt; <br>
Specify the GPG home directory (--gpg-home-dir). Defaults to
~/.gnupg.</p>

<p style="margin-top: 1em">GPG_EXE &lt;path&gt; <br>
Specify the path to GPG (--gpg-exe). Defaults to
/usr/bin/gpg.</p>

<p style="margin-top: 1em">SPOOF_USER &lt;user&gt; <br>
Set the username in the SPA data to the specified value (-U,
--spoof-user).</p>

<p style="margin-top: 1em">SPOOF_SOURCE_IP &lt;IP&gt; <br>
Set the source IP of the outgoing SPA packet to the
specified value (-Q, --spoof-source).</p>

<p style="margin-top: 1em">RAND_PORT &lt;Y/N&gt; <br>
Send the SPA packet over a randomly assigned port (-r,
--rand-port).</p>

<p style="margin-top: 1em">KEY_FILE &lt;file&gt; <br>
Load an encryption key/password from a file (-G,
--get-key).</p>

<p style="margin-top: 1em">HTTP_USER_AGENT &lt;agent
string&gt; <br>
Set the HTTP User-Agent for resolving the external IP via
-R, or for sending SPA packets over HTTP (-u,
--user-agent).</p>

<p style="margin-top: 1em">USE_WGET_USER_AGENT &lt;Y/N&gt;
<br>
Allow default wget User-Agent string to be used when
resolving the external IP instead of a User-Agent supplied
by the fwknop client.</p>

<p style="margin-top: 1em">NAT_ACCESS
&lt;internalIP:forwardPort&gt; <br>
Gain NAT access to an internal service protected by the
fwknop server (-N, --nat-access).</p>

<p style="margin-top: 1em">NAT_LOCAL &lt;Y/N&gt; <br>
Access a local service via a forwarded port on the fwknopd
server system (--nat-local).</p>

<p style="margin-top: 1em">NAT_PORT &lt;port&gt; <br>
Specify the port to forward to access a service via NAT
(--nat-port).</p>

<p style="margin-top: 1em">NAT_RAND_PORT &lt;Y/N&gt; <br>
Have the fwknop client assign a random port for NAT access
(--nat-rand-port).</p>

<p style="margin-top: 1em">ENVIRONMENT <br>
SPOOF_USER, GPG_AGENT_INFO (only used in --gpg-agent
mode).</p>

<p style="margin-top: 1em">SPA PACKET SPOOFING <br>
Because fwknop places the IP to be allowed through the
firewall within the encrypted SPA payload (unless -s is used
which is not recommended and can be prohibited in the
fwknopd <br>
server configuration), SPA packets can easily be spoofed,
and this is a good thing in this context. That is, the
source IP of an SPA packet is ignored by the fwknopd daemon
(when <br>
the REQUIRE_SOURCE_ADDRESS variable is set in the
/etc/fwknop/access.conf file) and only the IP that is
contained within an authenticated and properly decrypted SPA
packet is <br>
granted access through the firewall. This makes it possible
to make it appear as though, say, www.yahoo.com is trying to
authenticate to a target system but in reality the actual
<br>
connection will come from a seemingly unrelated IP.</p>

<p style="margin-top: 1em">EXAMPLES <br>
The following examples illustrate the command line arguments
that could be supplied to the fwknop client in a few
situations:</p>

<p style="margin-top: 1em">Quick start <br>
The most effective and easiest way to use fwknop is to have
the client generate both an encryption key and an HMAC key,
and then save them to the &acirc;$HOME/.fwknoprc&acirc; file
along <br>
with access request specifics. The keys will also need to be
transferred to the system where fwknopd is running. The also
client supports a separate set of encryption and HMAC <br>
keys for each SPA destination if multiple fwknopd servers
are running on different systems.</p>

<p style="margin-top: 1em">So, assuming that the IP 2.2.2.2
is the system where fwknopd is deployed and SSH is protected
by the firewall on that system in a default-drop stance, run
the client like so to <br>
generate encryption and HMAC keys:</p>

<p style="margin-top: 1em">$ fwknop -A tcp/22 --use-hmac -R
-D 2.2.2.2 --key-gen --save-rc-stanza --verbose <br>
[+] Wrote Rijndael and HMAC keys to rc file:
/home/user/.fwknoprc</p>

<p style="margin-top: 1em">With the access request
arguments and encryption and HMAC keys generated and saved
in &acirc;$HOME/.fwknoprc&acirc;, the keys themselves need
to be transferred to the 2.2.2.2 system where <br>
fwknopd is running. As always, this should be done via some
secure means such as SSH before SPA is enabled and SSHD is
blocked by the firewall. Here is what the new 2.2.2.2 <br>
stanza looks like in the ~/.fwknoprc file:</p>

<p style="margin-top: 1em">$ tail -n 8 /home/user/.fwknoprc
<br>
[2.2.2.2] <br>
ACCESS tcp/22 <br>
SPA_SERVER 2.2.2.2 <br>
KEY_BASE64 HvUtIOramehLGKimD4ECXOzinaH4h3U8H1WXum7b54Q= <br>
HMAC_KEY_BASE64
DLeLf93a3yBT2vhEpM+dWlirGta5GU+jdyG5uXp4461HgOtbqMem4gX0Bp2PJGzYZlbbcavcOM00UPm+0GqkXA==
<br>
USE_HMAC Y <br>
VERBOSE Y <br>
RESOLVE_IP_HTTPS Y</p>

<p style="margin-top: 1em">The keys are base64 encoded
blobs of random data, and both the KEY_BASE64 and
HMAC_KEY_BASE64 lines should be copied verbatim and placed
within the /etc/fwknop/access.conf file <br>
on 2.2.2.2. Once this is done, fwknopd can be started on
that system, a default-drop policy against SSH connections
can be put in place, and then access to SSH is managed via
<br>
fwknop. To access SSH, just use the -n argument to reference
the 2.2.2.2 stanza out of the .fwknoprc file (some --verbose
output is included for illustration):</p>

<p style="margin-top: 1em">$ fwknop -n 2.2.2.2</p>

<p style="margin-top: 1em">FKO Field Values: <br>
=================</p>

<p style="margin-top: 1em">Random Value: 8950423288486978
<br>
Username: mbr <br>
Timestamp: 1370194770 <br>
FKO Version: 2.5 <br>
Message Type: 1 (Access msg) <br>
Message String: 1.1.1.1,tcp/22 <br>
Nat Access: &lt;NULL&gt; <br>
Server Auth: &lt;NULL&gt; <br>
Client Timeout: 0 (seconds) <br>
Digest Type: 3 (SHA256) <br>
HMAC Type: 3 (SHA256) <br>
Encryption Type: 1 (Rijndael) <br>
Encryption Mode: 2 (CBC) <br>
...</p>

<p style="margin-top: 1em">$ ssh -l user 2.2.2.2 <br>
user@2.2.2.2&rsquo;s password:</p>

<p style="margin-top: 1em">Access mode examples <br>
The most common usage of fwknop is to gain access to SSH
running on a remote system that has the fwknopd daemon
deployed along with a default-drop firewall policy. The
following <br>
command illustrates this where IP 1.1.1.1 is the IP to be
allowed through the firewall running on 3.3.3.3 (note that
the /etc/fwknop/access.conf file consumed by fwknopd will
<br>
need to have matching encryption and HMAC keys, and
configuration specifics can be found in the fwknopd(8)
manual page). Also, note the examples below prompt the user
to supply <br>
the encryption and HMAC keys via stdin instead of writing
them to disk as in the case of using the
&acirc;$HOME/.fwknoprc&acirc; file in the example above.
However, all of the following <br>
examples can be converted to using the ~/.fwknoprc file just
by adding the --save-rc-stanza argument:</p>

<p style="margin-top: 1em">$ fwknop -A tcp/22 --use-hmac -a
1.1.1.1 -D 3.3.3.3 <br>
Enter encryption key: <br>
Enter HMAC key: <br>
$ ssh -l user 3.3.3.3 <br>
user@3.3.3.3&rsquo;s password:</p>

<p style="margin-top: 1em">If the --verbose flag is added
to the command line, then some SPA packet specifics are
printed to stdout (not all output is shown for brevity):</p>

<p style="margin-top: 1em">$ fwknop -A tcp/22 --use-hmac -a
1.1.1.1 -D 3.3.3.3 --verbose <br>
Enter encryption key: <br>
Enter HMAC key:</p>

<p style="margin-top: 1em">Random Value: 1916307060193417
<br>
Username: mbr <br>
Timestamp: 1368498909 <br>
FKO Version: 2.5 <br>
Message Type: 1 (Access msg) <br>
Message String: 1.1.1.1,tcp/22 <br>
Nat Access: &lt;NULL&gt; <br>
Server Auth: &lt;NULL&gt; <br>
Client Timeout: 0 (seconds) <br>
Digest Type: 3 (SHA256) <br>
HMAC Type: 3 (SHA256) <br>
Encryption Type: 1 (Rijndael) <br>
Encryption Mode: 2 (CBC)</p>

<p style="margin-top: 1em">Simultaneous access to multiple
services is also supported, and here is an example of
requesting access to both SSH and OpenVPN on 3.3.3.3:</p>

<p style="margin-top: 1em">$ fwknop -A
&quot;tcp/22,tcp/1194&quot; --use-hmac -a 1.1.1.1 -D
3.3.3.3</p>

<p style="margin-top: 1em">There are many cases where an
fwknop client is deployed on a network behind a NAT device
and the externally routable IP is not known to the user. In
this case, use the IP <br>
resolution service available at
https://www.cipherdyne.org/cgi-bin/myip via the -R command
line switch in order to derive the external client IP
address. This is a safer method <br>
of acquiring the client IP address than using the -s option
mentioned earlier in this manual page because the source IP
is put within the encrypted packet instead of having the
<br>
fwknopd daemon grant the requested access from whatever IP
address the SPA packet originates (i.e. using -s opens the
possibility of a MITM attack):</p>

<p style="margin-top: 1em">$ fwknop -A tcp/22 --use-hmac -R
-D 3.3.3.3</p>

<p style="margin-top: 1em">Use the Single Packet
Authorization mode to gain access to SSH and this time use
GnuPG keys to encrypt and decrypt:</p>

<p style="margin-top: 1em">$ fwknop -A tcp/22 --use-hmac
--gpg-sign ABCD1234 --gpg--recipient 1234ABCD -R -D
3.3.3.3</p>

<p style="margin-top: 1em">Instruct the fwknop server
running at 3.3.3.3 to allow 1.1.1.1 to connect to SSH, but
spoof the authorization packet from an IP associated with
www.yahoo.com (requires root on <br>
the fwknop client OS):</p>

<p style="margin-top: 1em"># fwknop --spoof-src
&quot;www.yahoo.com&quot; -A tcp/22 --use-hmac -a 1.1.1.1 -D
3.3.3.3</p>

<p style="margin-top: 1em">When fwknopd is running on an
iptables firewall with systems deployed behind it, it is
possible to take advantage of the NAT capabilities offered
by iptables in order to <br>
transparently reach systems behind the firewall via SPA.
Here is an example where the fwknop client is used to gain
access to SSH running on the non-routable IP 192.168.10.23
<br>
that is deployed on the network behind 3.3.3.3. In this
case, the SSH connection made to 3.3.3.3 is translated via
NAT to the 192.168.10.2 system automatically:</p>

<p style="margin-top: 1em">$ fwknop -A tcp/22 -N
192.168.10.2:22 -R -D 3.3.3.3</p>

<p style="margin-top: 1em">BACKWARDS COMPATIBILITY <br>
With the 2.5 release, fwknop underwent significant changes
in its usage of cryptography including the addition of
support for HMAC authenticated encryption for both Rijndael
and <br>
GnuPG modes, ensuring the proper usage of PBKDF1 for key
derivation when SPA packets are encrypted with Rijndael, and
several bugs were fixed from previous versions of fwknop. In
<br>
general, this implies that when Rijndael is used, SPA
packets produced by the 2.5 release are incompatible with
previous versions of fwknop. The GnuPG encryption mode is
<br>
unaffected by these updates. However, even with Rijndael is
used, backwards compatibility is supported through setting
the legacy encryption mode with -M on the fwknop client <br>
command line and/or the ENCRYPTION_MODE variable in the
/etc/fwknop/access.conf file. This way, a pre-2.5 server can
decrypt SPA packets produced by a 2.5 and later client (set
<br>
-M legacy), and a 2.5 and later server can decrypt SPA
packets produced by pre-2.5 clients (set ENCRYPTION_MODE
legacy in the access.conf file). Note that HMAC is only
supported <br>
as of 2.5 and is an optional feature, so backwards
compatibility is only for configurations that don&acirc;t
use an HMAC on either side. It is strongly recommended to
upgrade all <br>
fwknop clients and servers to 2.5 and use the new HMAC mode
for properly authenticated SPA communications. The backwards
compatibility support is used to make it easier to <br>
upgrade clients and servers with a phased approach.</p>

<p style="margin-top: 1em">For emphasis, if the fwknopd
server is upgraded to 2.5 (or later), but older clients
cannot be upgraded at the same time, then for each SOURCE
stanza in the <br>
/etc/fwknop/access.conf file, add the following line:</p>

<p style="margin-top: 1em">ENCRYPTION_MODE legacy</p>

<p style="margin-top: 1em">In addition, if the KEY variable
has an encryption key longer than 16 bytes, it will need to
be truncated to 16 characters in the access.conf file in
order for pre-2.5 clients to <br>
work properly. This limitation is fixed in 2.5, and provides
additional motivation for upgrading all clients and servers
to 2.5 or later.</p>

<p style="margin-top: 1em">Now, flipping the scenario
around, if the fwknop clients are upgraded but the fwknopd
server is still at a pre-2.5 version, then add the -M legacy
argument to the fwknop command <br>
line:</p>

<p style="margin-top: 1em">$ fwknop -A tcp/22 -M legacy -R
-D 2.2.2.2</p>

<p style="margin-top: 1em">DEPENDENCIES <br>
The fwknop client requires libfko which is normally included
with both source and binary distributions, and is a
dedicated library developed by the fwknop project. Whenever
the <br>
fwknopd server is used, libpcap is a required dependency.
However, the upcoming 2.6 release will offer a UDP listener
mode along with privilege separation support and will not
<br>
require libpcap in this mode. In UDP listener mode, even
though fwknopd binds to a UDP port, SPA packets are never
acknowledged so from an attacker&acirc;s perspective there
is no <br>
difference between fwknopd sniffing the wire passively vs.
listening on a UDP socket in terms of what can be scanned
for.</p>

<p style="margin-top: 1em">For GPG functionality, GnuPG
must also be correctly installed and configured along with
the libgpgme library.</p>

<p style="margin-top: 1em">To take advantage of all of the
authentication and access management features of the fwknopd
daemon/service a functioning iptables, ipfw, or pf firewall
is required on the <br>
underlying operating system.</p>

<p style="margin-top: 1em">DIAGNOSTICS <br>
The most comprehensive way to gain diagnostic information on
fwknop is to run the test suite test-fwknop.pl script
located in the test/ directory in the fwknop sources. The
test <br>
suite sends fwknop through a large number of run time tests,
has valgrind support, validates both SPA encryption and HMAC
results against OpenSSL, and even has its own built in <br>
fuzzer for SPA communications (and fwknop in version 2.6.4
supports the American Fuzzy Lop (AFL) from Michal Zalewski
as well). For more basic diagnostic information, fwknop can
<br>
be executed with the -T (or --test) command line option.
This will have fwknop simply create and print the SPA packet
information, then run it through a decrypt/decode cycle and
<br>
print it again. In addition, the --verbose command line
switch is useful to see various SPA packet specifics printed
to stdout.</p>

<p style="margin-top: 1em">SEE ALSO <br>
fwknopd(8), iptables(8), pf(4), pfctl(8), ipfw(8), gpg(1),
libfko documentation.</p>

<p style="margin-top: 1em">More information on Single
Packet Authorization can be found in the paper &acirc;Single
Packet Authorization with fwknop&acirc; available at
http://www.cipherdyne.org/fwknop/docs/SPA.html. A <br>
comprehensive tutorial on fwknop operations and theory can
be found at
http://www.cipherdyne.org/fwknop/docs/fwknop-tutorial.html.
This tutorial also includes information about <br>
the design of fwknop that may be worth reading for those
interested in why fwknop is different from other SPA
implementations.</p>

<p style="margin-top: 1em">fwknop uses the git versioning
system as its source code repository along with Github for
tracking of issues and milestones:</p>

<p style="margin-top: 1em">$ git clone
https://github.com/mrash/fwknop.git fwknop.git</p>

<p style="margin-top: 1em">Additional commentary on Single
Packet Authorization can be found via Michael Rash&acirc;s
Twitter feed: http://twitter.com/michaelrash,
@michaelrash</p>

<p style="margin-top: 1em">AUTHORS <br>
The primary developers of fwknop are Michael Rash (project
creator) &lt;mbr@cipherdyne.org&gt;, Damien Stuart
&lt;dstuart@dstuart.org&gt;, and Jonathan Bennett
&lt;jbennett@incomsystems.biz&gt;.</p>

<p style="margin-top: 1em">CONTRIBUTORS <br>
This &acirc;C&acirc; version of fwknop was derived from the
original Perl-based version on which many people who are
active in the open source community have contributed. See
the CREDITS <br>
file in the fwknop sources, or visit
https://github.com/mrash/fwknop/blob/master/CREDITS to view
the online list of contributors. A few contributors deserve
to be singled out <br>
including: Franck Joncourt, Max Kastanas, Vlad Glagolev,
Sean Greven, Hank Leininger, Fernando Arnaboldi, and Erik
Gomez.</p>

<p style="margin-top: 1em">The phrase &acirc;Single Packet
Authorization&acirc; was coined by MadHat and Simple Nomad
at the BlackHat Briefings of 2005.</p>

<p style="margin-top: 1em">BUGS <br>
Send bug reports to dstuart@dstuart.org or
mbr@cipherdyne.org, or open a new issue on Github (see
https://github.com/mrash/fwknop.git). Suggestions and/or
comments are always <br>
welcome as well. Additional information may be found in the
fwknop mailing list archives (see:
https://lists.sourceforge.net/lists/listinfo/fwknop-discuss).</p>

<p style="margin-top: 1em">DISTRIBUTION <br>
fwknop is distributed under the GNU General Public License
(GPL v2+), and the latest version may be downloaded from
http://www.cipherdyne.org.</p>

<p style="margin-top: 1em">Fwknop Client 06/08/2016
FWKNOP(8)</p>
<hr>
</body>
</html>
