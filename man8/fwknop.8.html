<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
  </style>
  <title>FWKNOP(8)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">FWKNOP(8)</td>
    <td class="head-vol">Fwknop Client</td>
    <td class="head-rtitle">FWKNOP(8)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="selflink" href="#NAME">NAME</a></h1>
fwknop - Firewall Knock Operator
<h1 class="Sh" title="Sh" id="SYNOPSIS"><a class="selflink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<b>fwknop</b> <b>-A</b> &lt;'proto/ports'&gt; <b>-R</b>|<b>-a</b>|<b>-s -D</b>
  &lt;'host'&gt; [ <i>options</i>]
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="selflink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<b>fwknop</b> implements an authorization scheme known as Single Packet
  Authorization (SPA) for strong service concealment. SPA requires only a single
  packet which is encrypted, non-replayable, and authenticated via an HMAC in
  order to communicate desired access to a service that is hidden behind a
  firewall in a default-drop filtering stance. The main application of SPA is to
  use a firewall to drop all attempts to connect to services such as <i>SSH</i>
  in order to make the exploitation of vulnerabilities (both 0-day and unpatched
  code) more difficult. Any service that is concealed by SPA naturally cannot be
  scanned for with <i>Nmap</i>. The fwknop project natively supports four
  different firewalls: <i>iptables</i> and <i>firewalld</i> on Linux systems,
  <i>pf</i> on OpenBSD, and <i>ipfw</i> on FreeBSD and Mac OS X.
<div style="height: 1.00em;">&#x00A0;</div>
SPA is essentially next generation Port Knocking (PK), but solves many of the
  limitations exhibited by PK while retaining its core benefits. PK limitations
  include a general difficulty in protecting against replay attacks, asymmetric
  ciphers and HMAC schemes are not usually possible to reliably support, and it
  is trivially easy to mount a DoS attack against a PK server just by spoofing
  an additional packet into a PK sequence as it traverses the network (thereby
  convincing the PK server that the client doesn&#x2019;t know the proper
  sequence). All of these limitation are solved by SPA. At the same time, SPA
  hides services behind a default-drop firewall policy, acquires SPA data
  passively (usually via libpcap or other means), and implements standard
  cryptographic operations for SPA packet authentication and
  encryption/decryption.
<div style="height: 1.00em;">&#x00A0;</div>
This is the manual page for the <b>fwknop</b> client which is responsible for
  constructing SPA packets and sending them over the network. The server side is
  implemented by the <b>fwknopd</b> daemon which sniffs the network for SPA
  packets and interacts with the local firewall to allow SPA authenticated
  connections. It is recommended to read the <i>fwknopd(8)</i> manual page as
  well. Further detailed information may be found in the tutorial &#x201C;Single
  Packet Authorization: A Comprehensive Guide to Strong Service Concealment with
  fwknop&#x201D; available online (see:
  <i>http://www.cipherdyne.org/fwknop/docs/fwknop-tutorial.html</i>).
<div style="height: 1.00em;">&#x00A0;</div>
SPA packets generated by <b>fwknop</b> leverage HMAC for authenticated
  encryption in the encrypt-then-authenticate model. Although the usage of an
  HMAC is currently optional (enabled via the <b>--use-hmac</b> command line
  switch), it is highly recommended for three reasons: <i>1)</i> without an
  HMAC, cryptographically strong authentication is not possible with
  <b>fwknop</b> unless GnuPG is used, but even then an HMAC should still be
  applied, <i>2)</i> an HMAC applied after encryption protects against
  cryptanalytic CBC-mode padding oracle attacks such as the Vaudenay attack and
  related trickery (like the more recent &quot;Lucky 13&quot; attack against
  SSL), and <i>3)</i> the code required by the <b>fwknopd</b> daemon to verify
  an HMAC is much more simplistic than the code required to decrypt an SPA
  packet, so an SPA packet without a proper HMAC isn&#x2019;t even sent through
  the decryption routines. Reason <i>3)</i> is why an HMAC should still be used
  even when SPA packets are encrypted with GnuPG due to the fact that SPA data
  is not sent through <b>libgpgme</b> functions unless the HMAC checks out
  first. GnuPG and libgpgme are relatively complex bodies of code, and therefore
  limiting the ability of a potential attacker to interact with this code
  through an HMAC operation helps to maintain a stronger security stance.
  Generating an HMAC for SPA communications requires a dedicated key in addition
  to the normal encryption key, and both can be generated with the
  <b>--key-gen</b> option.
<div style="height: 1.00em;">&#x00A0;</div>
<b>fwknop</b> encrypts SPA packets either with the <i>Rijndael</i> block cipher
  or via <i>GnuPG</i> and associated asymmetric cipher. If the symmetric
  encryption method is chosen, then as usual the encryption key is shared
  between the client and server (see the <b>fwknopd</b>
  <i>/etc/fwknop/access.conf</i> file for details). The actual encryption key
  used for Rijndael encryption is generated via the standard PBKDF1 key
  derivation algorithm, and CBC mode is set. If the GnuPG method is chosen, then
  the encryption keys are derived from GnuPG key rings. SPA packets generated by
  fwknop running as a client adhere to the following format (before encryption
  and the HMAC is applied):
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    random data (16 digits)
    username
    timestamp
    software version
    mode (command mode (0) or access mode (1))
    if command mode =&gt; command to execute
    else access mode  =&gt; IP,proto,port
    message digest (SHA512 / SHA384 / SHA256 / SHA1 / MD5 / SHA3_256 / SHA3_512)
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
Each of the above fields are separated by a &quot;:&quot; character due to the
  variable length of several of the fields, and those that might contain
  &quot;:&quot; characters are base64 encoded. The message digest (
  <b>SHA256</b> by default) is part of the data to be encrypted and is
  independent of the HMAC which is appended to the SPA packet data after
  encryption. The 16 digits of random data (about 53 bits) ensures that no two
  SPA packets are identical, and this is in addition to and independent of using
  PBKDF1 for key derivation for Rijndael in CBC mode (which uses an 8-byte
  random &quot;salt&quot; value). Because <b>fwknopd</b> tracks the SHA256
  digest of all incoming valid SPA packets and throws out duplicates, replay
  attacks are not feasible against <b>fwknop</b>. Syslog alerts are generated if
  a replay is detected.
<div style="height: 1.00em;">&#x00A0;</div>
By default, the <b>fwknop</b> client sends authorization packets over UDP port
  62201, but this can be altered with the <b>--server-port</b> argument (this
  requires <b>fwknopd</b> to be configured to acquire SPA data over the selected
  port). Also, <b>fwknop</b> can send the SPA packet over a random port via the
  <b>--rand-port</b> argument. See <i>fwknopd(8)</i> for further details. See
  the <b>EXAMPLES</b> section for example invocations of the <b>fwknop</b>
  client.
<div style="height: 1.00em;">&#x00A0;</div>
The <b>fwknop</b> client is quite portable, and is known to run on various Linux
  distributions (all major distros and embedded ones such as OpenWRT as well),
  FreeBSD, OpenBSD, and Cygwin on Windows. There is also a library <b>libfko</b>
  that both <b>fwknop</b> and <b>fwknopd</b> use for SPA packet
  encryption/decryption and HMAC authentication operations. This library can be
  used to allow third party applications to use SPA subject to the terms of the
  GNU General Public License (GPL v2+).
<h1 class="Sh" title="Sh" id="REQUIRED_ARGUMENTS"><a class="selflink" href="#REQUIRED_ARGUMENTS">REQUIRED
  ARGUMENTS</a></h1>
These required arguments can be specified via command-line or from within the
  <i>~/.fwknoprc</i> file (see <i>-n, --named-config</i> option and the FWKNOPRC
  FILE section below).
<div class="Pp"></div>
<b>-A, --access</b>=<i>&lt;port list&gt;</i>
<div style="margin-left: 4.00ex;">Provide a list of ports and protocols to
  access on a remote computer running <b>fwknopd</b>. The format of this list is
  &#x201C;+&lt;proto&gt;/&lt;port&gt;...&lt;proto&gt;/&lt;port&gt;+&#x201D;,
  e.g. &#x201C;tcp/22,udp/53&#x201D;. <b>NOTE:</b> The vast majority of usages
  for <b>fwknop</b> require the <b>-A</b> argument, but sending full commands
  with the <b>--server-cmd</b> argument via an SPA packet to be executed by
  <b>fwknopd</b> does not require this argument.</div>
<div class="Pp"></div>
<b>-D, --destination</b>=<i>&lt;hostname/IP-address&gt;</i>
<div style="margin-left: 4.00ex;">Direct the <b>fwknop</b> client to
  authenticate with the <b>fwknopd</b> daemon/service at the specified
  destination hostname or IP address. The connection mode is discovered by the
  <b>fwknopd</b> daemon/service when it decrypts and parses the authentication
  packet.</div>
<div class="Pp"></div>
<b>-R|-a|-s</b>
<div style="margin-left: 4.00ex;">One of these options (see below) is required
  to tell the remote <b>fwknopd</b> daemon what IP should be allowed through the
  firewall. It is recommend to use the <b>-R</b> or <b>-a</b> options instead of
  <b>-s</b> in order to harden SPA communications against possible
  <i>Man-In-The-Middle</i> (MITM) attacks, and on the server side set
  <i>REQUIRE_SOURCE_ADDRESS</i> variable in the <i>/etc/fwknop/access.conf</i>
  file. Note that the most secure option is <b>-a</b> so that <b>fwknop</b> does
  not have to issue any HTTPS request to
  <i>https://www.cipherdyne.org/cgi-bin/myip</i> in order to resolve the
  externally routable IP address. Using <b>-a</b> requires that the user already
  knows what the external IP is for the network where fwknop is running.</div>
<h1 class="Sh" title="Sh" id="GENERAL_OPTIONS"><a class="selflink" href="#GENERAL_OPTIONS">GENERAL
  OPTIONS</a></h1>
<b>-h, --help</b>
<div style="margin-left: 4.00ex;">Print a usage summary message and exit.</div>
<div class="Pp"></div>
<b>-G, --get-key</b>=<i>&lt;file&gt;</i>
<div style="margin-left: 4.00ex;">Load an encryption key/password from the
  specified file. The key file contains a line for each destination hostname or
  IP address, a colon (&quot;:&quot;), optional space and the password, followed
  by a newline. Note that the last line has to have a terminating newline
  character. Also note: though this is a convenience, having a file on your
  system with clear text passwords is not a good idea and is not recommended.
  Having the <b>fwknop</b> client prompt you for the key is generally more
  secure. Note also that if a key is stored on disk, the <b>fwknop</b> rc file
  is a more powerful mechanism for specifying not only the key but other options
  as well.</div>
<div class="Pp"></div>
<b>--stdin</b>
<div style="margin-left: 4.00ex;">Read the encryption key/password from stdin.
  This can be used to send the data via a pipe for example. This command is
  similar to --fd 0.</div>
<div class="Pp"></div>
<b>--fd</b>=<i>&lt;number&gt;</i>
<div style="margin-left: 4.00ex;">Specify the file descriptor number to read the
  key/password from. This command avoids the user being prompted for a password
  if none has been found in the user specific stanza, or none has been supplied
  on the command line. A file descriptor set to 0 is similar to the stdin
  command.</div>
<div class="Pp"></div>
<b>--get-hmac-key</b>=<i>&lt;file&gt;</i>
<div style="margin-left: 4.00ex;">Load an HMAC key/password from the specified
  file. Similarly to the format for the <b>--get-key</b> option, the HMAC key
  file contains a line for each destination hostname or IP address, a colon
  (&quot;:&quot;), optional space and the password, followed by a newline. Note
  that the last line has to have a terminating newline character. Also note:
  though this is a convenience, having a file on your system with clear text
  passwords is not a good idea and is not recommended. Having the <b>fwknop</b>
  client prompt you for the HMAC key is generally more secure. Note also that if
  a key is stored on disk, the <b>fwknop</b> rc file is a more powerful
  mechanism for specifying not only the HMAC key but other options as
  well.</div>
<div class="Pp"></div>
<b>--key-gen</b>
<div style="margin-left: 4.00ex;">Have <b>fwknop</b> generate both Rijndael and
  HMAC keys that can be used for SPA packet encryption and authentication. These
  keys are derived from /dev/urandom and then base64 encoded before being
  printed to stdout, and are meant to be included within the
  &#x201C;$HOME/.fwknoprc&#x201D; file (or the file referenced by
  <b>--get-key</b>). Such keys are generally more secure than passphrases that
  are typed in from the command line.</div>
<div class="Pp"></div>
<b>--key-gen-file</b>=<i>&lt;file&gt;</i>
<div style="margin-left: 4.00ex;">Write generated keys to the specified file.
  Note that the file is overwritten if it already exists. If this option is not
  given, then <b>--key-gen</b> writes the keys to stdout.</div>
<div class="Pp"></div>
<b>--key-len</b>=<i>&lt;length&gt;</i>
<div style="margin-left: 4.00ex;">Specify the number of bytes for a generated
  Rijndael key. The maximum size is currently 128 bytes.</div>
<div class="Pp"></div>
<b>--hmac-key-len</b>=<i>&lt;length&gt;</i>
<div style="margin-left: 4.00ex;">Specify the number of bytes for a generated
  HMAC key. The maximum size is currently 128 bytes.</div>
<div class="Pp"></div>
<b>-l, --last-cmd</b>
<div style="margin-left: 4.00ex;">Execute <b>fwknop</b> with the command-line
  arguments from the previous invocation (if any). The previous arguments are
  parsed out of the <i>~/.fwknop.run</i> file.</div>
<div class="Pp"></div>
<b>-n, --named-config</b>=<i>&lt;stanza name&gt;</i>
<div style="margin-left: 4.00ex;">Specify the name of the configuration stanza
  in the &#x201C;$HOME/.fwknoprc&#x201D; file to pull configuration and command
  directives. These named stanzas alleviate the need for remembering the various
  command-line arguments for frequently used invocations of <b>fwknop</b>. See
  the section labeled, FWKNOPRC FILE below for a list of the valid configuration
  directives in the <i>.fwknoprc</i> file.</div>
<div class="Pp"></div>
<b>--key-rijndael</b>=<i>&lt;key&gt;</i>
<div style="margin-left: 4.00ex;">Specify the Rijndael key on the command line.
  Since the key may be visible to utilities such as <i>ps</i> under Unix, this
  form should only be used where security is not critical. Having the
  <b>fwknop</b> client either prompt you for the key or acquire via the
  &#x201C;$HOME/.fwknoprc&#x201D; file is generally more secure.</div>
<div class="Pp"></div>
<b>--key-base64-rijndael</b>=<i>&lt;key&gt;</i>
<div style="margin-left: 4.00ex;">Specify the base64 encoded Rijndael key. Since
  the key may be visible to utilities such as <i>ps</i> under Unix, this form
  should only be used where security is not critical. Having the <b>fwknop</b>
  client either prompt you for the key or acquire via the
  &#x201C;$HOME/.fwknoprc&#x201D; file is generally more secure.</div>
<div class="Pp"></div>
<b>--key-base64-hmac</b>=<i>&lt;key&gt;</i>
<div style="margin-left: 4.00ex;">Specify the base64 encoded HMAC key. Since the
  key may be visible to utilities such as <i>ps</i> under Unix, this form should
  only be used where security is not critical. Having the <b>fwknop</b> client
  either prompt you for the key or acquire via the
  &#x201C;$HOME/.fwknoprc&#x201D; file is generally more secure.</div>
<div class="Pp"></div>
<b>--key-hmac</b>=<i>&lt;key&gt;</i>
<div style="margin-left: 4.00ex;">Specify the raw HMAC key (not base64 encoded).
  Since the key may be visible to utilities such as <i>ps</i> under Unix, this
  form should only be used where security is not critical. Having the
  <b>fwknop</b> client either prompt you for the key or acquire via the
  &#x201C;$HOME/.fwknoprc&#x201D; file is generally more secure.</div>
<div class="Pp"></div>
<b>--rc-file</b>=<i>&lt;file&gt;</i>
<div style="margin-left: 4.00ex;">Specify path to the <b>fwknop</b> rc file
  (default is &#x201C;$HOME/.fwknoprc&#x201D;).</div>
<div class="Pp"></div>
<b>--no-rc-file</b>
<div style="margin-left: 4.00ex;">Perform <b>fwknop</b> client operations
  without referencing the &#x201C;$HOME/.fwknoprc&#x201D; file.</div>
<div class="Pp"></div>
<b>--no-home-dir</b>
<div style="margin-left: 4.00ex;">Do not allow the <b>fwknop</b> client to look
  for the home directory associated with the user.</div>
<div class="Pp"></div>
<b>--save-rc-stanza</b>=<i>&lt;stanza name&gt;</i>
<div style="margin-left: 4.00ex;">Save command line arguments to the
  &#x201C;$HOME/.fwknoprc&#x201D; stanza specified with the <b>-n</b> option. If
  the <b>-n</b> option is omitted, then the stanza name will default to the
  destination server value (hostname or IP) given with the <b>-D</b>
  argument.</div>
<div class="Pp"></div>
<b>--force-stanza</b>
<div style="margin-left: 4.00ex;">Used with <b>--save-rc-stanza</b> to overwrite
  all of the variables for the specified stanza</div>
<div class="Pp"></div>
<b>--stanza-list</b>
<div style="margin-left: 4.00ex;">Dump a list of the stanzas found in
  &#x201C;$HOME/.fwknoprc&#x201D;.</div>
<div class="Pp"></div>
<b>--show-last</b>
<div style="margin-left: 4.00ex;">Display the last command-line arguments used
  by <b>fwknop</b>.</div>
<div class="Pp"></div>
<b>-E, --save-args-file</b>=<i>&lt;file&gt;</i>
<div style="margin-left: 4.00ex;">Save command line arguments to a specified
  file path. Without this option, and when <b>--no-save-args</b> is not also
  specified, then the default save args path is <i>~/.fwknop.run</i>.</div>
<div class="Pp"></div>
<b>--no-save-args</b>
<div style="margin-left: 4.00ex;">Do not save the command line arguments given
  when <b>fwknop</b> is executed.</div>
<div class="Pp"></div>
<b>-T, --test</b>
<div style="margin-left: 4.00ex;">Test mode. Generate the SPA packet data, but
  do not send it. Instead, print a break-down of the SPA data fields, then run
  the data through the decryption and decoding process and print the break-down
  again. This is primarily a debugging feature.</div>
<div class="Pp"></div>
<b>-B, --save-packet</b>=<i>&lt;file&gt;</i>
<div style="margin-left: 4.00ex;">Instruct the <b>fwknop</b> client to write a
  newly created SPA packet out to the specified file so that it can be examined
  off-line.</div>
<div class="Pp"></div>
<b>-b, --save-packet-append</b>
<div style="margin-left: 4.00ex;">Append the generated packet data to the file
  specified with the <b>-B</b> option.</div>
<div class="Pp"></div>
<b>--fault-injection-tag</b>=<i>&lt;tag&gt;</i>
<div style="margin-left: 4.00ex;">This option is only used for fault injection
  testing when <b>fwknop</b> is compiled to support the libfiu library (see:
  <i>http://blitiri.com.ar/p/libfiu/</i>). Under normal circumstances this
  option is not used, and any packaged version of fwknop will not have code
  compiled in so this capability is not enabled at run time. It is documented
  here for completeness.</div>
<div class="Pp"></div>
<b>-v, --verbose</b>
<div style="margin-left: 4.00ex;">Run the <b>fwknop</b> client in verbose mode.
  This causes <b>fwknop</b> to print some extra information about the current
  command and the resulting SPA data.</div>
<div class="Pp"></div>
<b>-V, --version</b>
<div style="margin-left: 4.00ex;">Display version information and exit.</div>
<h1 class="Sh" title="Sh" id="SPA_OPTIONS"><a class="selflink" href="#SPA_OPTIONS">SPA
  OPTIONS</a></h1>
<b>--use-hmac</b>
<div style="margin-left: 4.00ex;">Set HMAC mode for authenticated encryption of
  SPA communications. As of <b>fwknop</b> 2.5, this is an optional feature, but
  this will become the default in a future release.</div>
<div class="Pp"></div>
<b>-a, --allow-ip</b>=<i>&lt;IP-address&gt;</i>
<div style="margin-left: 4.00ex;">Specify IP address that should be permitted
  through the destination <b>fwknopd</b> server firewall (this IP is encrypted
  within the SPA packet itself). This is useful to prevent a MITM attack where a
  SPA packet can be intercepted en-route and sent from a different IP than the
  original. Hence, if the <b>fwknopd</b> server trusts the source address on the
  SPA packet IP header then the attacker gains access. The <b>-a</b> option puts
  the source address within the encrypted SPA packet, and so thwarts this
  attack. The <b>-a</b> option is also useful to specify the IP that will be
  granted access when the SPA packet itself is spoofed with the
  <b>--spoof-src</b> option. Another related option is <b>-R</b> (see below)
  which instructs the <b>fwknop</b> client to automatically resolve the
  externally routable IP address the local system is connected to by querying
  <i>https://www.cipherdyne.org/cgi-bin/myip</i>. This returns the actual IP
  address it sees from the calling system.</div>
<div class="Pp"></div>
<b>-g, --gpg-encryption</b>
<div style="margin-left: 4.00ex;">Use GPG encryption on the SPA packet (default
  if not specified is Rijndael). <b>Note:</b> Use of this option will also
  require a GPG recipient (see <b>--gpg-recipient</b> along with other
  GPG-related options below).</div>
<div class="Pp"></div>
<b>--hmac-digest-type</b>=<i>&lt;digest&gt;</i>
<div style="margin-left: 4.00ex;">Set the HMAC digest algorithm for
  authenticated encryption of SPA packets. Choices are: <b>MD5</b>, <b>SHA1</b>,
  <b>SHA256</b> (the default), <b>SHA384</b>, <b>SHA512</b>, <b>SHA3_256</b>,
  and <b>SHA3_512</b>.</div>
<div class="Pp"></div>
<b>-N, --nat-access</b>=<i>&lt;internalIP:forwardPort&gt;</i>
<div style="margin-left: 4.00ex;">The <b>fwknopd</b> server offers the ability
  to provide SPA access through an iptables firewall to an internal service by
  interfacing with the iptables NAT capabilities. So, if the <b>fwknopd</b>
  server is protecting an internal network on an RFC-1918 address space, an
  external <b>fwknop</b> client can request that the server port forward an
  external port to an internal IP, i.e. &#x201C;+--NAT-access
  192.168.10.2,55000+&#x201D;. In this case, access will be granted to
  192.168.10.2 via port 55000 to whatever service is requested via the
  <b>--access</b> argument (usually tcp/22). Hence, after sending such an SPA
  packet, one would then do &#x201C;ssh -p 55000 user@host&#x201D; and the
  connection would be forwarded on through to the internal 192.168.10.2 system
  automatically. Note that the port &#x201C;55000&#x201D; can be randomly
  generated via the <b>--nat-rand-port</b> argument (described later).</div>
<div class="Pp"></div>
<b>--nat-local</b>
<div style="margin-left: 4.00ex;">On the <b>fwknopd</b> server, a NAT operation
  can apply to the local system instead of being forwarded through the system.
  That is, for iptables firewalls, a connection to, say, port 55,000 can be
  translated to port 22 on the local system. By making use of the
  <b>--nat-local</b> argument, the <b>fwknop</b> client can be made to request
  such access. This means that any external attacker would only see a connection
  over port 55,000 instead of the expected port 22 after the SPA packet is
  sent.</div>
<div class="Pp"></div>
<b>--nat-port</b>
<div style="margin-left: 4.00ex;">Usually <b>fwknop</b> is used to request
  access to a specific port such as tcp/22 on a system running <b>fwknopd</b>.
  However, by using the <b>--nat-port</b> argument, it is possible to request
  access to a (again, such as tcp/22), but have this access granted via the
  specified port (so, the <b>-p</b> argument would then be used on the
  <i>SSH</i> client command line). See the <b>--nat-local</b> and
  <b>--nat-access</b> command line arguments to <b>fwknop</b> for additional
  details on gaining access to services via a NAT operation.</div>
<div class="Pp"></div>
<b>--nat-rand-port</b>
<div style="margin-left: 4.00ex;">Usually <b>fwknop</b> is used to request
  access to a specific port such as tcp/22 on a system running <b>fwknopd</b>.
  However, by using the <b>--nat-rand-port</b> argument, it is possible to
  request access to a particular service (again, such as tcp/22), but have this
  access granted via a random translated port. That is, once the <b>fwknop</b>
  client has been executed in this mode and the random port selected by
  <b>fwknop</b> is displayed, the destination port used by the follow-on client
  must be changed to match this random port. For <i>SSH</i>, this is
  accomplished via the <b>-p</b> argument. See the <b>--nat-local</b> and
  <b>--nat-access</b> command line arguments to <b>fwknop</b> for additional
  details on gaining access to services via a NAT operation.</div>
<div class="Pp"></div>
<b>-p, --server-port</b>=<i>&lt;port&gt;</i>
<div style="margin-left: 4.00ex;">Specify the port number where <b>fwknopd</b>
  accepts packets via libpcap or ulogd pcap writer. By default <b>fwknopd</b>
  looks for authorization packets over UDP port 62201.</div>
<div class="Pp"></div>
<b>-P, --server-proto</b>=<i>&lt;protocol&gt;</i>
<div style="margin-left: 4.00ex;">Set the protocol (udp, tcp, http, udpraw,
  tcpraw, or icmp) for the outgoing SPA packet. Note: The <b>udpraw</b>,
  <b>tcpraw</b>, and <b>icmp</b> modes use raw sockets and thus require root
  access to run. Also note: The <b>tcp</b> mode expects to establish a TCP
  connection to the server before sending the SPA packet. This is not normally
  done, but is useful for compatibility with the Tor for strong anonymity; see
  <i>http://tor.eff.org/</i>. In this case, the <b>fwknopd</b> server will need
  to be configured to listen on the target TCP port (which is 62201 by
  default).</div>
<div class="Pp"></div>
<b>-Q, --spoof-src</b>=<i>&lt;IP&gt;</i>
<div style="margin-left: 4.00ex;">Spoof the source address from which the
  <b>fwknop</b> client sends SPA packets. This requires root on the client side
  access since a raw socket is required to accomplish this. Note that the
  <b>--spoof-user</b> argument can be given in this mode in order to pass any
  <b>REQUIRE_USERNAME</b> keyword that might be specified in
  <i>/etc/fwknop/access.conf</i>.</div>
<div class="Pp"></div>
<b>-r, --rand-port</b>
<div style="margin-left: 4.00ex;">Instruct the <b>fwknop</b> client to send an
  SPA packet over a random destination port between 10,000 and 65535. The
  <b>fwknopd</b> server must use a <b>PCAP_FILTER</b> variable that is
  configured to accept such packets. For example, the <b>PCAP_FILTER</b>
  variable could be set to: &#x201C;+udp dst portrange
  10000-65535+&#x201D;.</div>
<div class="Pp"></div>
<b>-R, --resolve-ip-https</b>
<div style="margin-left: 4.00ex;">This is an important option, and instructs the
  <b>fwknop</b> client to issue an HTTPS request to a script running on
  <i>cipherdyne.org</i> that returns the client&#x2019;s IP address (as seen by
  the web server). In some cases, this is needed to determine the IP address
  that should be allowed through the firewall policy at the remote
  <b>fwknopd</b> server side. This option is useful if the <b>fwknop</b> client
  is being used on a system that is behind an obscure NAT address, and the
  external Internet facing IP is not known to the user. The full resolution URL
  is: <i>https://www.cipherdyne.org/cgi-bin/myip</i>, and is accessed by
  <b>fwknop</b> via <i>wget</i> in <b>--secure-protocol</b> mode. Note that it
  is generally more secure to use the <b>-a</b> option if the externally
  routable IP address for the client is already known to the user since this
  eliminates the need for <b>fwknop</b> to issue any sort of HTTPS
  request.</div>
<div class="Pp"></div>
<b>--resolve-url</b> <i>&lt;url&gt;</i>
<div style="margin-left: 4.00ex;">Override the default URL used for resolving
  the source IP address. For best results, the URL specified here should point
  to a web service that provides just an IP address in the body of the HTTP
  response.</div>
<div class="Pp"></div>
<b>--resolve-http-only</b>
<div style="margin-left: 4.00ex;">This option forces the <b>fwknop</b> client to
  resolve the external IP via HTTP instead of HTTPS. There are some
  circumstances where this might be necessary such as when <i>wget</i> is not
  available (or hasn&#x2019;t been compiled with SSL support), but generally
  this is not recommended since it opens the possibility of a MITM attack
  through manipulation of the IP resolution HTTP response. Either specify the IP
  manually with <b>-a</b>, or use <b>-R</b> and omit this option.</div>
<div class="Pp"></div>
<b>-w, --wget-cmd</b>=<i>&lt;wget full path&gt;</i>
<div style="margin-left: 4.00ex;">Manually set the full path to the <i>wget</i>
  command. Normally the <i>configure</i> script finds the <i>wget</i> command,
  but this option can be used to specify the path if it is located in a
  non-standard place.</div>
<div class="Pp"></div>
<b>-s, --source-ip</b>
<div style="margin-left: 4.00ex;">Instruct the <b>fwknop</b> client to form an
  SPA packet that contains the special-case IP address &#x201C;+0.0.0.0+&#x201D;
  which will inform the destination <b>fwknopd</b> SPA server to use the source
  IP address from which the SPA packet originates as the IP that will be allowed
  through upon modification of the firewall ruleset. This option is useful if
  the <b>fwknop</b> client is deployed on a machine that is behind a NAT device
  and the external IP is not known. However, usage of this option is not
  recommended, and either the <b>-a</b> or <b>-R</b> options should be used
  instead. The permit-address options <b>-s</b>, <b>-R</b> and <b>-a</b> are
  mutually exclusive.</div>
<div class="Pp"></div>
<b>-S, --source-port</b>=<i>&lt;port&gt;</i>
<div style="margin-left: 4.00ex;">Set the source port for outgoing SPA
  packet.</div>
<div class="Pp"></div>
<b>--server-resolve-ipv4</b>
<div style="margin-left: 4.00ex;">This option forces the <b>fwknop</b> client to
  only accept an IPv4 address from DNS when a hostname is used for the SPA
  server. This is necessary in some cases where DNS may return both IPv6 and
  IPv4 addresses.</div>
<div class="Pp"></div>
<b>-f, --fw-timeout</b>=<i>&lt;seconds&gt;</i>
<div style="margin-left: 4.00ex;">Specify the length of time (seconds) that the
  remote firewall rule that grants access to a service is to remain active. The
  default maintained by <b>fwknopd</b> is 30 seconds, but any established
  connection can be kept open after the initial accept rule is deleted through
  the use of a connection tracking mechanism that may be offered by the
  firewall.</div>
<div class="Pp"></div>
<b>-C, --server-cmd</b>=<i>&lt;command to execute&gt;</i>
<div style="margin-left: 4.00ex;">Instead of requesting access to a service with
  an SPA packet, the <b>--server-cmd</b> argument specifies a command that will
  be executed by the <b>fwknopd</b> server. The command is encrypted within the
  SPA packet and sniffed off the wire (as usual) by the <b>fwknopd</b>
  server.</div>
<div class="Pp"></div>
<b>-H, --http-proxy</b>=<i>&lt;proxy-host&gt;[:port]</i>
<div style="margin-left: 4.00ex;">Specify an HTTP proxy that the <b>fwknop</b>
  client will use to send the SPA packet through. Using this option will
  automatically set the SPA packet transmission mode (usually set via the
  <b>--server-proto</b> argument) to &quot;http&quot;. You can also specify the
  proxy port by adding &quot;:&lt;port&gt;&quot; to the proxy host name or
  ip.</div>
<div class="Pp"></div>
<b>-m, --digest-type</b>=<i>&lt;digest&gt;</i>
<div style="margin-left: 4.00ex;">Specify the message digest algorithm to use in
  the SPA data. Choices are: <b>MD5</b>, <b>SHA1</b>, <b>SHA256</b> (the
  default), <b>SHA384</b>, and <b>SHA512</b>, <b>SHA3_256</b>, and
  <b>SHA3_512</b>.</div>
<div class="Pp"></div>
<b>-M, --encryption-mode</b>=<i>&lt;mode&gt;</i>
<div style="margin-left: 4.00ex;">Specify the encryption mode when AES is used
  for encrypting SPA packets. The default is CBC mode, but others can be chosen
  such as CFB or OFB as long as this is also specified in the
  <i>/etc/fwknop/access.conf</i> file on the server side via the ENCRYPTION_MODE
  variable. In general, it is recommended to not include this argument and let
  the default (CBC) apply. Note that the string &#x201C;legacy&#x201D; can be
  specified in order to generate SPA packets with the old initialization vector
  strategy used by versions of <b>fwknop</b> prior to 2.5. With the 2.5 release,
  <b>fwknop</b> generates initialization vectors in a manner that is compatible
  with OpenSSL via the PBKDF1 algorithm.</div>
<div class="Pp"></div>
<b>--time-offset-plus</b>=<i>&lt;time&gt;</i>
<div style="margin-left: 4.00ex;">By default, the <b>fwknopd</b> daemon on the
  server side enforces time synchronization between the clocks running on client
  and server systems. The <b>fwknop</b> client places the local time within each
  SPA packet as a time stamp to be validated by the fwknopd server after
  decryption. However, in some circumstances, if the clocks are out of sync and
  the user on the client system does not have the required access to change the
  local clock setting, it can be difficult to construct and SPA packet with a
  time stamp the server will accept. In this situation, the
  <b>--time-offset-plus</b> option can allow the user to specify an offset (e.g.
  &#x201C;60sec&#x201D; &#x201C;60min&#x201D; &#x201C;2days&#x201D; etc.) that
  is added to the local time.</div>
<div class="Pp"></div>
<b>--time-offset-minus</b>=<i>&lt;time&gt;</i>
<div style="margin-left: 4.00ex;">This is similar to the
  <b>--time-offset-plus</b> option (see above), but subtracts the specified time
  offset instead of adding it to the local time stamp.</div>
<div class="Pp"></div>
<b>-u, --user-agent</b>=<i>&lt;user-agent-string&gt;</i>
<div style="margin-left: 4.00ex;">Set the HTTP User-Agent for resolving the
  external IP via <b>-R</b>, or for sending SPA packets over HTTP.</div>
<div class="Pp"></div>
<b>--use-wget-user-agent</b>
<div style="margin-left: 4.00ex;">By default when the <b>fwknop</b> client
  resolves the external IP with <b>wget</b> via SSL, it sets the User-Agent to
  &#x201C;Fwknop/&lt;version&gt;&#x201D; unless it was already manually
  specified with the <b>--user-agent</b> option mentioned above. However, the
  <b>--user-wget-user-agent</b> option lets the default <b>wget</b> User-Agent
  string apply without influence from <b>fwknop</b>.</div>
<div class="Pp"></div>
<b>-U, --spoof-user</b>=<i>&lt;user&gt;</i>
<div style="margin-left: 4.00ex;">Specify the username that is included within
  SPA packet. This allows the <b>fwknop</b> client to satisfy any non-root
  <b>REQUIRE_USERNAME</b> keyword on the fwknopd server ( <b>--spoof-src</b>
  mode requires that the <b>fwknop</b> client is executed as root).</div>
<div class="Pp"></div>
<b>--icmp-type</b>=<i>&lt;type&gt;</i>
<div style="margin-left: 4.00ex;">In <b>-P icmp</b> mode, specify the ICMP type
  value that will be set in the SPA packet ICMP header. The default is echo
  reply.</div>
<div class="Pp"></div>
<b>--icmp-code</b>=<i>&lt;code&gt;</i>
<div style="margin-left: 4.00ex;">In <b>-P icmp</b> mode, specify the ICMP code
  value that will be set in the SPA packet ICMP header. The default is
  zero.</div>
<h1 class="Sh" title="Sh" id="GPG_OPTIONS"><a class="selflink" href="#GPG_OPTIONS">GPG
  OPTIONS</a></h1>
Note that the usage of GPG for SPA encryption/decryption can and should involve
  GPG keys that are signed by each side (client and server). The basic procedure
  for this involves the following steps after the client key has been
  transferred to the server and vice-versa:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    [spaserver]# gpg --import client.asc
    [spaserver]# gpg --edit-key 1234ABCD
    Command&gt; sign
<div class="Pp"></div>
    [spaclient]$ gpg --import server.asc
    [spaclient]$ gpg --edit-key ABCD1234
    Command&gt; sign
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
More comprehensive information on this can be found here:
  <i>http://www.cipherdyne.org/fwknop/docs/gpghowto.html</i>.
<div class="Pp"></div>
<b>--gpg-agent</b>
<div style="margin-left: 4.00ex;">Instruct <b>fwknop</b> to acquire GnuPG key
  password from a running gpg-agent instance (if available).</div>
<div class="Pp"></div>
<b>--gpg-home-dir</b>=<i>&lt;dir&gt;</i>
<div style="margin-left: 4.00ex;">Specify the path to the GnuPG directory;
  normally this path is derived from the home directory of the user that is
  running the <b>fwknop</b> client (so the default is <i>~/.gnupg</i>). This is
  useful when a &#x201C;root&#x201D; user wishes to log into a remote machine
  whose sshd daemon/service does not permit root login.</div>
<div class="Pp"></div>
<b>--gpg-recipient</b>=<i>&lt;key ID or Name&gt;</i>
<div style="margin-left: 4.00ex;">Specify the GnuPG key ID, e.g.
  &#x201C;+1234ABCD+&#x201D; (see the output of
  &quot;gpg&#x2014;list-keys&quot;) or the key name (associated email address)
  of the recipient of the Single Packet Authorization message. This key is
  imported by the <b>fwknopd</b> server and the associated private key is used
  to decrypt the SPA packet. The recipient&#x2019;s key must first be imported
  into the client GnuPG key ring.</div>
<div class="Pp"></div>
<b>--gpg-signer-key</b>=<i>&lt;key ID or Name&gt;</i>
<div style="margin-left: 4.00ex;">Specify the GnuPG key ID, e.g.
  &#x201C;+ABCD1234+&#x201D; (see the output of &quot;gpg --list-keys&quot;) or
  the key name to use when signing the SPA message. The user is prompted for the
  associated GnuPG password to create the signature. This adds a
  cryptographically strong mechanism to allow the <b>fwknopd</b> daemon on the
  remote server to authenticate who created the SPA message.</div>
<div class="Pp"></div>
<b>--gpg-no-signing-pw</b>
<div style="margin-left: 4.00ex;">Instruct <b>fwknop</b> to not acquire a
  passphrase for usage of GnuPG signing key. This option is provided to make SPA
  packet construction easier for client-side operations in automated
  environments where the passphrase for the signing key has been removed from
  the GnuPG key ring. However, it is usually better to leverage <i>gpg-agent</i>
  instead of using this option.</div>
<h1 class="Sh" title="Sh" id="FWKNOPRC_FILE"><a class="selflink" href="#FWKNOPRC_FILE">FWKNOPRC
  FILE</a></h1>
The <i>.fwknoprc</i> file is used to set various parameters to override default
  program parameters at runtime. It also allows for additional named
  configuration <i>stanzas</i> for setting program parameters for a particular
  invocation.
<div style="height: 1.00em;">&#x00A0;</div>
The <b>fwknop</b> client will create this file if it does not exist in the
  user&#x2019;s home directory. This initial version has some sample directives
  that are commented out. It is up to the user to edit this file to meet their
  needs.
<div style="height: 1.00em;">&#x00A0;</div>
The <i>.fwknoprc</i> file contains a default configuration area or stanza which
  holds global configuration directives that override the program defaults. You
  can edit this file and create additional <i>named stanzas</i> that can be
  specified with the <b>-n</b> or <b>--named-config</b> option. Parameters
  defined in the named stanzas will override any matching <i>default</i> stanza
  directives. Note that command-line options will still override any
  corresponding <i>.fwknoprc</i> directives.
<div style="height: 1.00em;">&#x00A0;</div>
There are directives to match most of the command-line parameters <b>fwknop</b>
  supports. Here is the current list of each directive along with a brief
  description and its matching command-line option(s):
<div class="Pp"></div>
<b>SPA_SERVER</b> <i>&lt;hostname/IP-address&gt;</i>
<div style="margin-left: 4.00ex;">Specify the hostname or IP of the destination
  ( <b>fwknopd</b>) server (<i>-D, --destination</i>).</div>
<div class="Pp"></div>
<b>ALLOW_IP</b> <i>&lt;IP-address&gt;</i>
<div style="margin-left: 4.00ex;">Specify the address to allow within the SPA
  data. Note: This parameter covers the <b>-a</b>, <b>-s</b>, and <b>-R</b>
  command-line options. You can specify a hostname or IP address (the <b>-a</b>
  option), specify the word &quot;source&quot; to tell the <b>fwknopd</b> server
  to accept the source IP of the packet as the IP to allow (the <b>-s</b>
  option), or use the word &quot;resolve&quot; to have <b>fwknop</b> resolve the
  external network IP via HTTP request (the <b>-R</b> option).</div>
<div class="Pp"></div>
<b>ACCESS</b> <i>&lt;port list&gt;</i>
<div style="margin-left: 4.00ex;">Set the one or more protocol/ports to open on
  the firewall ( <i>-A, --access</i>). The format of this list is
  &#x201C;+&lt;proto&gt;/&lt;port&gt;...&lt;proto&gt;/&lt;port&gt;+&#x201D;,
  e.g. &#x201C;tcp/22,udp/53&#x201D;.</div>
<div class="Pp"></div>
<b>SPA_SERVER_PORT</b> <i>&lt;port&gt;</i>
<div style="margin-left: 4.00ex;">Set the server port to use for sending the SPA
  packet ( <i>-p, --server-port</i>).</div>
<div class="Pp"></div>
<b>SPA_SERVER_PROTO</b> <i>&lt;protocol</i>&gt;
<div style="margin-left: 4.00ex;">Set the protocol to use for sending the SPA
  packet ( <i>-P, --server-proto</i>).</div>
<div class="Pp"></div>
<b>KEY</b> <i>&lt;passphrase&gt;</i>
<div style="margin-left: 4.00ex;">This is the passphrase that is used for SPA
  packet encryption and applies to both Rijndael or GPG encryption modes. The
  actual encryption key that is used for Rijndael is derived from the PBKDF1
  algorithm, and the GPG key is derived from the specified GPG key ring.</div>
<div class="Pp"></div>
<b>KEY_BASE64</b> <i>&lt;base64 encoded passphrase&gt;</i>
<div style="margin-left: 4.00ex;">Specify the encryption passphrase as a base64
  encoded string. This allows non-ascii characters to be included in the
  base64-decoded key.</div>
<div class="Pp"></div>
<b>USE_HMAC</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Set HMAC mode for authenticated encryption of
  SPA packets. This will have <b>fwknop</b> prompt the user for a dedicated HMAC
  key that is independent of the encryption key. Alternatively, the HMAC key can
  be specified with the <i>HMAC_KEY</i> or <i>HMAC_KEY_BASE64</i> directives
  (see below).</div>
<div class="Pp"></div>
<b>HMAC_KEY</b> <i>&lt;key&gt;</i>
<div style="margin-left: 4.00ex;">Specify the HMAC key for authenticated
  encryption of SPA packets. This supports both Rijndael and GPG encryption
  modes, and is applied according to the encrypt-then-authenticate model.</div>
<div class="Pp"></div>
<b>HMAC_KEY_BASE64</b> <i>&lt;base64 encoded key&gt;</i>
<div style="margin-left: 4.00ex;">Specify the HMAC key as a base64 encoded
  string. This allows non-ascii characters to be included in the base64-decoded
  key.</div>
<div class="Pp"></div>
<b>HMAC_DIGEST_TYPE</b> <i>&lt;digest algorithm&gt;</i>
<div style="margin-left: 4.00ex;">Set the HMAC digest algorithm used for
  authenticated encryption of SPA packets. Choices are: <b>MD5</b>, <b>SHA1</b>,
  <b>SHA256</b> (the default), <b>SHA384</b>, <b>SHA512</b>, <b>SHA3_256</b>,
  and <b>SHA3_512</b>.</div>
<div class="Pp"></div>
<b>SPA_SOURCE_PORT</b> <i>&lt;port&gt;</i>
<div style="margin-left: 4.00ex;">Set the source port to use for sending the SPA
  packet ( <i>-S, --source-port</i>).</div>
<div class="Pp"></div>
<b>FW_TIMEOUT</b> <i>&lt;seconds&gt;</i>
<div style="margin-left: 4.00ex;">Set the firewall rule timeout value (<i>-f,
  --fw-timeout</i>).</div>
<div class="Pp"></div>
<b>RESOLVE_IP_HTTPS</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Set to <i>Y</i> to automatically resolve the
  externally routable IP associated with the <b>fwknop</b> client. This is done
  over SSL via <i>wget</i> in <i>--secure-protocol</i> mode against the IP
  resolution service available at
  <i>https://www.cipherdyne.org/cgi-bin/myip</i>.</div>
<div class="Pp"></div>
<b>RESOLVE_HTTP_ONLY</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">When the <b>fwknop</b> client is instructed to
  resolve the external client IP, this option can be used to force an
  <i>HTTP</i> connection instead of an <i>HTTPS</i> connection when set to
  <i>Y</i>. This option is useful when <i>wget</i> is not installed on the local
  OS, or when it is not compiled against an SSL library.</div>
<div class="Pp"></div>
<b>RESOLVE_URL</b> <i>&lt;url&gt;</i>
<div style="margin-left: 4.00ex;">Set to a URL that will be used for resolving
  the source IP address ( <i>--resolve-url</i>).</div>
<div class="Pp"></div>
<b>WGET_CMD</b> <i>&lt;wget full path&gt;</i>
<div style="margin-left: 4.00ex;">Set the full path to the <i>wget</i> command
  (used for client IP resolution).</div>
<div class="Pp"></div>
<b>TIME_OFFSET</b> <i>&lt;time&gt;</i>
<div style="margin-left: 4.00ex;">Set a value to apply to the timestamp in the
  SPA packet. This can be either a positive or negative value (
  <i>--time-offset-plus/minus</i>).</div>
<div class="Pp"></div>
<b>ENCRYPTION_MODE</b> <i>&lt;mode&gt;</i>
<div style="margin-left: 4.00ex;">Specify the encryption mode when AES is used.
  This variable is a synonym for the <i>-M, --encryption-mode</i> command line
  argument. In general, it is recommended to not include this argument and let
  the default (CBC) apply. Note that the string &#x201C;legacy&#x201D; can be
  specified in order to generate SPA packets with the old initialization vector
  strategy used by versions of <b>fwknop</b> prior to 2.5.</div>
<div class="Pp"></div>
<b>DIGEST_TYPE</b> <i>&lt;digest algorithm&gt;</i>
<div style="margin-left: 4.00ex;">Set the SPA message digest type (<i>-m,
  --digest-type</i>). Choices are: <b>MD5</b>, <b>SHA1</b>, <b>SHA256</b> (the
  default), <b>SHA384</b>, <b>SHA512</b>, <b>SHA3_256</b>, and
  <b>SHA3_512</b>.</div>
<div class="Pp"></div>
<b>USE_GPG</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Set to <i>Y</i> to specify the use of GPG for
  encryption ( <i>--gpg-encryption</i>).</div>
<div class="Pp"></div>
<b>USE_GPG_AGENT</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Set to <i>Y</i> to have <b>fwknop</b>
  interface with a GPG agent instance for the GPG key password (
  <i>--gpg-agent</i>). Agent information itself is specified with the
  <i>GPG_AGENT_INFO</i> environmental variable.</div>
<div class="Pp"></div>
<b>GPG_SIGNING_PW</b> <i>&lt;passphrase&gt;</i>
<div style="margin-left: 4.00ex;">This is the passphrase that is used for
  signing SPA packet data in GPG encryption mode, and is a synonym for the
  <i>KEY</i> variable (i.e. the signing passphrase can be specified with the
  <i>KEY</i> variable instead). The SPA packet is encrypted with the remote
  server key and signed with the local client key.</div>
<div class="Pp"></div>
<b>GPG_SIGNING_PW_BASE64</b> <i>&lt;base64 encoded passphrase&gt;</i>
<div style="margin-left: 4.00ex;">Specify the GPG signing passphrase as a base64
  encoded string. This allows non-ascii characters to be included in the
  base64-decoded key.</div>
<div class="Pp"></div>
<b>GPG_SIGNER</b> <i>&lt;key ID or Name&gt;</i>
<div style="margin-left: 4.00ex;">Specify the GPG key name or ID for signing the
  GPG-encrypted SPA data ( <i>--gpg-signer-key</i>).</div>
<div class="Pp"></div>
<b>GPG_RECIPIENT</b> <i>&lt;key ID or Name&gt;</i>
<div style="margin-left: 4.00ex;">Specify the GPG key name or ID for the
  recipient of the GPG-encrypted SPA data ( <i>--gpg-recipient-key</i>).</div>
<div class="Pp"></div>
<b>GPG_HOMEDIR</b> <i>&lt;dir&gt;</i>
<div style="margin-left: 4.00ex;">Specify the GPG home directory
  (<i>--gpg-home-dir</i>). Defaults to <i>~/.gnupg</i>.</div>
<div class="Pp"></div>
<b>GPG_EXE</b> <i>&lt;path&gt;</i>
<div style="margin-left: 4.00ex;">Specify the path to GPG (<i>--gpg-exe</i>).
  Defaults to <i>/usr/bin/gpg</i>.</div>
<div class="Pp"></div>
<b>SPOOF_USER</b> <i>&lt;user&gt;</i>
<div style="margin-left: 4.00ex;">Set the username in the SPA data to the
  specified value ( <i>-U, --spoof-user</i>).</div>
<div class="Pp"></div>
<b>SPOOF_SOURCE_IP</b> <i>&lt;IP&gt;</i>
<div style="margin-left: 4.00ex;">Set the source IP of the outgoing SPA packet
  to the specified value ( <i>-Q, --spoof-source</i>).</div>
<div class="Pp"></div>
<b>RAND_PORT</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Send the SPA packet over a randomly assigned
  port ( <i>-r, --rand-port</i>).</div>
<div class="Pp"></div>
<b>KEY_FILE</b> <i>&lt;file&gt;</i>
<div style="margin-left: 4.00ex;">Load an encryption key/password from a file
  (<i>-G, --get-key</i>).</div>
<div class="Pp"></div>
<b>HTTP_USER_AGENT</b> <i>&lt;agent string&gt;</i>
<div style="margin-left: 4.00ex;">Set the HTTP User-Agent for resolving the
  external IP via -R, or for sending SPA packets over HTTP ( <i>-u,
  --user-agent</i>).</div>
<div class="Pp"></div>
<b>USE_WGET_USER_AGENT</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Allow default <b>wget</b> User-Agent string to
  be used when resolving the external IP instead of a User-Agent supplied by the
  <b>fwknop</b> client.</div>
<div class="Pp"></div>
<b>NAT_ACCESS</b> <i>&lt;internalIP:forwardPort&gt;</i>
<div style="margin-left: 4.00ex;">Gain NAT access to an internal service
  protected by the fwknop server ( <i>-N, --nat-access</i>).</div>
<div class="Pp"></div>
<b>NAT_LOCAL</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Access a local service via a forwarded port on
  the fwknopd server system ( <i>--nat-local</i>).</div>
<div class="Pp"></div>
<b>NAT_PORT</b> <i>&lt;port&gt;</i>
<div style="margin-left: 4.00ex;">Specify the port to forward to access a
  service via NAT ( <i>--nat-port</i>).</div>
<div class="Pp"></div>
<b>NAT_RAND_PORT</b> <i>&lt;Y/N&gt;</i>
<div style="margin-left: 4.00ex;">Have the fwknop client assign a random port
  for NAT access ( <i>--nat-rand-port</i>).</div>
<h1 class="Sh" title="Sh" id="ENVIRONMENT"><a class="selflink" href="#ENVIRONMENT">ENVIRONMENT</a></h1>
<b>SPOOF_USER</b>, <b>GPG_AGENT_INFO</b> (only used in <b>--gpg-agent</b> mode).
<h1 class="Sh" title="Sh" id="SPA_PACKET_SPOOFING"><a class="selflink" href="#SPA_PACKET_SPOOFING">SPA
  PACKET SPOOFING</a></h1>
Because <b>fwknop</b> places the IP to be allowed through the firewall within
  the encrypted SPA payload (unless <b>-s</b> is used which is not recommended
  and can be prohibited in the <b>fwknopd</b> server configuration), SPA packets
  can easily be spoofed, and this is a good thing in this context. That is, the
  source IP of an SPA packet is ignored by the <b>fwknopd</b> daemon (when the
  <i>REQUIRE_SOURCE_ADDRESS</i> variable is set in the
  <i>/etc/fwknop/access.conf</i> file) and only the IP that is contained within
  an authenticated and properly decrypted SPA packet is granted access through
  the firewall. This makes it possible to make it appear as though, say,
  www.yahoo.com is trying to authenticate to a target system but in reality the
  actual connection will come from a seemingly unrelated IP.
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="selflink" href="#EXAMPLES">EXAMPLES</a></h1>
The following examples illustrate the command line arguments that could be
  supplied to the fwknop client in a few situations:
<h2 class="Ss" title="Ss" id="Quick_start"><a class="selflink" href="#Quick_start">Quick
  start</a></h2>
The most effective and easiest way to use <b>fwknop</b> is to have the client
  generate both an encryption key and an HMAC key, and then save them to the
  &#x201C;$HOME/.fwknoprc&#x201D; file along with access request specifics. The
  keys will also need to be transferred to the system where <b>fwknopd</b> is
  running. The also client supports a separate set of encryption and HMAC keys
  for each SPA destination if multiple fwknopd servers are running on different
  systems.
<div style="height: 1.00em;">&#x00A0;</div>
So, assuming that the IP <i>2.2.2.2</i> is the system where <b>fwknopd</b> is
  deployed and SSH is protected by the firewall on that system in a default-drop
  stance, run the client like so to generate encryption and HMAC keys:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A tcp/22 --use-hmac -R -D 2.2.2.2 --key-gen --save-rc-stanza --verbose
    [+] Wrote Rijndael and HMAC keys to rc file: /home/user/.fwknoprc
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
With the access request arguments and encryption and HMAC keys generated and
  saved in &#x201C;$HOME/.fwknoprc&#x201D;, the keys themselves need to be
  transferred to the <i>2.2.2.2</i> system where fwknopd is running. As always,
  this should be done via some secure means such as SSH before SPA is enabled
  and SSHD is blocked by the firewall. Here is what the new <i>2.2.2.2</i>
  stanza looks like in the <i>~/.fwknoprc</i> file:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ tail -n 8 /home/user/.fwknoprc
    [2.2.2.2]
    ACCESS                      tcp/22
    SPA_SERVER                  2.2.2.2
    KEY_BASE64                  HvUtIOramehLGKimD4ECXOzinaH4h3U8H1WXum7b54Q=
    HMAC_KEY_BASE64             DLeLf93a3yBT2vhEpM+dWlirGta5GU+jdyG5uXp4461HgOtbqMem4gX0Bp2PJGzYZlbbcavcOM00UPm+0GqkXA==
    USE_HMAC                    Y
    VERBOSE                     Y
    RESOLVE_IP_HTTPS            Y
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
The keys are base64 encoded blobs of random data, and both the <b>KEY_BASE64</b>
  and <b>HMAC_KEY_BASE64</b> lines should be copied verbatim and placed within
  the <i>/etc/fwknop/access.conf</i> file on <i>2.2.2.2</i>. Once this is done,
  <b>fwknopd</b> can be started on that system, a default-drop policy against
  SSH connections can be put in place, and then access to SSH is managed via
  fwknop. To access SSH, just use the <b>-n</b> argument to reference the
  <i>2.2.2.2</i> stanza out of the .fwknoprc file (some <b>--verbose</b> output
  is included for illustration):
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -n 2.2.2.2
<div class="Pp"></div>
    FKO Field Values:
    =================
<div class="Pp"></div>
       Random Value: 8950423288486978
           Username: mbr
          Timestamp: 1370194770
        FKO Version: 2.5
       Message Type: 1 (Access msg)
     Message String: 1.1.1.1,tcp/22
         Nat Access: &lt;NULL&gt;
        Server Auth: &lt;NULL&gt;
     Client Timeout: 0 (seconds)
        Digest Type: 3 (SHA256)
          HMAC Type: 3 (SHA256)
    Encryption Type: 1 (Rijndael)
    Encryption Mode: 2 (CBC)
    ...
<div class="Pp"></div>
    $ ssh -l user 2.2.2.2
    user@2.2.2.2's password:
</pre>
</div>
<h2 class="Ss" title="Ss" id="Access_mode_examples"><a class="selflink" href="#Access_mode_examples">Access
  mode examples</a></h2>
The most common usage of <b>fwknop</b> is to gain access to SSH running on a
  remote system that has the <b>fwknopd</b> daemon deployed along with a
  default-drop firewall policy. The following command illustrates this where IP
  <i>1.1.1.1</i> is the IP to be allowed through the firewall running on
  <i>3.3.3.3</i> (note that the <i>/etc/fwknop/access.conf</i> file consumed by
  <b>fwknopd</b> will need to have matching encryption and HMAC keys, and
  configuration specifics can be found in the <i>fwknopd(8)</i> manual page).
  Also, note the examples below prompt the user to supply the encryption and
  HMAC keys via stdin instead of writing them to disk as in the case of using
  the &#x201C;$HOME/.fwknoprc&#x201D; file in the example above. However, all of
  the following examples can be converted to using the ~/.fwknoprc file just by
  adding the <b>--save-rc-stanza</b> argument:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A tcp/22 --use-hmac -a 1.1.1.1 -D 3.3.3.3
    Enter encryption key:
    Enter HMAC key:
    $ ssh -l user 3.3.3.3
    user@3.3.3.3's password:
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
If the <b>--verbose</b> flag is added to the command line, then some SPA packet
  specifics are printed to stdout (not all output is shown for brevity):
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A tcp/22 --use-hmac -a 1.1.1.1 -D 3.3.3.3 --verbose
    Enter encryption key:
    Enter HMAC key:
<div class="Pp"></div>
       Random Value: 1916307060193417
           Username: mbr
          Timestamp: 1368498909
        FKO Version: 2.5
       Message Type: 1 (Access msg)
     Message String: 1.1.1.1,tcp/22
         Nat Access: &lt;NULL&gt;
        Server Auth: &lt;NULL&gt;
     Client Timeout: 0 (seconds)
        Digest Type: 3 (SHA256)
          HMAC Type: 3 (SHA256)
    Encryption Type: 1 (Rijndael)
    Encryption Mode: 2 (CBC)
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
Simultaneous access to multiple services is also supported, and here is an
  example of requesting access to both <i>SSH</i> and <i>OpenVPN</i> on
  <i>3.3.3.3</i>:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A &quot;tcp/22,tcp/1194&quot; --use-hmac -a 1.1.1.1 -D 3.3.3.3
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
There are many cases where an <b>fwknop</b> client is deployed on a network
  behind a NAT device and the externally routable IP is not known to the user.
  In this case, use the IP resolution service available at
  <i>https://www.cipherdyne.org/cgi-bin/myip</i> via the <b>-R</b> command line
  switch in order to derive the external client IP address. This is a safer
  method of acquiring the client IP address than using the <b>-s</b> option
  mentioned earlier in this manual page because the source IP is put within the
  encrypted packet instead of having the <b>fwknopd</b> daemon grant the
  requested access from whatever IP address the SPA packet originates (i.e.
  using <b>-s</b> opens the possibility of a MITM attack):
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A tcp/22 --use-hmac -R -D 3.3.3.3
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
Use the Single Packet Authorization mode to gain access to <i>SSH</i> and this
  time use GnuPG keys to encrypt and decrypt:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A tcp/22 --use-hmac --gpg-sign ABCD1234 --gpg--recipient 1234ABCD -R -D 3.3.3.3
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
Instruct the fwknop server running at 3.3.3.3 to allow 1.1.1.1 to connect to
  <i>SSH</i>, but spoof the authorization packet from an IP associated with
  <i>www.yahoo.com</i> (requires root on the <b>fwknop</b> client OS):
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    # fwknop --spoof-src &quot;www.yahoo.com&quot; -A tcp/22 --use-hmac -a 1.1.1.1 -D 3.3.3.3
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
When <b>fwknopd</b> is running on an iptables firewall with systems deployed
  behind it, it is possible to take advantage of the NAT capabilities offered by
  iptables in order to transparently reach systems behind the firewall via SPA.
  Here is an example where the <b>fwknop</b> client is used to gain access to
  SSH running on the non-routable IP <i>192.168.10.23</i> that is deployed on
  the network behind <i>3.3.3.3</i>. In this case, the SSH connection made to
  <i>3.3.3.3</i> is translated via NAT to the <i>192.168.10.2</i> system
  automatically:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A tcp/22 -N 192.168.10.2:22 -R -D 3.3.3.3
</pre>
</div>
<h1 class="Sh" title="Sh" id="BACKWARDS_COMPATIBILITY"><a class="selflink" href="#BACKWARDS_COMPATIBILITY">BACKWARDS
  COMPATIBILITY</a></h1>
With the <i>2.5</i> release, <b>fwknop</b> underwent significant changes in its
  usage of cryptography including the addition of support for HMAC authenticated
  encryption for both Rijndael and GnuPG modes, ensuring the proper usage of
  PBKDF1 for key derivation when SPA packets are encrypted with Rijndael, and
  several bugs were fixed from previous versions of fwknop. In general, this
  implies that when Rijndael is used, SPA packets produced by the <i>2.5</i>
  release are incompatible with previous versions of fwknop. The GnuPG
  encryption mode is unaffected by these updates. However, even with Rijndael is
  used, backwards compatibility is supported through setting the <i>legacy</i>
  encryption mode with <b>-M</b> on the fwknop client command line and/or the
  <i>ENCRYPTION_MODE</i> variable in the <i>/etc/fwknop/access.conf</i> file.
  This way, a pre-2.5 server can decrypt SPA packets produced by a 2.5 and later
  client (set <i>-M legacy</i>), and a 2.5 and later server can decrypt SPA
  packets produced by pre-2.5 clients (set <i>ENCRYPTION_MODE legacy</i> in the
  access.conf file). Note that HMAC is only supported as of 2.5 and is an
  optional feature, so backwards compatibility is only for configurations that
  don&#x2019;t use an HMAC on either side. It is strongly recommended to upgrade
  all fwknop clients and servers to 2.5 and use the new HMAC mode for properly
  authenticated SPA communications. The backwards compatibility support is used
  to make it easier to upgrade clients and servers with a phased approach.
<div style="height: 1.00em;">&#x00A0;</div>
For emphasis, if the <b>fwknopd</b> server is upgraded to 2.5 (or later), but
  older clients cannot be upgraded at the same time, then for each <i>SOURCE</i>
  stanza in the <i>/etc/fwknop/access.conf</i> file, add the following line:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    ENCRYPTION_MODE         legacy
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
In addition, if the <i>KEY</i> variable has an encryption key longer than 16
  bytes, it will need to be truncated to 16 characters in the <i>access.conf</i>
  file in order for pre-2.5 clients to work properly. This limitation is fixed
  in 2.5, and provides additional motivation for upgrading all clients and
  servers to 2.5 or later.
<div style="height: 1.00em;">&#x00A0;</div>
Now, flipping the scenario around, if the <b>fwknop</b> clients are upgraded but
  the <b>fwknopd</b> server is still at a pre-2.5 version, then add the <i>-M
  legacy</i> argument to the fwknop command line:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ fwknop -A tcp/22 -M legacy -R -D 2.2.2.2
</pre>
</div>
<h1 class="Sh" title="Sh" id="DEPENDENCIES"><a class="selflink" href="#DEPENDENCIES">DEPENDENCIES</a></h1>
The <b>fwknop</b> client requires <i>libfko</i> which is normally included with
  both source and binary distributions, and is a dedicated library developed by
  the fwknop project. Whenever the <b>fwknopd</b> server is used, <i>libpcap</i>
  is a required dependency. However, the upcoming <i>2.6</i> release will offer
  a UDP listener mode along with privilege separation support and will not
  require libpcap in this mode. In UDP listener mode, even though fwknopd binds
  to a UDP port, SPA packets are never acknowledged so from an attacker&#x2019;s
  perspective there is no difference between fwknopd sniffing the wire passively
  vs. listening on a UDP socket in terms of what can be scanned for.
<div style="height: 1.00em;">&#x00A0;</div>
For GPG functionality, GnuPG must also be correctly installed and configured
  along with the <i>libgpgme</i> library.
<div style="height: 1.00em;">&#x00A0;</div>
To take advantage of all of the authentication and access management features of
  the <b>fwknopd</b> daemon/service a functioning <i>iptables</i>, <i>ipfw</i>,
  or <i>pf</i> firewall is required on the underlying operating system.
<h1 class="Sh" title="Sh" id="DIAGNOSTICS"><a class="selflink" href="#DIAGNOSTICS">DIAGNOSTICS</a></h1>
The most comprehensive way to gain diagnostic information on <b>fwknop</b> is to
  run the test suite <i>test-fwknop.pl</i> script located in the <i>test/</i>
  directory in the fwknop sources. The test suite sends fwknop through a large
  number of run time tests, has <i>valgrind</i> support, validates both SPA
  encryption and HMAC results against OpenSSL, and even has its own built in
  fuzzer for SPA communications (and fwknop in version 2.6.4 supports the
  <i>American Fuzzy Lop</i> (AFL) from Michal Zalewski as well). For more basic
  diagnostic information, <b>fwknop</b> can be executed with the <b>-T</b> (or
  <b>--test</b>) command line option. This will have <b>fwknop</b> simply create
  and print the SPA packet information, then run it through a decrypt/decode
  cycle and print it again. In addition, the <b>--verbose</b> command line
  switch is useful to see various SPA packet specifics printed to stdout.
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="selflink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
fwknopd(8), iptables(8), pf(4), pfctl(8), ipfw(8), gpg(1), libfko documentation.
<div style="height: 1.00em;">&#x00A0;</div>
More information on Single Packet Authorization can be found in the paper
  &#x201C;Single Packet Authorization with fwknop&#x201D; available at
  <i>http://www.cipherdyne.org/fwknop/docs/SPA.html</i>. A comprehensive
  tutorial on <b>fwknop</b> operations and theory can be found at
  <i>http://www.cipherdyne.org/fwknop/docs/fwknop-tutorial.html</i>. This
  tutorial also includes information about the design of <b>fwknop</b> that may
  be worth reading for those interested in why fwknop is different from other
  SPA implementations.
<div style="height: 1.00em;">&#x00A0;</div>
<b>fwknop</b> uses the <i>git</i> versioning system as its source code
  repository along with <i>Github</i> for tracking of issues and milestones:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">
<pre>
    $ git clone https://github.com/mrash/fwknop.git fwknop.git
</pre>
</div>
<div style="height: 1.00em;">&#x00A0;</div>
Additional commentary on Single Packet Authorization can be found via Michael
  Rash&#x2019;s Twitter feed: http://twitter.com/michaelrash, @michaelrash
<h1 class="Sh" title="Sh" id="AUTHORS"><a class="selflink" href="#AUTHORS">AUTHORS</a></h1>
The primary developers of <b>fwknop</b> are Michael Rash (project creator)
  &lt;mbr@cipherdyne.org&gt;, Damien Stuart &lt;dstuart@dstuart.org&gt;, and
  Jonathan Bennett &lt;jbennett@incomsystems.biz&gt;.
<h1 class="Sh" title="Sh" id="CONTRIBUTORS"><a class="selflink" href="#CONTRIBUTORS">CONTRIBUTORS</a></h1>
This &#x201C;C&#x201D; version of fwknop was derived from the original
  Perl-based version on which many people who are active in the open source
  community have contributed. See the CREDITS file in the fwknop sources, or
  visit <i>https://github.com/mrash/fwknop/blob/master/CREDITS</i> to view the
  online list of contributors. A few contributors deserve to be singled out
  including: Franck Joncourt, Max Kastanas, Vlad Glagolev, Sean Greven, Hank
  Leininger, Fernando Arnaboldi, and Erik Gomez.
<div style="height: 1.00em;">&#x00A0;</div>
The phrase &#x201C;Single Packet Authorization&#x201D; was coined by MadHat and
  Simple Nomad at the BlackHat Briefings of 2005.
<h1 class="Sh" title="Sh" id="BUGS"><a class="selflink" href="#BUGS">BUGS</a></h1>
Send bug reports to dstuart@dstuart.org or mbr@cipherdyne.org, or open a new
  issue on Github (see <i>https://github.com/mrash/fwknop.git</i>). Suggestions
  and/or comments are always welcome as well. Additional information may be
  found in the <b>fwknop</b> mailing list archives (see:
  <i>https://lists.sourceforge.net/lists/listinfo/fwknop-discuss</i>).
<h1 class="Sh" title="Sh" id="DISTRIBUTION"><a class="selflink" href="#DISTRIBUTION">DISTRIBUTION</a></h1>
<b>fwknop</b> is distributed under the GNU General Public License (GPL v2+), and
  the latest version may be downloaded from
  <i>http://www.cipherdyne.org</i>.</div>
<table class="foot">
  <tr>
    <td class="foot-date">06/08/2016</td>
    <td class="foot-os">Fwknop Client</td>
  </tr>
</table>
</body>
</html>
