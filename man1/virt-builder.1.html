<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 16:42:17 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>virt-builder(1) Virtualization Support
virt-builder(1)</p>

<p style="margin-top: 1em">NAME <br>
virt-builder - Build virtual machine images quickly</p>

<p style="margin-top: 1em">SYNOPSIS <br>
virt-builder os-version <br>
[-o|--output DISKIMAGE] [--size SIZE] [--format raw|qcow2]
<br>
[--arch ARCHITECTURE] [--attach ISOFILE] <br>
[--chmod PERMISSIONS:FILE] [--commands-from-file FILENAME]
<br>
[--copy SOURCE:DEST] [--copy-in LOCALPATH:REMOTEDIR] <br>
[--delete PATH] [--edit FILE:EXPR] [--firstboot SCRIPT] <br>
[--firstboot-command &rsquo;CMD+ARGS&rsquo;]
[--firstboot-install PKG,PKG..] <br>
[--hostname HOSTNAME] [--install PKG,PKG..] <br>
[--link TARGET:LINK[:LINK..]] [--mkdir DIR] [--move
SOURCE:DEST] <br>
[--password USER:SELECTOR] [--root-password SELECTOR] <br>
[--run SCRIPT] [--run-command &rsquo;CMD+ARGS&rsquo;]
[--scrub FILE] <br>
[--sm-attach SELECTOR] [--sm-register] [--sm-remove] <br>
[--sm-unregister] [--ssh-inject USER[:SELECTOR]] [--truncate
FILE] <br>
[--truncate-recursive PATH] [--timezone TIMEZONE] [--touch
FILE] <br>
[--uninstall PKG,PKG..] [--update] [--upload FILE:DEST] <br>
[--write FILE:CONTENT] [--no-logfile] <br>
[--password-crypto md5|sha256|sha512] [--selinux-relabel]
<br>
[--sm-credentials SELECTOR]</p>

<p style="margin-top: 1em">virt-builder -l|--list [--long]
[--list-format short|long|json]</p>

<p style="margin-top: 1em">virt-builder --notes
os-version</p>

<p style="margin-top: 1em">virt-builder --print-cache</p>

<p style="margin-top: 1em">virt-builder
--cache-all-templates</p>

<p style="margin-top: 1em">virt-builder --delete-cache</p>

<p style="margin-top: 1em">virt-builder --get-kernel
DISKIMAGE <br>
[--format raw|qcow2] [--output OUTPUTDIR]</p>

<p style="margin-top: 1em">DESCRIPTION <br>
Virt-builder is a tool for quickly building new virtual
machines. You can build a variety of VMs for local or cloud
use, usually within a few minutes or less. Virt-builder also
<br>
has many ways to customize these VMs. Everything is run from
the command line and nothing requires root privileges, so
automation and scripting is simple.</p>

<p style="margin-top: 1em">Note that virt-builder does not
install guests from scratch. It takes cleanly prepared,
digitally signed OS templates and customizes them. This
approach is used because it is <br>
much faster, but if you need to do fresh installs you may
want to look at virt-install(1) and oz-install(1).</p>

<p style="margin-top: 1em">The easiest way to get started
is by looking at the examples in the next section.</p>

<p style="margin-top: 1em">EXAMPLES <br>
List the virtual machines available <br>
virt-builder --list</p>

<p style="margin-top: 1em">will list out the operating
systems available to install. A selection of freely
redistributable OSes is available as standard. You can add
your own too (see below).</p>

<p style="margin-top: 1em">After choosing a guest from the
list, you may want to see if there are any installation
notes:</p>

<p style="margin-top: 1em">virt-builder --notes
fedora-20</p>

<p style="margin-top: 1em">Build a virtual machine <br>
virt-builder fedora-20</p>

<p style="margin-top: 1em">will build a Fedora 20 image for
the same architecture as virt-builder (so running it from an
i386 installation will try to build an i386 image, if
available). This will have <br>
all default configuration (minimal size, no user accounts,
random root password, only the bare minimum installed
software, etc.).</p>

<p style="margin-top: 1em">You do not need to run this
command as root.</p>

<p style="margin-top: 1em">The first time this runs it has
to download the template over the network, but this gets
cached (see &quot;CACHING&quot;).</p>

<p style="margin-top: 1em">The name of the output file is
derived from the template name, so above it will be
fedora-20.img. You can change the output filename using the
-o option:</p>

<p style="margin-top: 1em">virt-builder fedora-20 -o
mydisk.img</p>

<p style="margin-top: 1em">You can also use the -o option
to write to existing devices or logical volumes.</p>

<p style="margin-top: 1em">virt-builder fedora-20 --format
qcow2</p>

<p style="margin-top: 1em">As above, but write the output
in qcow2 format to fedora-20.qcow2.</p>

<p style="margin-top: 1em">virt-builder fedora-20 --size
20G</p>

<p style="margin-top: 1em">As above, but the output size
will be 20 GB. The guest OS is resized as it is copied to
the output (automatically, using virt-resize(1)).</p>

<p style="margin-top: 1em">virt-builder fedora-20 --arch
i386</p>

<p style="margin-top: 1em">As above, but using an i386
template, if available.</p>

<p style="margin-top: 1em">Setting the root password <br>
virt-builder fedora-20 --root-password file:/tmp/rootpw</p>

<p style="margin-top: 1em">Create a Fedora 20 image. The
root password is taken from the file /tmp/rootpw.</p>

<p style="margin-top: 1em">Note if you don&rsquo;t set
--root-password then the guest is given a random root
password.</p>

<p style="margin-top: 1em">You can also create user
accounts. See &quot;USERS AND PASSWORDS&quot; below.</p>

<p style="margin-top: 1em">Set the hostname <br>
virt-builder fedora-20 --hostname virt.example.com</p>

<p style="margin-top: 1em">Set the hostname to
&quot;virt.example.com&quot;.</p>

<p style="margin-top: 1em">Installing software <br>
To install packages from the ordinary (guest) software
repository (eg. yum or apt):</p>

<p style="margin-top: 1em">virt-builder fedora-20 --install
&quot;inkscape,@Xfce Desktop&quot;</p>

<p style="margin-top: 1em">(In Fedora, &quot;@&quot; is
used to install groups of packages. On Debian you would
install a meta-package instead.)</p>

<p style="margin-top: 1em">To update the core packages to
the latest version:</p>

<p style="margin-top: 1em">virt-builder debian-7
--update</p>

<p style="margin-top: 1em">For guests which use SELinux,
like Fedora and Red Hat Enterprise Linux, you may need to do
SELinux relabelling after installing or updating packages
(see &quot;SELINUX&quot; below):</p>

<p style="margin-top: 1em">virt-builder fedora-20 --update
--selinux-relabel</p>

<p style="margin-top: 1em">Customizing the installation
<br>
There are many options that let you customize the
installation. These include: --run/--run-command, which run
a shell script or command while the disk image is being
generated <br>
and lets you add or edit files that go into the disk image.
--firstboot/--firstboot-command, which let you add
scripts/commands that are run the first time the guest
boots. <br>
--edit to edit files. --upload to upload files.</p>

<p style="margin-top: 1em">For example:</p>

<p style="margin-top: 1em">cat &lt;&lt;&rsquo;EOF&rsquo;
&gt; /tmp/yum-update.sh <br>
yum -y update <br>
EOF</p>

<p style="margin-top: 1em">virt-builder fedora-20
--firstboot /tmp/yum-update.sh</p>

<p style="margin-top: 1em">or simply:</p>

<p style="margin-top: 1em">virt-builder fedora-20
--firstboot-command &rsquo;yum -y update&rsquo;</p>

<p style="margin-top: 1em">which makes the yum(8)
&quot;update&quot; command run once the first time the guest
boots.</p>

<p style="margin-top: 1em">Or:</p>

<p style="margin-top: 1em">virt-builder fedora-20 --edit
&rsquo;/etc/yum.conf: <br>
s/gpgcheck=1/gpgcheck=0/&rsquo;</p>

<p style="margin-top: 1em">which edits /etc/yum.conf inside
the disk image (during disk image creation, long before
boot).</p>

<p style="margin-top: 1em">You can combine these options,
and have multiple options of all types.</p>

<p style="margin-top: 1em">OPTIONS <br>
--help <br>
Display help.</p>

<p style="margin-top: 1em">--arch ARCHITECTURE <br>
Use the specified architecture for the output image. This
means there must be sources providing the requested template
for the requested architecture.</p>

<p style="margin-top: 1em">See also
&quot;ARCHITECTURE&quot;.</p>

<p style="margin-top: 1em">--attach ISOFILE <br>
During the customization phase, the given disk is attached
to the libguestfs appliance. This is used to provide extra
software repositories or other data for customization.</p>

<p style="margin-top: 1em">You probably want to ensure the
volume(s) or filesystems in the attached disks are labelled
(or use an ISO volume name) so that you can mount them by
label in your run- <br>
scripts:</p>

<p style="margin-top: 1em">mkdir /tmp/mount <br>
mount LABEL=EXTRA /tmp/mount</p>

<p style="margin-top: 1em">You can have multiple --attach
options, and the format can be any disk format (not just an
ISO).</p>

<p style="margin-top: 1em">See also: --run,
&quot;Installing packages at build time from a side
repository&quot;, genisoimage(1), virt-make-fs(1).</p>

<p style="margin-top: 1em">--attach-format FORMAT <br>
Specify the disk format for the next --attach option. The
&quot;FORMAT&quot; is usually &quot;raw&quot; or
&quot;qcow2&quot;. Use &quot;raw&quot; for ISOs.</p>

<p style="margin-top: 1em">--cache DIR <br>
--no-cache <br>
--cache DIR sets the directory to use/check for cached
template files. If not set, defaults to either
$XDG_CACHE_HOME/virt-builder/ or
$HOME/.cache/virt-builder/.</p>

<p style="margin-top: 1em">--no-cache disables template
caching.</p>

<p style="margin-top: 1em">--cache-all-templates <br>
Download all templates to the cache and then exit. See
&quot;CACHING&quot;.</p>

<p style="margin-top: 1em">Note this doesn&rsquo;t cache
everything. More templates might be uploaded. Also this
doesn&rsquo;t cache packages (the --install, --update
options).</p>

<p style="margin-top: 1em">--check-signature <br>
--no-check-signature <br>
Check/don&rsquo;t check the digital signature of the OS
template. The default is to check the signature and exit if
it is not correct. Using --no-check-signature bypasses this
<br>
check.</p>

<p style="margin-top: 1em">See also --fingerprint.</p>

<p style="margin-top: 1em">--colors <br>
--colours <br>
Use ANSI colour sequences to colourize messages. This is the
default when the output is a tty. If the output of the
program is redirected to a file, ANSI colour sequences <br>
are disabled unless you use this option.</p>

<p style="margin-top: 1em">--curl CURL <br>
Specify an alternate curl(1) binary. You can also use this
to add curl parameters, for example to disable https
certificate checks:</p>

<p style="margin-top: 1em">virt-builder --curl &quot;curl
--insecure&quot; [...]</p>

<p style="margin-top: 1em">--delete-cache <br>
Delete the template cache. See &quot;CACHING&quot;.</p>

<p style="margin-top: 1em">--no-delete-on-failure <br>
Don&rsquo;t delete the output file on failure to build. You
can use this to debug failures to run scripts. See
&quot;DEBUGGING BUILDS&quot; for ways to debug images.</p>

<p style="margin-top: 1em">The default is to delete the
output file if virt-builder fails (or, for example, some
script that it runs fails).</p>

<p style="margin-top: 1em">--fingerprint &rsquo;AAAA BBBB
...&rsquo; <br>
Check that the index and templates are signed by the key
with the given fingerprint. (The fingerprint is a long
string, usually written as 10 groups of 4 hexadecimal <br>
digits).</p>

<p style="margin-top: 1em">You can give this option
multiple times. If you have multiple source URLs, then you
can have either no fingerprint, one fingerprint or multiple
fingerprints. If you have <br>
multiple, then each must correspond 1-1 with a source
URL.</p>

<p style="margin-top: 1em">--format qcow2 <br>
--format raw <br>
For ordinary builds, this selects the output format. The
default is raw.</p>

<p style="margin-top: 1em">With --get-kernel this specifies
the input format.</p>

<p style="margin-top: 1em">To create an old-style qcow2
file (for compatibility with RHEL 6 or very old qemu &lt;
1.1), after running virt-builder, use this command:</p>

<p style="margin-top: 1em">qemu-img amend -f qcow2 -o
compat=0.10 output.qcow2</p>

<p style="margin-top: 1em">--get-kernel IMAGE <br>
This option extracts the kernel and initramfs from a
previously built disk image called &quot;IMAGE&quot; (in
fact it works for any VM disk image, not just ones built
using virt- <br>
builder).</p>

<p style="margin-top: 1em">The kernel and initramfs are
written to the current directory, unless you also specify
the --output &quot;outputdir&quot; directory name.</p>

<p style="margin-top: 1em">The format of the disk image is
automatically detected unless you specify it by using the
--format option.</p>

<p style="margin-top: 1em">In the case where the guest
contains multiple kernels, the one with the highest version
number is chosen. To extract arbitrary kernels from the disk
image, see guestfish(1). <br>
To extract the entire /boot directory of a guest, see
virt-copy-out(1).</p>

<p style="margin-top: 1em">--gpg GPG <br>
Specify an alternate gpg(1) (GNU Privacy Guard) binary. You
can also use this to add gpg parameters, for example to
specify an alternate home directory:</p>

<p style="margin-top: 1em">virt-builder --gpg &quot;gpg
--homedir /tmp&quot; [...]</p>

<p style="margin-top: 1em">-l <br>
--list <br>
--list --list-format format <br>
--list --long <br>
List available templates.</p>

<p style="margin-top: 1em">It is possible to choose with
--list-format the output format for the list templates:</p>

<p style="margin-top: 1em">short <br>
The default format, prints only the template identifier and,
next to it, its short description.</p>

<p style="margin-top: 1em">long <br>
Prints a textual list with the details of the available
sources, followed by the details of the available
templates.</p>

<p style="margin-top: 1em">json <br>
Prints a JSON object with the details of the available
sources and the details of the available templates.</p>

<p style="margin-top: 1em">The &quot;version&quot; key in
the main object represents the &quot;compatibility
version&quot;, and it is bumped every time the resulting
JSON output is incompatible with the previous <br>
versions (for example the structure has changed, or
non-optional keys are no more present).</p>

<p style="margin-top: 1em">--long is a shorthand for the
&quot;long&quot; format.</p>

<p style="margin-top: 1em">See also: --source, --notes,
&quot;SOURCES OF TEMPLATES&quot;.</p>

<p style="margin-top: 1em">--machine-readable <br>
This option is used to make the output more machine friendly
when being parsed by other programs. See &quot;MACHINE
READABLE OUTPUT&quot; below.</p>

<p style="margin-top: 1em">-m MB <br>
--memsize MB <br>
Change the amount of memory allocated to --run scripts.
Increase this if you find that --run scripts or the
--install option are running out of memory.</p>

<p style="margin-top: 1em">The default can be found with
this command:</p>

<p style="margin-top: 1em">guestfish get-memsize</p>

<p style="margin-top: 1em">--network <br>
--no-network <br>
Enable or disable network access from the guest during the
installation.</p>

<p style="margin-top: 1em">Enabled is the default. Use
--no-network to disable access.</p>

<p style="margin-top: 1em">The network only allows outgoing
connections and has other minor limitations. See
&quot;NETWORK&quot; in virt-rescue(1).</p>

<p style="margin-top: 1em">If you use --no-network then
certain other options such as --install will not work.</p>

<p style="margin-top: 1em">This does not affect whether the
guest can access the network once it has been booted,
because that is controlled by your hypervisor or cloud
environment and has nothing to <br>
do with virt-builder.</p>

<p style="margin-top: 1em">Generally speaking you should
not use --no-network. But here are some reasons why you
might want to:</p>

<p style="margin-top: 1em">1. Because the libguestfs
backend that you are using doesn&rsquo;t support the
network. (See: &quot;BACKEND&quot; in guestfs(3)).</p>

<p style="margin-top: 1em">2. Any software you need to
install comes from an attached ISO, so you don&rsquo;t need
the network.</p>

<p style="margin-top: 1em">3. You don&rsquo;t want
untrusted guest code trying to access your host network when
running virt-builder. This is particularly an issue when you
don&rsquo;t trust the source of the <br>
operating system templates. (See &quot;SECURITY&quot;
below).</p>

<p style="margin-top: 1em">4. You don&rsquo;t have a host
network (eg. in secure/restricted environments).</p>

<p style="margin-top: 1em">--no-sync <br>
Do not sync the output file on exit.</p>

<p style="margin-top: 1em">Virt-builder fsync&rsquo;s the
output file or disk image when it exits.</p>

<p style="margin-top: 1em">The reason is that
qemu/KVM&rsquo;s default caching mode is &quot;none&quot; or
&quot;directsync&quot;, both of which bypass the host page
cache. Therefore these would not work correctly if you <br>
immediately started the guest after running virt-builder -
they would not see the complete output file. (Note that you
should not use these caching modes - they are <br>
fundamentally broken for this and other reasons.)</p>

<p style="margin-top: 1em">If you are not using these
broken caching modes, you can use --no-sync to avoid this
unnecessary sync and gain considerable extra
performance.</p>

<p style="margin-top: 1em">--notes os-version <br>
List any notes associated with this guest, then exit (this
does not do the install).</p>

<p style="margin-top: 1em">-o filename <br>
--output filename <br>
Write the output to filename. If you don&rsquo;t specify
this option, then the output filename is generated by taking
the &quot;os-version&quot; string and adding
&quot;.img&quot; (for raw format) or <br>
&quot;.qcow2&quot; (for qcow2 format).</p>

<p style="margin-top: 1em">Note that the output filename
could be a device, partition or logical volume.</p>

<p style="margin-top: 1em">When used with --get-kernel,
this option specifies the output directory.</p>

<p style="margin-top: 1em">--print-cache <br>
Print information about the template cache. See
&quot;CACHING&quot;.</p>

<p style="margin-top: 1em">-q <br>
--quiet <br>
Don&rsquo;t print ordinary progress messages.</p>

<p style="margin-top: 1em">--size SIZE <br>
Select the size of the output disk, where the size can be
specified using common names such as &quot;32G&quot; (32
gigabytes) etc.</p>

<p style="margin-top: 1em">Virt-builder will resize
filesystems inside the disk image automatically.</p>

<p style="margin-top: 1em">If the size is not specified,
then one of two things happens. If the output is a file,
then the size is the same as the template. If the output is
a device, partition, etc <br>
then the size of that device is used.</p>

<p style="margin-top: 1em">To specify size in bytes, the
number must be followed by the lowercase letter b, eg:
&quot;--size&Acirc;&nbsp;10737418240b&quot;.</p>

<p style="margin-top: 1em">--smp N <br>
Enable N &acirc;&yen; 2 virtual CPUs for --run scripts to
use.</p>

<p style="margin-top: 1em">--source URL <br>
Set the source URL to look for indexes.</p>

<p style="margin-top: 1em">You can give this option
multiple times to specify multiple sources.</p>

<p style="margin-top: 1em">See also &quot;SOURCES OF
TEMPLATES&quot; below.</p>

<p style="margin-top: 1em">Note that you should not point
--source to sources that you don&rsquo;t trust (unless the
source is signed by someone you do trust). See also the
--no-network option.</p>

<p style="margin-top: 1em">--no-warn-if-partition <br>
Do not emit a warning if the output device is a partition.
This warning avoids a common user error when writing to a
USB key or external drive, when you should normally <br>
write to the whole device (--output&Acirc;&nbsp;/dev/sdX),
not to a partition on the device
(--output&Acirc;&nbsp;/dev/sdX1). Use this option to
suppress this warning.</p>

<p style="margin-top: 1em">-v <br>
--verbose <br>
Enable debug messages and/or produce verbose output.</p>

<p style="margin-top: 1em">When reporting bugs, use this
option and attach the complete output to your bug
report.</p>

<p style="margin-top: 1em">-V <br>
--version <br>
Display version number and exit.</p>

<p style="margin-top: 1em">-x Enable tracing of libguestfs
API calls.</p>

<p style="margin-top: 1em">Customization options <br>
--chmod PERMISSIONS:FILE <br>
Change the permissions of &quot;FILE&quot; to
&quot;PERMISSIONS&quot;.</p>

<p style="margin-top: 1em">Note: &quot;PERMISSIONS&quot; by
default would be decimal, unless you prefix it with 0 to get
octal, ie. use 0700 not 700.</p>

<p style="margin-top: 1em">--commands-from-file FILENAME
<br>
Read the customize commands from a file, one (and its
arguments) each line.</p>

<p style="margin-top: 1em">Each line contains a single
customization command and its arguments, for example:</p>

<p style="margin-top: 1em">delete /some/file <br>
install some-package <br>
password some-user:password:its-new-password</p>

<p style="margin-top: 1em">Empty lines are ignored, and
lines starting with &quot;#&quot; are comments and are
ignored as well. Furthermore, arguments can be spread across
multiple lines, by adding a &quot; <br>
(continuation character) at the of a line, for example</p>

<p style="margin-top: 1em">edit /some/file:
s/^OPT=.*/OPT=ok/</p>

<p style="margin-top: 1em">The commands are handled in the
same order as they are in the file, as if they were
specified as --delete /some/file on the command line.</p>

<p style="margin-top: 1em">--copy SOURCE:DEST <br>
Copy files or directories recursively inside the guest.</p>

<p style="margin-top: 1em">Wildcards cannot be used.</p>

<p style="margin-top: 1em">--copy-in LOCALPATH:REMOTEDIR
<br>
Copy local files or directories recursively into the disk
image, placing them in the directory &quot;REMOTEDIR&quot;
(which must exist).</p>

<p style="margin-top: 1em">Wildcards cannot be used.</p>

<p style="margin-top: 1em">--delete PATH <br>
Delete a file from the guest. Or delete a directory (and all
its contents, recursively).</p>

<p style="margin-top: 1em">You can use shell glob
characters in the specified path. Be careful to escape glob
characters from the host shell, if that is required. For
example:</p>

<p style="margin-top: 1em">virt-customize --delete
&rsquo;/var/log/*.log&rsquo;.</p>

<p style="margin-top: 1em">See also: --upload, --scrub.</p>

<p style="margin-top: 1em">--edit FILE:EXPR <br>
Edit &quot;FILE&quot; using the Perl expression
&quot;EXPR&quot;.</p>

<p style="margin-top: 1em">Be careful to properly quote the
expression to prevent it from being altered by the
shell.</p>

<p style="margin-top: 1em">Note that this option is only
available when Perl 5 is installed.</p>

<p style="margin-top: 1em">See &quot;NON-INTERACTIVE
EDITING&quot; in virt-edit(1).</p>

<p style="margin-top: 1em">--firstboot SCRIPT <br>
Install &quot;SCRIPT&quot; inside the guest, so that when
the guest first boots up, the script runs (as root, late in
the boot process).</p>

<p style="margin-top: 1em">The script is automatically
chmod +x after installation in the guest.</p>

<p style="margin-top: 1em">The alternative version
--firstboot-command is the same, but it conveniently wraps
the command up in a single line script for you.</p>

<p style="margin-top: 1em">You can have multiple
--firstboot options. They run in the same order that they
appear on the command line.</p>

<p style="margin-top: 1em">Please take a look at
&quot;FIRST BOOT SCRIPTS&quot; for more information and
caveats about the first boot scripts.</p>

<p style="margin-top: 1em">See also --run.</p>

<p style="margin-top: 1em">--firstboot-command
&rsquo;CMD+ARGS&rsquo; <br>
Run command (and arguments) inside the guest when the guest
first boots up (as root, late in the boot process).</p>

<p style="margin-top: 1em">You can have multiple
--firstboot options. They run in the same order that they
appear on the command line.</p>

<p style="margin-top: 1em">Please take a look at
&quot;FIRST BOOT SCRIPTS&quot; for more information and
caveats about the first boot scripts.</p>

<p style="margin-top: 1em">See also --run.</p>

<p style="margin-top: 1em">--firstboot-install PKG,PKG..
<br>
Install the named packages (a comma-separated list). These
are installed when the guest first boots using the
guest&rsquo;s package manager (eg. apt, yum, etc.) and the
guest&rsquo;s <br>
network connection.</p>

<p style="margin-top: 1em">For an overview on the different
ways to install packages, see &quot;INSTALLING
PACKAGES&quot;.</p>

<p style="margin-top: 1em">--hostname HOSTNAME <br>
Set the hostname of the guest to &quot;HOSTNAME&quot;. You
can use a dotted hostname.domainname (FQDN) if you want.</p>

<p style="margin-top: 1em">--install PKG,PKG.. <br>
Install the named packages (a comma-separated list). These
are installed during the image build using the guest&rsquo;s
package manager (eg. apt, yum, etc.) and the host&rsquo;s
network <br>
connection.</p>

<p style="margin-top: 1em">For an overview on the different
ways to install packages, see &quot;INSTALLING
PACKAGES&quot;.</p>

<p style="margin-top: 1em">See also --update,
--uninstall.</p>

<p style="margin-top: 1em">--link TARGET:LINK[:LINK..] <br>
Create symbolic link(s) in the guest, starting at
&quot;LINK&quot; and pointing at &quot;TARGET&quot;.</p>

<p style="margin-top: 1em">--mkdir DIR <br>
Create a directory in the guest.</p>

<p style="margin-top: 1em">This uses
&quot;mkdir&Acirc;&nbsp;-p&quot; so any intermediate
directories are created, and it also works if the directory
already exists.</p>

<p style="margin-top: 1em">--move SOURCE:DEST <br>
Move files or directories inside the guest.</p>

<p style="margin-top: 1em">Wildcards cannot be used.</p>

<p style="margin-top: 1em">--no-logfile <br>
Scrub &quot;builder.log&quot; (log file from build commands)
from the image after building is complete. If you
don&rsquo;t want to reveal precisely how the image was
built, use this option.</p>

<p style="margin-top: 1em">See also: &quot;LOG
FILE&quot;.</p>

<p style="margin-top: 1em">--password USER:SELECTOR <br>
Set the password for &quot;USER&quot;. (Note this option
does not create the user account).</p>

<p style="margin-top: 1em">See &quot;USERS AND
PASSWORDS&quot; for the format of the &quot;SELECTOR&quot;
field, and also how to set up user accounts.</p>

<p style="margin-top: 1em">--password-crypto
md5|sha256|sha512 <br>
When the virt tools change or set a password in the guest,
this option sets the password encryption of that password to
&quot;md5&quot;, &quot;sha256&quot; or
&quot;sha512&quot;.</p>

<p style="margin-top: 1em">&quot;sha256&quot; and
&quot;sha512&quot; require glibc &acirc;&yen; 2.7 (check
crypt(3) inside the guest).</p>

<p style="margin-top: 1em">&quot;md5&quot; will work with
relatively old Linux guests (eg. RHEL 3), but is not secure
against modern attacks.</p>

<p style="margin-top: 1em">The default is
&quot;sha512&quot; unless libguestfs detects an old guest
that didn&rsquo;t have support for SHA-512, in which case it
will use &quot;md5&quot;. You can override libguestfs by
<br>
specifying this option.</p>

<p style="margin-top: 1em">Note this does not change the
default password encryption used by the guest when you
create new user accounts inside the guest. If you want to do
that, then you should use <br>
the --edit option to modify
&quot;/etc/sysconfig/authconfig&quot; (Fedora, RHEL) or
&quot;/etc/pam.d/common-password&quot; (Debian, Ubuntu).</p>

<p style="margin-top: 1em">--root-password SELECTOR <br>
Set the root password.</p>

<p style="margin-top: 1em">See &quot;USERS AND
PASSWORDS&quot; for the format of the &quot;SELECTOR&quot;
field, and also how to set up user accounts.</p>

<p style="margin-top: 1em">Note: In virt-builder, if you
don&rsquo;t set --root-password then the guest is given a
random root password.</p>

<p style="margin-top: 1em">--run SCRIPT <br>
Run the shell script (or any program) called
&quot;SCRIPT&quot; on the disk image. The script runs
virtualized inside a small appliance, chrooted into the
guest filesystem.</p>

<p style="margin-top: 1em">The script is automatically
chmod +x.</p>

<p style="margin-top: 1em">If libguestfs supports it then a
limited network connection is available but it only allows
outgoing network connections. You can also attach data disks
(eg. ISO files) as <br>
another way to provide data (eg. software packages) to the
script without needing a network connection (--attach). You
can also upload data files (--upload).</p>

<p style="margin-top: 1em">You can have multiple --run
options. They run in the same order that they appear on the
command line.</p>

<p style="margin-top: 1em">See also: --firstboot, --attach,
--upload.</p>

<p style="margin-top: 1em">--run-command
&rsquo;CMD+ARGS&rsquo; <br>
Run the command and arguments on the disk image. The command
runs virtualized inside a small appliance, chrooted into the
guest filesystem.</p>

<p style="margin-top: 1em">If libguestfs supports it then a
limited network connection is available but it only allows
outgoing network connections. You can also attach data disks
(eg. ISO files) as <br>
another way to provide data (eg. software packages) to the
script without needing a network connection (--attach). You
can also upload data files (--upload).</p>

<p style="margin-top: 1em">You can have multiple
--run-command options. They run in the same order that they
appear on the command line.</p>

<p style="margin-top: 1em">See also: --firstboot, --attach,
--upload.</p>

<p style="margin-top: 1em">--scrub FILE <br>
Scrub a file from the guest. This is like --delete except
that:</p>

<p style="margin-top: 1em">&Acirc;&middot; It scrubs the
data so a guest could not recover it.</p>

<p style="margin-top: 1em">&Acirc;&middot; It cannot delete
directories, only regular files.</p>

<p style="margin-top: 1em">--selinux-relabel <br>
Relabel files in the guest so that they have the correct
SELinux label.</p>

<p style="margin-top: 1em">This will attempt to relabel
files immediately, but if the operation fails this will
instead touch /.autorelabel on the image to schedule a
relabel operation for the next <br>
time the image boots.</p>

<p style="margin-top: 1em">You should only use this option
for guests which support SELinux.</p>

<p style="margin-top: 1em">--sm-attach SELECTOR <br>
Attach to a pool using &quot;subscription-manager&quot;.</p>

<p style="margin-top: 1em">See
&quot;SUBSCRIPTION-MANAGER&quot; for the format of the
&quot;SELECTOR&quot; field.</p>

<p style="margin-top: 1em">--sm-credentials SELECTOR <br>
Set the credentials for
&quot;subscription-manager&quot;.</p>

<p style="margin-top: 1em">See
&quot;SUBSCRIPTION-MANAGER&quot; for the format of the
&quot;SELECTOR&quot; field.</p>

<p style="margin-top: 1em">--sm-register <br>
Register the guest using
&quot;subscription-manager&quot;.</p>

<p style="margin-top: 1em">This requires credentials being
set using --sm-credentials.</p>

<p style="margin-top: 1em">--sm-remove <br>
Remove all the subscriptions from the guest using
&quot;subscription-manager&quot;.</p>

<p style="margin-top: 1em">--sm-unregister <br>
Unregister the guest using
&quot;subscription-manager&quot;.</p>

<p style="margin-top: 1em">--ssh-inject USER[:SELECTOR]
<br>
Inject an ssh key so the given &quot;USER&quot; will be able
to log in over ssh without supplying a password. The
&quot;USER&quot; must exist already in the guest.</p>

<p style="margin-top: 1em">See &quot;SSH KEYS&quot; for the
format of the &quot;SELECTOR&quot; field.</p>

<p style="margin-top: 1em">You can have multiple
--ssh-inject options, for different users and also for more
keys for each user.</p>

<p style="margin-top: 1em">--timezone TIMEZONE <br>
Set the default timezone of the guest to
&quot;TIMEZONE&quot;. Use a location string like
&quot;Europe/London&quot;</p>

<p style="margin-top: 1em">--touch FILE <br>
This command performs a touch(1)-like operation on
&quot;FILE&quot;.</p>

<p style="margin-top: 1em">--truncate FILE <br>
This command truncates &quot;FILE&quot; to a zero-length
file. The file must exist already.</p>

<p style="margin-top: 1em">--truncate-recursive PATH <br>
This command recursively truncates all files under
&quot;PATH&quot; to zero-length.</p>

<p style="margin-top: 1em">--uninstall PKG,PKG.. <br>
Uninstall the named packages (a comma-separated list). These
are removed during the image build using the guest&rsquo;s
package manager (eg. apt, yum, etc.). Dependent packages
<br>
may also need to be uninstalled to satisfy the request.</p>

<p style="margin-top: 1em">See also --install,
--update.</p>

<p style="margin-top: 1em">--update <br>
Do the equivalent of &quot;yum update&quot;, &quot;apt-get
upgrade&quot;, or whatever command is required to update the
packages already installed in the template to their latest
versions.</p>

<p style="margin-top: 1em">See also --install,
--uninstall.</p>

<p style="margin-top: 1em">--upload FILE:DEST <br>
Upload local file &quot;FILE&quot; to destination
&quot;DEST&quot; in the disk image. File owner and
permissions from the original are preserved, so you should
set them to what you want them to <br>
be in the disk image.</p>

<p style="margin-top: 1em">&quot;DEST&quot; could be the
final filename. This can be used to rename the file on
upload.</p>

<p style="margin-top: 1em">If &quot;DEST&quot; is a
directory name (which must already exist in the guest) then
the file is uploaded into that directory, and it keeps the
same name as on the local filesystem.</p>

<p style="margin-top: 1em">See also: --mkdir, --delete,
--scrub.</p>

<p style="margin-top: 1em">--write FILE:CONTENT <br>
Write &quot;CONTENT&quot; to &quot;FILE&quot;.</p>

<p style="margin-top: 1em">REFERENCE <br>
INSTALLING PACKAGES <br>
There are several approaches to installing packages or
applications in the guest which have different
trade-offs.</p>

<p style="margin-top: 1em">Installing packages at build
time</p>

<p style="margin-top: 1em">If the guest OS you are
installing is similar to the host OS (eg. both are Linux),
and if libguestfs supports network connections, then you can
use --install to install packages <br>
like this:</p>

<p style="margin-top: 1em">virt-builder fedora-20 --install
inkscape</p>

<p style="margin-top: 1em">This uses the guest&rsquo;s
package manager and the host&rsquo;s network connection.</p>

<p style="margin-top: 1em">Updating packages at build
time</p>

<p style="margin-top: 1em">To update the core set of
packages in the template at build time:</p>

<p style="margin-top: 1em">virt-builder fedora-20
--update</p>

<p style="margin-top: 1em">Most of the templates that ship
with virt-builder come with a very minimal selection of
packages (known as a &quot;JEOS&quot; or &quot;Just Enough
Operating System&quot;), which are up to date at <br>
the time the template is created, but could be out of date
by the time you come to install an OS from the template.
This option updates those template packages.</p>

<p style="margin-top: 1em">Installing packages at first
boot</p>

<p style="margin-top: 1em">Another option is to install the
packages when the guest first boots:</p>

<p style="margin-top: 1em">virt-builder fedora-20
--firstboot-install inkscape</p>

<p style="margin-top: 1em">This uses the guest&rsquo;s
package manager and the guest&rsquo;s network
connection.</p>

<p style="margin-top: 1em">The downsides are that it will
take the guest a lot longer to boot first time, and
there&rsquo;s nothing much you can do if package
installation fails (eg. if a network problem means <br>
the guest can&rsquo;t reach the package repositories).</p>

<p style="margin-top: 1em">Installing packages at build
time from a side repository</p>

<p style="margin-top: 1em">If the software you want to
install is not available in the main package repository of
the guest, then you can add a side repository. Usually this
is presented as an ISO (CD <br>
disk image) file containing extra packages.</p>

<p style="margin-top: 1em">You can create the disk image
using either genisoimage(1) or virt-make-fs(1). For
genisoimage, use a command like this:</p>

<p style="margin-top: 1em">genisoimage -o
extra-packages.iso -R -J -V EXTRA cdcontents/</p>

<p style="margin-top: 1em">Create a script that mounts the
ISO and sets up the repository. For yum, create
/tmp/install.sh containing:</p>

<p style="margin-top: 1em">mkdir /tmp/mount <br>
mount LABEL=EXTRA /tmp/mount</p>

<p style="margin-top: 1em">cat &lt;&lt;&rsquo;EOF&rsquo;
&gt; /etc/yum.repos.d/extra.repo <br>
[extra] <br>
name=extra <br>
baseurl=file:///tmp/mount <br>
enabled=1 <br>
EOF</p>

<p style="margin-top: 1em">yum -y install
famousdatabase</p>

<p style="margin-top: 1em">For apt, create /tmp/install.sh
containing:</p>

<p style="margin-top: 1em">mkdir /tmp/mount <br>
mount LABEL=EXTRA /tmp/mount</p>

<p style="margin-top: 1em">apt-cdrom -d=/tmp/mount add <br>
apt-get -y install famousdatabase</p>

<p style="margin-top: 1em">Use the --attach option to
attach the CD / disk image and the --run option to run the
script:</p>

<p style="margin-top: 1em">virt-builder fedora-20 --attach
extra-packages.iso --run /tmp/install.sh</p>

<p style="margin-top: 1em">USERS AND PASSWORDS <br>
The --root-password option is used to change the root
password (otherwise a random password is used). This option
takes a password &quot;SELECTOR&quot; in one of the
following formats:</p>

<p style="margin-top: 1em">--root-password file:FILENAME
<br>
Read the root password from &quot;FILENAME&quot;. The whole
first line of this file is the replacement password. Any
other lines are ignored. You should create the file with
mode <br>
0600 to ensure no one else can read it.</p>

<p style="margin-top: 1em">--root-password
password:PASSWORD <br>
Set the root password to the literal string
&quot;PASSWORD&quot;.</p>

<p style="margin-top: 1em">Note: this is not secure since
any user on the same machine can see the cleartext password
using ps(1).</p>

<p style="margin-top: 1em">--root-password random <br>
Choose a random password, which is printed on stdout. The
password has approximately 120 bits of randomness.</p>

<p style="margin-top: 1em">This is the default.</p>

<p style="margin-top: 1em">--root-password disabled <br>
The root account password is disabled. This is like putting
&quot;*&quot; in the password field.</p>

<p style="margin-top: 1em">--root-password
locked:file:FILENAME <br>
--root-password locked:password:PASSWORD <br>
--root-password locked:random <br>
The root account is locked, but a password is placed on the
account. If first unlocked (using &quot;passwd -u&quot;)
then logins will use the given password.</p>

<p style="margin-top: 1em">--root-password locked <br>
--root-password locked:disabled <br>
The root account is locked and password is disabled.</p>

<p style="margin-top: 1em">Creating user accounts</p>

<p style="margin-top: 1em">To create user accounts, use the
useradd(8) command with --firstboot-command like this:</p>

<p style="margin-top: 1em">virt-builder --firstboot-command
&rsquo;useradd -m -p &quot;&quot; rjones ; chage -d 0
rjones&rsquo;</p>

<p style="margin-top: 1em">The above command will create an
&quot;rjones&quot; account with no password, and force the
user to set a password when they first log in. There are
other ways to manage passwords, see <br>
useradd(8) for details.</p>

<p style="margin-top: 1em">KEYBOARD LAYOUT <br>
Because there are so many different ways to set the keyboard
layout in Linux distributions, virt-builder does not yet
attempt to have a simple command line option. This section
<br>
describes how to set the keyboard for some common Linux
distributions.</p>

<p style="margin-top: 1em">Keyboard layout with systemd</p>

<p style="margin-top: 1em">For distros that use systemd
&quot;localectl&quot;, use a command like this:</p>

<p style="margin-top: 1em">virt-builder fedora-20
--firstboot-command &rsquo;localectl set-keymap
uk&rsquo;</p>

<p style="margin-top: 1em">See localectl(1) and
https://www.happyassassin.net/2013/11/23/keyboard-layouts-in-fedora-20-and-previously/
for more details.</p>

<p style="margin-top: 1em">Keyboard layout using
/etc/sysconfig/keyboard</p>

<p style="margin-top: 1em">For RHEL &acirc;&curren; 6,
Fedora &acirc;&curren; 18 and similar, upload or modify the
keyboard configuration file using the --upload, --write or
--edit options. For example:</p>

<p style="margin-top: 1em">virt-builder centos-6 --edit
&rsquo;/etc/sysconfig/keyboard:
s/^KEYTABLE=.*/KEYTABLE=&quot;uk&quot;/&rsquo;</p>

<p style="margin-top: 1em">The format of this file can be
found documented in many places online.</p>

<p style="margin-top: 1em">Keyboard layout with
Debian-derived distros</p>

<p style="margin-top: 1em">For Debian-derived distros using
/etc/default/keyboard, upload or modify the keyboard file
using the --upload, --write or --edit options. For
example:</p>

<p style="margin-top: 1em">virt-builder debian-7 --edit
&rsquo;/etc/default/keyboard:
s/^XKBLAYOUT=.*/XKBLAYOUT=&quot;gb&quot;/&rsquo;</p>

<p style="margin-top: 1em">See
https://wiki.debian.org/Keyboard.</p>

<p style="margin-top: 1em">LANGUAGE <br>
Most Linux distributions support multiple locale settings so
that you can have guest messages printed in another language
such as Russian.</p>

<p style="margin-top: 1em">However there is no single
setting which controls this, since extra packages may need
to be installed to support console and X fonts, and keyboard
input methods. The packages <br>
required, and their configuration is highly distro-specific,
and it is outside the scope of virt-builder to do this.</p>

<p style="margin-top: 1em">This section contains examples
for some common Linux distributions.</p>

<p style="margin-top: 1em">Setting Japanese in Fedora
20</p>

<p style="margin-top: 1em">virt-builder fedora-20 --size
20G --update --install @japanese-support --install @xfce
--install xorg-x11-server-Xorg,xorg-x11-drivers,rsyslog
--link
/usr/lib/systemd/system/graphical.target:/etc/systemd/system/default.target
--firstboot-command &rsquo;localectl set-locale
LANG=ja_JP.utf8&rsquo; --firstboot-command &rsquo;localectl
set-keymap jp&rsquo; --firstboot-command &rsquo;systemctl
isolate graphical.target&rsquo;</p>

<p style="margin-top: 1em">Setting Japanese in Debian 7
(Wheezy)</p>

<p style="margin-top: 1em">Note that although this enables
Japanese in the text console too, it is unlikely that you
will see properly rendered Japanese there. However Japanese
is properly rendered in X <br>
applications and terminals.</p>

<p style="margin-top: 1em">pkgs=locales,xfce4,
ibus,ibus-anthy, ttf-sazanami-gothic,ttf-sazanami-mincho,
fonts-takao-mincho,
xfonts-intl-japanese,xfonts-intl-japanese-big,
iceweasel-l10n-ja,manpages-ja</p>

<p style="margin-top: 1em">virt-builder debian-7 --size 20G
--install $pkgs --edit &rsquo;/etc/inittab:
s,^#([1-9].*respawn.*/sbin/getty.*),$1,&rsquo; --edit
&rsquo;/etc/locale.gen: s,^#ja,ja,&rsquo; --write
&rsquo;/etc/default/locale:LANG=&quot;ja_JP.UTF-8&quot;&rsquo;
--run-command &quot;locale-gen&quot;</p>

<p style="margin-top: 1em">LOG FILE <br>
Scripts and package installation that runs at build time
(--run, --run-command, --install, --update, but not
firstboot) is logged in one of the following locations:</p>

<p style="margin-top: 1em">/tmp/builder.log <br>
On Linux, BSD and other guests. i l d e</p>

<p style="margin-top: 1em">C:Tempr . l o g <br>
On Windows, DOS guests.</p>

<p style="margin-top: 1em">/builder.log <br>
If /tmp or C:Temp is missing.</p>

<p style="margin-top: 1em">If you don&rsquo;t want the log
file to appear in the final image, then use the --no-logfile
command line option.</p>

<p style="margin-top: 1em">SSH KEYS <br>
The --ssh-inject option is used to inject ssh keys for users
in the guest, so they can login without supplying a
password.</p>

<p style="margin-top: 1em">The &quot;SELECTOR&quot; part of
the option value is optional; in this case, --ssh-inject
&quot;USER&quot; means that we look in the current
user&rsquo;s ~/.ssh directory to find the default public ID
<br>
file. That key is uploaded. &quot;default public ID&quot; is
the default_ID_file file described in ssh-copy-id(1).</p>

<p style="margin-top: 1em">If specified, the
&quot;SELECTOR&quot; can be in one of the following
formats:</p>

<p style="margin-top: 1em">--ssh-inject USER:file:FILENAME
<br>
Read the ssh key from FILENAME. FILENAME is usually a .pub
file.</p>

<p style="margin-top: 1em">--ssh-inject
USER:string:KEY_STRING <br>
Use the specified &quot;KEY_STRING&quot;.
&quot;KEY_STRING&quot; is usually a public string like
ssh-rsa AAAA.... user@localhost.</p>

<p style="margin-top: 1em">In any case, the ~USER/.ssh
directory and the ~USER/.ssh/authorized_keys file will be
created if not existing already.</p>

<p style="margin-top: 1em">FIRST BOOT SCRIPTS <br>
The --firstboot and --firstboot-command options allow you to
execute commands at the first boot of the guest. To do so,
an init script for the guest init system is installed, <br>
which takes care of running all the added scripts and
commands.</p>

<p style="margin-top: 1em">Supported operating systems
are:</p>

<p style="margin-top: 1em">Linux <br>
Init systems supported are: systemd, System-V init (known
also as sysvinit), and Upstart (using the System-V
scripts).</p>

<p style="margin-top: 1em">Note that usually init scripts
run as root, but with a more limited environment than what
could be available from a normal shell: for example, $HOME
may be unset or empty.</p>

<p style="margin-top: 1em">The output of the first boot
scripts is available in the guest as
~root/virt-sysprep-firstboot.log.</p>

<p style="margin-top: 1em">Windows <br>
rhsrvany.exe, available from sources at
https://github.com/rwmjones/rhsrvany, is installed to run
the first boot scripts. It is required, and the setup of
first boot scripts <br>
will fail if it is not present.</p>

<p style="margin-top: 1em">rhsrvany.exe is copied from the
location pointed to by the &quot;VIRT_TOOLS_DATA_DIR&quot;
environment variable; if not set, a compiled-in default will
be used (something like <br>
/usr/share/virt-tools).</p>

<p style="margin-top: 1em">The output of the first boot
scripts is available in the guest as C:Program
Filesatrstboot.txt.</p>

<p style="margin-top: 1em">SUBSCRIPTION-MANAGER <br>
It is possible to automate the registration and attaching of
the system using &quot;subscription-manager&quot;. This is
typical on Red Hat Enterprise Linux guests. There are few
options <br>
which ease this process, avoid executing commands manually
and exposing passwords on command line.</p>

<p style="margin-top: 1em">--sm-register starts the
registration process, and requires --sm-credentials to be
specified; the format of the &quot;SELECTOR&quot; of
--sm-credentials is one of the following formats:</p>

<p style="margin-top: 1em">--sm-credentials
USER:file:FILENAME <br>
Read the password for the specified &quot;USER&quot; from
FILENAME.</p>

<p style="margin-top: 1em">--sm-credentials
USER:password:PASSWORD <br>
Use the literal string &quot;PASSWORD&quot; for the
specified &quot;USER&quot;.</p>

<p style="margin-top: 1em">--sm-attach attaches the system
to subscriptions; the format of its &quot;SELECTOR&quot; is
one of the following:</p>

<p style="margin-top: 1em">--sm-attach auto <br>
&quot;subscription-manager&quot; attaches to the
best-fitting subscriptions for the system.</p>

<p style="margin-top: 1em">--sm-attach file:FILENAME <br>
Read the pool ID from FILENAME.</p>

<p style="margin-top: 1em">--sm-attach pool:POOL <br>
Use the literal string &quot;POOL&quot; as pool ID.</p>

<p style="margin-top: 1em">--sm-remove removes all the
subscriptions from the guest, while --sm-unregister
completely unregister the system.</p>

<p style="margin-top: 1em">INSTALLATION PROCESS <br>
When you invoke virt-builder, installation proceeds as
follows:</p>

<p style="margin-top: 1em">&Acirc;&middot; The template
image is downloaded.</p>

<p style="margin-top: 1em">If the template image is present
in the cache, the cached version is used instead. (See
&quot;CACHING&quot;).</p>

<p style="margin-top: 1em">&Acirc;&middot; The template
signature is checked.</p>

<p style="margin-top: 1em">&Acirc;&middot; The template is
uncompressed to a tmp file.</p>

<p style="margin-top: 1em">&Acirc;&middot; The template
image is resized into the destination, using
virt-resize(1).</p>

<p style="margin-top: 1em">&Acirc;&middot; Extra disks are
attached (--attach).</p>

<p style="margin-top: 1em">&Acirc;&middot; A new random
seed is generated for the guest.</p>

<p style="margin-top: 1em">&Acirc;&middot; Guest
customization is performed, in the order specified on the
command line.</p>

<p style="margin-top: 1em">&Acirc;&middot; SELinux
relabelling is done (--selinux-relabel).</p>

<p style="margin-top: 1em">IMPORTING THE DISK IMAGE <br>
Importing into libvirt</p>

<p style="margin-top: 1em">Import the disk image into
libvirt using virt-install(1) --import option.</p>

<p style="margin-top: 1em">virt-install --import --name
guest --ram 2048 --disk path=disk.img,format=raw
--os-variant fedora20</p>

<p style="margin-top: 1em">Notes:</p>

<p style="margin-top: 1em">1. You must specify the correct
format. The format is &quot;raw&quot; unless you used
virt-builder&rsquo;s --format option.</p>

<p style="margin-top: 1em">2. --os-variant is highly
recommended, because it will present optimum devices to
enable the guest to run most efficiently. To get a list of
all variants, do:</p>

<p style="margin-top: 1em">osinfo-query os</p>

<p style="margin-top: 1em">The above tool is provided by
libosinfo package.</p>

<p style="margin-top: 1em">3. You can run virt-install as
root or non-root. Each works slightly differently because
libvirt manages a different set of virtual machines for each
user. In particular virt- <br>
manager normally shows the root-owned VMs, whereas Boxes
shows the user-owned VMs, and other tools probably work
differently as well.</p>

<p style="margin-top: 1em">Importing into OpenStack</p>

<p style="margin-top: 1em">Import the image into Glance
(the OpenStack image store) by doing:</p>

<p style="margin-top: 1em">glance image-create --name
fedora-20-image --file fedora-20.img --disk-format raw
--container-format bare --is-public True</p>

<p style="margin-top: 1em">The --file parameter is the
virt-builder-generated disk image. It should match
virt-builder&rsquo;s --output option. The --disk-format
parameter should match virt-builder&rsquo;s --format <br>
option (or &quot;raw&quot; if you didn&rsquo;t use that
option). The --container-format should always be
&quot;bare&quot; since virt-builder doesn&rsquo;t put images
into containers.</p>

<p style="margin-top: 1em">You can use the
&quot;glance&Acirc;&nbsp;image-show&Acirc;&nbsp;fedora-20-image&quot;
command to display the properties of the image.</p>

<p style="margin-top: 1em">To boot up an instance of your
image on a Nova compute node, do:</p>

<p style="margin-top: 1em">nova boot fedora-20-server
--image fedora-20-image --flavor m1.medium</p>

<p style="margin-top: 1em">Use
&quot;nova&Acirc;&nbsp;flavor-list&quot; to list possible
machine flavors. Use &quot;nova&Acirc;&nbsp;list&quot; to
list running instances.</p>

<p style="margin-top: 1em">Booting directly using qemu or
KVM</p>

<p style="margin-top: 1em">The qemu command line is not
very stable or easy to use, hence libvirt should be used if
possible. However a command line similar to the following
could be used to boot the <br>
virtual machine:</p>

<p style="margin-top: 1em">qemu-system-x86_64 -machine
accel=kvm:tcg -cpu host -m 2048 -drive
file=disk.img,format=raw,if=virtio</p>

<p style="margin-top: 1em">As with libvirt, it is very
important that the correct format is chosen. It will be
&quot;raw&quot; unless the --format option was used.</p>

<p style="margin-top: 1em">CONFIGURATION MANAGEMENT <br>
Puppet</p>

<p style="margin-top: 1em">To enable the Puppet agent in a
guest, install the package, point the configuration at your
Puppetmaster, and ensure the agent runs at boot.</p>

<p style="margin-top: 1em">A typical virt-builder command
would be:</p>

<p style="margin-top: 1em">virt-builder fedora-20
--hostname client.example.com --update --install puppet
--edit &rsquo;/etc/puppet/puppet.conf: <br>
s/^/[agent] server = puppetmaster.example.com/&rsquo;
--run-command &rsquo;systemctl enable puppet&rsquo;
--selinux-relabel</p>

<p style="margin-top: 1em">The precise instructions vary
according to the Linux distro. For further information see:
http://docs.puppetlabs.com/guides/installation.htm</p>

<p style="margin-top: 1em">DEBUGGING BUILDS <br>
If virt-builder itself fails, then enable debugging (-v) and
report a bug (see &quot;BUGS&quot; below).</p>

<p style="margin-top: 1em">If virt-builder fails because
some script or package it is installing fails, try using
--no-delete-on-failure to preserve the output file, and
continue reading this section.</p>

<p style="margin-top: 1em">If virt-builder is successful
but the image doesn&rsquo;t work, here are some things to
try:</p>

<p style="margin-top: 1em">Use virt-rescue <br>
Run virt-rescue(1) on the disk image:</p>

<p style="margin-top: 1em">virt-rescue -a disk.img</p>

<p style="margin-top: 1em">This gives you a rescue shell.
You can mount the filesystems from the disk image on
/sysroot and examine them using ordinary Linux commands. You
can also chroot into the <br>
guest to reinstall the bootloader. The virt-rescue man page
has a lot more information and examples.</p>

<p style="margin-top: 1em">Use guestfish <br>
Run guestfish(1) on the disk image:</p>

<p style="margin-top: 1em">guestfish -a disk.img -i</p>

<p style="margin-top: 1em">Use guestfish commands like
&quot;ll /directory&quot; and &quot;cat /file&quot; to
examine directories and files.</p>

<p style="margin-top: 1em">Use guestmount <br>
Mount the disk image safely on the host using FUSE and
guestmount(1):</p>

<p style="margin-top: 1em">mkdir /tmp/mp <br>
guestmount -a disk.img -i /tmp/mp <br>
cd /tmp/mp</p>

<p style="margin-top: 1em">To unmount the disk image
do:</p>

<p style="margin-top: 1em">fusermount -u /tmp/mp</p>

<p style="margin-top: 1em">Add a serial console <br>
If the guest hangs during boot, it can be helpful to add a
serial console to the guest, and direct kernel messages to
the serial console. Adding the serial console will <br>
involve looking at the documentation for your hypervisor. To
direct kernel messages to the serial console, add the
following on the kernel command line:</p>

<p style="margin-top: 1em">console=tty0
console=ttyS0,115200</p>

<p style="margin-top: 1em">SOURCES OF TEMPLATES <br>
virt-builder reads the available sources from configuration
files, with the .conf extension and located in the following
paths:</p>

<p style="margin-top: 1em">&Acirc;&middot;
$XDG_CONFIG_HOME/virt-builder/repos.d/ ($XDG_CONFIG_HOME is
$HOME/.config if not set).</p>

<p style="margin-top: 1em">&Acirc;&middot;
$XDG_CONFIG_DIRS/virt-builder/repos.d/ (where
$XDG_CONFIG_DIRS means any of the directories in that
environment variable, or just /etc/xdg if not set)</p>

<p style="margin-top: 1em">Each .conf file in those paths
has a simple text format like the following:</p>

<p style="margin-top: 1em">[libguestfs.org] <br>
uri=http://libguestfs.org/download/builder/index.asc <br>

gpgkey=file:///etc/xdg/virt-builder/repos.d/libguestfs.gpg</p>

<p style="margin-top: 1em">The part in square brackets is
the repository identifier, which is used as unique
identifier.</p>

<p style="margin-top: 1em">The following fields can
appear:</p>

<p style="margin-top: 1em">&quot;uri=URI&quot; <br>
The URI of the index file which this repository refers
to.</p>

<p style="margin-top: 1em">This field is required.</p>

<p style="margin-top: 1em">&quot;gpgkey=URI&quot; <br>
This optional field represents the URI (although only
file:// URIs are accepted) of the key used to sign the index
file. If not present, the index file referred by uri=.. is
<br>
not signed.</p>

<p style="margin-top: 1em">&quot;proxy=MODE&quot; <br>
This optional field specifies the proxy mode, to be used
when downloading the index file of this repository. The
possible values are:</p>

<p style="margin-top: 1em">no, off <br>
No proxy is being used at all, even overriding the system
configuration.</p>

<p style="margin-top: 1em">system <br>
The proxy used is the system one.</p>

<p style="margin-top: 1em">anything else <br>
Specifies the actual proxy configuration to be used,
overriding the system configuration.</p>

<p style="margin-top: 1em">If not present, the assumed
value is to respect the proxy settings of the system (i.e.
as if system would be specified).</p>

<p style="margin-top: 1em">&quot;format=FORMAT&quot; <br>
This optional field specifies the format of the repository.
The possible values are:</p>

<p style="margin-top: 1em">native <br>
The native format of the &quot;virt-builder&quot;
repository. See also &quot;Creating and signing the index
file&quot; below.</p>

<p style="margin-top: 1em">simplestreams <br>
The URI represents the root of a Simple Streams v1.0 tree of
metadata.</p>

<p style="margin-top: 1em">For more information about
Simple Streams, see also
https://launchpad.net/simplestreams.</p>

<p style="margin-top: 1em">If not present, the assumed
value is &quot;native&quot;.</p>

<p style="margin-top: 1em">For serious virt-builder use,
you may want to create your own repository of templates.</p>

<p style="margin-top: 1em">Libguestfs.org repository</p>

<p style="margin-top: 1em">Out of the box, virt-builder
downloads the file
http://libguestfs.org/download/builder/index.asc which is an
index of available templates plus some information about
each one, <br>
wrapped up in a digital signature. The command
&quot;virt-builder --list&quot; lists out the information in
this index file.</p>

<p style="margin-top: 1em">The templates hosted on
libguestfs.org were created using shell scripts, kickstart
files and preseed files which can be found in the libguestfs
source tree, in &quot;builder/website&quot;.</p>

<p style="margin-top: 1em">Setting up the repository</p>

<p style="margin-top: 1em">You can set up your own site
containing an index file and some templates, and then point
virt-builder at the site by creating a .conf file pointing
to it.</p>

<p style="margin-top: 1em">Note that if your index is
signed, you will need to properly fill gpgkey=.. in your
.conf file, making sure to deploy also the GPG key file.</p>

<p style="margin-top: 1em">virt-builder --source
https://example.com/builder/index.asc --fingerprint
&rsquo;AAAA BBBB ...&rsquo; --list</p>

<p style="margin-top: 1em">You can host this on any web or
FTP server, or a local or network filesystem.</p>

<p style="margin-top: 1em">Setting up a GPG key</p>

<p style="margin-top: 1em">If you don&rsquo;t have a GnuPG
key, you will need to set one up. (Strictly speaking this is
optional, but if your index and template files are not
signed then virt-builder users will <br>
have to use the --no-check-signature flag every time they
use virt-builder.)</p>

<p style="margin-top: 1em">To create a key, see the GPG
manual http://www.gnupg.org/gph/en/manual.html.</p>

<p style="margin-top: 1em">Export your GPG public key:</p>

<p style="margin-top: 1em">gpg --export -a
&quot;you@example.com&quot; &gt; pubkey</p>

<p style="margin-top: 1em">Create the templates</p>

<p style="margin-top: 1em">There are many ways to create
the templates. For example you could clone existing guests
(see virt-sysprep(1)), or you could install a guest by hand
(virt-install(1)). To see <br>
how the templates were created for virt-builder, look at the
scripts in &quot;builder/website&quot;</p>

<p style="margin-top: 1em">For best results when
compressing the templates, use the following xz options (see
nbdkit-xz-plugin(1) for further explanation):</p>

<p style="margin-top: 1em">xz --best --block-size=16777216
disk</p>

<p style="margin-top: 1em">Creating and signing the index
file</p>

<p style="margin-top: 1em">The index file has a simple text
format (shown here without the digital signature):</p>

<p style="margin-top: 1em">[fedora-18] <br>
name=Fedora&Acirc;&reg; 18 <br>
osinfo=fedora18 <br>
arch=x86_64 <br>
file=fedora-18.xz <br>
checksum[sha512]=... <br>
format=raw <br>
size=6442450944 <br>
compressed_size=148947524 <br>
expand=/dev/sda3</p>

<p style="margin-top: 1em">[fedora-19] <br>
name=Fedora&Acirc;&reg; 19 <br>
osinfo=fedora19 <br>
arch=x86_64 <br>
file=fedora-19.xz <br>
checksum[sha512]=... <br>
revision=3 <br>
format=raw <br>
size=4294967296 <br>
compressed_size=172190964 <br>
expand=/dev/sda3</p>

<p style="margin-top: 1em">The part in square brackets is
the &quot;os-version&quot;, which is the same string that is
used on the virt-builder command line to build that OS.</p>

<p style="margin-top: 1em">After preparing the
&quot;index&quot; file in the correct format, clearsign it
using the following command:</p>

<p style="margin-top: 1em">gpg --clearsign --armor
index</p>

<p style="margin-top: 1em">This will create the final file
called index.asc which can be uploaded to the server (and is
the uri=.. URL). As noted above, signing the index file is
optional, but <br>
recommended.</p>

<p style="margin-top: 1em">The following fields can
appear:</p>

<p style="margin-top: 1em">&quot;name=NAME&quot; <br>
The user-friendly name of this template. This is displayed
in the --list output but is otherwise not significant.</p>

<p style="margin-top: 1em">&quot;osinfo=ID&quot; <br>
This optional field maps the operating system to the
associated libosinfo ID. Virt-builder does not use it
(yet).</p>

<p style="margin-top: 1em">&quot;arch=ARCH&quot; <br>
The architecture of the operating system installed within
the template. This field is required.</p>

<p style="margin-top: 1em">&quot;file=PATH&quot; <br>
The path (relative to the index) of the xz-compressed
template.</p>

<p style="margin-top: 1em">Note that absolute paths or URIs
are not permitted here. This is because virt-builder has a
&quot;same origin&quot; policy for templates so they cannot
come from other servers.</p>

<p style="margin-top: 1em">&quot;sig=PATH&quot; <br>
This option is deprecated. Use the checksum field
instead.</p>

<p style="margin-top: 1em">The path (relative to the index)
of the GPG detached signature of the xz file.</p>

<p style="margin-top: 1em">Note that absolute paths or URIs
are not permitted here. This is because virt-builder has a
&quot;same origin&quot; policy for templates so they cannot
come from other servers.</p>

<p style="margin-top: 1em">The file can be created as
follows:</p>

<p style="margin-top: 1em">gpg --detach-sign --armor -o
disk.xz.sig disk.xz</p>


<p style="margin-top: 1em">&quot;checksum[sha512]=7b882fe9b82eb0fef...&quot;
<br>
The SHA-512 checksum of the compressed file is checked after
it is downloaded. To work out the signature, do:</p>

<p style="margin-top: 1em">sha512sum disk.xz</p>

<p style="margin-top: 1em">Note if you use this, you
don&rsquo;t need to sign the file, ie. don&rsquo;t use
&quot;sig&quot;. This option overrides &quot;sig&quot;.</p>


<p style="margin-top: 1em">&quot;checksum=7b882fe9b82eb0fef...&quot;
<br>
&quot;checksum&quot; is an alias for
&quot;checksum[sha512]&quot;.</p>

<p style="margin-top: 1em">If you need to interoperate with
virt-builder = 1.24.0 then you have to use
&quot;checksum&quot; because that version would give a parse
error with square brackets and numbers in the <br>
key of a field. This is fixed in virt-builder &acirc;&yen;
1.24.1.</p>

<p style="margin-top: 1em">&quot;revision=N&quot; <br>
The revision is an integer which is used to control the
template cache. Increasing the revision number causes
clients to download the template again even if they have a
copy <br>
in the cache.</p>

<p style="margin-top: 1em">The revision number is optional.
If omitted it defaults to 1.</p>

<p style="margin-top: 1em">&quot;format=raw&quot; <br>
&quot;format=qcow2&quot; <br>
Specify the format of the disk image (before it was
compressed). If not given, the format is autodetected, but
generally it is better to be explicit about the intended
<br>
format.</p>

<p style="margin-top: 1em">Note this is the source format,
which is different from the --format option (requested
output format). Virt-builder does on-the-fly conversion from
the source format to the <br>
requested output format.</p>

<p style="margin-top: 1em">&quot;size=NNN&quot; <br>
The virtual size of the image in bytes. This is the size of
the image when uncompressed. If using a non-raw format such
as qcow2 then it means the virtual disk size, not <br>
the size of the qcow2 file.</p>

<p style="margin-top: 1em">This field is required.</p>

<p style="margin-top: 1em">Virt-builder also uses this as
the minimum size that users can request via the --size
option, or as the default size if there is no --size
option.</p>

<p style="margin-top: 1em">&quot;compressed_size=NNN&quot;
<br>
The compressed size of the disk image in bytes. This is just
used for information (when using --list --long).</p>

<p style="margin-top: 1em">&quot;expand=/dev/sdaX&quot;
<br>
When expanding the image to its final size, instruct
virt-resize(1) to expand the named partition in the guest
image to fill up all available space. This works like the
<br>
virt-resize --expand option.</p>

<p style="margin-top: 1em">You should usually put the
device name of the guest&rsquo;s root filesystem here.</p>

<p style="margin-top: 1em">It&rsquo;s a good idea to use
this, but not required. If the field is omitted then
virt-resize will create an extra partition at the end of the
disk to cover the free space, which <br>
is much less user-friendly.</p>


<p style="margin-top: 1em">&quot;lvexpand=/dev/VolGroup/LogVol&quot;
<br>
When expanding the image to its final size, instruct
virt-resize(1) to expand the named logical volume in the
guest image to fill up all available space. This works like
the <br>
virt-resize --lv-expand option.</p>

<p style="margin-top: 1em">If the guest uses LVM2 you
should usually put the LV of the guest&rsquo;s root
filesystem here. If the guest does not use LVM2 or its root
filesystem is not on an LV, don&rsquo;t use <br>
this option.</p>

<p style="margin-top: 1em">&quot;notes=NOTES&quot; <br>
Any notes that go with this image, especially notes
describing what packages are in the image, how the image was
prepared, and licensing information.</p>

<p style="margin-top: 1em">This information is shown in the
--notes and --list --long modes.</p>

<p style="margin-top: 1em">You can use multi-line notes
here by indenting each new line with at least one character
of whitespace (even on blank lines):</p>

<p style="margin-top: 1em">notes=This image was prepared
using <br>
the following kickstart script: <br>
&lt;-- one space at beginning of line <br>
part /boot --fstype ext3 <br>
...</p>

<p style="margin-top: 1em">&quot;hidden=true&quot; <br>
Using the hidden flag prevents the template from being
listed by the --list option (but it is still installable).
This is used for test images.</p>

<p style="margin-top: 1em">&quot;aliases=ALIAS1 ALIAS2
...&quot; <br>
This optional field specifies a list of aliases, separated
by spaces, for the image. For example, an alias could be
used to always point to the latest version of a certain <br>
image, leaving the old versions available in the index
instead of updating the same image (see the
&quot;revision&quot; field).</p>

<p style="margin-top: 1em">Running virt-builder against
multiple sources</p>

<p style="margin-top: 1em">It is possible to use multiple
sources with virt-builder. The recommended way is to deploy
.conf files pointing to the index files. Another way is to
specify the sources using <br>
multiple --source and/or --fingerprint options:</p>

<p style="margin-top: 1em">virt-builder --source
http://example.com/s1/index.asc --source
http://example.com/s2/index.asc</p>

<p style="margin-top: 1em">You can provide N or 1
fingerprints. In the case where you provide N fingerprints,
N = number of sources and there is a 1-1 correspondence
between each source and each <br>
fingerprint:</p>

<p style="margin-top: 1em">virt-builder --source
http://example.com/s1/index.asc --fingerprint &rsquo;0123
...&rsquo; --source http://example.com/s2/index.asc
--fingerprint &rsquo;9876 ...&rsquo;</p>

<p style="margin-top: 1em">In the case where you provide 1
fingerprint, the same fingerprint is used for all
sources.</p>

<p style="margin-top: 1em">You &quot;must&quot; provide at
least 1 fingerprint.</p>

<p style="margin-top: 1em">Licensing of templates</p>

<p style="margin-top: 1em">You should be aware of the
licensing of images that you distribute. For open source
guests, provide a link to the source code in the
&quot;notes&quot; field and comply with other <br>
requirements (eg. around trademarks).</p>

<p style="margin-top: 1em">Formal specification of the
index file</p>

<p style="margin-top: 1em">The index file format has a
formal specification defined by the flex scanner and bison
parser used to parse the file. This can be found in the
following files in the libguestfs <br>
source tree:</p>

<p style="margin-top: 1em">builder/index-scan.l <br>
builder/index-parse.y</p>

<p style="margin-top: 1em">A tool called
virt-index-validate(1) is available to validate the index
file to ensure it is correct.</p>

<p style="margin-top: 1em">Note that the parser and tool
can work on either the signed or unsigned index file (ie.
index or index.asc).</p>

<p style="margin-top: 1em">The index is always encoded in
UTF-8.</p>

<p style="margin-top: 1em">CACHING <br>
Caching templates</p>

<p style="margin-top: 1em">Since the templates are usually
very large, downloaded templates are cached in the
user&rsquo;s home directory.</p>

<p style="margin-top: 1em">The location of the cache is
$XDG_CACHE_HOME/virt-builder/ or
$HOME/.cache/virt-builder.</p>

<p style="margin-top: 1em">You can print out information
about the cache directory, including which guests are
currently cached, by doing:</p>

<p style="margin-top: 1em">virt-builder --print-cache</p>

<p style="margin-top: 1em">The cache can be deleted if you
want to save space by doing:</p>

<p style="margin-top: 1em">virt-builder --delete-cache</p>

<p style="margin-top: 1em">You can download all (current)
templates to the local cache by doing:</p>

<p style="margin-top: 1em">virt-builder
--cache-all-templates</p>

<p style="margin-top: 1em">To disable the template cache,
use --no-cache.</p>

<p style="margin-top: 1em">Only templates are cached. The
index and detached digital signatures are not cached.</p>

<p style="margin-top: 1em">Caching packages</p>

<p style="margin-top: 1em">Virt-builder uses curl(1) to
download files and it also uses the current
&quot;http_proxy&quot; (etc) settings when installing
packages (--install, --update).</p>

<p style="margin-top: 1em">You may therefore want to set
those environment variables in order to maximize the amount
of local caching that happens. See &quot;ENVIRONMENT
VARIABLES&quot; and curl(1).</p>

<p style="margin-top: 1em">Local mirrors</p>

<p style="margin-top: 1em">To increase both speed and
reliability of installing packages, you can set up a local
mirror of the target distribution, and point the guest
package manager at that.</p>

<p style="margin-top: 1em">Because of the order in which
each phase of installation happens, you cannot use --write
(to point the package manager at a repo) followed by
--install (to install from that <br>
repo). The --write and --install steps run in the opposite
order, regardless of their order on the command line. You
have to do this using --run-command instead of
--install.</p>

<p style="margin-top: 1em">Using a local mirror with
Fedora</p>

<p style="margin-top: 1em">To install a Fedora guest using
a local mirror:</p>

<p style="margin-top: 1em">virt-builder fedora-20 --edit
&rsquo;/etc/yum.repos.d/fedora.repo: <br>
s{.*baseurl=.*}{baseurl=http://example.com/mirror/}; <br>
s{.*metalink=.*}{}; <br>
&rsquo; --edit &rsquo;/etc/yum.repos.d/fedora-updates.repo:
<br>

s{.*baseurl=.*}{baseurl=http://example.com/mirror-updates/};
<br>
s{.*metalink=.*}{}; <br>
&rsquo; --run-command &rsquo;yum -y update&rsquo;
--run-command &rsquo;yum -y install pkg1 pkg2 ...&rsquo;</p>

<p style="margin-top: 1em">Using a local mirror with
Debian</p>

<p style="margin-top: 1em">Assuming that you are using
&quot;apt-proxy&quot; to mirror the repository, you should
create a new sources.list file to point to your proxy (see
<br>
https://help.ubuntu.com/community/AptProxy) and then do:</p>

<p style="margin-top: 1em">virt-builder debian-7 --upload
sources.list:/etc/apt/sources.list --run-command
&rsquo;apt-get -y update&rsquo; --run-command &rsquo;apt-get
-y install pkg1 pkg2 ...&rsquo;</p>

<p style="margin-top: 1em">DIGITAL SIGNATURES <br>
Virt-builder uses GNU Privacy Guard (GnuPG or gpg) to verify
that the index and templates have not been tampered
with.</p>

<p style="margin-top: 1em">The source points to an index
file, which is optionally signed.</p>

<p style="margin-top: 1em">Virt-builder downloads the index
and checks that the signature is valid and the
signer&rsquo;s fingerprint matches the specified fingerprint
(ie. the one specified in gpgkey=.. in the <br>
.conf, or with --fingerprint, in that order).</p>

<p style="margin-top: 1em">For checking against the
built-in public key/fingerprint, this requires importing the
public key into the user&rsquo;s local gpg keyring
(that&rsquo;s just the way that gpg works).</p>

<p style="margin-top: 1em">When a template is downloaded,
its signature is checked in the same way.</p>

<p style="margin-top: 1em">Although the signatures are
optional, if you don&rsquo;t have them then virt-builder
users will have to use --no-check-signature on the command
line. This prevents an attacker from <br>
replacing the signed index file with an unsigned index file
and having virt-builder silently work without checking the
signature. In any case it is highly recommended that you
<br>
always create signed index and templates.</p>

<p style="margin-top: 1em">ARCHITECTURE <br>
Virt-builder can build a guest for any architecture no
matter what the host architecture is. For example an x86-64
guest on an ARM host.</p>

<p style="margin-top: 1em">However certain options may not
work, specifically options that require running commands in
the guest during the build process: --install, --update,
--run, --run-command. You <br>
may need to replace these with their
firstboot-equivalents.</p>

<p style="margin-top: 1em">An x86-64 host building 32 bit
i686 guests should work without any special steps.</p>

<p style="margin-top: 1em">SECURITY <br>
Virt-builder does not need to run as root (in fact, should
not be run as root), and doesn&rsquo;t use setuid,
&quot;sudo&quot; or any similar mechanism.</p>

<p style="margin-top: 1em">--install, --update, --run and
--run-command are implemented using an appliance (a small
virtual machine) so these commands do not run on the host.
If you are using the <br>
libguestfs libvirt backend and have SELinux enabled then the
virtual machine is additionally encapsulated in an SELinux
container (sVirt).</p>

<p style="margin-top: 1em">However these options will have
access to the host&rsquo;s network and since the template
may contain untrusted code, the code might try to access
host network resources which it <br>
should not. You can use --no-network to prevent this.</p>

<p style="margin-top: 1em">Firstboot commands run in the
context of the guest when it is booted, and so the security
of your hypervisor / cloud should be considered.</p>

<p style="margin-top: 1em">Virt-builder injects a random
seed into every guest which it builds. This helps to ensure
that TCP sequence numbers, UUIDs, ssh host keys etc are
truly random when the guest <br>
boots.</p>

<p style="margin-top: 1em">You should check digital
signatures and not ignore any signing errors.</p>

<p style="margin-top: 1em">CLONES <br>
If you wish to create many new guests of the same type, it
is tempting to run virt-builder once and then copy the
output file. You should not do this. You should run virt-
<br>
builder once for each new guest you need.</p>

<p style="margin-top: 1em">The reason is that each clone
needs to have (at least) a separate random seed, and
possibly other unique features (such as filesystem UUIDs) in
future versions of virt-builder.</p>

<p style="margin-top: 1em">Another thing you should not do
is to boot the guest, then clone the booted disk image. The
reason is that some guests create unique machine IDs, SSH
host keys and so on at <br>
first boot, and you would not want clones to have duplicate
identities.</p>

<p style="margin-top: 1em">See also: virt-sysprep(1).</p>

<p style="margin-top: 1em">PERFORMANCE <br>
The most important aspect of getting good performance is
caching. Templates gets downloaded into the cache the first
time they are used, or if you use the --cache-all-templates
<br>
option. See &quot;CACHING&quot; above for further
information.</p>

<p style="margin-top: 1em">Packages required for the
--install and --update options are downloaded using the host
network connection. Setting the &quot;http_proxy&quot;,
&quot;https_proxy&quot; and &quot;ftp_proxy&quot;
environment <br>
variables to point to a local web cache may ensure they only
need to be downloaded once. You can also try using a local
package repository, although this can be complex to set <br>
up and varies according to which Linux distro you are trying
to install.</p>

<p style="margin-top: 1em">Using --no-sync</p>

<p style="margin-top: 1em">Use --no-sync. However read the
caveats in the &quot;OPTIONS&quot; section above, since this
can cause disk corruption if not used correctly.</p>

<p style="margin-top: 1em">Skipping virt-resize</p>

<p style="margin-top: 1em">Virt-builder can skip the
virt-resize step under certain conditions. This makes
virt-builder much faster. The conditions are:</p>

<p style="margin-top: 1em">&Acirc;&middot; the output must
be a regular file (not a block device), and</p>

<p style="margin-top: 1em">&Acirc;&middot; the user did not
use the --size option, and</p>

<p style="margin-top: 1em">&Acirc;&middot; the output
format is the same as the template format (usually raw).</p>

<p style="margin-top: 1em">pxzcat</p>

<p style="margin-top: 1em">Virt-builder uses an internal
implementation of pxzcat (parallel xzcat) if liblzma was
found at build time. If liblzma was not found at build time,
regular &quot;xzcat&quot; is used which <br>
is single-threaded.</p>

<p style="margin-top: 1em">User-Mode Linux</p>

<p style="margin-top: 1em">You can use virt-builder with
the User-Mode Linux (UML) backend. This may be faster when
running virt-builder inside a virtual machine (eg. in the
cloud).</p>

<p style="margin-top: 1em">To enable the UML backend, read
the instructions in &quot;USER-MODE LINUX BACKEND&quot; in
guestfs(3).</p>

<p style="margin-top: 1em">Currently you have to use the
--no-network option. This should be fixed in a future
version.</p>

<p style="margin-top: 1em">The qcow2 output format is not
supported by UML. You can only create raw-format guests.</p>

<p style="margin-top: 1em">SELINUX <br>
Guests which use SELinux (such as Fedora and Red Hat
Enterprise Linux) require that each file has a correct
SELinux label.</p>

<p style="margin-top: 1em">Virt-builder does not know how
to give new files a label, so there are two possible
strategies it can use to ensure correct labelling:</p>

<p style="margin-top: 1em">Using --selinux-relabel <br>
This runs setfiles(8) just before finalizing the guest,
which sets SELinux labels correctly in the disk image.</p>

<p style="margin-top: 1em">This is the recommended
method.</p>

<p style="margin-top: 1em">--touch /.autorelabel <br>
Guest templates may already contain a file called
/.autorelabel or you may touch it.</p>

<p style="margin-top: 1em">For guests that use SELinux,
this causes restorecon(8) to run at first boot. Guests will
reboot themselves once the first time you use them, which is
normal and harmless.</p>

<p style="margin-top: 1em">Please note that if your guest
uses SELinux, and you are doing operations on it which might
create new files or change existing ones, you are
recommended to use <br>
--selinux-relabel. This will help in making sure that files
have the right SELinux labels.</p>

<p style="margin-top: 1em">MACHINE READABLE OUTPUT <br>
The --machine-readable option can be used to make the output
more machine friendly, which is useful when calling
virt-builder from other programs, GUIs etc.</p>

<p style="margin-top: 1em">Use the option on its own to
query the capabilities of the virt-builder binary. Typical
output looks like this:</p>

<p style="margin-top: 1em">$ virt-builder
--machine-readable <br>
virt-builder <br>
arch <br>
config-file <br>
customize <br>
json-list <br>
pxzcat</p>

<p style="margin-top: 1em">A list of features is printed,
one per line, and the program exits with status 0.</p>

<p style="margin-top: 1em">ENVIRONMENT VARIABLES <br>
For other environment variables which affect all libguestfs
programs, see &quot;ENVIRONMENT VARIABLES&quot; in
guestfs(3).</p>

<p style="margin-top: 1em">&quot;http_proxy&quot; <br>
&quot;https_proxy&quot; <br>
&quot;no_proxy&quot; <br>
Set the proxy for downloads. These environment variables
(and more) are actually interpreted by curl(1), not
virt-builder.</p>

<p style="margin-top: 1em">&quot;HOME&quot; <br>
Used to determine the location of the template cache, and
the location of the user&rsquo; sources. See
&quot;CACHING&quot; and &quot;SOURCES OF
TEMPLATES&quot;.</p>

<p style="margin-top: 1em">&quot;VIRT_TOOLS_DATA_DIR&quot;
<br>
This can point to the directory containing data files used
for Windows firstboot installation.</p>

<p style="margin-top: 1em">Normally you do not need to set
this. If not set, a compiled-in default will be used
(something like /usr/share/virt-tools).</p>

<p style="margin-top: 1em">This directory may contain the
following files:</p>

<p style="margin-top: 1em">rhsrvany.exe <br>
This is the RHSrvAny Windows binary, used to install a
&quot;firstboot&quot; script in Windows guests. It is
required if you intend to use the --firstboot or
--firstboot-command <br>
options with Windows guests.</p>

<p style="margin-top: 1em">See also:
&quot;https://github.com/rwmjones/rhsrvany&quot;</p>

<p style="margin-top: 1em">&quot;XDG_CACHE_HOME&quot; <br>
Used to determine the location of the template cache. See
&quot;CACHING&quot;.</p>

<p style="margin-top: 1em">&quot;XDG_CONFIG_HOME&quot; <br>
Used to determine the location of the user&rsquo; sources.
See &quot;SOURCES OF TEMPLATES&quot;.</p>

<p style="margin-top: 1em">&quot;XDG_CONFIG_DIRS&quot; <br>
Used to determine the location of the system sources. See
&quot;SOURCES OF TEMPLATES&quot;.</p>

<p style="margin-top: 1em">EXIT STATUS <br>
This program returns 0 if successful, or non-zero if there
was an error.</p>

<p style="margin-top: 1em">SEE ALSO <br>
guestfs(3), guestfish(1), guestmount(1), virt-copy-out(1),
virt-customize(1), virt-install(1), virt-rescue(1),
virt-resize(1), virt-sysprep(1), oz-install(1), gpg(1),
curl(1), <br>
virt-make-fs(1), genisoimage(1), http://libguestfs.org/.</p>

<p style="margin-top: 1em">AUTHOR <br>
Richard W.M. Jones http://people.redhat.com/~rjones/</p>

<p style="margin-top: 1em">COPYRIGHT <br>
Copyright (C) 2013 Red Hat Inc.</p>

<p style="margin-top: 1em">LICENSE <br>
This program is free software; you can redistribute it
and/or modify it under the terms of the GNU General Public
License as published by the Free Software Foundation; either
<br>
version 2 of the License, or (at your option) any later
version.</p>

<p style="margin-top: 1em">This program is distributed in
the hope that it will be useful, but WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR <br>
PURPOSE. See the GNU General Public License for more
details.</p>

<p style="margin-top: 1em">You should have received a copy
of the GNU General Public License along with this program;
if not, write to the Free Software Foundation, Inc., 51
Franklin Street, Fifth Floor, <br>
Boston, MA 02110-1301 USA.</p>

<p style="margin-top: 1em">BUGS <br>
To get a list of bugs against libguestfs, use this link:
https://bugzilla.redhat.com/buglist.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p style="margin-top: 1em">To report a new bug against
libguestfs, use this link:
https://bugzilla.redhat.com/enter_bug.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p style="margin-top: 1em">When reporting a bug, please
supply:</p>

<p style="margin-top: 1em">&Acirc;&middot; The version of
libguestfs.</p>

<p style="margin-top: 1em">&Acirc;&middot; Where you got
libguestfs (eg. which Linux distro, compiled from source,
etc)</p>

<p style="margin-top: 1em">&Acirc;&middot; Describe the bug
accurately and give a way to reproduce it.</p>

<p style="margin-top: 1em">&Acirc;&middot; Run
libguestfs-test-tool(1) and paste the complete, unedited
output into the bug report.</p>

<p style="margin-top: 1em">libguestfs-1.32.7 2016-08-08
virt-builder(1)</p>
<hr>
</body>
</html>
