<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 16:31:01 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>PERLOS2(1) Perl Programmers Reference Guide
PERLOS2(1)</p>

<p style="margin-top: 1em">NAME <br>
perlos2 - Perl under OS/2, DOS, Win0.3*, Win0.95 and
WinNT.</p>

<p style="margin-top: 1em">SYNOPSIS <br>
One can read this document in the following formats:</p>

<p style="margin-top: 1em">man perlos2 <br>
view perl perlos2 <br>
explorer perlos2.html <br>
info perlos2</p>

<p style="margin-top: 1em">to list some (not all may be
available simultaneously), or it may be read as is: either
as README.os2, or pod/perlos2.pod.</p>

<p style="margin-top: 1em">To read the .INF version of
documentation (very recommended) outside of OS/2, one needs
an IBM&rsquo;s reader (may be available on IBM ftp sites (?)
(URL anyone?)) or shipped with PC <br>
DOS 7.0 and IBM&rsquo;s Visual Age C++ 3.5.</p>

<p style="margin-top: 1em">A copy of a Win* viewer is
contained in the &quot;Just add OS/2 Warp&quot; package</p>


<p style="margin-top: 1em">ftp://ftp.software.ibm.com/ps/products/os2/tools/jaow/jaow.zip</p>

<p style="margin-top: 1em">in ?:JUST_ADDw.exe. This gives
one an access to EMX&rsquo;s .INF docs as well (text form is
available in /emx/doc in EMX&rsquo;s distribution). There is
also a different viewer named <br>
xview.</p>

<p style="margin-top: 1em">Note that if you have lynx.exe
or netscape.exe installed, you can follow WWW links from
this document in .INF format. If you have EMX docs installed
correctly, you can follow <br>
library links (you need to have &quot;view emxbook&quot;
working by setting &quot;EMXBOOK&quot; environment variable
as it is described in EMX docs).</p>

<p style="margin-top: 1em">DESCRIPTION <br>
Target <br>
The target is to make OS/2 one of the best supported
platform for using/building/developing Perl and Perl
applications, as well as make Perl the best language to use
under OS/2. <br>
The secondary target is to try to make this work under DOS
and Win* as well (but not too hard).</p>

<p style="margin-top: 1em">The current state is quite close
to this target. Known limitations:</p>

<p style="margin-top: 1em">&Acirc;&middot; Some *nix
programs use fork() a lot; with the mostly useful flavors of
perl for OS/2 (there are several built simultaneously) this
is supported; but some flavors do not <br>
support this (e.g., when Perl is called from inside REXX).
Using fork() after useing dynamically loading extensions
would not work with very old versions of EMX.</p>

<p style="margin-top: 1em">&Acirc;&middot; You need a
separate perl executable perl__.exe (see
&quot;perl__.exe&quot;) if you want to use PM code in your
application (as Perl/Tk or OpenGL Perl modules do) without
having a <br>
text-mode window present.</p>

<p style="margin-top: 1em">While using the standard
perl.exe from a text-mode window is possible too, I have
seen cases when this causes degradation of the system
stability. Using perl__.exe avoids <br>
such a degradation.</p>

<p style="margin-top: 1em">&Acirc;&middot; There is no
simple way to access WPS objects. The only way I know is via
&quot;OS2::REXX&quot; and &quot;SOM&quot; extensions (see
OS2::REXX, SOM). However, we do not have access to <br>
convenience methods of Object-REXX. (Is it possible at all?
I know of no Object-REXX API.) The &quot;SOM&quot; extension
(currently in alpha-text) may eventually remove this <br>
shortcoming; however, due to the fact that DII is not
supported by the &quot;SOM&quot; module, using
&quot;SOM&quot; is not as convenient as one would like
it.</p>

<p style="margin-top: 1em">Please keep this list up-to-date
by informing me about other items.</p>

<p style="margin-top: 1em">Other OSes <br>
Since OS/2 port of perl uses a remarkable EMX environment,
it can run (and build extensions, and - possibly - be built
itself) under any environment which can run EMX. The <br>
current list is DOS, DOS-inside-OS/2, Win0.3*, Win0.95 and
WinNT. Out of many perl flavors, only one works, see
&quot;perl_.exe&quot;.</p>

<p style="margin-top: 1em">Note that not all features of
Perl are available under these environments. This depends on
the features the extender - most probably RSX - decided to
implement.</p>

<p style="margin-top: 1em">Cf.
&quot;Prerequisites&quot;.</p>

<p style="margin-top: 1em">Prerequisites <br>
EMX EMX runtime is required (may be substituted by RSX).
Note that it is possible to make perl_.exe to run under DOS
without any external support by binding emx.exe/rsx.exe to
<br>
it, see &quot;emxbind&quot;. Note that under DOS for best
results one should use RSX runtime, which has much more
functions working (like &quot;fork&quot;, &quot;popen&quot;
and so on). In fact RSX is <br>
required if there is no VCPI present. Note the RSX requires
DPMI. Many implementations of DPMI are known to be very
buggy, beware!</p>

<p style="margin-top: 1em">Only the latest runtime is
supported, currently &quot;0.9d fix 03&quot;. Perl may run
under earlier versions of EMX, but this is not tested.</p>

<p style="margin-top: 1em">One can get different parts of
EMX from, say</p>


<p style="margin-top: 1em">ftp://crydee.sai.msu.ru/pub/comp/os/os2/leo/gnu/emx+gcc/
<br>

http://hobbes.nmsu.edu/h-browse.php?dir=/pub/os2/dev/emx/v0.9d/</p>

<p style="margin-top: 1em">The runtime component should
have the name emxrt.zip.</p>

<p style="margin-top: 1em">NOTE. When using
emx.exe/rsx.exe, it is enough to have them on your path. One
does not need to specify them explicitly (though this</p>

<p style="margin-top: 1em">emx perl_.exe -de 0</p>

<p style="margin-top: 1em">will work as well.)</p>

<p style="margin-top: 1em">RSX To run Perl on DPMI
platforms one needs RSX runtime. This is needed under
DOS-inside-OS/2, Win0.3*, Win0.95 and WinNT (see &quot;Other
OSes&quot;). RSX would not work with VCPI only, <br>
as EMX would, it requires DMPI.</p>

<p style="margin-top: 1em">Having RSX and the latest sh.exe
one gets a fully functional *nix-ish environment under DOS,
say, &quot;fork&quot;, &quot;&lsquo;&lsquo;&quot; and
pipe-&quot;open&quot; work. In fact, MakeMaker works (for
static <br>
build), so one can have Perl development environment under
DOS.</p>

<p style="margin-top: 1em">One can get RSX from, say</p>


<p style="margin-top: 1em">http://cd.textfiles.com/hobbesos29804/disk1/EMX09C/
<br>

ftp://crydee.sai.msu.ru/pub/comp/os/os2/leo/gnu/emx+gcc/contrib/</p>

<p style="margin-top: 1em">Contact the author on
&quot;rainer@mathematik.uni-bielefeld.de&quot;.</p>

<p style="margin-top: 1em">The latest sh.exe with DOS hooks
is available in</p>


<p style="margin-top: 1em">http://www.ilyaz.org/software/os2/</p>

<p style="margin-top: 1em">as sh_dos.zip or under similar
names starting with &quot;sh&quot;, &quot;pdksh&quot;
etc.</p>

<p style="margin-top: 1em">HPFS Perl does not care about
file systems, but the perl library contains many files with
long names, so to install it intact one needs a file system
which supports long file <br>
names.</p>

<p style="margin-top: 1em">Note that if you do not plan to
build the perl itself, it may be possible to fool EMX to
truncate file names. This is not supported, read EMX docs to
see how to do it.</p>

<p style="margin-top: 1em">pdksh To start external programs
with complicated command lines (like with pipes in between,
and/or quoting of arguments), Perl uses an external shell.
With EMX port such shell <br>
should be named sh.exe, and located either in the
wired-in-during-compile locations (usually F:/bin), or in
configurable location (see &quot;PERL_SH_DIR&quot;).</p>

<p style="margin-top: 1em">For best results use EMX pdksh.
The standard binary (5.2.14 or later) runs under DOS (with
&quot;RSX&quot;) as well, see</p>


<p style="margin-top: 1em">http://www.ilyaz.org/software/os2/</p>

<p style="margin-top: 1em">Starting Perl programs under
OS/2 (and DOS and...) <br>
Start your Perl program foo.pl with arguments &quot;arg1
arg2 arg3&quot; the same way as on any other platform,
by</p>

<p style="margin-top: 1em">perl foo.pl arg1 arg2 arg3</p>

<p style="margin-top: 1em">If you want to specify perl
options &quot;-my_opts&quot; to the perl itself (as opposed
to your program), use</p>

<p style="margin-top: 1em">perl -my_opts foo.pl arg1 arg2
arg3</p>

<p style="margin-top: 1em">Alternately, if you use OS/2-ish
shell, like CMD or 4os2, put the following at the start of
your perl script:</p>

<p style="margin-top: 1em">extproc perl -S -my_opts</p>

<p style="margin-top: 1em">rename your program to foo.cmd,
and start it by typing</p>

<p style="margin-top: 1em">foo arg1 arg2 arg3</p>

<p style="margin-top: 1em">Note that because of stupid OS/2
limitations the full path of the perl script is not
available when you use &quot;extproc&quot;, thus you are
forced to use &quot;-S&quot; perl switch, and your <br>
script should be on the &quot;PATH&quot;. As a plus side, if
you know a full path to your script, you may still start it
with</p>

<p style="margin-top: 1em">perl ../../blah/foo.cmd arg1
arg2 arg3</p>

<p style="margin-top: 1em">(note that the argument
&quot;-my_opts&quot; is taken care of by the
&quot;extproc&quot; line in your script, see
&quot;&quot;extproc&quot; on the first line&quot;).</p>

<p style="margin-top: 1em">To understand what the above
magic does, read perl docs about &quot;-S&quot; switch - see
perlrun, and cmdref about &quot;extproc&quot;:</p>

<p style="margin-top: 1em">view perl perlrun <br>
man perlrun <br>
view cmdref extproc <br>
help extproc</p>

<p style="margin-top: 1em">or whatever method you
prefer.</p>

<p style="margin-top: 1em">There are also endless
possibilities to use executable extensions of 4os2,
associations of WPS and so on... However, if you use *nixish
shell (like sh.exe supplied in the binary <br>
distribution), you need to follow the syntax specified in
&quot;Command Switches&quot; in perlrun.</p>

<p style="margin-top: 1em">Note that -S switch supports
scripts with additional extensions .cmd, .btm, .bat, .pl as
well.</p>

<p style="margin-top: 1em">Starting OS/2 (and DOS) programs
under Perl <br>
This is what system() (see &quot;system&quot; in perlfunc),
&quot;&lsquo;&lsquo;&quot; (see &quot;I/O Operators&quot; in
perlop), and open pipe (see &quot;open&quot; in perlfunc)
are for. (Avoid exec() (see &quot;exec&quot; in perlfunc)
<br>
unless you know what you do).</p>

<p style="margin-top: 1em">Note however that to use some of
these operators you need to have a sh-syntax shell installed
(see &quot;Pdksh&quot;, &quot;Frequently asked
questions&quot;), and perl should be able to find it (see
<br>
&quot;PERL_SH_DIR&quot;).</p>

<p style="margin-top: 1em">The cases when the shell is used
are:</p>

<p style="margin-top: 1em">1. One-argument system() (see
&quot;system&quot; in perlfunc), exec() (see
&quot;exec&quot; in perlfunc) with redirection or shell
meta-characters;</p>

<p style="margin-top: 1em">2. Pipe-open (see
&quot;open&quot; in perlfunc) with the command which
contains redirection or shell meta-characters;</p>

<p style="margin-top: 1em">3. Backticks
&quot;&lsquo;&lsquo;&quot; (see &quot;I/O Operators&quot; in
perlop) with the command which contains redirection or shell
meta-characters;</p>

<p style="margin-top: 1em">4. If the executable called by
system()/exec()/pipe-open()/&quot;&lsquo;&lsquo;&quot; is a
script with the &quot;magic&quot; &quot;#!&quot; line or
&quot;extproc&quot; line which specifies shell;</p>

<p style="margin-top: 1em">5. If the executable called by
system()/exec()/pipe-open()/&quot;&lsquo;&lsquo;&quot; is a
script without &quot;magic&quot; line, and $ENV{EXECSHELL}
is set to shell;</p>

<p style="margin-top: 1em">6. If the executable called by
system()/exec()/pipe-open()/&quot;&lsquo;&lsquo;&quot; is
not found (is not this remark obsolete?);</p>

<p style="margin-top: 1em">7. For globbing (see
&quot;glob&quot; in perlfunc, &quot;I/O Operators&quot; in
perlop) (obsolete? Perl uses builtin globbing
nowadays...).</p>

<p style="margin-top: 1em">For the sake of speed for a
common case, in the above algorithms backslashes in the
command name are not considered as shell metacharacters.</p>

<p style="margin-top: 1em">Perl starts scripts which begin
with cookies &quot;extproc&quot; or &quot;#!&quot; directly,
without an intervention of shell. Perl uses the same
algorithm to find the executable as pdksh: if the <br>
path on &quot;#!&quot; line does not work, and contains
&quot;/&quot;, then the directory part of the executable is
ignored, and the executable is searched in . and on
&quot;PATH&quot;. To find arguments for <br>
these scripts Perl uses a different algorithm than pdksh: up
to 3 arguments are recognized, and trailing whitespace is
stripped.</p>

<p style="margin-top: 1em">If a script does not contain
such a cooky, then to avoid calling sh.exe, Perl uses the
same algorithm as pdksh: if $ENV{EXECSHELL} is set, the
script is given as the first <br>
argument to this command, if not set, then
&quot;$ENV{COMSPEC} /c&quot; is used (or a hardwired guess
if $ENV{COMSPEC} is not set).</p>

<p style="margin-top: 1em">When starting scripts directly,
Perl uses exactly the same algorithm as for the search of
script given by -S command-line option: it will look in the
current directory, then on <br>
components of $ENV{PATH} using the following order of
appended extensions: no extension, .cmd, .btm, .bat,
.pl.</p>

<p style="margin-top: 1em">Note that Perl will start to
look for scripts only if OS/2 cannot start the specified
application, thus &quot;system &rsquo;blah&rsquo;&quot; will
not look for a script if there is an executable file <br>
blah.exe anywhere on &quot;PATH&quot;. In other words,
&quot;PATH&quot; is essentially searched twice: once by the
OS for an executable, then by Perl for scripts.</p>

<p style="margin-top: 1em">Note also that executable files
on OS/2 can have an arbitrary extension, but .exe will be
automatically appended if no dot is present in the name. The
workaround is as simple as <br>
that: since blah. and blah denote the same file (at list on
FAT and HPFS file systems), to start an executable residing
in file n:/bin/blah (no extension) give an argument <br>
&quot;n:/bin/blah.&quot; (dot appended) to system().</p>

<p style="margin-top: 1em">Perl will start PM programs from
VIO (=text-mode) Perl process in a separate PM session; the
opposite is not true: when you start a non-PM program from a
PM Perl process, Perl <br>
would not run it in a separate session. If a separate
session is desired, either ensure that shell will be used,
as in &quot;system &rsquo;cmd /c myprog&rsquo;&quot;, or
start it using optional <br>
arguments to system() documented in &quot;OS2::Process&quot;
module. This is considered to be a feature.</p>

<p style="margin-top: 1em">Frequently asked questions <br>
&quot;It does not work&quot; <br>
Perl binary distributions come with a testperl.cmd script
which tries to detect common problems with misconfigured
installations. There is a pretty large chance it will
discover <br>
which step of the installation you managed to goof.
&quot;;-)&quot;</p>

<p style="margin-top: 1em">I cannot run external programs
<br>
&Acirc;&middot; Did you run your programs with
&quot;-w&quot; switch? See &quot;Starting OS/2 (and DOS)
programs under Perl&quot;.</p>

<p style="margin-top: 1em">&Acirc;&middot; Do you try to
run internal shell commands, like &quot;&lsquo;copy a
b&lsquo;&quot; (internal for cmd.exe), or &quot;&lsquo;glob
a*b&lsquo;&quot; (internal for ksh)? You need to specify
your shell explicitly, like &quot;&lsquo;cmd <br>
/c copy a b&lsquo;&quot;, since Perl cannot deduce which
commands are internal to your shell.</p>

<p style="margin-top: 1em">I cannot embed perl into my
program, or use perl.dll from my program. <br>
Is your program EMX-compiled with &quot;-Zmt -Zcrtdll&quot;?
<br>
Well, nowadays Perl DLL should be usable from a differently
compiled program too... If you can run Perl code from REXX
scripts (see OS2::REXX), then there are some other <br>
aspect of interaction which are overlooked by the current
hackish code to support differently-compiled principal
programs.</p>

<p style="margin-top: 1em">If everything else fails, you
need to build a stand-alone DLL for perl. Contact me, I did
it once. Sockets would not work, as a lot of other
stuff.</p>

<p style="margin-top: 1em">Did you use ExtUtils::Embed?
<br>
Some time ago I had reports it does not work. Nowadays it is
checked in the Perl test suite, so grep ./t subdirectory of
the build tree (as well as *.t files in the ./lib <br>
subdirectory) to find how it should be done
&quot;correctly&quot;.</p>

<p style="margin-top: 1em">&quot;&lsquo;&lsquo;&quot; and
pipe-&quot;open&quot; do not work under DOS. <br>
This may a variant of just &quot;I cannot run external
programs&quot;, or a deeper problem. Basically: you need RSX
(see &quot;Prerequisites&quot;) for these commands to work,
and you may need a <br>
port of sh.exe which understands command arguments. One of
such ports is listed in &quot;Prerequisites&quot; under RSX.
Do not forget to set variable &quot;PERL_SH_DIR&quot; as
well.</p>

<p style="margin-top: 1em">DPMI is required for RSX.</p>

<p style="margin-top: 1em">Cannot start &quot;find.exe
&quot;pattern&quot; file&quot; <br>
The whole idea of the &quot;standard C API to start
applications&quot; is that the forms &quot;foo&quot; and
&quot;foo&quot; of program arguments are completely
interchangeable. find breaks this paradigm;</p>

<p style="margin-top: 1em">find &quot;pattern&quot; file
<br>
find pattern file</p>

<p style="margin-top: 1em">are not equivalent; find cannot
be started directly using the above API. One needs a way to
surround the doublequotes in some other quoting
construction, necessarily having an <br>
extra non-Unixish shell in between.</p>

<p style="margin-top: 1em">Use one of</p>

<p style="margin-top: 1em">system &rsquo;cmd&rsquo;,
&rsquo;/c&rsquo;, &rsquo;find &quot;pattern&quot;
file&rsquo;; <br>
&lsquo;cmd /c &rsquo;find &quot;pattern&quot;
file&rsquo;&lsquo;</p>

<p style="margin-top: 1em">This would start find.exe via
cmd.exe via &quot;sh.exe&quot; via &quot;perl.exe&quot;, but
this is a price to pay if you want to use non-conforming
program.</p>

<p style="margin-top: 1em">INSTALLATION <br>
Automatic binary installation <br>
The most convenient way of installing a binary distribution
of perl is via perl installer install.exe. Just follow the
instructions, and 99% of the installation blues would go
<br>
away.</p>

<p style="margin-top: 1em">Note however, that you need to
have unzip.exe on your path, and EMX environment running.
The latter means that if you just installed EMX, and made
all the needed changes to <br>
Config.sys, you may need to reboot in between. Check EMX
runtime by running</p>

<p style="margin-top: 1em">emxrev</p>

<p style="margin-top: 1em">Binary installer also creates a
folder on your desktop with some useful objects. If you need
to change some aspects of the work of the binary installer,
feel free to edit the <br>
file Perl.pkg. This may be useful e.g., if you need to run
the installer many times and do not want to make many
interactive changes in the GUI.</p>

<p style="margin-top: 1em">Things not taken care of by
automatic binary installation:</p>

<p style="margin-top: 1em">&quot;PERL_BADLANG&quot; may be
needed if you change your codepage after perl installation,
and the new value is not supported by EMX. See
&quot;PERL_BADLANG&quot;.</p>

<p style="margin-top: 1em">&quot;PERL_BADFREE&quot; see
&quot;PERL_BADFREE&quot;.</p>

<p style="margin-top: 1em">Config.pm This file resides
somewhere deep in the location you installed your perl
library, find it out by</p>

<p style="margin-top: 1em">perl -MConfig -le &quot;print
$INC{&rsquo;Config.pm&rsquo;}&quot;</p>

<p style="margin-top: 1em">While most important values in
this file are updated by the binary installer, some of them
may need to be hand-edited. I know no such data, please keep
me informed <br>
if you find one. Moreover, manual changes to the installed
version may need to be accompanied by an edit of this
file.</p>

<p style="margin-top: 1em">NOTE. Because of a typo the
binary installer of 5.00305 would install a variable
&quot;PERL_SHPATH&quot; into Config.sys. Please remove this
variable and put &quot;PERL_SH_DIR&quot; instead.</p>

<p style="margin-top: 1em">Manual binary installation <br>
As of version 5.00305, OS/2 perl binary distribution comes
split into 11 components. Unfortunately, to enable
configurable binary installation, the file paths in the zip
files <br>
are not absolute, but relative to some directory.</p>

<p style="margin-top: 1em">Note that the extraction with
the stored paths is still necessary (default with unzip,
specify &quot;-d&quot; to pkunzip). However, you need to
know where to extract the files. You need <br>
also to manually change entries in Config.sys to reflect
where did you put the files. Note that if you have some
primitive unzipper (like &quot;pkunzip&quot;), you may get a
lot of <br>
warnings/errors during unzipping. Upgrade to
&quot;(w)unzip&quot;.</p>

<p style="margin-top: 1em">Below is the sample of what to
do to reproduce the configuration on my machine. In VIEW.EXE
you can press &quot;Ctrl-Insert&quot; now, and cut-and-paste
from the resulting file - created <br>
in the directory you started VIEW.EXE from.</p>

<p style="margin-top: 1em">For each component, we mention
environment variables related to each installation
directory. Either choose directories to match your values of
the variables, or create/append-to <br>
variables to take into account the directories.</p>

<p style="margin-top: 1em">Perl VIO and PM executables
(dynamically linked) <br>
unzip perl_exc.zip *.exe *.ico -d f:/emx.add/bin <br>
unzip perl_exc.zip *.dll -d f:/emx.add/dll</p>

<p style="margin-top: 1em">(have the directories with
&quot;*.exe&quot; on PATH, and &quot;*.dll&quot; on
LIBPATH);</p>

<p style="margin-top: 1em">Perl_ VIO executable (statically
linked) <br>
unzip perl_aou.zip -d f:/emx.add/bin</p>

<p style="margin-top: 1em">(have the directory on
PATH);</p>

<p style="margin-top: 1em">Executables for Perl utilities
<br>
unzip perl_utl.zip -d f:/emx.add/bin</p>

<p style="margin-top: 1em">(have the directory on
PATH);</p>

<p style="margin-top: 1em">Main Perl library <br>
unzip perl_mlb.zip -d f:/perllib/lib</p>

<p style="margin-top: 1em">If this directory is exactly the
same as the prefix which was compiled into perl.exe, you do
not need to change anything. However, for perl to find the
library if you use a <br>
different path, you need to &quot;set PERLLIB_PREFIX&quot;
in Config.sys, see &quot;PERLLIB_PREFIX&quot;.</p>

<p style="margin-top: 1em">Additional Perl modules <br>
unzip perl_ste.zip -d f:/perllib/lib/site_perl/5.16.3/</p>

<p style="margin-top: 1em">Same remark as above applies.
Additionally, if this directory is not one of directories on
@INC (and @INC is influenced by &quot;PERLLIB_PREFIX&quot;),
you need to put this directory <br>
and subdirectory ./os2 in &quot;PERLLIB&quot; or
&quot;PERL5LIB&quot; variable. Do not use
&quot;PERL5LIB&quot; unless you have it set already. See
&quot;ENVIRONMENT&quot; in perl.</p>

<p style="margin-top: 1em">[Check whether this extraction
directory is still applicable with the new directory
structure layout!]</p>

<p style="margin-top: 1em">Tools to compile Perl modules
<br>
unzip perl_blb.zip -d f:/perllib/lib</p>

<p style="margin-top: 1em">Same remark as for
perl_ste.zip.</p>

<p style="margin-top: 1em">Manpages for Perl and utilities
<br>
unzip perl_man.zip -d f:/perllib/man</p>

<p style="margin-top: 1em">This directory should better be
on &quot;MANPATH&quot;. You need to have a working man to
access these files.</p>

<p style="margin-top: 1em">Manpages for Perl modules <br>
unzip perl_mam.zip -d f:/perllib/man</p>

<p style="margin-top: 1em">This directory should better be
on &quot;MANPATH&quot;. You need to have a working man to
access these files.</p>

<p style="margin-top: 1em">Source for Perl documentation
<br>
unzip perl_pod.zip -d f:/perllib/lib</p>

<p style="margin-top: 1em">This is used by the
&quot;perldoc&quot; program (see perldoc), and may be used
to generate HTML documentation usable by WWW browsers, and
documentation in zillions of other formats: <br>
&quot;info&quot;, &quot;LaTeX&quot;, &quot;Acrobat&quot;,
&quot;FrameMaker&quot; and so on. [Use programs such as
pod2latex etc.]</p>

<p style="margin-top: 1em">Perl manual in .INF format <br>
unzip perl_inf.zip -d d:/os2/book</p>

<p style="margin-top: 1em">This directory should better be
on &quot;BOOKSHELF&quot;.</p>

<p style="margin-top: 1em">Pdksh <br>
unzip perl_sh.zip -d f:/bin</p>

<p style="margin-top: 1em">This is used by perl to run
external commands which explicitly require shell, like the
commands using redirection and shell metacharacters. It is
also used instead of explicit <br>
/bin/sh.</p>

<p style="margin-top: 1em">Set &quot;PERL_SH_DIR&quot; (see
&quot;PERL_SH_DIR&quot;) if you move sh.exe from the above
location.</p>

<p style="margin-top: 1em">Note. It may be possible to use
some other sh-compatible shell (untested).</p>

<p style="margin-top: 1em">After you installed the
components you needed and updated the Config.sys
correspondingly, you need to hand-edit Config.pm. This file
resides somewhere deep in the location you <br>
installed your perl library, find it out by</p>

<p style="margin-top: 1em">perl -MConfig -le &quot;print
$INC{&rsquo;Config.pm&rsquo;}&quot;</p>

<p style="margin-top: 1em">You need to correct all the
entries which look like file paths (they currently start
with &quot;f:/&quot;).</p>

<p style="margin-top: 1em">Warning <br>
The automatic and manual perl installation leave precompiled
paths inside perl executables. While these paths are
overwriteable (see &quot;PERLLIB_PREFIX&quot;,
&quot;PERL_SH_DIR&quot;), some people <br>
may prefer binary editing of paths inside the
executables/DLLs.</p>

<p style="margin-top: 1em">Accessing documentation <br>
Depending on how you built/installed perl you may have
(otherwise identical) Perl documentation in the following
formats:</p>

<p style="margin-top: 1em">OS/2 .INF file <br>
Most probably the most convenient form. Under OS/2 view it
as</p>

<p style="margin-top: 1em">view perl <br>
view perl perlfunc <br>
view perl less <br>
view perl ExtUtils::MakeMaker</p>

<p style="margin-top: 1em">(currently the last two may hit
a wrong location, but this may improve soon). Under Win* see
&quot;SYNOPSIS&quot;.</p>

<p style="margin-top: 1em">If you want to build the docs
yourself, and have OS/2 toolkit, run</p>

<p style="margin-top: 1em">pod2ipf &gt; perl.ipf</p>

<p style="margin-top: 1em">in /perllib/lib/pod directory,
then</p>

<p style="margin-top: 1em">ipfc /inf perl.ipf</p>

<p style="margin-top: 1em">(Expect a lot of errors during
the both steps.) Now move it on your BOOKSHELF path.</p>

<p style="margin-top: 1em">Plain text <br>
If you have perl documentation in the source form, perl
utilities installed, and GNU groff installed, you may
use</p>

<p style="margin-top: 1em">perldoc perlfunc <br>
perldoc less <br>
perldoc ExtUtils::MakeMaker</p>

<p style="margin-top: 1em">to access the perl documentation
in the text form (note that you may get better results using
perl manpages).</p>

<p style="margin-top: 1em">Alternately, try running
pod2text on .pod files.</p>

<p style="margin-top: 1em">Manpages <br>
If you have man installed on your system, and you installed
perl manpages, use something like this:</p>

<p style="margin-top: 1em">man perlfunc <br>
man 3 less <br>
man ExtUtils.MakeMaker</p>

<p style="margin-top: 1em">to access documentation for
different components of Perl. Start with</p>

<p style="margin-top: 1em">man perl</p>

<p style="margin-top: 1em">Note that dot (.) is used as a
package separator for documentation for packages, and as
usual, sometimes you need to give the section - 3 above - to
avoid shadowing by the <br>
less(1) manpage.</p>

<p style="margin-top: 1em">Make sure that the directory
above the directory with manpages is on our
&quot;MANPATH&quot;, like this</p>

<p style="margin-top: 1em">set
MANPATH=c:/man;f:/perllib/man</p>

<p style="margin-top: 1em">for Perl manpages in
&quot;f:/perllib/man/man1/&quot; etc.</p>

<p style="margin-top: 1em">HTML <br>
If you have some WWW browser available, installed the Perl
documentation in the source form, and Perl utilities, you
can build HTML docs. Cd to directory with .pod files, and do
<br>
like this</p>

<p style="margin-top: 1em">cd f:/perllib/lib/pod <br>
pod2html</p>

<p style="margin-top: 1em">After this you can direct your
browser the file perl.html in this directory, and go ahead
with reading docs, like this:</p>

<p style="margin-top: 1em">explore
file:///f:/perllib/lib/pod/perl.html</p>

<p style="margin-top: 1em">Alternatively you may be able to
get these docs prebuilt from CPAN.</p>

<p style="margin-top: 1em">GNU &quot;info&quot; files <br>
Users of Emacs would appreciate it very much, especially
with &quot;CPerl&quot; mode loaded. You need to get latest
&quot;pod2texi&quot; from &quot;CPAN&quot;, or, alternately,
the prebuilt info pages.</p>

<p style="margin-top: 1em">PDF files <br>
for &quot;Acrobat&quot; are available on CPAN (may be for
slightly older version of perl).</p>

<p style="margin-top: 1em">&quot;LaTeX&quot; docs <br>
can be constructed using &quot;pod2latex&quot;.</p>

<p style="margin-top: 1em">BUILD <br>
Here we discuss how to build Perl under OS/2.</p>

<p style="margin-top: 1em">The short story <br>
Assume that you are a seasoned porter, so are sure that all
the necessary tools are already present on your system, and
you know how to get the Perl source distribution. Untar <br>
it, change to the extract directory, and</p>

<p style="margin-top: 1em">gnupatch -p0 &lt;
os2iff.configure <br>
sh Configure -des -D prefix=f:/perllib <br>
make <br>
make test <br>
make install <br>
make aout_test <br>
make aout_install</p>

<p style="margin-top: 1em">This puts the executables in
f:/perllib/bin. Manually move them to the &quot;PATH&quot;,
manually move the built perl*.dll to &quot;LIBPATH&quot;
(here for Perl DLL * is a not-very-meaningful hex <br>
checksum), and run</p>

<p style="margin-top: 1em">make installcmd
INSTALLCMDDIR=d:/ir/on/path</p>

<p style="margin-top: 1em">Assuming that the
&quot;man&quot;-files were put on an appropriate location,
this completes the installation of minimal Perl system. (The
binary distribution contains also a lot of <br>
additional modules, and the documentation in INF
format.)</p>

<p style="margin-top: 1em">What follows is a detailed guide
through these steps.</p>

<p style="margin-top: 1em">Prerequisites <br>
You need to have the latest EMX development environment, the
full GNU tool suite (gawk renamed to awk, and GNU find.exe
earlier on path than the OS/2 find.exe, same with <br>
sort.exe, to check use</p>

<p style="margin-top: 1em">find --version <br>
sort --version</p>

<p style="margin-top: 1em">). You need the latest version
of pdksh installed as sh.exe.</p>

<p style="margin-top: 1em">Check that you have BSD
libraries and headers installed, and - optionally - Berkeley
DB headers and libraries, and crypt.</p>

<p style="margin-top: 1em">Possible locations to get the
files:</p>


<p style="margin-top: 1em">ftp://ftp.uni-heidelberg.de/pub/os2/unix/
<br>
http://hobbes.nmsu.edu/h-browse.php?dir=/pub/os2 <br>
http://cd.textfiles.com/hobbesos29804/disk1/DEV32/ <br>
http://cd.textfiles.com/hobbesos29804/disk1/EMX09C/</p>

<p style="margin-top: 1em">It is reported that the
following archives contain enough utils to build perl:
gnufutil.zip, gnusutil.zip, gnututil.zip, gnused.zip,
gnupatch.zip, gnuawk.zip, gnumake.zip, <br>
gnugrep.zip, bsddev.zip and ksh527rt.zip (or a later
version). Note that all these utilities are known to be
available from LEO:</p>


<p style="margin-top: 1em">ftp://crydee.sai.msu.ru/pub/comp/os/os2/leo/gnu/</p>

<p style="margin-top: 1em">Note also that the db.lib and
db.a from the EMX distribution are not suitable for
multi-threaded compile (even single-threaded flavor of Perl
uses multi-threaded C RTL, for <br>
compatibility with XFree86-OS/2). Get a corrected one
from</p>


<p style="margin-top: 1em">http://www.ilyaz.org/software/os2/db_mt.zip</p>

<p style="margin-top: 1em">If you have exactly the same
version of Perl installed already, make sure that no copies
or perl are currently running. Later steps of the build may
fail since an older version <br>
of perl.dll loaded into memory may be found. Running
&quot;make test&quot; becomes meaningless, since the test
are checking a previous build of perl (this situation is
detected and <br>
reported by lib/os2_base.t test). Do not forget to unset
&quot;PERL_EMXLOAD_SEC&quot; in environment.</p>

<p style="margin-top: 1em">Also make sure that you have
/tmp directory on the current drive, and . directory in your
&quot;LIBPATH&quot;. One may try to correct the latter
condition by</p>

<p style="margin-top: 1em">set BEGINLIBPATH ..</p>

<p style="margin-top: 1em">if you use something like
CMD.EXE or latest versions of 4os2.exe. (Setting
BEGINLIBPATH to just &quot;.&quot; is ignored by the OS/2
kernel.)</p>

<p style="margin-top: 1em">Make sure your gcc is good for
&quot;-Zomf&quot; linking: run &quot;omflibs&quot; script in
/emx/lib directory.</p>

<p style="margin-top: 1em">Check that you have link386
installed. It comes standard with OS/2, but may be not
installed due to customization. If typing</p>

<p style="margin-top: 1em">link386</p>

<p style="margin-top: 1em">shows you do not have it, do
Selective install, and choose &quot;Link object
modules&quot; in Optional system utilities/More. If you get
into link386 prompts, press &quot;Ctrl-C&quot; to exit.</p>

<p style="margin-top: 1em">Getting perl source <br>
You need to fetch the latest perl source (including
developers releases). With some probability it is located
in</p>

<p style="margin-top: 1em">http://www.cpan.org/src/ <br>
http://www.cpan.org/src/unsupported</p>

<p style="margin-top: 1em">If not, you may need to dig in
the indices to find it in the directory of the current
maintainer.</p>

<p style="margin-top: 1em">Quick cycle of developers
release may break the OS/2 build time to time, looking
into</p>


<p style="margin-top: 1em">http://www.cpan.org/ports/os2/</p>

<p style="margin-top: 1em">may indicate the latest release
which was publicly released by the maintainer. Note that the
release may include some additional patches to apply to the
current source of perl.</p>

<p style="margin-top: 1em">Extract it like this</p>

<p style="margin-top: 1em">tar vzxf perl5.00409.tar.gz</p>

<p style="margin-top: 1em">You may see a message about
errors while extracting Configure. This is because there is
a conflict with a similarly-named file configure.</p>

<p style="margin-top: 1em">Change to the directory of
extraction.</p>

<p style="margin-top: 1em">Application of the patches <br>
You need to apply the patches in ./os2/diff.* like this:</p>

<p style="margin-top: 1em">gnupatch -p0 &lt;
os2iff.configure</p>

<p style="margin-top: 1em">You may also need to apply the
patches supplied with the binary distribution of perl. It
also makes sense to look on the perl5-porters mailing list
for the latest OS/2-related <br>
patches (see
http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/
&lt;http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/&gt;).
Such patches usually contain strings &quot;/os2/&quot; and
<br>
&quot;patch&quot;, so it makes sense looking for these
strings.</p>

<p style="margin-top: 1em">Hand-editing <br>
You may look into the file ./hints/os2.sh and correct
anything wrong you find there. I do not expect it is needed
anywhere.</p>

<p style="margin-top: 1em">Making <br>
sh Configure -des -D prefix=f:/perllib</p>

<p style="margin-top: 1em">&quot;prefix&quot; means: where
to install the resulting perl library. Giving correct prefix
you may avoid the need to specify
&quot;PERLLIB_PREFIX&quot;, see
&quot;PERLLIB_PREFIX&quot;.</p>

<p style="margin-top: 1em">Ignore the message about missing
&quot;ln&quot;, and about &quot;-c&quot; option to tr. The
latter is most probably already fixed, if you see it and can
trace where the latter spurious warning comes <br>
from, please inform me.</p>

<p style="margin-top: 1em">Now</p>

<p style="margin-top: 1em">make</p>

<p style="margin-top: 1em">At some moment the built may
die, reporting a version mismatch or unable to run perl.
This means that you do not have . in your LIBPATH, so
perl.exe cannot find the needed <br>
perl67B2.dll (treat these hex digits as line noise). After
this is fixed the build should finish without a lot of
fuss.</p>

<p style="margin-top: 1em">Testing <br>
Now run</p>

<p style="margin-top: 1em">make test</p>

<p style="margin-top: 1em">All tests should succeed (with
some of them skipped). If you have the same version of Perl
installed, it is crucial that you have &quot;.&quot; early
in your LIBPATH (or in BEGINLIBPATH), <br>
otherwise your tests will most probably test the wrong
version of Perl.</p>

<p style="margin-top: 1em">Some tests may generate extra
messages similar to</p>

<p style="margin-top: 1em">A lot of &quot;bad free&quot;
<br>
in database tests related to Berkeley DB. This should be
fixed already. If it persists, you may disable this
warnings, see &quot;PERL_BADFREE&quot;.</p>

<p style="margin-top: 1em">Process terminated by
SIGTERM/SIGINT <br>
This is a standard message issued by OS/2 applications. *nix
applications die in silence. It is considered to be a
feature. One can easily disable this by appropriate <br>
sighandlers.</p>

<p style="margin-top: 1em">However the test engine bleeds
these message to screen in unexpected moments. Two messages
of this kind should be present during testing.</p>

<p style="margin-top: 1em">To get finer test reports,
call</p>

<p style="margin-top: 1em">perl t/harness</p>

<p style="margin-top: 1em">The report with io/pipe.t
failing may look like this:</p>

<p style="margin-top: 1em">Failed Test Status Wstat Total
Fail Failed List of failed <br>

------------------------------------------------------------
<br>
io/pipe.t 12 1 8.33% 9 <br>
7 tests skipped, plus 56 subtests skipped. <br>
Failed 1/195 test scripts, 99.49% okay. 1/6542 subtests
failed, 99.98% okay.</p>

<p style="margin-top: 1em">The reasons for most important
skipped tests are:</p>

<p style="margin-top: 1em">op/fs.t <br>
18 Checks &quot;atime&quot; and &quot;mtime&quot; of
&quot;stat()&quot; - unfortunately, HPFS provides only 2sec
time granularity (for compatibility with FAT?).</p>

<p style="margin-top: 1em">25 Checks &quot;truncate()&quot;
on a filehandle just opened for write - I do not know why
this should or should not work.</p>

<p style="margin-top: 1em">op/stat.t <br>
Checks &quot;stat()&quot;. Tests:</p>

<p style="margin-top: 1em">4 Checks &quot;atime&quot; and
&quot;mtime&quot; of &quot;stat()&quot; - unfortunately,
HPFS provides only 2sec time granularity (for compatibility
with FAT?).</p>

<p style="margin-top: 1em">Installing the built perl <br>
If you haven&rsquo;t yet moved &quot;perl*.dll&quot; onto
LIBPATH, do it now.</p>

<p style="margin-top: 1em">Run</p>

<p style="margin-top: 1em">make install</p>

<p style="margin-top: 1em">It would put the generated files
into needed locations. Manually put perl.exe, perl__.exe and
perl___.exe to a location on your PATH, perl.dll to a
location on your LIBPATH.</p>

<p style="margin-top: 1em">Run</p>

<p style="margin-top: 1em">make installcmd
INSTALLCMDDIR=d:/ir/on/path</p>

<p style="margin-top: 1em">to convert perl utilities to
.cmd files and put them on PATH. You need to put
.EXE-utilities on path manually. They are installed in
&quot;$prefix/bin&quot;, here $prefix is what you gave <br>
to Configure, see &quot;Making&quot;.</p>

<p style="margin-top: 1em">If you use &quot;man&quot;,
either move the installed */man/ directories to your
&quot;MANPATH&quot;, or modify &quot;MANPATH&quot; to match
the location. (One could have avoided this by providing a
correct <br>
&quot;manpath&quot; option to ./Configure, or editing
./config.sh between configuring and making steps.)</p>

<p style="margin-top: 1em">&quot;a.out&quot;-style build
<br>
Proceed as above, but make perl_.exe (see
&quot;perl_.exe&quot;) by</p>

<p style="margin-top: 1em">make perl_</p>

<p style="margin-top: 1em">test and install by</p>

<p style="margin-top: 1em">make aout_test <br>
make aout_install</p>

<p style="margin-top: 1em">Manually put perl_.exe to a
location on your PATH.</p>

<p style="margin-top: 1em">Note. The build process for
&quot;perl_&quot; does not know about all the dependencies,
so you should make sure that anything is up-to-date, say, by
doing</p>

<p style="margin-top: 1em">make perl_dll</p>

<p style="margin-top: 1em">first.</p>

<p style="margin-top: 1em">Building a binary distribution
<br>
[This section provides a short overview only...]</p>

<p style="margin-top: 1em">Building should proceed
differently depending on whether the version of perl you
install is already present and used on your system, or is a
new version not yet used. The <br>
description below assumes that the version is new, so
installing its DLLs and .pm files will not disrupt the
operation of your system even if some intermediate steps are
not yet <br>
fully working.</p>

<p style="margin-top: 1em">The other cases require a little
bit more convoluted procedures. Below I suppose that the
current version of Perl is 5.8.2, so the executables are
named accordingly.</p>

<p style="margin-top: 1em">1. Fully build and test the Perl
distribution. Make sure that no tests are failing with
&quot;test&quot; and &quot;aout_test&quot; targets; fix the
bugs in Perl and the Perl test suite detected by <br>
these tests. Make sure that &quot;all_test&quot; make target
runs as clean as possible. Check that os2/perlrexx.cmd runs
fine.</p>

<p style="margin-top: 1em">2. Fully install Perl, including
&quot;installcmd&quot; target. Copy the generated DLLs to
&quot;LIBPATH&quot;; copy the numbered Perl executables (as
in perl5.8.2.exe) to &quot;PATH&quot;; copy
&quot;perl_.exe&quot; <br>
to &quot;PATH&quot; as &quot;perl_5.8.2.exe&quot;. Think
whether you need backward-compatibility DLLs. In most cases
you do not need to install them yet; but sometime this may
simplify the <br>
following steps.</p>

<p style="margin-top: 1em">3. Make sure that
&quot;CPAN.pm&quot; can download files from CPAN. If not,
you may need to manually install &quot;Net::FTP&quot;.</p>

<p style="margin-top: 1em">4. Install the bundle
&quot;Bundle::OS2_default&quot;</p>

<p style="margin-top: 1em">perl5.8.2 -MCPAN -e
&quot;install Bundle::OS2_default&quot; &lt; nul |&amp; tee
00cpan_i_1</p>

<p style="margin-top: 1em">This may take a couple of hours
on 1GHz processor (when run the first time). And this should
not be necessarily a smooth procedure. Some modules may not
specify required <br>
dependencies, so one may need to repeat this procedure
several times until the results stabilize.</p>

<p style="margin-top: 1em">perl5.8.2 -MCPAN -e
&quot;install Bundle::OS2_default&quot; &lt; nul |&amp; tee
00cpan_i_2 <br>
perl5.8.2 -MCPAN -e &quot;install Bundle::OS2_default&quot;
&lt; nul |&amp; tee 00cpan_i_3</p>

<p style="margin-top: 1em">Even after they stabilize, some
tests may fail.</p>

<p style="margin-top: 1em">Fix as many discovered bugs as
possible. Document all the bugs which are not fixed, and all
the failures with unknown reasons. Inspect the produced logs
00cpan_i_1 to find <br>
suspiciously skipped tests, and other fishy events.</p>

<p style="margin-top: 1em">Keep in mind that installation
of some modules may fail too: for example, the DLLs to
update may be already loaded by CPAN.pm. Inspect the
&quot;install&quot; logs (in the example <br>
above 00cpan_i_1 etc) for errors, and install things
manually, as in</p>

<p style="margin-top: 1em">cd
$CPANHOME/.cpan/build/Digest-MD5-2.31 <br>
make install</p>

<p style="margin-top: 1em">Some distributions may fail some
tests, but you may want to install them anyway (as above, or
via &quot;force install&quot; command of &quot;CPAN.pm&quot;
shell-mode).</p>

<p style="margin-top: 1em">Since this procedure may take
quite a long time to complete, it makes sense to
&quot;freeze&quot; your CPAN configuration by disabling
periodic updates of the local copy of CPAN index: <br>
set &quot;index_expire&quot; to some big value (I use 365),
then save the settings</p>

<p style="margin-top: 1em">CPAN&gt; o conf index_expire 365
<br>
CPAN&gt; o conf commit</p>

<p style="margin-top: 1em">Reset back to the default value
1 when you are finished.</p>

<p style="margin-top: 1em">5. When satisfied with the
results, rerun the &quot;installcmd&quot; target. Now you
can copy &quot;perl5.8.2.exe&quot; to &quot;perl.exe&quot;,
and install the other OMF-build executables:
&quot;perl__.exe&quot; <br>
etc. They are ready to be used.</p>

<p style="margin-top: 1em">6. Change to the
&quot;./pod&quot; directory of the build tree, download the
Perl logo CamelGrayBig.BMP, and run</p>

<p style="margin-top: 1em">( perl2ipf &gt; perl.ipf )
|&amp; tee 00ipf <br>
ipfc /INF perl.ipf |&amp; tee 00inf</p>

<p style="margin-top: 1em">This produces the Perl docs
online book &quot;perl.INF&quot;. Install in on
&quot;BOOKSHELF&quot; path.</p>

<p style="margin-top: 1em">7. Now is the time to build
statically linked executable perl_.exe which includes
newly-installed via &quot;Bundle::OS2_default&quot; modules.
Doing testing via &quot;CPAN.pm&quot; is going to be <br>
painfully slow, since it statically links a new executable
per XS extension.</p>

<p style="margin-top: 1em">Here is a possible workaround:
create a toplevel Makefile.PL in $CPANHOME/.cpan/build/ with
contents being (compare with &quot;Making executables with a
custom collection of <br>
statically loaded extensions&quot;)</p>

<p style="margin-top: 1em">use ExtUtils::MakeMaker; <br>
WriteMakefile NAME =&gt; &rsquo;dummy&rsquo;;</p>

<p style="margin-top: 1em">execute this as</p>

<p style="margin-top: 1em">perl_5.8.2.exe Makefile.PL
&lt;nul |&amp; tee 00aout_c1 <br>
make -k all test &lt;nul |&amp; 00aout_t1</p>

<p style="margin-top: 1em">Again, this procedure should not
be absolutely smooth. Some &quot;Makefile.PL&quot;&rsquo;s
in subdirectories may be buggy, and would not run as
&quot;child&quot; scripts. The interdependency of <br>
modules can strike you; however, since non-XS modules are
already installed, the prerequisites of most modules have a
very good chance to be present.</p>

<p style="margin-top: 1em">If you discover some glitches,
move directories of problematic modules to a different
location; if these modules are non-XS modules, you may just
ignore them - they are <br>
already installed; the remaining, XS, modules you need to
install manually one by one.</p>

<p style="margin-top: 1em">After each such removal you need
to rerun the &quot;Makefile.PL&quot;/&quot;make&quot;
process; usually this procedure converges soon. (But be sure
to convert all the necessary external C <br>
libraries from .lib format to .a format: run one of</p>

<p style="margin-top: 1em">emxaout foo.lib <br>
emximp -o foo.a foo.lib</p>

<p style="margin-top: 1em">whichever is appropriate.) Also,
make sure that the DLLs for external libraries are usable
with with executables compiled without &quot;-Zmtd&quot;
options.</p>

<p style="margin-top: 1em">When you are sure that only a
few subdirectories lead to failures, you may want to add
&quot;-j4&quot; option to &quot;make&quot; to speed up
skipping subdirectories with already finished build.</p>

<p style="margin-top: 1em">When you are satisfied with the
results of tests, install the build C libraries for
extensions:</p>

<p style="margin-top: 1em">make install |&amp; tee
00aout_i</p>

<p style="margin-top: 1em">Now you can rename the file
./perl.exe generated during the last phase to
perl_5.8.2.exe; place it on &quot;PATH&quot;; if there is an
inter-dependency between some XS modules, you may <br>
need to repeat the &quot;test&quot;/&quot;install&quot; loop
with this new executable and some excluded modules - until
the procedure converges.</p>

<p style="margin-top: 1em">Now you have all the necessary
.a libraries for these Perl modules in the places where Perl
builder can find it. Use the perl builder: change to an
empty directory, create a <br>
&quot;dummy&quot; Makefile.PL again, and run</p>

<p style="margin-top: 1em">perl_5.8.2.exe Makefile.PL
|&amp; tee 00c <br>
make perl |&amp; tee 00p</p>

<p style="margin-top: 1em">This should create an executable
./perl.exe with all the statically loaded extensions built
in. Compare the generated perlmain.c files to make sure that
during the <br>
iterations the number of loaded extensions only increases.
Rename ./perl.exe to perl_5.8.2.exe on &quot;PATH&quot;.</p>

<p style="margin-top: 1em">When it converges, you got a
functional variant of perl_5.8.2.exe; copy it to
&quot;perl_.exe&quot;. You are done with generation of the
local Perl installation.</p>

<p style="margin-top: 1em">8. Make sure that the installed
modules are actually installed in the location of the new
Perl, and are not inherited from entries of @INC given for
inheritance from the older <br>
versions of Perl: set &quot;PERLLIB_582_PREFIX&quot; to
redirect the new version of Perl to a new location, and copy
the installed files to this new location. Redo the tests to
make <br>
sure that the versions of modules inherited from older
versions of Perl are not needed.</p>

<p style="margin-top: 1em">Actually, the log output of
pod2ipf(1) during the step 6 gives a very detailed info
about which modules are loaded from which place; so you may
use it as an additional <br>
verification tool.</p>

<p style="margin-top: 1em">Check that some temporary files
did not make into the perl install tree. Run something like
this</p>

<p style="margin-top: 1em">pfind . -f
&quot;!(/.(pm|pl|ix|al|h|a|lib|txt|pod|imp|bs|dll|ld|bs|inc|xbm|yml|cgi|uu|e2x|skip|packlist|eg|cfg|html|pub|enc|all|ini|po|pot)$/i
or /^264</p>

<p style="margin-top: 1em">in the install tree (both top
one and sitelib one).</p>

<p style="margin-top: 1em">Compress all the DLLs with
lxlite. The tiny .exe can be compressed with
&quot;/c:max&quot; (the bug only appears when there is a
fixup in the last 6 bytes of a page (?); since the <br>
tiny executables are much smaller than a page, the bug will
not hit). Do not compress &quot;perl_.exe&quot; - it would
not work under DOS.</p>

<p style="margin-top: 1em">9. Now you can generate the
binary distribution. This is done by running the test of the
CPAN distribution &quot;OS2::SoftInstaller&quot;. Tune up
the file test.pl to suit the layout of <br>
current version of Perl first. Do not forget to pack the
necessary external DLLs accordingly. Include the description
of the bugs and test suite failures you could not fix. <br>
Include the small-stack versions of Perl executables from
Perl build directory.</p>

<p style="margin-top: 1em">Include perl5.def so that people
can relink the perl DLL preserving the binary compatibility,
or can create compatibility DLLs. Include the diff files
(&quot;diff -pu old new&quot;) <br>
of fixes you did so that people can rebuild your version.
Include perl5.map so that one can use remote debugging.</p>

<p style="margin-top: 1em">10. Share what you did with the
other people. Relax. Enjoy fruits of your work.</p>

<p style="margin-top: 1em">11. Brace yourself for thanks,
bug reports, hate mail and spam coming as result of the
previous step. No good deed should remain unpunished!</p>

<p style="margin-top: 1em">Building custom .EXE files <br>
The Perl executables can be easily rebuilt at any moment.
Moreover, one can use the embedding interface (see
perlembed) to make very customized executables.</p>

<p style="margin-top: 1em">Making executables with a custom
collection of statically loaded extensions <br>
It is a little bit easier to do so while decreasing the list
of statically loaded extensions. We discuss this case only
here.</p>

<p style="margin-top: 1em">1. Change to an empty directory,
and create a placeholder &lt;Makefile.PL&gt;:</p>

<p style="margin-top: 1em">use ExtUtils::MakeMaker; <br>
WriteMakefile NAME =&gt; &rsquo;dummy&rsquo;;</p>

<p style="margin-top: 1em">2. Run it with the flavor of
Perl (perl.exe or perl_.exe) you want to rebuild.</p>

<p style="margin-top: 1em">perl_ Makefile.PL</p>

<p style="margin-top: 1em">3. Ask it to create new Perl
executable:</p>

<p style="margin-top: 1em">make perl</p>

<p style="margin-top: 1em">(you may need to manually add
&quot;PERLTYPE=-DPERL_CORE&quot; to this commandline on some
versions of Perl; the symptom is that the command-line
globbing does not work from OS/2 <br>
shells with the newly-compiled executable; check with</p>

<p style="margin-top: 1em">.erl.exe -wle &quot;print for
@ARGV&quot; *</p>

<p style="margin-top: 1em">).</p>

<p style="margin-top: 1em">4. The previous step created
perlmain.c which contains a list of newXS() calls near the
end. Removing unnecessary calls, and rerunning</p>

<p style="margin-top: 1em">make perl</p>

<p style="margin-top: 1em">will produce a customized
executable.</p>

<p style="margin-top: 1em">Making executables with a custom
search-paths <br>
The default perl executable is flexible enough to support
most usages. However, one may want something yet more
flexible; for example, one may want to find Perl DLL
relatively <br>
to the location of the EXE file; or one may want to ignore
the environment when setting the Perl-library search patch,
etc.</p>

<p style="margin-top: 1em">If you fill comfortable with
embedding interface (see perlembed), such things are easy to
do repeating the steps outlined in &quot;Making executables
with a custom collection of <br>
statically loaded extensions&quot;, and doing more
comprehensive edits to main() of perlmain.c. The people with
little desire to understand Perl can just rename main(), and
do <br>
necessary modification in a custom main() which calls the
renamed function in appropriate time.</p>

<p style="margin-top: 1em">However, there is a third way:
perl DLL exports the main() function and several callbacks
to customize the search path. Below is a complete example of
a &quot;Perl loader&quot; which</p>

<p style="margin-top: 1em">1. Looks for Perl DLL in the
directory &quot;$exedir/../dll&quot;;</p>

<p style="margin-top: 1em">2. Prepends the above directory
to &quot;BEGINLIBPATH&quot;;</p>

<p style="margin-top: 1em">3. Fails if the Perl DLL found
via &quot;BEGINLIBPATH&quot; is different from what was
loaded on step 1; e.g., another process could have loaded it
from &quot;LIBPATH&quot; or from a different <br>
value of &quot;BEGINLIBPATH&quot;. In these cases one needs
to modify the setting of the system so that this other
process either does not run, or loads the DLL from
&quot;BEGINLIBPATH&quot; <br>
with &quot;LIBPATHSTRICT=T&quot; (available with kernels
after September 2000).</p>

<p style="margin-top: 1em">4. Loads Perl library from
&quot;$exedir/../dll/lib/&quot;.</p>

<p style="margin-top: 1em">5. Uses Bourne shell from
&quot;$exedir/../dll/sh/ksh.exe&quot;.</p>

<p style="margin-top: 1em">For best results compile the C
file below with the same options as the Perl DLL. However, a
lot of functionality will work even if the executable is not
an EMX applications, <br>
e.g., if compiled with</p>

<p style="margin-top: 1em">gcc -Wall -DDOSISH -DOS2=1 -O2
-s -Zomf -Zsys perl-starter.c -DPERL_DLL_BASENAME=</p>

<p style="margin-top: 1em">Here is the sample C file:</p>

<p style="margin-top: 1em">#define INCL_DOS <br>
#define INCL_NOPM <br>
/* These are needed for compile if os2.h includes os2tk.h,
not os2emx.h */ <br>
#define INCL_DOSPROCESS <br>
#include &lt;os2.h&gt;</p>

<p style="margin-top: 1em">#include &quot;EXTERN.h&quot;
<br>
#define PERL_IN_MINIPERLMAIN_C <br>
#include &quot;perl.h&quot;</p>

<p style="margin-top: 1em">static char *me; <br>
HMODULE handle;</p>

<p style="margin-top: 1em">static void <br>
die_with(char *msg1, char *msg2, char *msg3, char *msg4)
<br>
{ <br>
ULONG c; <br>
char *s = &quot; error: &quot;;</p>

<p style="margin-top: 1em">DosWrite(2, me, strlen(me),
&amp;c); <br>
DosWrite(2, s, strlen(s), &amp;c); <br>
DosWrite(2, msg1, strlen(msg1), &amp;c); <br>
DosWrite(2, msg2, strlen(msg2), &amp;c); <br>
DosWrite(2, msg3, strlen(msg3), &amp;c); <br>
DosWrite(2, msg4, strlen(msg4), &amp;c);0, 2, &amp;c); <br>
DosWrite(2, &quot; <br>
exit(255); <br>
}</p>

<p style="margin-top: 1em">typedef ULONG
(*fill_extLibpath_t)(int type, char *pre, char *post, int
replace, char *msg); <br>
typedef int (*main_t)(int type, char *argv[], char *env[]);
<br>
typedef int (*handler_t)(void* data, int which);</p>

<p style="margin-top: 1em">#ifndef PERL_DLL_BASENAME <br>
# define PERL_DLL_BASENAME &quot;perl&quot; <br>
#endif</p>

<p style="margin-top: 1em">static HMODULE <br>
load_perl_dll(char *basename) <br>
{ <br>
char buf[300], fail[260]; <br>
STRLEN l, dirl; <br>
fill_extLibpath_t f; <br>
ULONG rc_fullname; <br>
HMODULE handle, handle1;</p>

<p style="margin-top: 1em">if (_execname(buf, sizeof(buf) -
13) != 0) <br>
die_with(&quot;Can&rsquo;t find full path: &quot;,
strerror(errno), &quot;&quot;, &quot;&quot;); <br>
/* XXXX Fill &rsquo;me&rsquo; with new value */ <br>
l = strlen(buf); <br>
while (l &amp;&amp; buf[l-1] != &rsquo;/&rsquo; &amp;&amp;
buf[l-1] != &rsquo;\&rsquo;) <br>
l--; <br>
dirl = l - 1; <br>
strcpy(buf + l, basename); <br>
l += strlen(basename); <br>
strcpy(buf + l, &quot;.dll&quot;); <br>
if ( (rc_fullname = DosLoadModule(fail, sizeof fail, buf,
&amp;handle)) != 0 <br>
&amp;&amp; DosLoadModule(fail, sizeof fail, basename,
&amp;handle) != 0 ) <br>
die_with(&quot;Can&rsquo;t load DLL &quot;, buf,
&quot;&quot;, &quot;&quot;); <br>
if (rc_fullname) <br>
return handle; /* was loaded with short name; all is fine */
<br>
if (DosQueryProcAddr(handle, 0, &quot;fill_extLibpath&quot;,
(PFN*)&amp;f)) <br>
die_with(buf, &quot;: DLL exports no symbol &quot;,
&quot;fill_extLibpath&quot;, &quot;&quot;); <br>
buf[dirl] = 0; <br>
if (f(0 /*BEGINLIBPATH*/, buf /* prepend */, NULL /* append
*/, <br>
0 /* keep old value */, me)) <br>
die_with(me, &quot;: prepending BEGINLIBPATH&quot;,
&quot;&quot;, &quot;&quot;); <br>
if (DosLoadModule(fail, sizeof fail, basename, &amp;handle1)
!= 0) <br>
die_with(me, &quot;: finding perl DLL again via
BEGINLIBPATH&quot;, &quot;&quot;, &quot;&quot;); <br>
buf[dirl] = &rsquo;\&rsquo;; <br>
if (handle1 != handle) { <br>
if (DosQueryModuleName(handle1, sizeof(fail), fail)) <br>
strcpy(fail, &quot;???&quot;); <br>
die_with(buf, &quot;:perl DLL via BEGINLIBPATH is different:
&quot;, <br>
fail, <br>
&quot;You may need to manipulate global BEGINLIBPATH and
LIBPATHSTRICT&quot; <br>
&quot;so that the other copy is loaded via
BEGINLIBPATH.&quot;); <br>
} <br>
return handle; <br>
}</p>

<p style="margin-top: 1em">int <br>
main(int argc, char **argv, char **env) <br>
{ <br>
main_t f; <br>
handler_t h;</p>

<p style="margin-top: 1em">me = argv[0]; <br>
/**/ <br>
handle = load_perl_dll(PERL_DLL_BASENAME);</p>

<p style="margin-top: 1em">if (DosQueryProcAddr(handle, 0,
&quot;Perl_OS2_handler_install&quot;, (PFN*)&amp;h)) <br>
die_with(PERL_DLL_BASENAME, &quot;: DLL exports no symbol
&quot;, &quot;Perl_OS2_handler_install&quot;, &quot;&quot;);
<br>
if ( !h((void *)&quot;~installprefix&quot;,
Perlos2_handler_perllib_from) <br>
|| !h((void *)&quot;~dll&quot;, Perlos2_handler_perllib_to)
<br>
|| !h((void *)&quot;~dll/sh/ksh.exe&quot;,
Perlos2_handler_perl_sh) ) <br>
die_with(PERL_DLL_BASENAME, &quot;: Can&rsquo;t install @INC
manglers&quot;, &quot;&quot;, &quot;&quot;);</p>

<p style="margin-top: 1em">if (DosQueryProcAddr(handle, 0,
&quot;dll_perlmain&quot;, (PFN*)&amp;f)) <br>
die_with(PERL_DLL_BASENAME, &quot;: DLL exports no symbol
&quot;, &quot;dll_perlmain&quot;, &quot;&quot;); <br>
return f(argc, argv, env); <br>
}</p>

<p style="margin-top: 1em">Build FAQ <br>
Some &quot;/&quot; became &quot; <br>
You have a very old pdksh. See
&quot;Prerequisites&quot;.</p>

<p style="margin-top: 1em">&rsquo;errno&rsquo; - unresolved
external <br>
You do not have MT-safe db.lib. See
&quot;Prerequisites&quot;.</p>

<p style="margin-top: 1em">Problems with tr or sed <br>
reported with very old version of tr and sed.</p>

<p style="margin-top: 1em">Some problem (forget which ;-)
<br>
You have an older version of perl.dll on your LIBPATH, which
broke the build of extensions.</p>

<p style="margin-top: 1em">Library ... not found <br>
You did not run &quot;omflibs&quot;. See
&quot;Prerequisites&quot;.</p>

<p style="margin-top: 1em">Segfault in make <br>
You use an old version of GNU make. See
&quot;Prerequisites&quot;.</p>

<p style="margin-top: 1em">op/sprintf test failure <br>
This can result from a bug in emx sprintf which was fixed in
0.9d fix 03.</p>

<p style="margin-top: 1em">Specific (mis)features of OS/2
port <br>
&quot;setpriority&quot;, &quot;getpriority&quot; <br>
Note that these functions are compatible with *nix, not with
the older ports of &rsquo;94 - 95. The priorities are
absolute, go from 32 to -95, lower is quicker. 0 is the
default <br>
priority.</p>

<p style="margin-top: 1em">WARNING. Calling
&quot;getpriority&quot; on a non-existing process could lock
the system before Warp3 fixpak22. Starting with Warp3, Perl
will use a workaround: it aborts getpriority() <br>
if the process is not present. This is not possible on older
versions &quot;2.*&quot;, and has a race condition
anyway.</p>

<p style="margin-top: 1em">&quot;system()&quot; <br>
Multi-argument form of &quot;system()&quot; allows an
additional numeric argument. The meaning of this argument is
described in OS2::Process.</p>

<p style="margin-top: 1em">When finding a program to run,
Perl first asks the OS to look for executables on
&quot;PATH&quot; (OS/2 adds extension .exe if no extension
is present). If not found, it looks for a <br>
script with possible extensions added in this order: no
extension, .cmd, .btm, .bat, .pl. If found, Perl checks the
start of the file for magic strings &quot;#!&quot; and
&quot;extproc &quot;. If <br>
found, Perl uses the rest of the first line as the beginning
of the command line to run this script. The only mangling
done to the first line is extraction of arguments <br>
(currently up to 3), and ignoring of the path-part of the
&quot;interpreter&quot; name if it can&rsquo;t be found
using the full path.</p>

<p style="margin-top: 1em">E.g., &quot;system
&rsquo;foo&rsquo;, &rsquo;bar&rsquo;,
&rsquo;baz&rsquo;&quot; may lead Perl to finding
C:/emx/bin/foo.cmd with the first line being</p>

<p style="margin-top: 1em">extproc /bin/bash -x -c</p>

<p style="margin-top: 1em">If /bin/bash.exe is not found,
then Perl looks for an executable bash.exe on
&quot;PATH&quot;. If found in C:/emx.add/bin/bash.exe, then
the above system() is translated to</p>

<p style="margin-top: 1em">system
qw(C:/emx.add/bin/bash.exe -x -c C:/emx/bin/foo.cmd bar
baz)</p>

<p style="margin-top: 1em">One additional translation is
performed: instead of /bin/sh Perl uses the
hardwired-or-customized shell (see
&quot;PERL_SH_DIR&quot;).</p>

<p style="margin-top: 1em">The above search for
&quot;interpreter&quot; is recursive: if bash executable is
not found, but bash.btm is found, Perl will investigate its
first line etc. The only hardwired limit on <br>
the recursion depth is implicit: there is a limit 4 on the
number of additional arguments inserted before the actual
arguments given to system(). In particular, if no additional
<br>
arguments are specified on the &quot;magic&quot; first
lines, then the limit on the depth is 4.</p>

<p style="margin-top: 1em">If Perl finds that the found
executable is of PM type when the current session is not, it
will start the new process in a separate session of
necessary type. Call via <br>
&quot;OS2::Process&quot; to disable this magic.</p>

<p style="margin-top: 1em">WARNING. Due to the described
logic, you need to explicitly specify .com extension if
needed. Moreover, if the executable perl5.6.1 is requested,
Perl will not look for <br>
perl5.6.1.exe. [This may change in the future.]</p>

<p style="margin-top: 1em">&quot;extproc&quot; on the first
line <br>
If the first chars of a Perl script are &quot;extproc
&quot;, this line is treated as &quot;#!&quot;-line, thus
all the switches on this line are processed (twice if script
was started via cmd.exe). <br>
See &quot;DESCRIPTION&quot; in perlrun.</p>

<p style="margin-top: 1em">Additional modules: <br>
OS2::Process, OS2::DLL, OS2::REXX, OS2::PrfDB, OS2::ExtAttr.
These modules provide access to additional numeric argument
for &quot;system&quot; and to the information about the
running <br>
process, to DLLs having functions with REXX signature and to
the REXX runtime, to OS/2 databases in the .INI format, and
to Extended Attributes.</p>

<p style="margin-top: 1em">Two additional extensions by
Andreas Kaiser, &quot;OS2::UPM&quot;, and
&quot;OS2::FTP&quot;, are included into &quot;ILYAZ&quot;
directory, mirrored on CPAN. Other OS/2-related extensions
are available too.</p>

<p style="margin-top: 1em">Prebuilt methods: <br>
&quot;File::Copy::syscopy&quot; <br>
used by &quot;File::Copy::copy&quot;, see File::Copy.</p>


<p style="margin-top: 1em">&quot;DynaLoader::mod2fname&quot;
<br>
used by &quot;DynaLoader&quot; for DLL name mangling.</p>


<p style="margin-top: 1em">&quot;Cwd::current_drive()&quot;
<br>
Self explanatory.</p>


<p style="margin-top: 1em">&quot;Cwd::sys_chdir(name)&quot;
<br>
leaves drive as it is.</p>


<p style="margin-top: 1em">&quot;Cwd::change_drive(name)&quot;
<br>
changes the &quot;current&quot; drive.</p>


<p style="margin-top: 1em">&quot;Cwd::sys_is_absolute(name)&quot;
<br>
means has drive letter and is_rooted.</p>


<p style="margin-top: 1em">&quot;Cwd::sys_is_rooted(name)&quot;
<br>
means has leading &quot;[/\]&quot; (maybe after a
drive-letter:).</p>


<p style="margin-top: 1em">&quot;Cwd::sys_is_relative(name)&quot;
<br>
means changes with current dir.</p>

<p style="margin-top: 1em">&quot;Cwd::sys_cwd(name)&quot;
<br>
Interface to cwd from EMX. Used by &quot;Cwd::cwd&quot;.</p>

<p style="margin-top: 1em">&quot;Cwd::sys_abspath(name,
dir)&quot; <br>
Really really odious function to implement. Returns absolute
name of file which would have &quot;name&quot; if CWD were
&quot;dir&quot;. &quot;Dir&quot; defaults to the current
dir.</p>


<p style="margin-top: 1em">&quot;Cwd::extLibpath([type])&quot;
<br>
Get current value of extended library search path. If
&quot;type&quot; is present and positive, works with
&quot;END_LIBPATH&quot;, if negative, works with
&quot;LIBPATHSTRICT&quot;, otherwise with <br>
&quot;BEGIN_LIBPATH&quot;.</p>

<p style="margin-top: 1em">&quot;Cwd::extLibpath_set( path
[, type ] )&quot; <br>
Set current value of extended library search path. If
&quot;type&quot; is present and positive, works with
&lt;END_LIBPATH&gt;, if negative, works with
&quot;LIBPATHSTRICT&quot;, otherwise with <br>
&quot;BEGIN_LIBPATH&quot;.</p>


<p style="margin-top: 1em">&quot;OS2::Error(do_harderror,do_exception)&quot;
<br>
Returns &quot;undef&quot; if it was not called yet,
otherwise bit 1 is set if on the previous call do_harderror
was enabled, bit 2 is set if on previous call do_exception
was <br>
enabled.</p>

<p style="margin-top: 1em">This function enables/disables
error popups associated with hardware errors (Disk not ready
etc.) and software exceptions.</p>

<p style="margin-top: 1em">I know of no way to find out the
state of popups before the first call to this function.</p>


<p style="margin-top: 1em">&quot;OS2::Errors2Drive(drive)&quot;
<br>
Returns &quot;undef&quot; if it was not called yet,
otherwise return false if errors were not requested to be
written to a hard drive, or the drive letter if this was
requested.</p>

<p style="margin-top: 1em">This function may redirect error
popups associated with hardware errors (Disk not ready etc.)
and software exceptions to the file POPUPLOG.OS2 at the root
directory of the <br>
specified drive. Overrides OS2::Error() specified by
individual programs. Given argument undef will disable
redirection.</p>

<p style="margin-top: 1em">Has global effect, persists
after the application exits.</p>

<p style="margin-top: 1em">I know of no way to find out the
state of redirection of popups to the disk before the first
call to this function.</p>

<p style="margin-top: 1em">OS2::SysInfo() <br>
Returns a hash with system information. The keys of the hash
are</p>

<p style="margin-top: 1em">MAX_PATH_LENGTH,
MAX_TEXT_SESSIONS, MAX_PM_SESSIONS, <br>
MAX_VDM_SESSIONS, BOOT_DRIVE, DYN_PRI_VARIATION, <br>
MAX_WAIT, MIN_SLICE, MAX_SLICE, PAGE_SIZE, <br>
VERSION_MAJOR, VERSION_MINOR, VERSION_REVISION, <br>
MS_COUNT, TIME_LOW, TIME_HIGH, TOTPHYSMEM, TOTRESMEM, <br>
TOTAVAILMEM, MAXPRMEM, MAXSHMEM, TIMER_INTERVAL, <br>
MAX_COMP_LENGTH, FOREGROUND_FS_SESSION, <br>
FOREGROUND_PROCESS</p>

<p style="margin-top: 1em">OS2::BootDrive() <br>
Returns a letter without colon.</p>


<p style="margin-top: 1em">&quot;OS2::MorphPM(serve)&quot;,
&quot;OS2::UnMorphPM(serve)&quot; <br>
Transforms the current application into a PM application and
back. The argument true means that a real message loop is
going to be served. OS2::MorphPM() returns the PM <br>
message queue handle as an integer.</p>

<p style="margin-top: 1em">See &quot;Centralized management
of resources&quot; for additional details.</p>


<p style="margin-top: 1em">&quot;OS2::Serve_Messages(force)&quot;
<br>
Fake on-demand retrieval of outstanding PM messages. If
&quot;force&quot; is false, will not dispatch messages if a
real message loop is known to be present. Returns number of
<br>
messages retrieved.</p>

<p style="margin-top: 1em">Dies with &quot;QUITing...&quot;
if WM_QUIT message is obtained.</p>


<p style="margin-top: 1em">&quot;OS2::Process_Messages(force
[, cnt])&quot; <br>
Retrieval of PM messages until window creation/destruction.
If &quot;force&quot; is false, will not dispatch messages if
a real message loop is known to be present.</p>

<p style="margin-top: 1em">Returns change in number of
windows. If &quot;cnt&quot; is given, it is incremented by
the number of messages retrieved.</p>

<p style="margin-top: 1em">Dies with &quot;QUITing...&quot;
if WM_QUIT message is obtained.</p>


<p style="margin-top: 1em">&quot;OS2::_control87(new,mask)&quot;
<br>
the same as _control87(3) of EMX. Takes integers as
arguments, returns the previous coprocessor control word as
an integer. Only bits in &quot;new&quot; which are present
in &quot;mask&quot; <br>
are changed in the control word.</p>

<p style="margin-top: 1em">OS2::get_control87() <br>
gets the coprocessor control word as an integer.</p>


<p style="margin-top: 1em">&quot;OS2::set_control87_em(new=MCW_EM,mask=MCW_EM)&quot;
<br>
The variant of OS2::_control87() with default values good
for handling exception mask: if no &quot;mask&quot;, uses
exception mask part of &quot;new&quot; only. If no
&quot;new&quot;, disables all the <br>
floating point exceptions.</p>

<p style="margin-top: 1em">See &quot;Misfeatures&quot; for
details.</p>

<p style="margin-top: 1em">&quot;OS2::DLLname([how [,
xsub]])&quot; <br>
Gives the information about the Perl DLL or the DLL
containing the C function bound to by &amp;xsub. The meaning
of &quot;how&quot; is: default (2): full name; 0: handle; 1:
module name.</p>

<p style="margin-top: 1em">(Note that some of these may be
moved to different libraries - eventually).</p>

<p style="margin-top: 1em">Prebuilt variables: <br>
$OS2::emx_rev <br>
numeric value is the same as _emx_rev of EMX, a string value
the same as _emx_vprt (similar to &quot;0.9c&quot;).</p>

<p style="margin-top: 1em">$OS2::emx_env <br>
same as _emx_env of EMX, a number similar to 0x8001.</p>

<p style="margin-top: 1em">$OS2::os_ver <br>
a number &quot;OS_MAJOR + 0.001 * OS_MINOR&quot;.</p>

<p style="margin-top: 1em">$OS2::is_aout <br>
true if the Perl library was compiled in AOUT format.</p>

<p style="margin-top: 1em">$OS2::can_fork <br>
true if the current executable is an AOUT EMX executable, so
Perl can fork. Do not use this, use the portable check for
$Config::Config{dfork}.</p>

<p style="margin-top: 1em">$OS2::nsyserror <br>
This variable (default is 1) controls whether to enforce the
contents of $^E to start with &quot;SYS0003&quot;-like id.
If set to 0, then the string value of $^E is what is
available <br>
from the OS/2 message file. (Some messages in this file have
an &quot;SYS0003&quot;-like id prepended, some not.)</p>

<p style="margin-top: 1em">Misfeatures <br>
&Acirc;&middot; Since flock(3) is present in EMX, but is not
functional, it is emulated by perl. To disable the
emulations, set environment variable
&quot;USE_PERL_FLOCK=0&quot;.</p>

<p style="margin-top: 1em">&Acirc;&middot; Here is the list
of things which may be &quot;broken&quot; on EMX (from EMX
docs):</p>

<p style="margin-top: 1em">&Acirc;&middot; The functions
recvmsg(3), sendmsg(3), and socketpair(3) are not
implemented.</p>

<p style="margin-top: 1em">&Acirc;&middot; sock_init(3) is
not required and not implemented.</p>

<p style="margin-top: 1em">&Acirc;&middot; flock(3) is not
yet implemented (dummy function). (Perl has a
workaround.)</p>

<p style="margin-top: 1em">&Acirc;&middot; kill(3): Special
treatment of PID=0, PID=1 and PID=-1 is not implemented.</p>

<p style="margin-top: 1em">&Acirc;&middot; waitpid(3):</p>

<p style="margin-top: 1em">WUNTRACED <br>
Not implemented. <br>
waitpid() is not implemented for negative values of PID.</p>

<p style="margin-top: 1em">Note that &quot;kill -9&quot;
does not work with the current version of EMX.</p>

<p style="margin-top: 1em">&Acirc;&middot; See
&quot;Text-mode filehandles&quot;.</p>

<p style="margin-top: 1em">&Acirc;&middot; Unix-domain
sockets on OS/2 live in a pseudo-file-system
&quot;/sockets/...&quot;. To avoid a failure to create a
socket with a name of a different form, &quot;/socket/&quot;
is prepended to <br>
the socket name (unless it starts with this already).</p>

<p style="margin-top: 1em">This may lead to problems later
in case the socket is accessed via the &quot;usual&quot;
file-system calls using the &quot;initial&quot; name.</p>

<p style="margin-top: 1em">&Acirc;&middot; Apparently, IBM
used a compiler (for some period of time around &rsquo;95?)
which changes FP mask right and left. This is not that bad
for IBM&rsquo;s programs, but the same compiler <br>
was used for DLLs which are used with general-purpose
applications. When these DLLs are used, the state of
floating-point flags in the application is not
predictable.</p>

<p style="margin-top: 1em">What is much worse, some DLLs
change the floating point flags when in _DLLInitTerm()
(e.g., TCP32IP). This means that even if you do not call any
function in the DLL, just <br>
the act of loading this DLL will reset your flags. What is
worse, the same compiler was used to compile some HOOK DLLs.
Given that HOOK dlls are executed in the context of <br>
all the applications in the system, this means a complete
unpredictability of floating point flags on systems using
such HOOK DLLs. E.g., GAMESRVR.DLL of DIVE origin changes
<br>
the floating point flags on each write to the TTY of a VIO
(windowed text-mode) applications.</p>

<p style="margin-top: 1em">Some other (not completely
debugged) situations when FP flags change include some video
drivers (?), and some operations related to creation of the
windows. People who code <br>
OpenGL may have more experience on this.</p>

<p style="margin-top: 1em">Perl is generally used in the
situation when all the floating-point exceptions are
ignored, as is the default under EMX. If they are not
ignored, some benign Perl programs <br>
would get a &quot;SIGFPE&quot; and would die a horrible
death.</p>

<p style="margin-top: 1em">To circumvent this, Perl uses
two hacks. They help against one type of damage only: FP
flags changed when loading a DLL.</p>

<p style="margin-top: 1em">One of the hacks is to disable
floating point exceptions on Perl startup (as is the default
with EMX). This helps only with compile-time-linked DLLs
changing the flags <br>
before main() had a chance to be called.</p>

<p style="margin-top: 1em">The other hack is to restore FP
flags after a call to dlopen(). This helps against similar
damage done by DLLs _DLLInitTerm() at runtime. Currently no
way to switch these <br>
hacks off is provided.</p>

<p style="margin-top: 1em">Modifications <br>
Perl modifies some standard C library calls in the following
ways:</p>

<p style="margin-top: 1em">&quot;popen&quot;
&quot;my_popen&quot; uses sh.exe if shell is required, cf.
&quot;PERL_SH_DIR&quot;.</p>

<p style="margin-top: 1em">&quot;tmpnam&quot; is created
using &quot;TMP&quot; or &quot;TEMP&quot; environment
variable, via &quot;tempnam&quot;.</p>

<p style="margin-top: 1em">&quot;tmpfile&quot; <br>
If the current directory is not writable, file is created
using modified &quot;tmpnam&quot;, so there may be a race
condition.</p>

<p style="margin-top: 1em">&quot;ctermid&quot; <br>
a dummy implementation.</p>

<p style="margin-top: 1em">&quot;stat&quot;
&quot;os2_stat&quot; special-cases /dev/tty and
/dev/con.</p>

<p style="margin-top: 1em">&quot;mkdir&quot;,
&quot;rmdir&quot; <br>
these EMX functions do not work if the path contains a
trailing &quot;/&quot;. Perl contains a workaround for
this.</p>

<p style="margin-top: 1em">&quot;flock&quot; Since flock(3)
is present in EMX, but is not functional, it is emulated by
perl. To disable the emulations, set environment variable
&quot;USE_PERL_FLOCK=0&quot;.</p>

<p style="margin-top: 1em">Identifying DLLs <br>
All the DLLs built with the current versions of Perl have ID
strings identifying the name of the extension, its version,
and the version of Perl required for this DLL. Run <br>
&quot;bldlevel DLL-name&quot; to find this info.</p>

<p style="margin-top: 1em">Centralized management of
resources <br>
Since to call certain OS/2 API one needs to have a correctly
initialized &quot;Win&quot; subsystem, OS/2-specific
extensions may require getting &quot;HAB&quot;s and
&quot;HMQ&quot;s. If an extension would <br>
do it on its own, another extension could fail to
initialize.</p>

<p style="margin-top: 1em">Perl provides a centralized
management of these resources:</p>

<p style="margin-top: 1em">&quot;HAB&quot; <br>
To get the HAB, the extension should call &quot;hab =
perl_hab_GET()&quot; in C. After this call is performed,
&quot;hab&quot; may be accessed as &quot;Perl_hab&quot;.
There is no need to release the <br>
HAB after it is used.</p>

<p style="margin-top: 1em">If by some reasons perl.h cannot
be included, use</p>

<p style="margin-top: 1em">extern int
Perl_hab_GET(void);</p>

<p style="margin-top: 1em">instead.</p>

<p style="margin-top: 1em">&quot;HMQ&quot; <br>
There are two cases:</p>

<p style="margin-top: 1em">&Acirc;&middot; the extension
needs an &quot;HMQ&quot; only because some API will not work
otherwise. Use &quot;serve = 0&quot; below.</p>

<p style="margin-top: 1em">&Acirc;&middot; the extension
needs an &quot;HMQ&quot; since it wants to engage in a PM
event loop. Use &quot;serve = 1&quot; below.</p>

<p style="margin-top: 1em">To get an &quot;HMQ&quot;, the
extension should call &quot;hmq = perl_hmq_GET(serve)&quot;
in C. After this call is performed, &quot;hmq&quot; may be
accessed as &quot;Perl_hmq&quot;.</p>

<p style="margin-top: 1em">To signal to Perl that HMQ is
not needed any more, call &quot;perl_hmq_UNSET(serve)&quot;.
Perl process will automatically morph/unmorph itself
into/from a PM process if HMQ is <br>
needed/not-needed. Perl will automatically enable/disable
&quot;WM_QUIT&quot; message during shutdown if the message
queue is served/not-served.</p>

<p style="margin-top: 1em">NOTE. If during a shutdown there
is a message queue which did not disable WM_QUIT, and which
did not process the received WM_QUIT message, the shutdown
will be automatically <br>
cancelled. Do not call perl_hmq_GET(1) unless you are going
to process messages on an orderly basis.</p>

<p style="margin-top: 1em">Treating errors reported by OS/2
API <br>
There are two principal conventions (it is useful to call
them &quot;Dos*&quot; and &quot;Win*&quot; - though this
part of the function signature is not always determined by
the name of the API) <br>
of reporting the error conditions of OS/2 API. Most of
&quot;Dos*&quot; APIs report the error code as the result of
the call (so 0 means success, and there are many types of
errors). <br>
Most of &quot;Win*&quot; API report success/fail via the
result being &quot;TRUE&quot;/&quot;FALSE&quot;; to find the
reason for the failure one should call WinGetLastError()
API.</p>

<p style="margin-top: 1em">Some &quot;Win*&quot; entry
points also overload a &quot;meaningful&quot; return value
with the error indicator; having a 0 return value indicates
an error. Yet some other &quot;Win*&quot; entry points <br>
overload things even more, and 0 return value may mean a
successful call returning a valid value 0, as well as an
error condition; in the case of a 0 return value one should
<br>
call WinGetLastError() API to distinguish a successful call
from a failing one.</p>

<p style="margin-top: 1em">By convention, all the calls to
OS/2 API should indicate their failures by resetting $^E.
All the Perl-accessible functions which call OS/2 API may be
broken into two <br>
classes: some die()s when an API error is encountered, the
other report the error via a false return value (of course,
this does not concern Perl-accessible functions which <br>
expect a failure of the OS/2 API call, having some
workarounds coded).</p>

<p style="margin-top: 1em">Obviously, in the situation of
the last type of the signature of an OS/2 API, it is must
more convenient for the users if the failure is indicated by
die()ing: one does not <br>
need to check $^E to know that something went wrong. If,
however, this solution is not desirable by some reason, the
code in question should reset $^E to 0 before making <br>
this OS/2 API call, so that the caller of this
Perl-accessible function has a chance to distinguish a
success-but-0-return value from a failure. (One may return
undef as an <br>
alternative way of reporting an error.)</p>

<p style="margin-top: 1em">The macros to simplify this type
of error propagation are</p>

<p style="margin-top: 1em">&quot;CheckOSError(expr)&quot;
<br>
Returns true on error, sets $^E. Expects expr() be a call of
&quot;Dos*&quot;-style API.</p>

<p style="margin-top: 1em">&quot;CheckWinError(expr)&quot;
<br>
Returns true on error, sets $^E. Expects expr() be a call of
&quot;Win*&quot;-style API.</p>

<p style="margin-top: 1em">&quot;SaveWinError(expr)&quot;
<br>
Returns &quot;expr&quot;, sets $^E from WinGetLastError() if
&quot;expr&quot; is false.</p>


<p style="margin-top: 1em">&quot;SaveCroakWinError(expr,die,name1,name2)&quot;
<br>
Returns &quot;expr&quot;, sets $^E from WinGetLastError() if
&quot;expr&quot; is false, and die()s if &quot;die&quot; and
$^E are true. The message to die is the concatenated strings
&quot;name1&quot; and <br>
&quot;name2&quot;, separated by &quot;: &quot; from the
contents of $^E.</p>

<p style="margin-top: 1em">&quot;WinError_2_Perl_rc&quot;
<br>
Sets &quot;Perl_rc&quot; to the return value of
WinGetLastError().</p>

<p style="margin-top: 1em">&quot;FillWinError&quot; <br>
Sets &quot;Perl_rc&quot; to the return value of
WinGetLastError(), and sets $^E to the corresponding
value.</p>

<p style="margin-top: 1em">&quot;FillOSError(rc)&quot; <br>
Sets &quot;Perl_rc&quot; to &quot;rc&quot;, and sets $^E to
the corresponding value.</p>

<p style="margin-top: 1em">Loading DLLs and ordinals in
DLLs <br>
Some DLLs are only present in some versions of OS/2, or in
some configurations of OS/2. Some exported entry points are
present only in DLLs shipped with some versions of <br>
OS/2. If these DLLs and entry points were linked directly
for a Perl executable/DLL or from a Perl extensions, this
binary would work only with the specified <br>
versions/setups. Even if these entry points were not needed,
the load of the executable (or DLL) would fail.</p>

<p style="margin-top: 1em">For example, many newer useful
APIs are not present in OS/2 v2; many PM-related APIs
require DLLs not available on floppy-boot setup.</p>

<p style="margin-top: 1em">To make these calls fail only
when the calls are executed, one should call these API via a
dynamic linking API. There is a subsystem in Perl to
simplify such type of calls. <br>
A large number of entry points available for such linking is
provided (see &quot;entries_ordinals&quot; - and also
&quot;PMWIN_entries&quot; - in os2ish.h). These ordinals can
be accessed via <br>
the APIs:</p>

<p style="margin-top: 1em">CallORD(), DeclFuncByORD(),
DeclVoidFuncByORD(), <br>
DeclOSFuncByORD(), DeclWinFuncByORD(), AssignFuncPByORD(),
<br>
DeclWinFuncByORD_CACHE(), DeclWinFuncByORD_CACHE_survive(),
<br>
DeclWinFuncByORD_CACHE_resetError_survive(), <br>
DeclWinFunc_CACHE(), DeclWinFunc_CACHE_resetError(), <br>
DeclWinFunc_CACHE_survive(),
DeclWinFunc_CACHE_resetError_survive()</p>

<p style="margin-top: 1em">See the header files and the C
code in the supplied OS/2-related modules for the details on
usage of these functions.</p>

<p style="margin-top: 1em">Some of these functions also
combine dynaloading semantic with the error-propagation
semantic discussed above.</p>

<p style="margin-top: 1em">Perl flavors <br>
Because of idiosyncrasies of OS/2 one cannot have all the
eggs in the same basket (though EMX environment tries hard
to overcome this limitations, so the situation may somehow
<br>
improve). There are 4 executables for Perl provided by the
distribution:</p>

<p style="margin-top: 1em">perl.exe <br>
The main workhorse. This is a chimera executable: it is
compiled as an &quot;a.out&quot;-style executable, but is
linked with &quot;omf&quot;-style dynamic library perl.dll,
and with dynamic CRT <br>
DLL. This executable is a VIO application.</p>

<p style="margin-top: 1em">It can load perl dynamic
extensions, and it can fork().</p>

<p style="margin-top: 1em">Note. Keep in mind that fork()
is needed to open a pipe to yourself.</p>

<p style="margin-top: 1em">perl_.exe <br>
This is a statically linked &quot;a.out&quot;-style
executable. It cannot load dynamic Perl extensions. The
executable supplied in binary distributions has a lot of
extensions prebuilt, <br>
thus the above restriction is important only if you use
custom-built extensions. This executable is a VIO
application.</p>

<p style="margin-top: 1em">This is the only executable with
does not require OS/2. The friends locked into
&quot;M$&quot; world would appreciate the fact that this
executable runs under DOS, Win0.3*, Win0.95 and <br>
WinNT with an appropriate extender. See &quot;Other
OSes&quot;.</p>

<p style="margin-top: 1em">perl__.exe <br>
This is the same executable as perl___.exe, but it is a PM
application.</p>

<p style="margin-top: 1em">Note. Usually (unless explicitly
redirected during the startup) STDIN, STDERR, and STDOUT of
a PM application are redirected to nul. However, it is
possible to see them if you <br>
start &quot;perl__.exe&quot; from a PM program which
emulates a console window, like Shell mode of Emacs or EPM.
Thus it is possible to use Perl debugger (see perldebug) to
debug your PM <br>
application (but beware of the message loop lockups - this
will not work if you have a message queue to serve, unless
you hook the serving into the getc() function of the <br>
debugger).</p>

<p style="margin-top: 1em">Another way to see the output of
a PM program is to run it as</p>

<p style="margin-top: 1em">pm_prog args 2&gt;&amp;1 | cat
-</p>

<p style="margin-top: 1em">with a shell different from
cmd.exe, so that it does not create a link between a VIO
session and the session of &quot;pm_porg&quot;. (Such a link
closes the VIO window.) E.g., this works <br>
with sh.exe - or with Perl!</p>

<p style="margin-top: 1em">open P, &rsquo;pm_prog args
2&gt;&amp;1 |&rsquo; or die; <br>
print while &lt;P&gt;;</p>

<p style="margin-top: 1em">The flavor perl__.exe is
required if you want to start your program without a VIO
window present, but not &quot;detach&quot;ed (run &quot;help
detach&quot; for more info). Very useful for <br>
extensions which use PM, like &quot;Perl/Tk&quot; or
&quot;OpenGL&quot;.</p>

<p style="margin-top: 1em">Note also that the differences
between PM and VIO executables are only in the default
behaviour. One can start any executable in any kind of
session by using the arguments <br>
&quot;/fs&quot;, &quot;/pm&quot; or &quot;/win&quot;
switches of the command &quot;start&quot; (of CMD.EXE or a
similar shell). Alternatively, one can use the numeric first
argument of the &quot;system&quot; Perl function (see <br>
OS2::Process).</p>

<p style="margin-top: 1em">perl___.exe <br>
This is an &quot;omf&quot;-style executable which is
dynamically linked to perl.dll and CRT DLL. I know no
advantages of this executable over &quot;perl.exe&quot;, but
it cannot fork() at all. Well, <br>
one advantage is that the build process is not so convoluted
as with &quot;perl.exe&quot;.</p>

<p style="margin-top: 1em">It is a VIO application.</p>

<p style="margin-top: 1em">Why strange names? <br>
Since Perl processes the &quot;#!&quot;-line (cf.
&quot;DESCRIPTION&quot; in perlrun, &quot;Command
Switches&quot; in perlrun, &quot;No Perl script found in
input&quot; in perldiag), it should know when a program is a
<br>
Perl. There is some naming convention which allows Perl to
distinguish correct lines from wrong ones. The above names
are almost the only names allowed by this convention which
<br>
do not contain digits (which have absolutely different
semantics).</p>

<p style="margin-top: 1em">Why dynamic linking? <br>
Well, having several executables dynamically linked to the
same huge library has its advantages, but this would not
substantiate the additional work to make it compile. The
<br>
reason is the complicated-to-developers but very quick and
convenient-to-users &quot;hard&quot; dynamic linking used by
OS/2.</p>

<p style="margin-top: 1em">There are two distinctive
features of the dyna-linking model of OS/2: first, all the
references to external functions are resolved at the compile
time; second, there is no <br>
runtime fixup of the DLLs after they are loaded into memory.
The first feature is an enormous advantage over other
models: it avoids conflicts when several DLLs used by an
<br>
application export entries with the same name. In such cases
&quot;other&quot; models of dyna-linking just choose between
these two entry points using some random criterion - with
<br>
predictable disasters as results. But it is the second
feature which requires the build of perl.dll.</p>

<p style="margin-top: 1em">The address tables of DLLs are
patched only once, when they are loaded. The addresses of
the entry points into DLLs are guaranteed to be the same for
all the programs which use <br>
the same DLL. This removes the runtime fixup - once DLL is
loaded, its code is read-only.</p>

<p style="margin-top: 1em">While this allows some
(significant?) performance advantages, this makes life much
harder for developers, since the above scheme makes it
impossible for a DLL to be &quot;linked&quot; to a <br>
symbol in the .EXE file. Indeed, this would need a DLL to
have different relocations tables for the (different)
executables which use this DLL.</p>

<p style="margin-top: 1em">However, a dynamically loaded
Perl extension is forced to use some symbols from the perl
executable, e.g., to know how to find the arguments to the
functions: the arguments live <br>
on the perl internal evaluation stack. The solution is to
put the main code of the interpreter into a DLL, and make
the .EXE file which just loads this DLL into memory and <br>
supplies command-arguments. The extension DLL cannot link to
symbols in .EXE, but it has no problem linking to symbols in
the .DLL.</p>

<p style="margin-top: 1em">This greatly increases the load
time for the application (as well as complexity of the
compilation). Since interpreter is in a DLL, the C RTL is
basically forced to reside in a <br>
DLL as well (otherwise extensions would not be able to use
CRT). There are some advantages if you use different flavors
of perl, such as running perl.exe and perl__.exe <br>
simultaneously: they share the memory of perl.dll.</p>

<p style="margin-top: 1em">NOTE. There is one additional
effect which makes DLLs more wasteful: DLLs are loaded in
the shared memory region, which is a scarse resource given
the 512M barrier of the <br>
&quot;standard&quot; OS/2 virtual memory. The code of .EXE
files is also shared by all the processes which use the
particular .EXE, but they are &quot;shared in the private
address space of <br>
the process&quot;; this is possible because the address at
which different sections of the .EXE file are loaded is
decided at compile-time, thus all the processes have these
sections <br>
loaded at same addresses, and no fixup of internal links
inside the .EXE is needed.</p>

<p style="margin-top: 1em">Since DLLs may be loaded at run
time, to have the same mechanism for DLLs one needs to have
the address range of any of the loaded DLLs in the system to
be available in all the <br>
processes which did not load a particular DLL yet. This is
why the DLLs are mapped to the shared memory region.</p>

<p style="margin-top: 1em">Why chimera build? <br>
Current EMX environment does not allow DLLs compiled using
Unixish &quot;a.out&quot; format to export symbols for data
(or at least some types of data). This forces
&quot;omf&quot;-style compile of <br>
perl.dll.</p>

<p style="margin-top: 1em">Current EMX environment does not
allow .EXE files compiled in &quot;omf&quot; format to
fork(). fork() is needed for exactly three Perl
operations:</p>

<p style="margin-top: 1em">&Acirc;&middot; explicit fork()
in the script,</p>

<p style="margin-top: 1em">&Acirc;&middot; &quot;open FH,
&quot;|-&quot;&quot;</p>

<p style="margin-top: 1em">&Acirc;&middot; &quot;open FH,
&quot;-|&quot;&quot;, in other words, opening pipes to
itself.</p>

<p style="margin-top: 1em">While these operations are not
questions of life and death, they are needed for a lot of
useful scripts. This forces &quot;a.out&quot;-style compile
of perl.exe.</p>

<p style="margin-top: 1em">ENVIRONMENT <br>
Here we list environment variables with are either OS/2- and
DOS- and Win*-specific, or are more important under OS/2
than under other OSes.</p>

<p style="margin-top: 1em">&quot;PERLLIB_PREFIX&quot; <br>
Specific for EMX port. Should have the form</p>

<p style="margin-top: 1em">path1;path2</p>

<p style="margin-top: 1em">or</p>

<p style="margin-top: 1em">path1 path2</p>

<p style="margin-top: 1em">If the beginning of some
prebuilt path matches path1, it is substituted with
path2.</p>

<p style="margin-top: 1em">Should be used if the perl
library is moved from the default location in preference to
&quot;PERL(5)LIB&quot;, since this would not leave wrong
entries in @INC. For example, if the <br>
compiled version of perl looks for @INC in f:/perllib/lib,
and you want to install the library in h:/opt/gnu, do</p>

<p style="margin-top: 1em">set
PERLLIB_PREFIX=f:/perllib/lib;h:/opt/gnu</p>

<p style="margin-top: 1em">This will cause Perl with the
prebuilt @INC of</p>

<p style="margin-top: 1em">f:/perllib/lib/5.00553/os2 <br>
f:/perllib/lib/5.00553 <br>
f:/perllib/lib/site_perl/5.00553/os2 <br>
f:/perllib/lib/site_perl/5.00553 <br>
.</p>

<p style="margin-top: 1em">to use the following @INC:</p>

<p style="margin-top: 1em">h:/opt/gnu/5.00553/os2 <br>
h:/opt/gnu/5.00553 <br>
h:/opt/gnu/site_perl/5.00553/os2 <br>
h:/opt/gnu/site_perl/5.00553 <br>
.</p>

<p style="margin-top: 1em">&quot;PERL_BADLANG&quot; <br>
If 0, perl ignores setlocale() failing. May be useful with
some strange locales.</p>

<p style="margin-top: 1em">&quot;PERL_BADFREE&quot; <br>
If 0, perl would not warn of in case of unwarranted free().
With older perls this might be useful in conjunction with
the module DB_File, which was buggy when dynamically linked
<br>
and OMF-built.</p>

<p style="margin-top: 1em">Should not be set with newer
Perls, since this may hide some real problems.</p>

<p style="margin-top: 1em">&quot;PERL_SH_DIR&quot; <br>
Specific for EMX port. Gives the directory part of the
location for sh.exe.</p>

<p style="margin-top: 1em">&quot;USE_PERL_FLOCK&quot; <br>
Specific for EMX port. Since flock(3) is present in EMX, but
is not functional, it is emulated by perl. To disable the
emulations, set environment variable
&quot;USE_PERL_FLOCK=0&quot;.</p>

<p style="margin-top: 1em">&quot;TMP&quot; or
&quot;TEMP&quot; <br>
Specific for EMX port. Used as storage place for temporary
files.</p>

<p style="margin-top: 1em">Evolution <br>
Here we list major changes which could make you by
surprise.</p>

<p style="margin-top: 1em">Text-mode filehandles <br>
Starting from version 5.8, Perl uses a builtin translation
layer for text-mode files. This replaces the efficient
well-tested EMX layer by some code which should be best <br>
characterized as a &quot;quick hack&quot;.</p>

<p style="margin-top: 1em">In addition to possible bugs and
an inability to follow changes to the translation policy
with off/on switches of TERMIO translation, this introduces
a serious incompatible <br>
change: before sysread() on text-mode filehandles would go
through the translation layer, now it would not.</p>

<p style="margin-top: 1em">Priorities <br>
&quot;setpriority&quot; and &quot;getpriority&quot; are not
compatible with earlier ports by Andreas Kaiser. See
&quot;setpriority, getpriority&quot;.</p>

<p style="margin-top: 1em">DLL name mangling: pre 5.6.2
<br>
With the release 5.003_01 the dynamically loadable libraries
should be rebuilt when a different version of Perl is
compiled. In particular, DLLs (including perl.dll) are now
<br>
created with the names which contain a checksum, thus
allowing workaround for OS/2 scheme of caching DLLs.</p>

<p style="margin-top: 1em">It may be possible to code a
simple workaround which would</p>

<p style="margin-top: 1em">&Acirc;&middot; find the old
DLLs looking through the old @INC;</p>

<p style="margin-top: 1em">&Acirc;&middot; mangle the names
according to the scheme of new perl and copy the DLLs to
these names;</p>

<p style="margin-top: 1em">&Acirc;&middot; edit the
internal &quot;LX&quot; tables of DLL to reflect the change
of the name (probably not needed for Perl extension DLLs,
since the internally coded names are not used for <br>
&quot;specific&quot; DLLs, they used only for
&quot;global&quot; DLLs).</p>

<p style="margin-top: 1em">&Acirc;&middot; edit the
internal &quot;IMPORT&quot; tables and change the name of
the &quot;old&quot; perl????.dll to the &quot;new&quot;
perl????.dll.</p>

<p style="margin-top: 1em">DLL name mangling: 5.6.2 and
beyond <br>
In fact mangling of extension DLLs was done due to
misunderstanding of the OS/2 dynaloading model. OS/2
(effectively) maintains two different tables of loaded
DLL:</p>

<p style="margin-top: 1em">Global DLLs <br>
those loaded by the base name from &quot;LIBPATH&quot;;
including those associated at link time;</p>

<p style="margin-top: 1em">specific DLLs <br>
loaded by the full name.</p>

<p style="margin-top: 1em">When resolving a request for a
global DLL, the table of already-loaded specific DLLs is
(effectively) ignored; moreover, specific DLLs are always
loaded from the prescribed path.</p>

<p style="margin-top: 1em">There is/was a minor twist which
makes this scheme fragile: what to do with DLLs loaded
from</p>

<p style="margin-top: 1em">&quot;BEGINLIBPATH&quot; and
&quot;ENDLIBPATH&quot; <br>
(which depend on the process)</p>

<p style="margin-top: 1em">. from &quot;LIBPATH&quot; <br>
which effectively depends on the process (although
&quot;LIBPATH&quot; is the same for all the processes).</p>

<p style="margin-top: 1em">Unless &quot;LIBPATHSTRICT&quot;
is set to &quot;T&quot; (and the kernel is after
2000/09/01), such DLLs are considered to be global. When
loading a global DLL it is first looked in the table of <br>
already-loaded global DLLs. Because of this the fact that
one executable loaded a DLL from &quot;BEGINLIBPATH&quot;
and &quot;ENDLIBPATH&quot;, or . from &quot;LIBPATH&quot;
may affect which DLL is loaded <br>
when another executable requests a DLL with the same name.
This is the reason for version-specific mangling of the DLL
name for perl DLL.</p>

<p style="margin-top: 1em">Since the Perl extension DLLs
are always loaded with the full path, there is no need to
mangle their names in a version-specific ways: their
directory already reflects the <br>
corresponding version of perl, and @INC takes into account
binary compatibility with older version. Starting from 5.6.2
the name mangling scheme is fixed to be the same as for <br>
Perl 5.005_53 (same as in a popular binary release). Thus
new Perls will be able to resolve the names of old extension
DLLs if @INC allows finding their directories.</p>

<p style="margin-top: 1em">However, this still does not
guarantee that these DLL may be loaded. The reason is the
mangling of the name of the Perl DLL. And since the
extension DLLs link with the Perl <br>
DLL, extension DLLs for older versions would load an older
Perl DLL, and would most probably segfault (since the data
in this DLL is not properly initialized).</p>

<p style="margin-top: 1em">There is a partial workaround
(which can be made complete with newer OS/2 kernels): create
a forwarder DLL with the same name as the DLL of the older
version of Perl, which <br>
forwards the entry points to the newer Perl&rsquo;s DLL.
Make this DLL accessible on (say) the
&quot;BEGINLIBPATH&quot; of the new Perl executable. When
the new executable accesses old Perl&rsquo;s <br>
extension DLLs, they would request the old Perl&rsquo;s DLL
by name, get the forwarder instead, so effectively will link
with the currently running (new) Perl DLL.</p>

<p style="margin-top: 1em">This may break in two ways:</p>

<p style="margin-top: 1em">&Acirc;&middot; Old perl
executable is started when a new executable is running has
loaded an extension compiled for the old executable (ouph!).
In this case the old executable will get a <br>
forwarder DLL instead of the old perl DLL, so would link
with the new perl DLL. While not directly fatal, it will
behave the same as new executable. This beats the whole <br>
purpose of explicitly starting an old executable.</p>

<p style="margin-top: 1em">&Acirc;&middot; A new executable
loads an extension compiled for the old executable when an
old perl executable is running. In this case the extension
will not pick up the forwarder - with <br>
fatal results.</p>

<p style="margin-top: 1em">With support for
&quot;LIBPATHSTRICT&quot; this may be circumvented - unless
one of DLLs is started from . from &quot;LIBPATH&quot; (I do
not know whether &quot;LIBPATHSTRICT&quot; affects this
case).</p>

<p style="margin-top: 1em">REMARK. Unless newer kernels
allow . in &quot;BEGINLIBPATH&quot; (older do not), this
mess cannot be completely cleaned. (It turns out that as of
the beginning of 2002, . is not allowed, <br>
but .. is - and it has the same effect.)</p>

<p style="margin-top: 1em">REMARK.
&quot;LIBPATHSTRICT&quot;, &quot;BEGINLIBPATH&quot; and
&quot;ENDLIBPATH&quot; are not environment variables,
although cmd.exe emulates them on &quot;SET ...&quot; lines.
From Perl they may be accessed by <br>
Cwd::extLibpath and Cwd::extLibpath_set.</p>

<p style="margin-top: 1em">DLL forwarder generation <br>
Assume that the old DLL is named perlE0AC.dll (as is one for
5.005_53), and the new version is 5.6.1. Create a file
perl5shim.def-leader with</p>

<p style="margin-top: 1em">LIBRARY &rsquo;perlE0AC&rsquo;
INITINSTANCE TERMINSTANCE <br>
DESCRIPTION &rsquo;@#perl5-porters@perl.org:5.006001#@ Perl
module for 5.00553 -&gt; Perl 5.6.1 forwarder&rsquo; <br>
CODE LOADONCALL <br>
DATA LOADONCALL NONSHARED MULTIPLE <br>
EXPORTS</p>

<p style="margin-top: 1em">modifying the versions/names as
needed. Run</p>

<p style="margin-top: 1em">perl -wnle &quot;next if
0../EXPORTS/; print qq(</p>

<p style="margin-top: 1em">in the Perl build directory (to
make the DLL smaller replace perl5.def with the definition
file for the older version of Perl if present).</p>

<p style="margin-top: 1em">cat perl5shim.def-leader lst
&gt;perl5shim.def <br>
gcc -Zomf -Zdll -o perlE0AC.dll perl5shim.def -s
-llibperl</p>

<p style="margin-top: 1em">(ignore multiple &quot;warning
L4085&quot;).</p>

<p style="margin-top: 1em">Threading <br>
As of release 5.003_01 perl is linked to multithreaded C RTL
DLL. If perl itself is not compiled multithread-enabled, so
will not be perl&rsquo;s malloc(). However, extensions may
use <br>
multiple thread on their own risk.</p>

<p style="margin-top: 1em">This was needed to compile
&quot;Perl/Tk&quot; for XFree86-OS/2 out-of-the-box, and
link with DLLs for other useful libraries, which typically
are compiled with &quot;-Zmt -Zcrtdll&quot;.</p>

<p style="margin-top: 1em">Calls to external programs <br>
Due to a popular demand the perl external program calling
has been changed wrt Andreas Kaiser&rsquo;s port. If perl
needs to call an external program via shell, the
f:/bin/sh.exe will <br>
be called, or whatever is the override, see
&quot;PERL_SH_DIR&quot;.</p>

<p style="margin-top: 1em">Thus means that you need to get
some copy of a sh.exe as well (I use one from pdksh). The
path F:/bin above is set up automatically during the build
to a correct value on the <br>
builder machine, but is overridable at runtime,</p>

<p style="margin-top: 1em">Reasons: a consensus on
&quot;perl5-porters&quot; was that perl should use one
non-overridable shell per platform. The obvious choices for
OS/2 are cmd.exe and sh.exe. Having perl build <br>
itself would be impossible with cmd.exe as a shell, thus I
picked up &quot;sh.exe&quot;. This assures almost 100%
compatibility with the scripts coming from *nix. As an added
benefit this <br>
works as well under DOS if you use DOS-enabled port of pdksh
(see &quot;Prerequisites&quot;).</p>

<p style="margin-top: 1em">Disadvantages: currently sh.exe
of pdksh calls external programs via fork()/exec(), and
there is no functioning exec() on OS/2. exec() is emulated
by EMX by an asynchronous call <br>
while the caller waits for child completion (to pretend that
the &quot;pid&quot; did not change). This means that 1 extra
copy of sh.exe is made active via fork()/exec(), which may
lead to <br>
some resources taken from the system (even if we do not
count extra work needed for fork()ing).</p>

<p style="margin-top: 1em">Note that this a lesser issue
now when we do not spawn sh.exe unless needed (metachars
found).</p>

<p style="margin-top: 1em">One can always start cmd.exe
explicitly via</p>

<p style="margin-top: 1em">system &rsquo;cmd&rsquo;,
&rsquo;/c&rsquo;, &rsquo;mycmd&rsquo;, &rsquo;arg1&rsquo;,
&rsquo;arg2&rsquo;, ...</p>

<p style="margin-top: 1em">If you need to use cmd.exe, and
do not want to hand-edit thousands of your scripts, the
long-term solution proposed on p5-p is to have a
directive</p>

<p style="margin-top: 1em">use OS2::Cmd;</p>

<p style="margin-top: 1em">which will override system(),
exec(), &quot;&lsquo;&lsquo;&quot;, and
&quot;open(,&rsquo;...|&rsquo;)&quot;. With current perl you
may override only system(), readpipe() - the explicit
version of &quot;&lsquo;&lsquo;&quot;, and maybe exec().
<br>
The code will substitute the one-argument call to system()
by &quot;CORE::system(&rsquo;cmd.exe&rsquo;,
&rsquo;/c&rsquo;, shift)&quot;.</p>

<p style="margin-top: 1em">If you have some working code
for &quot;OS2::Cmd&quot;, please send it to me, I will
include it into distribution. I have no need for such a
module, so cannot test it.</p>

<p style="margin-top: 1em">For the details of the current
situation with calling external programs, see &quot;Starting
OS/2 (and DOS) programs under Perl&quot;. Set us mention a
couple of features:</p>

<p style="margin-top: 1em">&Acirc;&middot; External scripts
may be called by their basename. Perl will try the same
extensions as when processing -S command-line switch.</p>

<p style="margin-top: 1em">&Acirc;&middot; External scripts
starting with &quot;#!&quot; or &quot;extproc &quot; will be
executed directly, without calling the shell, by calling the
program specified on the rest of the first line.</p>

<p style="margin-top: 1em">Memory allocation <br>
Perl uses its own malloc() under OS/2 - interpreters are
usually malloc-bound for speed, but perl is not, since its
malloc is lightning-fast. Perl-memory-usage-tuned benchmarks
<br>
show that Perl&rsquo;s malloc is 5 times quicker than EMX
one. I do not have convincing data about memory footprint,
but a (pretty random) benchmark showed that Perl&rsquo;s one
is 5% <br>
better.</p>

<p style="margin-top: 1em">Combination of perl&rsquo;s
malloc() and rigid DLL name resolution creates a special
problem with library functions which expect their return
value to be free()d by system&rsquo;s free(). To <br>
facilitate extensions which need to call such functions,
system memory-allocation functions are still available with
the prefix &quot;emx_&quot; added. (Currently only DLL perl
has this, <br>
it should propagate to perl_.exe shortly.)</p>

<p style="margin-top: 1em">Threads <br>
One can build perl with thread support enabled by providing
&quot;-D usethreads&quot; option to Configure. Currently
OS/2 support of threads is very preliminary.</p>

<p style="margin-top: 1em">Most notable problems:</p>

<p style="margin-top: 1em">&quot;COND_WAIT&quot; <br>
may have a race condition (but probably does not due to
edge-triggered nature of OS/2 Event semaphores). (Needs a
reimplementation (in terms of chaining waiting threads, <br>
with the linked list stored in per-thread structure?)?)</p>

<p style="margin-top: 1em">os2.c <br>
has a couple of static variables used in OS/2-specific
functions. (Need to be moved to per-thread structure, or
serialized?)</p>

<p style="margin-top: 1em">Note that these problems should
not discourage experimenting, since they have a low
probability of affecting small programs.</p>

<p style="margin-top: 1em">BUGS <br>
This description is not updated often (since 5.6.1?), see
./os2/Changes for more info.</p>

<p style="margin-top: 1em">AUTHOR <br>
Ilya Zakharevich, cpan@ilyaz.org</p>

<p style="margin-top: 1em">SEE ALSO <br>
perl(1).</p>

<p style="margin-top: 1em">perl v5.16.3 2013-03-06
PERLOS2(1)</p>
<hr>
</body>
</html>
