<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
  </style>
  <title>r.terraflow(1grass)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">r.terraflow(1grass)</td>
    <td class="head-vol">Grass User's Manual</td>
    <td class="head-rtitle">r.terraflow(1grass)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="selflink" href="#NAME">NAME</a></h1>
<i></i><b>r.terraflow</b> - Performs flow computation for massive grids.
<div>&#x00A0;</div>
Float version.
<h1 class="Sh" title="Sh" id="KEYWORDS"><a class="selflink" href="#KEYWORDS">KEYWORDS</a></h1>
raster, hydrology, flow, accumulation, sink
<h1 class="Sh" title="Sh" id="SYNOPSIS"><a class="selflink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<b>r.terraflow</b>
<div>&#x00A0;</div>
<b>r.terraflow --help</b>
<div>&#x00A0;</div>
<b>r.terraflow</b> [-<b>s</b>] <b>elevation</b>=<i>name</i>
  <b>filled</b>=<i>name</i> <b>direction</b>=<i>name</i>
  <b>swatershed</b>=<i>name</i> <b>accumulation</b>=<i>name</i>
  <b>tci</b>=<i>name</i> [ <b>d8cut</b>=<i>float</i>]
  [<b>memory</b>=<i>integer</i>] [ <b>directory</b>=<i>string</i>]
  [<b>stats</b>= <i>string</i>] [--<b>overwrite</b>] [--<b>help</b>]
  [--<b>verbose</b>] [-- <b>quiet</b>] [--<b>ui</b>]
<h2 class="Ss" title="Ss" id="Flags:"><a class="selflink" href="#Flags:">Flags:</a></h2>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-s</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    SFD (D8) flow (default is MFD)
    <div>&#x00A0;</div>
    SFD: single flow direction, MFD: multiple flow direction</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>--overwrite</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Allow output files to overwrite existing files</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>--help</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Print usage summary</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>--verbose</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Verbose module output</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>--quiet</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Quiet module output</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>--ui</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Force launching GUI dialog</dd>
</dl>
<h2 class="Ss" title="Ss" id="Parameters:"><a class="selflink" href="#Parameters:">Parameters:</a></h2>
<dl class="Bl-tag">
  <dt class="It-tag"><b>elevation</b>=<i>name</i> <b>[required]</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Name of input elevation raster map</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>filled</b>=<i>name</i> <b>[required]</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Name for output filled (flooded) elevation raster map</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>direction</b>=<i>name</i> <b>[required]</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Name for output flow direction raster map</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>swatershed</b>=<i>name</i> <b>[required]</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Name for output sink-watershed raster map</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>accumulation</b>=<i>name</i> <b>[required]</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Name for output flow accumulation raster map</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>tci</b>=<i>name</i> <b>[required]</b></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Name for output topographic convergence index (tci) raster map</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>d8cut</b>=<i>float</i></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Routing using SFD (D8) direction
    <div>&#x00A0;</div>
    If flow accumulation is larger than this value it is routed using SFD (D8)
      direction (meaningfull only for MFD flow). If no answer is given it
      defaults to infinity.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>memory</b>=<i>integer</i></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Maximum memory to be used (in MB)
    <div>&#x00A0;</div>
    Default: <i>300</i></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>directory</b>=<i>string</i></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Directory to hold temporary files (they can be large)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>stats</b>=<i>string</i></dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Name of file containing runtime statistics</dd>
</dl>
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="selflink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<i>r.terraflow</i> takes as input a raster digital elevation model (DEM) and
  computes the flow direction raster and the flow accumulation raster, as well
  as the flooded elevation raster, sink-watershed raster (partition into
  watersheds around sinks) and TCI (topographic convergence index) raster maps.
<div class="Pp"></div>
<i>r.terraflow</i> computes these rasters using well-known approaches, with the
  difference that its emphasis is on the computational complexity of the
  algorithms, rather than on modeling realistic flow. <i>r.terraflow</i> emerged
  from the necessity of having scalable software able to process efficiently
  very large terrains. It is based on theoretically optimal algorithms developed
  in the framework of I/O-efficient algorithms. <i>r.terraflow</i> was designed
  and optimized especially for massive grids and is able to process terrains
  which were impractical with similar functions existing in other GIS systems.
<div class="Pp"></div>
Flow directions are computed using either the MFD (Multiple Flow Direction)
  model or the SFD (Single Flow Direction, or D8) model, illustrated below. Both
  methods compute downslope flow directions by inspecting the 3-by-3 window
  around the current cell. The SFD method assigns a unique flow direction
  towards the steepest downslope neighbor. The MFD method assigns multiple flow
  directions towards all downslope neighbors.
<table class="tbl">
  <colgroup>
    <col style="width: 60.00ex;"/>
    <col style="width: 1.00ex;"/>
    <col style="width: 60.00ex;"/>
  </colgroup>
  <tr>
    <td></td>
    <td> </td>
    <td></td>
  </tr>
  <tr>
    <td>Flow direction to steepest downslope neighbor (SFD).</td>
    <td> </td>
    <td>Flow direction to all downslope neighbors (MFD).</td>
  </tr>
</table>
<div class="Pp"></div>
The SFD and the MFD method cannot compute flow directions for cells which have
  the same height as all their neighbors (flat areas) or cells which do not have
  downslope neighbors (one-cell pits).
<div style="margin-left: 4.00ex;">
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">On plateaus (flat areas that spill out) <i>r.terraflow</i>
      routes flow so that globally the flow goes towards the spill cells of the
      plateaus.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">On sinks (flat areas that do not spill out, including
      one-cell pits) <i>r.terraflow</i> assigns flow by flooding the terrain
      until all the sinks are filled and assigning flow directions on the filled
      terrain.</dd>
</dl>
</div>
<div class="Pp"></div>
In order to flood the terrain, <i>r.terraflow</i> identifies all sinks and
  partitions the terrain into sink-watersheds (a sink-watershed contains all the
  cells that flow into that sink), builds a graph representing the adjacency
  information of the sink-watersheds, and uses this sink-watershed graph to
  merge watersheds into each other along their lowest common boundary until all
  watersheds have a flow path outside the terrain. Flooding produces a sink-less
  terrain in which every cell has a downslope flow path leading outside the
  terrain and therefore every cell in the terrain can be assigned SFD/MFD flow
  directions as above.
<div class="Pp"></div>
Once flow directions are computed for every cell in the terrain,
  <i>r.terraflow</i> computes flow accumulation by routing water using the flow
  directions and keeping track of how much water flows through each cell.
<div class="Pp"></div>
If flow accumulation of a cell is larger than the value given by the
  <b>d8cut</b> option, then the flow of this cell is routed to its neighbors
  using the SFD (D8) model. This option affects only the flow accumulation
  raster and is meaningful only for MFD flow (i.e. if the -s flag is not used);
  If this option is used for SFD flow it is ignored. The default value of
  <b>d8cut</b> is <i>infinity</i>.
<div class="Pp"></div>
<i>r.terraflow</i> also computes the tci raster (topographic convergence index,
  defined as the logarithm of the ratio of flow accumulation and local slope).
<div class="Pp"></div>
For more details on the algorithms see [1,2,3] below.
<h1 class="Sh" title="Sh" id="NOTES"><a class="selflink" href="#NOTES">NOTES</a></h1>
One of the techniques used by <i>r.terraflow</i> is the space-time trade-off. In
  particular, in order to avoid searches, which are I/O-expensive,
  <i>r.terraflow</i> computes and works with an augmented elevation raster in
  which each cell stores relevant information about its 8 neighbors, in total up
  to 80B per cell. As a result <i>r.terraflow</i> works with intermediate
  temporary files that may be up to 80N bytes, where N is the number of cells
  (rows x columns) in the elevation raster (more precisely, 80K bytes, where K
  is the number of valid (not no-data) cells in the input elevation raster).
<div class="Pp"></div>
All these intermediate temporary files are stored in the path specified by the
  <b>STREAM_DIR</b> option. Note: <b>STREAM_DIR</b> must contain enough free
  disk space in order to store up to 2 x 80N bytes.
<div class="Pp"></div>
The <b>memory</b> option can be used to set the maximum amount of main memory
  (RAM) the module will use during processing. In practice its <i>value</i>
  should be an underestimate of the amount of available (free) main memory on
  the machine. <i>r.terraflow</i> will use at all times at most this much
  memory, and the virtual memory system (swap space) will never be used. The
  default value is 300 MB.
<div class="Pp"></div>
The <b>stats</b> option defines the name of the file that contains the
  statistics (stats) of the run.
<div class="Pp"></div>
<i>r.terraflow</i> has a limit on the number of rows and columns (max 32,767
  each).
<div class="Pp"></div>
The internal type used by <i>r.terraflow</i> to store elevations can be defined
  at compile-time. By default, <i>r.terraflow</i> is compiled to store
  elevations internally as floats. Other versions can be created by the user if
  needed.
<div class="Pp"></div>
Hints concerning compilation with storage of elevations internally as shorts:
<div>&#x00A0;</div>
such a version uses less space (up to 60B per cell, up to 60N intermediate file)
  and therefore is more space and time efficient. <i>r.terraflow</i> is intended
  for use with floating point raster data (FCELL), and <i>r.terraflow
  (short)</i> with integer raster data (CELL) in which the maximum elevation
  does not exceed the value of a short SHRT_MAX=32767 (this is not a constraint
  for any terrain data of the Earth, if elevation is stored in meters). Both
  <i>r.terraflow</i> and <i>r.terraflow (short)</i> work with input elevation
  rasters which can be either integer, floating point or double (CELL, FCELL,
  DCELL). If the input raster contains a value that exceeds the allowed internal
  range (short for <i>r.terraflow (short)</i>, float for <i>r.terraflow</i>),
  the program exits with a warning message. Otherwise, if all values in the
  input elevation raster are in range, they will be converted (truncated) to the
  internal elevation type (short for <i>r.terraflow (short)</i>, float for
  <i>r.terraflow</i>). In this case precision may be lost and artificial flat
  areas may be created. For instance, if <i>r.terraflow (short)</i> is used with
  floating point raster data (FCELL or DCELL), the values of the elevation will
  be truncated as shorts. This may create artificial flat areas, and the output
  of <i>r.terraflow (short)</i> may be less realistic than those of
  <i>r.terraflow</i> on floating point raster data. The outputs of
  <i>r.terraflow (short)</i> and <i>r.terraflow</i> are identical for integer
  raster data (CELL maps).
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="selflink" href="#EXAMPLES">EXAMPLES</a></h1>
Example for small area in North Carolina sample dataset:
<div>&#x00A0;</div>
<pre>
g.region raster=elev_lid792_1m
r.terraflow elevation=elev_lid792_1m filled=elev_lid792_1m_filled \
    direction=elev_lid792_1m_direction swatershed=elev_lid792_1m_swatershed \
    accumulation=elev_lid792_1m_accumulation tci=elev_lid792_1m_tci
</pre>
<div>&#x00A0;</div>
<i>Flow accumulation</i>
<div class="Pp"></div>
Spearfish sample data set:
<div>&#x00A0;</div>
<pre>
g.region raster=elevation.10m -p
r.terraflow elev=elevation.10m filled=elevation10m.filled \
    dir=elevation10m.mfdir swatershed=elevation10m.watershed \
    accumulation=elevation10m.accu tci=elevation10m.tci
</pre>
<div>&#x00A0;</div>
<pre>
g.region raster=elevation.10m -p
r.terraflow elev=elevation.10m filled=elevation10m.filled \
    dir=elevation10m.mfdir swatershed=elevation10m.watershed \
    accumulation=elevation10m.accu tci=elevation10m.tci d8cut=500 memory=800 \
    stats=elevation10mstats.txt
</pre>
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="selflink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<i></i> <i>r.flow,</i> <i>r.basins.fill,</i> <i>r.drain,</i> <i>r.topidx,</i>
  <i>r.topmodel,</i> <i>r.water.outlet,</i> <i>r.watershed</i> <i></i>
<h1 class="Sh" title="Sh" id="AUTHORS"><a class="selflink" href="#AUTHORS">AUTHORS</a></h1>
<dl class="Bl-tag">
  <dt class="It-tag">Original version of program: The 	TerraFlow project, 	1999,
    Duke University. 	</dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Lars Arge, Jeff Chase, Pat Halpin, Laura Toma, Dean Urban, Jeff Vitter,
      Rajiv Wickremesinghe.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Porting to GRASS GIS, 2002: </dt>
  <dd class="It-tag">
    <div>&#x00A0;</div>
    Lars Arge, Helena Mitasova, Laura Toma.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Contact: Laura Toma</dt>
  <dd class="It-tag"></dd>
</dl>
<h1 class="Sh" title="Sh" id="REFERENCES"><a class="selflink" href="#REFERENCES">REFERENCES</a></h1>
<dl class="Bl-tag">
  <dt class="It-tag"><b>1</b></dt>
  <dd class="It-tag">The TerraFlow project at Duke University</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>2</b></dt>
  <dd class="It-tag">I/O-efficient algorithms for problems on grid-based
      terrains. Lars Arge, Laura Toma, and Jeffrey S. Vitter. In <i>Proc.
      Workshop on Algorithm Engineering and Experimentation</i>, 2000. To appear
      in <i>Journal of Experimental Algorithms</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>3</b></dt>
  <dd class="It-tag">Flow computation on massive grids. Lars Arge, Jeffrey S.
      Chase, Patrick N. Halpin, Laura Toma, Jeffrey S. Vitter, Dean Urban and
      Rajiv Wickremesinghe. In <i>Proc. ACM Symposium on Advances in Geographic
      Information</i> <i>Systems</i>, 2001.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>4</b></dt>
  <dd class="It-tag">Flow computation on massive grid terrains. Lars Arge,
      Jeffrey S. Chase, Patrick N. Halpin, Laura Toma, Jeffrey S. Vitter, Dean
      Urban and Rajiv Wickremesinghe. In <i>GeoInformatica, International
      Journal on</i> <i>Advances of Computer Science for Geographic
      Information</i> <i>Systems</i>, 7(4):283-313, December 2003.</dd>
</dl>
<div class="Pp"></div>
<i>Last changed: $Date: 2015-01-14 09:26:25 +0100 (Wed, 14 Jan 2015) $</i>
<h1 class="Sh" title="Sh" id="SOURCE_CODE"><a class="selflink" href="#SOURCE_CODE">SOURCE
  CODE</a></h1>
Available at: r.terraflow source code (history)
<div class="Pp"></div>
Main index | Raster index | Topics index | Keywords index | Graphical index |
  Full index
<div class="Pp"></div>
&#x00A9; 2003-2016 GRASS Development Team, GRASS GIS 7.2.0 Reference
  Manual</div>
<table class="foot">
  <tr>
    <td class="foot-date"></td>
    <td class="foot-os">GRASS 7.2.0</td>
  </tr>
</table>
</body>
</html>
