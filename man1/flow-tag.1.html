<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
  </style>
  <title><b>flow-tag</b>(1)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle"><b>flow-tag</b>(1)</td>
    <td class="head-vol">General Commands Manual</td>
    <td class="head-rtitle"><b>flow-tag</b>(1)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="selflink" href="#NAME">NAME</a></h1>
<b>flow-tag</b> &#x2014; Apply tags to flow files.
<h1 class="Sh" title="Sh" id="SYNOPSIS"><a class="selflink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<b>flow-tag</b> [-hk] [-b<i> big</i>|<i>little</i>] [-C<i> comment</i>] [-d<i>
  debug_level</i>] [-t <i> tag_fname</i>] [-T<i> tag_definition</i>] [-v<i>
  variable binding</i>]
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="selflink" href="#DESCRIPTION">DESCRIPTION</a></h1>
The <b>flow-tag</b> utility is used to add or modify source and destination tags
  in flow records. Tags are 32 bit identifiers derived from rules and fields in
  a flow record. Tags can be used to group flows with common prefixes,
  autonomous systems, next hops, exporter id and/or input/output interface.
  <b>flow-stat</b> can be used with tagged flows to produce group based reports.
  For example, all outbound traffic for a customer where the customer is defined
  by a list of IP prefixes.
<h1 class="Sh" title="Sh" id="OPTIONS"><a class="selflink" href="#OPTIONS">OPTIONS</a></h1>
<dl class="Bl-tag">
  <dt class="It-tag">-b<i> big</i>|<i>little</i></dt>
  <dd class="It-tag">Byte order of output.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">-C<i> Comment</i></dt>
  <dd class="It-tag">Add a comment.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">-d<i> debug_level</i></dt>
  <dd class="It-tag">Enable debugging.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">-h</dt>
  <dd class="It-tag">Display help.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">-k</dt>
  <dd class="It-tag">Keep time from input.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">-t<i> tag_fname</i></dt>
  <dd class="It-tag">Load tags from <b>tag_name</b>. Defaults to
      <b>/etc/flow-tools/cfg/tag</b></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">-T<i> active_def</i>|</dt>
  <dd class="It-tag">Use <i>active_def</i> as the active tag definition(s).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">-v<i> variable binding</i></dt>
  <dd class="It-tag">Set a variable FOO=bar.</dd>
</dl>
<div class="Pp"></div>
The configuration file is a collection of actions and definitions. An action is
  triggered by a definition and a definition is invoked only if listed with the
  <i>-T</i> flag. Lines begining with # are treated as comments and ignored.
<div class="Pp"></div>
Words in the configuration file of the form @VAR or @{VAR:default} will be
  expanded at run-time by setting variable names with the -v option.
<div class="Pp"></div>
<pre>
tag-action command            Description/Example
----------------------------------------------------------------------
tag-action                    Begin tag-action section
                              tag-action foo
<div class="Pp"></div>
type                          Configure the type of action, one of
                              source-prefix, destination-prefix, prefix,
                              source-as, destination-as, as, next-hop,
                              tcp-source-port, tcp-destination-port,
                              tcp-port, udp-source-port,
                              udp-destination-port, udp-port,
                              tos, exporter, source-ip-address,
                              destination-ip-address, ip-address,
                              input-interface, output-interface,
                              interface, any.
                              type src-prefix
<div class="Pp"></div>
match                         Match criteria.  The match condition
                              depends on the type.  Following the
                              match condition is one of
                              set-destination, set-source,
                              or-destination, or-source to
                              set or logically or a value to the
                              source or destination tag.
                              match 128.146/16 set-destination 0x010001
<div class="Pp"></div>
Multiple actions may match and set tags on the same flow.  Note that
listing many actions will cause tags to be applied in O(actions) time.
The actions try to run in O(1) time.  For example if 10 prefixes are
listed in a single action it will take about the same CPU as if 100
prefixes are used.  Listing 100 actions will require 100 times the
CPU as 1 action.
<div class="Pp"></div>
<div class="Pp"></div>
tag-action types                    Description
----------------------------------------------------------------------
<div class="Pp"></div>
source-prefix                       Source Prefix
<div class="Pp"></div>
destination-prefix                  Destination Prefix
<div class="Pp"></div>
prefix                              Source or Destination Prefix
<div class="Pp"></div>
source-as                           Source AS
<div class="Pp"></div>
destination-as                      Destination AS
<div class="Pp"></div>
as                                  Source or Destination AS
<div class="Pp"></div>
next-hop                            IP Next Hop
<div class="Pp"></div>
tcp-source-port                     TCP Source Port
<div class="Pp"></div>
tcp-destination-port                TCP Destination Port
<div class="Pp"></div>
tcp-port                            TCP Source or Destination Port
<div class="Pp"></div>
udp-source-port                     UDP Source Port
<div class="Pp"></div>
udp-destination-port                UDP Destination Port
<div class="Pp"></div>
udp-port                            UDP Source or Destination Port
<div class="Pp"></div>
tos                                 Type of Service
<div class="Pp"></div>
exporter                            Exporter IP Address
<div class="Pp"></div>
source-ip-address                   Source IP Address
<div class="Pp"></div>
destination-ip-address              Destination IP Address
<div class="Pp"></div>
ip-address                          Source or Destination IP Address
<div class="Pp"></div>
input-interface                     Input Interface
<div class="Pp"></div>
output-interface                    Output Interface
<div class="Pp"></div>
interface                           Input or Output Interface
<div class="Pp"></div>
any                                 Match any flows
<div class="Pp"></div>
<div class="Pp"></div>
tag-action matches                  Description
----------------------------------------------------------------------
<div class="Pp"></div>
set-destination                     Set the destination tag, replacing
                                    any previous tag.
<div class="Pp"></div>
set-source                          Set the source tag, replacing any
                                    previous tag.
<div class="Pp"></div>
or-destination                      Logically or this value to the
                                    existing destination tag
<div class="Pp"></div>
or-source                           Logically or this value to the
                                    existing source tag
<div class="Pp"></div>
</pre>
<div class="Pp"></div>
A definition lists a set of actions which are evaluated if the filter criteria
  is met. Each definition is built with terms. A term has its action(s)
  evaluated if the filter is passed.
<div class="Pp"></div>
<pre>
definition command                  Description/Example
-----------------------------------------------------------------------
tag-definition                      Begin tag-defintion secrion
                                    tag-definition bar
<div class="Pp"></div>
term                                Begin a list of actions to be
                                    evaluated that match the filter
                                    rule.
                                    term
<div class="Pp"></div>
input-filter                        List of input ifIndexes the flow
                                    must match.
                                    input-filter 1,2,3,4
<div class="Pp"></div>
output-filter                       List of output ifIndexes the flow
                                    must match.
                                    output-filter 1,2,3,4
<div class="Pp"></div>
exporter                            IP address of exporter the flow must
                                    match.
                                    exporter 1.2.3.4
<div class="Pp"></div>
action                              Name of action to evaluate.  Actions
                                    are evaluated in the order they
                                    appear in a definition.
                                    action foo
</pre>
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="selflink" href="#EXAMPLES">EXAMPLES</a></h1>
The meaning of a tag is user defined. The following example uses 16 bits of a
  tag as a customer ID and 4 bits as a customer type. <b>flow-xlate</b> can be
  used to apply a mask to these fields.
<div class="Pp"></div>
<pre>
# file: gigapop-tags
# tag format
# 
# 0       7         15        23        31
# 0000 0000 0000 0000 0000 0000 0000 0000 (32 bits)
# RRRRRRRRRRRRRR TTTT NNNNNNNNNNNNNNNNNNN
#              |    |                   | Site name
#              |    | Site type
#              | Reserved
#
#
# SITE_NAME_MASK = 0x0000FFFF  
# SITE_TYPE_MASK = 0x00FF0000
#
# ID             Name
#---------------------------------
# 0x0001         OSU
# 0x0002         CWRU
# 0x0003         BGSU   
# ... etc
# 0x0019         MULTICAST
#
# ID             Type  
#------------------------
# 0x01         Participant
# 0x02         SEGP
# 0x03         Sponsored-Participant
# 0x04         Gigapop
# 0x05         MULTICAST
<div class="Pp"></div>
tag-action OHIO-GIGAPOP_DST
 type destination-prefix
# OSU
 match 128.146/16 set-destination     0x010001
 match 164.107/16 set-destination     0x010001
 match 140.254/16 set-destination     0x010001
 match 192.153.26/24 set-destination  0x010001
# CWRU
 match 129.22/16 set-destination      0x010002
 match 192.5.110/24 set-destination   0x010002
# BGSU
 match 129.1/16 set-destination       0x010003
# ...etc
# MULTICAST
 match 224/4 set-destination 0x050019
<div class="Pp"></div>
tag-action OHIO-GIGAPOP_SRC
 type source-prefix
# OSU
 match 128.146/16 set-source     0x010001
 match 164.107/16 set-source     0x010001
 match 140.254/16 set-source     0x010001
 match 192.153.26/24 set-source  0x010001
# CWRU
 match 129.22/16 set-source      0x010002
 match 192.5.110/24 set-source   0x010002
# BGSU
 match 129.1/16 set-source       0x010003
# ...etc
<div class="Pp"></div>
tag-action OTHER_DST
 type destination-prefix
 match 0/0 set-destination 0x0
 
tag-action OTHER_SRC
 type source-prefix
 match 0/0 set-source 0x0
<div class="Pp"></div>
tag-definition OHIO-GIGAPOP
 term
# Abilene interface
 input-filter 25
# clear tag first -- it defaults to 0, so this may not be necessary.
 action OTHER_DST
 action OHIO-GIGAPOP_DST
 term
# Abilene interface
 output-filter 25
# clear tag first -- it defaults to 0, so this may not be necessary.
 action OTHER_SRC
 action OHIO-GIGAPOP_SRC
</pre>
<div class="Pp"></div>
First populate <b>/etc/flow-tools/sym/tag</b> for <b>flow-stat</b> to use as
  symbols.
<div class="Pp"></div>
<pre>
0x0001 OSU
0x0002 CWRU
0x0003 BGSU
0x0019 MULTICAST
0x010000 PART
0x020000 SEGP
0x030000 SPART
0x040000 GIGAPOP
0x050000 MULTICAST
</pre>
<div class="Pp"></div>
To generate a report for outgoing traffic to Abilene based on customer ID:
<div class="Pp"></div>
<pre>
flow-cat  <b>flows</b> | flow-filter -I25 | flow-tag -t gigapop-tags -TOHIO-GIGAPOP | flow-xlate -t0x0000FFFF | flow-stat -n -f30 -S2
</pre>
<div class="Pp"></div>
<pre>
#  --- ---- ---- Report Information --- --- ---
#
# Fields:    Total
# Symbols:   Enabled
# Sorting:   Descending Field 2
# Name:      Source Tag
#
# Args:      ../flow-stat -n -f30 -S2 
#
#
# Src Tag   flows                 octets                packets
#
OSU         4942230               181326237007          302476793
CWRU        874883                54358312807           70589318
BGSU        1008797               7600209852            22060870
</pre>
<div class="Pp"></div>
To generate a report for inbound traffic from Abilene based on customer type:
<div class="Pp"></div>
<pre>
flow-cat  <b>flows</b> | flow-filter -i25 | flow-tag -t gigapop-tags -TOHIO-GIGAPOP | flow-xlate -T0xFF0000 | flow-stat -n -f31 -S2
</pre>
<div class="Pp"></div>
<pre>
#  --- ---- ---- Report Information --- --- ---
#
# Fields:    Total
# Symbols:   Enabled
# Sorting:   Descending Field 2
# Name:      Destination Tag
#
# Args:      ../flow-stat -n -f31 -S2 
#
#
# Dst Tag   flows                 octets                packets
#
PART        15923156              663289954569          981163979
SEGP        4995795               135525076170          196534917
MULTICAST   45171                 49866825003           137798118
GIGAPOP     942209                26422533266           23199961
SPART       73998                 5170323905            7597985
</pre>
<h1 class="Sh" title="Sh" id="FILES"><a class="selflink" href="#FILES">FILES</a></h1>
<br/>
 Configuration files:
<br/>
 Symbols - <b>/etc/flow-tools/sym/*</b>.
<br/>
 Tag - <b>/etc/flow-tools/cfg/tag.cfg</b>.
<h1 class="Sh" title="Sh" id="BUGS"><a class="selflink" href="#BUGS">BUGS</a></h1>
None known.
<h1 class="Sh" title="Sh" id="AUTHOR"><a class="selflink" href="#AUTHOR">AUTHOR</a></h1>
Mark Fullmer maf@splintered.net
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="selflink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<b>flow-tools</b>(1)</div>
<table class="foot">
  <tr>
    <td class="foot-date"></td>
    <td class="foot-os"></td>
  </tr>
</table>
</body>
</html>
