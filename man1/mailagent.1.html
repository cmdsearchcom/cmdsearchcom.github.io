<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
  </style>
  <title>MAILAGENT(1)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">MAILAGENT(1)</td>
    <td class="head-vol">General Commands Manual</td>
    <td class="head-rtitle">MAILAGENT(1)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="selflink" href="#NAME">NAME</a></h1>
mailagent - an automatic mail-processing tool
<h1 class="Sh" title="Sh" id="SYNOPSIS"><a class="selflink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<b>mailagent</b> [ <b>-dhilqtFIVU</b> ] [ <b>-s{umaryt}</b> ] [ <b>-f</b><i>
  file</i> ] [ <b>-e</b><i> rule</i> ] [ <b>-c</b><i> config</i> ] [
  <b>-L</b><i> loglevel</i> ] [ <b>-r</b><i> rulefile</i> ] [ <b>-o</b><i>
  override</i> ] [ <i>mailfile</i> ]
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="selflink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<i>Mailagent</i> allows you to process your mail automatically. Given a set of
  <i>lex</i>-like rules, you are able to fill mails to specific folders, forward
  messages to a third person, pipe a message to a command or even post the
  message to a newsgroup. It is also possible to process messages containing
  some commands. The <i>mailagent</i> is not usually invoked manually but is
  rather called via the <i>filter</i> program, which is in turn invoked by
  <i>sendmail</i>. That means you must have <i>sendmail</i> on your system to
  use this. You also must have <i>perl</i> to run the mailagent scripts.
<div class="Pp"></div>
There is a set of options which may be used when you invoke <i>mailagent</i>
  yourself. Please refer to the <b>OPTIONS</b> section for a complete
  description. You may use the <b>-h</b> option to get a cryptic usage reminder.
<h2 class="Ss" title="Ss" id="Product_Overview"><a class="selflink" href="#Product_Overview">Product
  Overview</a></h2>
<i>Mailagent</i> has actually four distinct set of features, which can be used
  simultaneously or one at a time. This involves:
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">An @SH command processor, to remain compatible with the
      first implementation. In this simplest usage, all the mail messages are
      left in your mailbox (or the catch all folder required on Debian systems:
      Please see <b>/usr/share/doc/mailagent/SECURITY for details),</b> with
      special processing raised on messages whose subject is <i>Command</i>.
      Please refer to the section entitled <b>USING THE DEFAULT RULES</b> if you
      wish to use this feature.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">A complete mail filter, which helps you sort your mail
      based on various sorting criteria and actions. Filtering is specified in a
      rule file and supersedes the default <i>Command</i> mail processing (which
      may be turned on again by explicitly setting up a rule for it). This
      should be the most common use of <i>mailagent</i> and is fully documented
      under the section entitled <b>USING THE FILTER</b>. You may deliver mail
      to plain Unix-style folders but also to MMDF and MH ones.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">A replacement for the <i>vacation</i> program, which will
      automatically answer your mail while you are not there. You only need to
      supply a message to be sent back and the frequency at which this will
      occur. Some simple macro substitutions allow you to re-use some parts of
      the mail header into your vacation message, for a more personalized reply.
      See the <b>VACATION</b> <b>MODE</b> section for more details.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">A generic mail server, which will let you implement a real
      mail server without the hassle of the lower-level concerns like error
      recovery, logging or command parsing. The full documentation can be found
      in the section <b>GENERIC MAIL SERVER</b> at the end of this manual
    page.</dd>
</dl>
<div class="Pp"></div>
It is possible to extend the mailagent filtering commands by implementing them
  in <i>perl</i> and then having them automagically loaded when used. Those
  extended commands will behave exactly like built in ones, as documented in the
  <b>EXTENDING FILTERING COMMANDS</b> section.
<h2 class="Ss" title="Ss" id="Learning_From_Examples"><a class="selflink" href="#Learning_From_Examples">Learning
  From Examples</a></h2>
It is quite possible that you will find this manual page too complex for you.
  Unfortunately, it is not really meant to be a tutorial but rather a reference
  material. If you wish, you may start by looking at the examples held in the
  distribution source tree under <i>agent/examples</i>. This directory contains
  two examples of rule files (look at the README file first) and are verbosely
  commented.
<h1 class="Sh" title="Sh" id="GETTING_STARTED"><a class="selflink" href="#GETTING_STARTED">GETTING
  STARTED</a></h1>
First, you need to install a minimum configuration and see how it works. It
  would be useless to fully install the program and then discover that it does
  not work as advertised...
<div class="Pp"></div>
To start the installation, you have to set up a <i>~/.mailagent</i> file which
  is the main configuration file, and choose the right <i>filter</i> program.
<h2 class="Ss" title="Ss" id="Choosing_The_Filter_Program"><a class="selflink" href="#Choosing_The_Filter_Program">Choosing
  The Filter Program</a></h2>
The distribution comes with two filter programs. One written in shell and one in
  C. The shell version might be the one to use if you can receive your mail on
  many different platforms where your home directory is NFS-mounted (i.e. shared
  among all those platforms). The C version is safer and much faster, but you
  need to install it to a fixed location.
<div class="Pp"></div>
On some platforms, <i>sendmail</i> does not correctly reset its UID when
  processing mails in its own queue. In that case, you need to get a private
  copy of the C filter program and make it setuid to yourself. The filter will
  then correctly reset its UID if invoked with an effective UID different from
  yours (it may also require the setgid bit to reset GID as well). If this is
  indeed the case on your system, make sure you use the <i>path</i>
  configuration variable to set a proper PATH, as the filter will spawn a perl
  process with the '-S' option, looking for a <i>mailagent</i> script.
<div class="Pp"></div>
Even if you do not need to get a setuid copy of the <i>filter</i> program, it is
  wise to set up a proper path: someone might break into your account by putting
  a mailagent Trojan horse in the appropriate location. Also make sure the
  mailagent program is protected against writing, as well as the directory which
  holds it, or someone might substitute his own version of the script and break
  security. I believe the setuid <i>filter</i> program to be safe, but
  overlooking is always possible so please report any security hole to me.
<div class="Pp"></div>
The <i>filter</i> script can be found in the <i>Lib/mailagent</i> directory. It
  needs some tailoring so you should copy it into your home directory and edit
  it to suit your needs. Comments held in it should be self explanatory. There
  is only a small section at the head of the script which needs to be edited.
  You'll have to delete shell comments in the <i>filter</i> script by yourself
  if your shell cannot deal with them.
<div class="Pp"></div>
As of version 3.0 PL44, I advise you to prefer the C version if you are
  concerned about security. If you are in a position where multiple
  architectures can process your <i>.forward</i>, then a shell wrapper selecting
  the proper executable based on the architecture will be required.
<h2 class="Ss" title="Ss" id="Configuring_Mailagent"><a class="selflink" href="#Configuring_Mailagent">Configuring
  Mailagent</a></h2>
If <i>mailagent</i> is in your path, you may automatically configure a default
  installation by running: 	mailagent -I which will create a <i>~/.mailagent</i>
  file from an existing template, customize some important variables for your
  site, and make some basic sanity checks. Everything the command does is output
  on the screen for checking purposes, and any problem found is reported.
<div class="Pp"></div>
Otherwise, you have to copy the <i>mailagent.cf</i> file held in the mailagent
  sub-directory <i>/usr/share/mailagent</i> (hereafter named Lib) as a
  <i>.mailagent</i> in your home directory. Edit it to configure the whole
  processing. In particular, you have to choose a spool directory (hereafter
  named Spool) and a log directory (hereafter named Log).
<div class="Pp"></div>
Note that using the automatic installation procedure above does not prevent you
  from going through the file and modifying it as you wish. In fact, you are
  greatly encouraged to do this, especially for the home directory setting, the
  logging level and the <i>path</i> or <i>p_host</i> variables. Once you are
  done, rerun the <i>mailagent -I</i> command to make sure everything is fine.
  Still, you will have to plug in mailagent by creating a <i>~/.forward</i>
  file, as explained in a few sections.
<div class="Pp"></div>
Following is a description of each of the fields you will find in the
  <i>~/.mailagent</i> file, followed by a suggested value, when applicable.
  Fields marked as optional may not be present in the configuration file. Some
  fields have a close relationship with others, and that is given too.
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>agemax</i></dt>
  <dd class="It-tag">Period after which an entry in the database should be
      removed (suggested: 1y) This field is optional, but needed if
      <i>autoclean</i> is on.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>authfile</i></dt>
  <dd class="It-tag">Remote sending authorizations (not implemented yet).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>autoclean</i></dt>
  <dd class="It-tag">Set to ON (case insensitively), mailagent will perform
      automatic cleaning of the database entries under <i>hash</i> by removing
      all the items older than <i>agemax</i>. This is an optional field,
      omitting it defaults to OFF. (suggested: OFF, unless you use ONCE, UNIQUE
      or RECORD commands, or activate the vacation mode.)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>biff</i></dt>
  <dd class="It-tag">Whether or not biffing is wanted when <i>mailagent</i>
      delivers mail to a folder. Set it to ON (case insensitively) to allow
      local biffing if you are logged in. (optional, defaults to: OFF)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>biffhead</i></dt>
  <dd class="It-tag">When biffing is enabled, this variable lists which headers
      should be printed out. Headers should be given in their normalized format
      and be separated with commas. (optional, defaults to: From, To, Subject,
      Date).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>bifflen</i></dt>
  <dd class="It-tag">The maximum length of the message body that should be
      printed when biffing. (optional, defaults to 560).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>bifflines</i></dt>
  <dd class="It-tag">The maximum number of lines of the message body that should
      be printed when biffing. Actually, <i>mailagent</i> attempts to print that
      amount of lines, provided the total amount of characters printed is less
      than <i>bifflen</i>. (optional, defaults to 7).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>biffmh</i></dt>
  <dd class="It-tag">When turned ON, the body of the message is compacted before
      biffing by removing consecutive spaces and replacing newlines with a
      single space. The message itself is not altered physically of course, only
      the output on the screen is concerned. Since this may yield to a
      difficult-to-read message, I suggest you also turn on <i>biffnice</i> when
      using this option. (optional, defaults to: OFF).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>biffmsg</i></dt>
  <dd class="It-tag">The path to a file describing the format biffing should
      use. If not set, a default hardwired format is used. Season to taste.
      (suggested: ~/.biffmsg).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>biffnice</i></dt>
  <dd class="It-tag">Whether the message should be reformatted to nicely fit
      into the terminal. (optional, defaults to OFF, suggested: ON when
      <i>biffmh</i> is also ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>biffnl</i></dt>
  <dd class="It-tag">Controls whether &quot;blank&quot; body lines should be
      printed or not. By &quot;blank&quot; lines, we mean lines not containing
      words. Set it to ON to print such blank lines, to OFF if you wish to get a
      more compact view of the body within the limits fixed by <i>bifflen</i>
      and <i>bifflines</i>. (optional, defaults to ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>biffquote</i></dt>
  <dd class="It-tag">Controls whether the leading attribution line introducing a
      trimmed quotation should be part of the biff message or not. When turned
      OFF, the attribution line is trimmed along and this is reported in the
      trimming message, when <i>bifftrim</i> is ON. (optional, defaults to
    ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>bifftrim</i></dt>
  <dd class="It-tag">Controls whether trimmed lines within the biff message
      should be replaced by a message stating how many of them were trimmed.
      Only used by the %-T biffing macro. When turned OFF, it automatically
      turns off <i>biffquote</i> as well. (optional, defaults to ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>bifftrlen</i></dt>
  <dd class="It-tag">States how many lines long a leading quotation should be
      before performing any trimming. Only used by the %-T biffing macro.
      (optional, defaults to 2).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>callout</i></dt>
  <dd class="It-tag">The name of the callout queue file where batched jobs are
      kept. This parameter must be defined when using the AFTER command.
      (suggested: $spool/callout)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>cleanlaps</i></dt>
  <dd class="It-tag">Cleaning period for database entries. The value of the last
      clean up is saved into the context file. This is optional, but needed if
      <i>autoclean</i> is on. (suggested: 1M)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>comfile</i></dt>
  <dd class="It-tag">Name of the file containing authorized commands. Needed
      when PROCESS is used. (suggested: $spool/commands).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>compress</i></dt>
  <dd class="It-tag">Name of the file containing the list of compressed folders.
      See section about folder compression. This is an optional parameter.
      (suggested: ~/.compress).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>compspecs</i></dt>
  <dd class="It-tag">Name of the file containing specifications for how to
      handle different types of compression formats. See section about folder
      compression. This is an optional parameter. (suggested:
      $spool/compressors).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>comptag</i></dt>
  <dd class="It-tag">The default compression tag when creating new folders. If
      not specified, the default is 'gzip'.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>comserver</i></dt>
  <dd class="It-tag">Name of the file containing authorized SERVER commands and
      their definition. This is an optional parameter if you don't plan to use
      the generic mail server. (suggested: $spool/server).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>context</i></dt>
  <dd class="It-tag">File holding the mailagent context. The context saves some
      variables which need to be kept over the life of the process. Needed if
      auto cleaning is activated. (suggested: $spool/context)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>distlist</i></dt>
  <dd class="It-tag">A list of all the available distributions. See the sample
      held in <i>Lib/mailagent/distribs</i>. Needed by PROCESS only. (suggested:
      $spool/distribs)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>domain</i></dt>
  <dd class="It-tag">Your domain name, without the leading dot, as in
      <i>example.com</i>. The value is appended to the value of <i>email</i>
      when that variable does not have any '@', to construct a fully qualified
      e-mail address. See also the <i>hidenet</i> variable. (optional, defaults
      to the domain name determined at build time).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>email</i></dt>
  <dd class="It-tag">Your electronic mail address. If left unspecified,
      mailagent will try to guess it. This address is used by mailagent when
      trying to send something to the user (you!). (suggested: specify your
      e-mail address).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>emergdir</i></dt>
  <dd class="It-tag">Name of the directory which should be used for dumps,
      preferably. This is optional. (suggested: ~/tmp/lost+mail)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>execsafe</i></dt>
  <dd class="It-tag">Whether to be strict before using <i>exec()</i> to launch a
      new process or not. The value of this variable is used in place of
      <i>secure</i> when checking executable files. (defaults to OFF, suggested:
      ON if possible).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>execskip</i></dt>
  <dd class="It-tag">Whether to skip the <i>exec()</i> security checks
      alltogether. Don't turn this ON unless you really trust all the users
      having access to your machine or file server. (optional, default to OFF,
      suggested: OFF).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>fromall</i></dt>
  <dd class="It-tag">Whether or not <i>mailagent</i> should escape all the
      <i>From</i> lines in the message, not only those it thinks should appear
      dangerous (i.e. a <i>From</i> after a blank line). This option only makes
      sense when <i>fromesc</i> is also activated. It is ignored otherwise, and
      therefore is optional. By default, it is assumed to be OFF. (suggested:
      OFF, until you have reasons to believe your mail user-agent is confused in
      this mode: when it happens, your user agent will split mail for no
      apparent reason).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>fromesc</i></dt>
  <dd class="It-tag">Whether or not <i>mailagent</i> should escape potentially
      dangerous <i>From</i> lines in mail messages. If you use MH or if your
      mail reader does not use those lines to separate messages, then you may
      set it to OFF. (suggested: ON)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>fromfake</i></dt>
  <dd class="It-tag">Whether or not <i>mailagent</i> should fake a From: line
      into the message header when it is absent. Naturally, it requires a valid
      leading From line to operate! (optional, defaults to ON, suggested:
    ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>groupsafe</i></dt>
  <dd class="It-tag">If turned OFF, then group-writable files will be managed as
      if they were secure, from a security point of view. Leave it to ON if
      possible, or you may pass by a huge security hole without your noticing
      (optional, defaults to ON, suggested: ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>hash</i></dt>
  <dd class="It-tag">The directory used for name hashing by the built-in
      database used by ONCE, UNIQUE and RECORD commands. Optional, unless you
      make use of those commands or activate auto cleaning. The directory is
      placed in the spool area. (suggested: $spool/dbr).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>helpdir</i></dt>
  <dd class="It-tag">Directory where help files for SERVER commands are kept.
      (suggested: $spool/help)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>hidenet</i></dt>
  <dd class="It-tag">When set to ON, the value of the variable <i>domain</i> is
      the fully qualified name used. When OFF, the hostname is prepended to the
      <i>domain</i>. If the hostname is already fully qualified, then the value
      of <i>domain</i> is ignored. Assuuming <i>domain</i> is set to
      <i>example.com</i> and the hostname is <i>host</i>, then the fully
      qualified name will be <i>host.example.com</i> if <i>hidenet</i> is OFF,
      and <i>example.com</i> if ON. (optional, defaults to whatever was
      determined at build time)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>home</i></dt>
  <dd class="It-tag">Defines where the home directory is. This must be
    accurate.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>level</i></dt>
  <dd class="It-tag">Log level, see below for a definition of available levels
      (suggested: 9).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>linkdirs</i></dt>
  <dd class="It-tag">When set to ON, carefully checks symbolic links to
      directories when performing security checks on sensitive files. This will
      (recursively) check for each symbolic link level that the target directory
      is not world writable or group writable and that the parent directory of
      each target link is not world writable. If the <i>secure</i> option is
      OFF, this parameter is ignored. (optional, defaults to: ON, suggested: ON
      when secure is also ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>lockdekay</i></dt>
  <dd class="It-tag">The delay in seconds between two locking attempts.
      (optional, defaults to: 2).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>lockhold</i></dt>
  <dd class="It-tag">The maximum delay in seconds for holding a lock. After that
      time, the lock will be broken. (optional, defaults to: 3600).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>lockmax</i></dt>
  <dd class="It-tag">Maximum number of locking attempts before giving up.
      (optional, defaults to: 20).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>locksafe</i></dt>
  <dd class="It-tag">When locking a file, <i>mailagent</i> normally makes
      <i>lockmax</i> attempts separated by <i>lockdelay</i> seconds, and then
      gives up. When facing a delivery to a mailbox, it may make sense to
      continue even if no lock was grabbed, or even if only a partial locking
      was done (e.g. one of the .lock or flock()-style locking succeeded). This
      variable controls how safe you want to be. Set it to OFF to let mailagent
      continue its mailbox delivery even though no locking was done, to ON if
      you want strict locking, to PARTIAL if you can live with partial locking.
      Messages not saved in a folder are dumped to an emergency mailbox.
      (optional, defaults to ON). On Debian systems, since <i>mailagent</i> can
      not grab locks,it should always be left ON, or else mail garbling may
      occur. See <i>/usr/share/doc/mailagent/SECURITY</i> for details.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>lockwarn</i></dt>
  <dd class="It-tag">This variable controls the time after which
      <i>mailagent</i> should start emiting a warning when busy trying to
      acquire a lock. It is a comma separated list of values, in seconds. If two
      values are given, the first is the initial time threshold, the second is
      the repeat period. For instance, a value of &quot;15,60&quot; would cause
      a warning after 15 seconds, then every 60 seconds until the lock is taken
      or the locking attempt time is expired (see <i>lockmax</i> and
      <i>lockdelay</i>). If only one value is given, it is taken as being both
      the initial threshold and the period. (optional, defaults to:
    20,300).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>log</i></dt>
  <dd class="It-tag">Name of the log file which will be put in Log directory.
      (suggested: agentlog).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>logdir</i></dt>
  <dd class="It-tag">Logging directory. (suggested: ~/var/log).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>mailbox</i></dt>
  <dd class="It-tag">The name of the system mailbox file, which by default is
      the value of the <i>user</i> configuration variable. This is an optional
      parameter.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>maildrop</i></dt>
  <dd class="It-tag">Location of the system mail spool directory. If none is
      provided, then the mailagent will use the value determined by
    Configure.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>mailopt</i></dt>
  <dd class="It-tag">Options to be passed to the mailer (see <i>sendmail</i>).
      (optional, suggested: -odq -i, when using sendmail).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>maxcmds</i></dt>
  <dd class="It-tag">Maximum number of commands that are allowed to be executed
      by a SERVER command before flushing the remaining of the mail message.
      (suggested: 10).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>maxerrors</i></dt>
  <dd class="It-tag">Maximum number of errors for the SERVER command before
      flushing the remaining of the mail message. (suggested: 10).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>maxsize</i></dt>
  <dd class="It-tag">Maximum size in bytes of files before using <i>kit</i> for
      sending files. This is used by PROCESS. (suggested: 150000).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>mboxlock</i></dt>
  <dd class="It-tag">The format to be used for locking mailboxes before
      delivering to them. This string goes through a small macro substitution
      mechanism to make it more general. The file name derived after macro
      substitution is the name of the lock that will be used, given the name of
      the file that is to be locked. Available macros are: %D: the file
      directory name %f: the file name to be locked (full path) %F: the file
      base name (last path component) %p: the current process pid number %%: a
      plain % character Common locking formats are &quot;%f.lock&quot; and
      &quot;%D/.%F.lock&quot;. Of course, to be able to use this feature,
      mailagent must not have been configured to use flock()-style locking only.
      (optional, defaults to: %f.lock). This has no effect on Debian systems,
      since <i>mailagent</i> can not get a lock anyway, since it is not sgid
      mail.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>mhprofile</i></dt>
  <dd class="It-tag">The name of the MH profile to be used. This is needed only
      when attempting to save in an MH folder. If this optional parameter is not
      set, the default value <i>~/.mh_profile</i> is used.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>mmdf</i></dt>
  <dd class="It-tag">Set this to ON if you wish to be able to save mail in
      MMDF-style mailboxes. (suggested: OFF, unless you use MMDF or MH). This is
      invalid on a Debian system.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>mmdfbox</i></dt>
  <dd class="It-tag">The value of this variable only matters when <i>mmdf</i> is
      on. If set to ON, then new folders will be created as MMDF ones. This
      variable is not used when saving to an existing folder, since in that case
      the <i>mailagent</i> will automatically determine the type and save the
      message accordingly. (suggested: OFF, unless you use MMDF or wish to use
      MH's <i>mshf</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>msgprefix</i></dt>
  <dd class="It-tag">Name of the file to put in directory folders, specifying
      the message prefix to be used. Optional, defaults to
    <i>.msg_prefix</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>name</i></dt>
  <dd class="It-tag">First name of the user, used by mailagent when referring to
      you. This sets the value of the %U macro.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>newcmd</i></dt>
  <dd class="It-tag">Name of the file describing new filtering commands. See
      section <i>Extending</i> <i>Filtering Commands</i> for more details. Leave
      this optional parameter out unless you are a mailagent expert. (suggested:
      $spool/newcmd).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>newsopt</i></dt>
  <dd class="It-tag">Options to be passed to the news posting program (see
      <i>sendnews</i>). (optional, suggested: leave empty when using
    inews).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>nfslock</i></dt>
  <dd class="It-tag">Set it to ON to ensure NFS-secure locks. The difference is
      that the hostname is used in conjunction with the PID to obtain a lock.
      However, mailagent has to fork/exec to obtain that information. This is an
      optional parameter which is set to OFF by default. (suggested: OFF if you
      deliver mail from only one machine, even though it's via NFS).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>passwd</i></dt>
  <dd class="It-tag">File where SERVER power passwords are kept -- encrypted
      usually. (suggested: $powers/passwd).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>path</i></dt>
  <dd class="It-tag">Minimum path to be used by C filter program. To set a
      specific path for a machine <i>host</i>, set up a <i>p_host</i> variable.
      This will be <i>prepended</i> to the default <i>PATH</i> variable supplied
      by other programs. (suggested: /bin:/usr/bin:/usr/ucb). Note that the host
      name must be specified without any domain name appended to it (e.g. for an
      host name of <i>lyon.eiffel.com</i>, use variable <i>p_lyon</i>). If your
      host name contains an '-' in it, you must write it as a '_', since '-' is
      not a valid character for a <i>perl</i> variable name.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>perlib</i></dt>
  <dd class="It-tag">This variable may be used to change the perl search path
      for required files. Directories should be separated using a ':' character,
      just like a shell PATH. This path is prepended to the default perl search
      path. Any directory not starting with a '/' (after ~name substitution) is
      taken relatively to the mailagent private lib directory determined at
      configuration time.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>plsave</i></dt>
  <dd class="It-tag">Name of the file used to save the patchlevels for archived
      distributions. This is only used by the commands invoked via PROCESS.
      (suggested: $spool/plsave).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>powerdir</i></dt>
  <dd class="It-tag">Directory listing user clearances for SERVER powers.
      (suggested: $powers/clearance)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>powerlist</i></dt>
  <dd class="It-tag">Name of file containing SERVER power aliases. Since power
      names can be arbitrary long but some filesystems still have a 14 character
      limitation on filename length, internal aliases are created and maintained
      by mailagent. (suggested: $powers/aliases).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>powerlog</i></dt>
  <dd class="It-tag">File where SERVER power requests are logged, in addition to
      the agentlog. Since those are a security concern, it is a good idea to log
      them separately. If not defined, log them only in agentlog. (suggested:
      $logdir/powerlog).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>powers</i></dt>
  <dd class="It-tag">Directory for SERVER power administration. (suggested:
      $spool/powers)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>proglist</i></dt>
  <dd class="It-tag">A small description for the available distributions. See
      the sample held in <i>Lib/mailagent/proglist</i>. This is used by PROCESS
      only. (suggested: $spool/proglist)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>queue</i></dt>
  <dd class="It-tag">Queue directory (messages waiting to be processed).
      Required, of course. (suggested: $spool/queue)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>queuehold</i></dt>
  <dd class="It-tag">Maximum number of seconds a mail can sit in the mailagent
      queue before being actually processed. During that time, <i>mailagent</i>
      will not try to process the message even when <b>-q</b> is used.
      (optional, defaults to: 1800).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>queuelost</i></dt>
  <dd class="It-tag">Maximum number of seconds after which <i>mailagent</i>
      should flag messages still in its queue as being old. (optional, defaults
      to: 86400, i.e. a day).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>queuewait</i></dt>
  <dd class="It-tag">Time in seconds telling the C <i>filter</i> program how
      long it must wait before launching <i>mailagent</i>. (optional, defaults
      to: 60, but can be lowered to 0 if you don't want to wait to delay getting
      new messages).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>rulecache</i></dt>
  <dd class="It-tag">The name of the file used to cache the latest compiled
      rules. Since usually <i>mailagent</i> works mainly with one same rule
      file, this saves the overhead of recompiling all the rules each time.
      (optional, suggested: $spool/rulecache).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>rulemac</i></dt>
  <dd class="It-tag">Set this to ON to enable macro substitutions in rule
      patterns. (optional, defaults to: OFF).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>rules</i></dt>
  <dd class="It-tag">The name of the file holding the filtering rules (optional
      on non Debian systems, suggested: ~/.rules). On Debian systems, one must
      have a minimal rules file to prevent <i>mailagent</i> from trying to put
      messages into <i>/var/spool/mail/$USER,</i> since mailagent can't lock
      that directory to prevent mail from being garbled. This is because Debian
      policy requires all entities attempting locks on that directory to be
      <i>sgid mail,</i> and making <i>mailagent</i> sgid anything would be a
      security loophole.
    <br/>
     { SAVE incoming };
    <br/>
     is the suggested minimal rules file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>runmax</i></dt>
  <dd class="It-tag">Timeout for RUN commands and friends. (optional, defaults
      to: 3600).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>scriptcc</i></dt>
  <dd class="It-tag">Flag indicating whether a copy of the SERVER session
      transcript should be send to the user running mailagent. (suggested:
    OFF).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>secure</i></dt>
  <dd class="It-tag">When set to ON, mailagent and the C filter will perform
      extensive security checks on sensitive files. This includes checks for
      group writability, ownerships and protection testing on the directory
      where the file resides, and checks on symbolic links to directories
      (mailagent only, when linkdirs is ON too). Note that secure is assumed to
      be ON, whatever its real setting, when running as super-user. (suggested:
      ON).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>sendmail</i></dt>
  <dd class="It-tag">The name of the program used to send mail. That program
      must accept the mail message with headers on its standard input and a list
      of recipients on the command line. If not specified, will use the mailer
      chosen at configuration time (sendmail usually). The command line used to
      mail a message will be <i>sendmail mailopt address(es)</i>. (optional,
      suggested: /usr/lib/sendmail).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>sendnews</i></dt>
  <dd class="It-tag">The name of the program used to post news. That program
      must accept the news article with headers on its standard input. If not
      specified, will use the news posting program chosen at configuration time
      (inews usually). The command line used to post an article will be
      <i>sendnews -h newsopt</i>. (optional, suggested:
    /usr/local/bin/inews).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>seq</i></dt>
  <dd class="It-tag">File used to compute job numbers (suggested: .seq).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>servdir</i></dt>
  <dd class="It-tag">The directory name where shell and perl server commands are
      stored. This is the default lookup place. Optional parameter unless SERVER
      is used. (suggested: $spool/cmds).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>servshell</i></dt>
  <dd class="It-tag">This is the name of the shell used to launch SERVER shell
      commands (actually to process the wrapper file that will ultimately exec()
      the command). On some systems like HPUX 10.x, this has to be set to
      /usr/old/bin/sh to get the plain old Bourne shell, because /bin/sh is a
      braindead POSIX shell that closes file descriptors greater than 2 upon
      exec(), whereas the Bourne shell does not. (optional, suggested: /bin/sh
      unless you're on HPUX 10.x, as explained before).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>spool</i></dt>
  <dd class="It-tag">Spool directory, required (suggested:
    ~/var/mailagent).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>statfile</i></dt>
  <dd class="It-tag">File where statistics should be gathered. If no such file
      exists, no statistics will be recorded (suggested:
    $spool/mailagent.st).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>tofake</i></dt>
  <dd class="It-tag">Whether or not <i>mailagent</i> should fake a To: line into
      the message header when it is absent, which will be used for filtering
      purposes (no physical alteration of the header occur). It uses
      Alternate-To: headers if found, otherwise it assumes the message was send
      to the user and takes the value from the <i>user</i> configuration
      variable. (optional, defaults to ON, suggested: ON; turn it OFF only if
      you want to identify missing To: lines to detect SPAM).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>tome</i></dt>
  <dd class="It-tag">This optional variable may contain a comma separated list
      of alternate logins that are also valid for the user (mail aliases). This
      is used in vacation mode to check whether the mail was sent to the user or
      to a mailing list. Matching is anchored on the login name, so saying
      &quot;ro*&quot; will match both <i>root</i> and <i>rom</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>track</i></dt>
  <dd class="It-tag">Set to <i>on</i> (case insensitively), this turns on the
      <b>-t</b> option which tracks all the rule matches and the actions on
      standard output. This is optional (suggested: OFF).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>timezone</i></dt>
  <dd class="It-tag">The time zone value for environment variable TZ
    (optional).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>tmpdir</i></dt>
  <dd class="It-tag">Directory for temporary files. Required (suggested:
    /tmp).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>umask</i></dt>
  <dd class="It-tag">Default umask which is reset by <i>mailagent</i> before
      processing a message. Assumed to be decimal unless starting with '0' (for
      octal) or '0x' (for hexadecimal). The octal format is the easiest way to
      specify it nonetheless. (optional, defaults to: 077).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>user</i></dt>
  <dd class="It-tag">Login name of the user who runs mailagent. This sets the
      value of the %u macro.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>vacation</i></dt>
  <dd class="It-tag">A flag set to ON or OFF to switch the vacation mode
      accordingly.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>vacfile</i></dt>
  <dd class="It-tag">The name of the file to be sent back in vacation mode
      (suggested: ~/.vacation).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>vacfixed</i></dt>
  <dd class="It-tag">When ON, all changes to the vacation file (even locally) by
      means of the VACATION command are forbidden. This is useful if you usually
      have many customized vacation messages for different people but
      temporarily want to force one unique message (optional, defaults to:
    OFF).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>vacperiod</i></dt>
  <dd class="It-tag">The minimum time elapsed between two vacation messages to a
      given address (suggested: 1d).</dd>
</dl>
<h2 class="Ss" title="Ss" id="Available_Logging_Levels"><a class="selflink" href="#Available_Logging_Levels">Available
  Logging Levels</a></h2>
The following log levels can be used while running mailagent: 0	No logging
  1	Major problems only 2	Failed deliveries 3	Successful deliveries 4	Deferred
  messages 5	Successful filter actions 6	Unusual but benign incidents
  7	Informative messages 8	Non-delivery filter actions 9	Mail reception 12	Debug
  19	Verbose 20	Lot more verbose
<h2 class="Ss" title="Ss" id="Plugging_Mailagent"><a class="selflink" href="#Plugging_Mailagent">Plugging
  Mailagent</a></h2>
Once you have configured mailagent in a <i>~/.mailagent</i> (where <i>~</i>
  stands for your home directory), you must tell <i>sendmail</i> how to invoke
  it. This is done by setting a <i>~/.forward</i> file which looks like this
  (leading and trailing double quotes are a mandatory part of it): &quot;| exec
  /users/ram/mail/filter &gt;&gt;/users/ram/.bak 2&gt;&amp;1&quot; This will
  pipe all your mails to the <i>filter</i> program, redirecting all unusual
  messages to <i>~/.bak</i>. A sample filter shell script may be found in
  <i>Lib/mailagent</i>, as well as a C filter program. On some systems, it may
  be necessary to move the '|' character before the leading quote, but don't try
  this unless you have no other choice (i.e. only as a last resort). Also,
  apparently <b>Exim</b> takes exeption to the exec, and even perhaps to the
  redirection -- which would be a pity.
<div class="Pp"></div>
It is <i>very</i> important to redirect error messages to some file within your
  home directory. For one thing, that will get you out of trouble if strange
  things start to happen, but more to the point, it makes your <i>.forward</i>
  file unique. Older <i>sendmail</i> program, in an heroic attempt to
  &quot;optimize&quot; delivery, will silently remove duplicate recipients, and
  if a recipient has a <i>.forward</i>, its literal content is used in place of
  his e-mail address. Therefore, two local recipients with the same filtering
  string will be considered as one unique recipient and only one of them will
  get the message...
<div class="Pp"></div>
If your system does not allow shell redirection from within the .forward, you
  can use this instead (only supported by the C filter): &quot;| exec
  /users/ram/mail/filter -o /users/ram/.bak&quot; which in effect redirects
  <i>stdout</i> and <i>stderr</i> to the specified file for you, appending data
  at the end of the file. If the filter runs setuid or setgid, you will not be
  allowed to create the file, nor to append to it unless the owner of the file
  is the <i>real</i> uid invoking the program (for security reasons).
<div class="Pp"></div>
Note that the <i>.forward</i> file only pipes the mail to the <i>filter</i>
  program and does not leave any copy in the mailbox. It is up to you to decide
  in the rule file whether you want to trash the mail away or leave it in the
  mailbox.(Note that on Debian systems <i>mailagent</i> can not lock the spool
  directory, and letting it leave mail in mailbox may cause it to get garbled).
  If you do not have a rule file (i.e. you left a blank entry in your
  <i>~/.mailagent</i>, or you named a non-existent file, or your file is simply
  empty), the default action is to leave the mail in the mailbox, which is not a
  good idea for Debian machines. Please onstall a minimal rules file in any
  case,
<br/>
 { SAVE incoming };
<br/>
 is the suggested minimal rules file.
<h2 class="Ss" title="Ss" id="Allowed_Commands"><a class="selflink" href="#Allowed_Commands">Allowed
  Commands</a></h2>
The allowed command file (as specified by the <i>comfile</i> variable in your
  <i>~/.mailagent</i>) contains all the recognized and allowed commands. The
  file <i>commands</i> held in directory <i>Lib/mailagent</i> should be copied
  as-is into your Spool directory.
<h2 class="Ss" title="Ss" id="Testing_Your_Installation"><a class="selflink" href="#Testing_Your_Installation">Testing
  Your Installation</a></h2>
Now, assuming you have set a proper <i>~/.mailagent</i> file and edited the
  configuration section of the <i>filter</i>, it is time to test your
  installation. Make sure your <i>.forward</i> is world readable and that the
  <i>filter</i> has the execution bits set (there is no reason to make the
  <i>filter</i> world readable). Set a log-level of 20 and disable vacation mode
  (the <i>vacation</i> entry in the <i>~/.mailagent</i> should be OFF). Set the
  name of the rule file to an file containing a catch-all rule:
<br/>
 { SAVE incoming };
<br/>
 You are ready to proceed...
<div class="Pp"></div>
Send yourself a mail and give mailagent time to process your mail. The subject
  of the message should be 'test' (in fact, anything but 'Command'). You may
  want to run a &quot; <i>tail -f logfile</i>&quot; to see what's happening. At
  the end of the processing, the logfile should contain something like the
  following (names of temporaries may -and will- of course differ; timestamps
  have been removed): got the right to process mail building default rules
  parsing mail analyzing mail in mode 'INITIAL' for ALL selector 'All' on
  '&lt;1,-&gt;', pattern '/^Subject: [Cc]ommand/' matching '/^Subject:
  [Cc]ommand/' on 'All' (&lt;1,-&gt;) was false selector 'All' on '&lt;1,-&gt;'
  matching . on 'All' (&lt;1,-&gt;) was true saving in folder incoming XEQ
  (LEAVE) starting LEAVE starting SAVE /home/ram/mail/incoming SAVED [qm7831] in
  folder incoming FILTERED [qm7831] from ram (Raphael Manfredi) mailagent
  continues mailagent exits
<div class="Pp"></div>
If you do not get that, there is a problem somewhere. Start by looking at the
  <i>~/.bak</i> file (or whatever file the <i>.forward</i> uses to redirect
  output of the filter). If you see something like: FATAL no valid queue
  directory DUMPED in ~/mbox.filter then it means the <i>queue</i> parameter in
  your <i>~/.mailagent</i> does not point to a valid directory. Your mail has
  been dumped in an emergency mailbox.
<div class="Pp"></div>
The <i>~/.bak</i> file may also contain error messages stating that <i>perl</i>
  was not found. In that case, there should be an error message in the logfile:
  ERROR mailagent failed, [qm7886] left in queue In that case, make sure the
  mail has correctly been queued in a file <i>qm7886</i>. The queue will be
  processed again when another mail arrives or when the <i>mailagent</i> is
  invoked with <b>-q</b> (however, to avoid race conditions, only mails which
  have remained for a while will be processed).
<div class="Pp"></div>
Queuing of mail also happens when another <i>mailagent</i> is running. If the
  logfile says: denied right to process mail then remove the <i>perl.lock</i>
  file in the Spool directory. Old lock files are automatically discarded by the
  <i>mailagent</i> anyway (after one hour).
<div class="Pp"></div>
If none of these occurs, then maybe <i>sendmail</i> did not process your
  <i>~/.forward</i> at all or the file has a syntax error. Check your mailbox,
  and if your mail is in there, your <i>.forward</i> has not been processed.
  Otherwise, ask your system administrator to check <i>sendmail</i>'s logfile. A
  correct entry would appear as (with leading timestamps and syslog stamps
  removed): message-id=&lt;9202041919.AA07882@york.eiffel.com&gt; from=ram,
  size=395, class=0, received from local to=&quot;| /york/ram/mail/filter
  &gt;&gt;/york/ram/.bak 2&gt;&amp;1&quot;, delay=00:00:05, stat=Sent
<div class="Pp"></div>
If you still cannot find why the mail was not correctly processed, you should
  make sure you normally receive mail by removing (or renaming) your
  <i>~/.forward</i> and sending yourself another test mail. Also make sure your
  home directory is world readable and &quot;executable&quot;.
<div class="Pp"></div>
If you are using the C filter, make sure it is running on the right platform.
  There may be a low-level routing of all your mail to a <i>mailhost</i>
  machine, responsible for the final delivery, and the filter program will run
  on that machine, which may be a different platform than the one you compiled
  filter on. Also make sure your home directory is mounted on that machine, or
  the mail transport agent will be unable to locate your <i>.forward</i> file,
  less process it.
<div class="Pp"></div>
This kind of centralized mail delivery is good only when a few people have mail
  processing hooks (i.e. <i>.forward</i> files piping mail to a program);
  otherwise it's better to route mail to each user's workstation or machine, for
  local processing, to avoid an excessive workload on the <i>mailhost</i>
  machine, especially if it is a dedicated NFS server. If you are a system
  administrator installing <i>mailagent</i> and expect many people to use it,
  keep this in mind.
<h1 class="Sh" title="Sh" id="OPTIONS"><a class="selflink" href="#OPTIONS">OPTIONS</a></h1>
There is a limited set of options which may be used when calling the mailagent
  directly. Only one special option at a time may be specified. Invoking
  mailagent as <i>mailqueue</i> is equivalent to using the <b>-l</b> option.
<dl class="Bl-tag">
  <dt class="It-tag"><b>-c<i> file</i></b></dt>
  <dd class="It-tag">Specify an alternate configuration file (~ substitution
      occurs). The default is <i>~/.mailagent</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-d</b></dt>
  <dd class="It-tag">The mailagent parses the rule file, compiles the rules and
      dumps them on the standard output. This option is mainly used to check the
      syntax of the rule file and make sure the rules are what the user really
      thinks they are.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-e</b><i> rule</i></dt>
  <dd class="It-tag">This option lets you specify some rules on the command
      line, which will override those specified via the ~/.mailagent, if any.
      There may be as many <b>-e</b> as necessary, all the rules being
      concatenated together as one happy array, which is then parsed the same
      way a rule file is. If only <b>one</b> rule is given and there is no
      action specified between {...} braces, then the whole line is enclosed
      between braces. Hence saying <i>-e 'SAVE foo'</i> will be understood as
      <i>-e '{SAVE foo}'</i>, which will always match and be executed. Using the
      <b>-d</b> option in conjunction with this one is a convenient way to debug
      a set of rules.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-f</b><i> mailfile</i></dt>
  <dd class="It-tag">Using <i>mailfile</i> as a UNIX-style mailbox (i.e. one
      where each mail is preceded by a special From line stating the sender and
      the date the message was issued), extract all its messages into the queue
      and process them as if they were freshly arrived from the mail delivery
      subsystem.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-F</b></dt>
  <dd class="It-tag">Force processing on already seen messages. Usually,
      <i>mailagent</i> enters the special <i>_SEEN_</i> state when it detects an
      <i>X-Filter:</i> line issued by itself, but this option will have it
      continue as usual (although vacation messages are disabled). Use this
      option when post-processing mail already filtered. Also look at the
      <b>-U</b> switch if you are using the RECORD or UNIQUE actions in some
      rules.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-h</b></dt>
  <dd class="It-tag">Print out a usage message on the standard error and
    exit.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-i</b></dt>
  <dd class="It-tag">Interactive mode, directs mailagent to print a copy of all
      the log messages on <i>stderr</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-I</b></dt>
  <dd class="It-tag">Install a <i>~/.mailagent</i> file from template, or merge
      new configuration variables into an existing file; then perform sanity
      checks and create mandatory files or directories. This option may be
      viewed as an help into setting up <i>mailagent</i>'s environment. In any
      case, the created/merged <i>~/.mailagent</i> file should be manually
      verified before letting <i>mailagent</i> deal with your mail by hooking it
      into <i>~/.forward</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-l</b></dt>
  <dd class="It-tag">List the mailagent queue. Recently queued mails which are
      waited for by the <i>filter</i> are <i>skipped</i> for about half an hour,
      to avoid race conditions. This may be configured via the <i>queuehold</i>
      variable. Really old messages (more than <i>queuelost</i> seconds old) are
      flagged with a '#' character. Messages out of the queue ( <i>queue</i>
      variable) are flagged with a '*', whilst old messages out of the queue are
      signaled by an '@'. Locked messages have a '*' appended to their
    status.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-L<i> level</i></b></dt>
  <dd class="It-tag">Override the log level specified in the configuration
    file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-o<i> override</i></b></dt>
  <dd class="It-tag">This option lets you override a specific configuration
      option. The option must be followed by a valid configuration line, which
      will be parsed after the configuration file itself. For instance, the
      <i>-L 4</i> option is completely equivalent to <i>-o 'level: 4'</i>. Note
      that any white space must be protected against shell interpretation by
      using the appropriate quoting mechanism. There may be as many <b>-o</b>
      options on the command line as necessary.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-q</b></dt>
  <dd class="It-tag">Force processing of mailagent's queue. Only the mails not
      tagged as <i>skipped</i> by the <b>-l</b> option will be processed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-r<i> file</i></b></dt>
  <dd class="It-tag">Specify an alternate rule file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-s {umaryt}</b></dt>
  <dd class="It-tag">Build a summary of all the statistics gathered so far. The
      output can be controlled by appending one or more letters from the set
      {umaryt}. Using <b>-summary</b> is a convenient way to get the whole
      history of the filter actions. The <b>u</b> modifier will print only used
      rules. The <b>m</b> will merge all the statistics at the end while
      <b>a</b> reports the mode the filter was in when the command was executed.
      The <b>r</b> asks for rule-based statistics and the <b>y</b> is pretty
      useless and is here only to get a nice mnemonic option. Note that
      specifying an option more than once has no effect whatsoever on the option
      itself (i.e. you may put three <b>Uu</b> and only one <b>m</b>, but you'll
      still get the summary!). The <b>t</b> letter may be followed by digits
      specifying how many rule file versions relative to the topmost (most
      recent) rule file we should extract from the statistics, that amount
      defaulting to 1: using <b>-surat</b> will print a complete statistics
      report for the last version of your rules, while <b>-surt12a</b> would do
      the same for the last twelve versions of those same rules.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-t</b></dt>
  <dd class="It-tag">Put mailagent in a special tracking mode where all the rule
      matches and executed actions are printed on the standard output. This is
      mostly useful for debugging a rule file. See also the <i>track</i>
      parameter in the configuration file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-V</b></dt>
  <dd class="It-tag">Print version number and exit.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>-U</b></dt>
  <dd class="It-tag">Prevent the UNIQUE and RECORD commands from rejecting an
      already processed Message-ID the first time they are run on a given
      message. This is useful when processing messages that have been dropped in
      the <i>emergdir</i> directory due to some abnormal (but transient)
      condition and you wish to reprocess the message. Also see the <b>-F</b>
      switch if you are re-processing messages.</dd>
</dl>
<div class="Pp"></div>
If you invoke mailagent without options and without any arguments, the program
  waits for a mail on its standard input. If an argument is provided, it is the
  name of a file holding one mail to be processed. This is the normal calling
  procedure from the filter, the argument being the location of the queued mail.
<h1 class="Sh" title="Sh" id="USING_THE_DEFAULT_RULES"><a class="selflink" href="#USING_THE_DEFAULT_RULES">USING
  THE DEFAULT RULES</a></h1>
If you do not want to use the filtering feature of mailagent, <b>(NOTE:</b> This
  may cause mail to be garbled on Debian systems, since <i>mailagent</i> can not
  lock the spol directory under Debian policy restrictions) then the default
  built-in rules will be used. Those are really simple: all the mails are left
  in your mailbox and mails with a line &quot;Subject: Command&quot; anywhere in
  the message will be processed. Commands are looked for on lines starting with
  &quot;@SH&quot;. The remaining of the line is then given to a shell for
  execution.
<div class="Pp"></div>
Available commands are read from a file (entry <i>comfile</i> in your
  configuration file), one command name per line. Only those listed there will
  be executed, others will produce an error message. The mailagent traps the
  exit status and will send an error report if a command fails (provided that
  the command does not issue a message by itself, in which case it should return
  a zero exit status).
<div class="Pp"></div>
If you do not want to use the default rules, you may skip the remaining of this
  section.
<h2 class="Ss" title="Ss" id="Configuring_Help"><a class="selflink" href="#Configuring_Help">Configuring
  Help</a></h2>
The help text mailagent will send to people must be copied from
  <i>Lib/mailagent/agenthelp</i> into your own spool directory, as specified in
  your <i>~/.mailagent</i>. Two macros may be used:
<dl class="Bl-tag">
  <dt class="It-tag"><i>=DEST=</i></dt>
  <dd class="It-tag">This will be expanded to the sender's address (the one who
      sent you the mail currently processed by mailagent).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>=MAXSIZE=</i></dt>
  <dd class="It-tag">This stands for the maximum size set before <i>kit</i> is
      used to send files back (parameter <i>maxsize</i> in your
      <i>~/.mailagent</i> file).</dd>
</dl>
<div class="Pp"></div>
You may use the default help file or design one that will give even more details
  to the poor user.
<h2 class="Ss" title="Ss" id="Distribution_Files"><a class="selflink" href="#Distribution_Files">Distribution
  Files</a></h2>
The two files <i>proglist</i> and <i>distribs</i> held in <i>Lib/mailagent</i>
  describe the distributions your mailagent will be able to distribute. The
  samples given show the expected syntax. In order to clarify things, here is
  what the format should be:
<div class="Pp"></div>
File <i>proglist</i> contains a small description for programs. The name of the
  program appears after a single star. It is followed by lines in free format.
  An optional three-dashes line separates each program's description. Note that
  a leading tab will be added to each line of description.
<div class="Pp"></div>
The <i>distribs</i> file holds lines of the following form: <i>progname version
  path archived compressed patches</i> where:
<dl class="Bl-tag">
  <dt class="It-tag"><i>progname</i></dt>
  <dd class="It-tag">is the program name (the same as the one mentioned in
      <i>proglist</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>version</i></dt>
  <dd class="It-tag">is the current version number. If none, a three-dashed line
      may be used.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>path</i></dt>
  <dd class="It-tag">is the path where the distribution is stored. The ~ will be
      expanded into your home directory. Note that if the distribution is stored
      in archived form, the path name is the one of the archive without the
      ending extension (which may be <i>.cpio.Z</i> or <i>.tar.Z</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>archived</i></dt>
  <dd class="It-tag">is either <i>y</i> or <i>n</i> depending on whether the
      distribution is archived or not.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>compressed</i></dt>
  <dd class="It-tag">is either <i>y</i> or <i>n</i> depending on whether the
      distribution is compressed or not. This could be guessed from the
      extension's name, but we must think of file systems with short names.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>patches</i></dt>
  <dd class="It-tag">is <i>y</i> or <i>n</i> depending on whether the
      distribution is maintained or not by you. If you put a <i>p</i>, this
      means official patches are available, although you do not maintain the
      distribution. Finally, an <i>o</i> means that this is an old version,
      where only patches are available, but maildist will not work. In that
      case, assuming the version number is <i>1.0</i>, old patches are expected
      in a <i>bugs-1.0</i> directory.</dd>
</dl>
<div class="Pp"></div>
You may include comments in both files: all lines starting with a leading # will
  be ignored.
<h2 class="Ss" title="Ss" id="Testing_Your_Mail_Agent"><a class="selflink" href="#Testing_Your_Mail_Agent">Testing
  Your Mail Agent</a></h2>
It is now time to make sure your mailagent works. Send yourself the following
  mail: Subject: Command @SH mailhelp You should receive back a mail from
  yourself with the subject set to: &quot;How to use my mailagent&quot;. If you
  don't, check the file <i>~/.bak</i> (or whatever file you set in your
  <i>.forward</i>). If it is empty, look at the log file. If the log file is not
  empty, then perhaps the mail has been queued. Check the <i>sendmail</i> queue.
  Also make sure that you removed the '#' comments in the <i>filter</i> script.
  On some systems, they cause some trouble. If you are using the C filter, maybe
  your sendmail is broken and you need to make your own setuid copy (or perl
  might complain that you have a kernel bug, etc...).
<div class="Pp"></div>
If you have done everything right but it still does not work properly, increase
  log level to 20 and resend your command mail. Then check the log file. The
  diagnosis should be easier.
<div class="Pp"></div>
Once this works, you should check your <i>distribs</i> and <i>proglist</i> files
  by sending yourself the following mail: Subject: Command @SH maillist If the
  list you have in return is incorrect, then your distribution files are wrongly
  written. If you do not get the list, there is a problem with your mailagent's
  configuration. Retry with a log level set to 20 and look at the issued log
  messages in your Log directory. Make sure that the file listed in the
  <i>plsave</i> entry of your <i>~/.mailagent</i> is correctly updated after a
  <i>maillist</i> has been run.
<h1 class="Sh" title="Sh" id="USING_THE_FILTER"><a class="selflink" href="#USING_THE_FILTER">USING
  THE FILTER</a></h1>
The <i>mailagent</i> can also be used as a filter: mail is parsed and some
  actions are taken based on simple <i>lex</i>-like rules. Actions range from a
  simple saving in a folder, a forwarding to another person, or even spawning of
  a shell command. Before going further, here is a small example of a valid rule
  file: From: root { FORWARD postmaster }; To: gue@eiffel.fr { POST mail.gue };
  Subject: /metaconfig/ { SAVE dist }; { SAVE incoming }; There are three
  distinct rules. Rules are applied in sequence, until one matches (so the order
  is important). Any mail coming from <i>root</i> will be forwarded to user
  <i>postmaster</i>. A mail addressed to <i>gue@eiffel.fr</i> is a mail coming
  from a mailing list. The mail is posted on a local newsgroup <i>mail.gue</i>.
  Mails whose subject contains the word &quot;metaconfig&quot; will be saved in
  a folder <i>dist</i> for delayed reading and will not appear in the main
  mailbox. If no rule matched, the mail is left in the folder incoming.
<h2 class="Ss" title="Ss" id="Rule_File_Syntax"><a class="selflink" href="#Rule_File_Syntax">Rule
  File Syntax</a></h2>
Here is a non-formal description of the rule file. Parsing of the file is done
  lexically, hence the choice of non-ambiguous tokens like '{' or ';' which are
  easily parsed. This introduces some limitations which are silently applied:
  for instance, no '{' may be used as part of an address.
<div class="Pp"></div>
Comments are introduced by a leading '#' , which must be on the left margin.
  Unlike shell comments, a '#' which is not left justified will not be
  understood as a comment. However, spaces or tabs are allowed in front of '#'.
<div class="Pp"></div>
All the statements in the rule file must end with a ';'. There are mainly four
  parts in each line. A list of comma separated modes, between '&lt;' and
  '&gt;', which give the set of modes in which the rule applies. The special
  mode ALL will match everything. The filter begins in the mode INITIAL.
  Omitting the mode defaults to &quot;&lt;ALL&gt;&quot;. It is possible to guard
  a rule against some specific mode by negating it, which is done by prefixing
  the mode with '!'. Negated modes take precedence other plain modes, meaning
  &quot;&lt;!ALL&gt;&quot; will never be matched, ever, and that &quot;&lt;MODE,
  !MODE&gt;&quot; is equivalent to &quot;&lt;!MODE&gt;&quot;.
<div class="Pp"></div>
Then comes a list of selectors. Those selectors must be space separated and end
  with ':'. They represent the names of header fields which must be looked at by
  the forthcoming pattern. An empty selector list defaults to
  &quot;Subject:&quot;. Special selectors &quot;All:&quot;, &quot;Body:&quot;
  and &quot;Head:&quot; apply to the whole message, its body or its header. A
  commonly used selector list is &quot;To Cc:&quot; which tests the recipient
  fields of the header. If the selector name is preceded by an exclamation mark
  '!', then the logical value of the test for that selector is negated.
<div class="Pp"></div>
The list of selectors may end with an optional range specification, given as
  <i>&lt;min, max&gt;</i>, before the final ':' character marking the end of the
  selector list. The minimum or the maximum may be given as '-', in which case
  it is replaced with the minimal or maximal possible value. Indices for
  selection begin at 1 (not 0), for instance: <i>&lt;3, 7&gt;</i>. If no range
  selection is given, then the default <i>&lt;1, -&gt;</i> is used. Ranges
  normally select lines within the matching buffer, unless the selector is
  expecting a list in which case it operates on the list items. For instance,
  <i>Body &lt;3, 5&gt;:</i> would select lines #3 to #5 (included) from the mail
  body, whereas <i>To Cc &lt;1,3&gt;:</i> would focus on the first three
  addresses on each To: or Cc: header lines. Negative values refer to that many
  lines or addresses back from the end, i.e. <i>Cc &lt;-2,-&gt;:</i> selects the
  last two addresses on the Cc: line. A single number such as <i>&lt;2&gt;</i>
  is understood as <i>&lt;2, 2&gt;</i>, i.e. it select only one item in the
  list, <i>&lt;-&gt;</i> meaning everything (and being therefore redundant).
<div class="Pp"></div>
The selector is then followed by a pattern within '/' or by a single name. In
  order to ease the writing of the rules, the semantic of a single name varies
  depending on the selector used. For the special selectors &quot;From:&quot;,
  &quot;To:&quot;, &quot;Cc:&quot;, &quot;Sender:&quot;, their associated
  &quot;Resent-&quot; fields, &quot;Reply-To:&quot;, &quot;Envelope:&quot; and
  &quot;Apparently-To:&quot;, a single name is understood as a match on the
  <i>login</i> <i>name</i> of the address. Note that if no &quot;To:&quot; field
  is present in the header, one will be forged from the
  &quot;Apparently-To:&quot; for the purpose of filtering only (i.e. no physical
  modification on the header is done). If the login name of the address is a
  full name of the form First.Last, only the last name is kept, and is
  lower-cased. If only a single name is given, only shell metacharacters * and ?
  are allowed, as well as intervals [].
<div class="Pp"></div>
If the pattern is preceded by a single exclamation mark '!', then the matching
  status is negated (i.e. it will succeed if the pattern is not found). If a
  single word is used for non-special selectors, the same rules apply but the
  pattern is anchored at the beginning and the end for an exact match. With a
  pattern starting with '/', any regular expression understood by <i>perl</i>
  may be used and your pattern will not be modified in any way. The other
  special selector &quot;Newsgroups:&quot; works as &quot;To:&quot;, excepted
  that newsgroups names are expected and a match is attempted on every item in
  the list. Every pattern match on a single name for an address-type field (i.e.
  &quot;Newsgroups:&quot; excluded), are made in case-insensitive mode.
  Otherwise, you can force a case-insensitive match by appending a trailing
  <i>i</i> option, as in <i>/pattern/i</i>.
<div class="Pp"></div>
There is also a little magic involved when matching on an address field. Namely,
  if the pattern is not a single word and is <i>anchored at the beginning</i>,
  then only the address part of the field will be kept. For instance, if we have
  a From: field whose value is <i>Raphael Manfredi &lt;ram@eiffel.com&gt;</i>,
  then the pattern <i>/Raphael/</i> would match, but not <i>/^Raphael/</i>.
  Instead, <i>/^ram@.*$/</i> would match, but this is more easily done with a
  single word pattern <i>ram</i>, for it only focuses on the login name of the
  address and would also match if the address was written as
  <i>eiffel.com!ram</i>. A single address in Internet form, as in
  <i>ram@eiffel.com</i> is implicitely matching on the address part of the
  field, and you must not escape the '.' as you would have to in a regular
  expression.
<div class="Pp"></div>
This may sound a little complex, but this design is meant to make things easier
  for the user. Here are some other examples: # Match <i>ram@eiffel.com</i> as
  well as <i>ram@educ.emse.fr</i>. From: ram
<div style="height: 1.00em;">&#x00A0;</div>
# Match <i>root@eiffel.com</i>, <i>ram</i> but not <i>ribbon@eiffel.com</i>
  From: r[oa]*
<div style="height: 1.00em;">&#x00A0;</div>
# Match <i>gue@eiffel.fr</i> but not <i>algue@eiffel.fr</i> To Cc:
  /^gue@eiffel\.fr/
<div style="height: 1.00em;">&#x00A0;</div>
# This will match <i>gue@eiffel.fr</i> as well as <i>algue@eiffel.com</i> To Cc:
  /gue@eiffel/
<div style="height: 1.00em;">&#x00A0;</div>
# Match <i>comp.lang.perl</i> but not <i>comp.lang.perl.poetry</i> (?)
  Newsgroups: comp.lang.perl
<div style="height: 1.00em;">&#x00A0;</div>
# Accept anything but messages coming from <i>root</i> From: !root When
  attempting a match on &quot;To:&quot;, &quot;Cc:&quot; or
  &quot;Apparently-To:&quot;, a list of addresses separated by a comma is
  expected, whereas only one address is expected after &quot;From:&quot;. If you
  omit the pattern, it will be understood as * (recall that a single word uses
  shell meta-characters), which will match anything.
<div class="Pp"></div>
Then comes the action to be taken when a match occurs. There are only a limited
  set of valid actions which will be described soon in detail. The action is
  enclosed in curly braces '{' and '}' and actions are separated or terminated
  (depending on your taste) by a ';'. Action names are spelled in upper-case for
  readability, but case is irrelevant. If you want to put a ';' within the rule,
  it must be escaped by preceding it with a backslash. A double backslash is
  translated into a single one, and any other escape sequence involving the
  backslash character is ignored (i.e. \n would be kept verbatim).
<div class="Pp"></div>
Note that a rule should be ended by a single ';' after the last '}'. It is
  possible to omit this final ';', but that single token is the re-synchronizing
  point for error recovery. One could argue however that there should be no
  syntax error, and thus the ';' ought to be safely omitted. Whenever in doubt,
  check your rule file with the <b>-d</b> option.
<div class="Pp"></div>
Here is a prototypical rule (using <i>perl</i> regular expressions; please refer
  to the subsection <b>Regular Expressions</b> for more information):
  &lt;ROOT&gt; From: /^\w+@eiffel.com$/ { SAVE eiffel }; That rule will only be
  taken into account when the filter is in the mode ROOT (recall that the
  processing starts in mode INITIAL; use BEGIN to change the mode, as in
  <i>lex</i>). So in mode ROOT, anything which comes from a user located in the
  <i>eiffel.com</i> site is saved in folder <i>eiffel</i> for deferred reading.
  The mail will not appear in the mailbox.
<div class="Pp"></div>
It is possible to have more than one selection for a rule. Identical selectors
  are logically <i>or</i>'ed while different ones are <i>and</i>'ed. The
  selections are comma separated. For instance, From: root, To: ram, From: ram,
  Subject: /\btest\b/ { DELETE }; will delete a mail from <i>root</i> or
  <i>ram</i> if it is sent to <i>ram</i> and has the word <i>test</i> in its
  subject. It is also possible to write the previous rule as: From: root, ram,
  To: ram, Subject: /\btest\b/ { DELETE }; because if no selector is given, the
  previous one is used (with the first selector being &quot;Subject:&quot; by
  default).
<div class="Pp"></div>
Anywhere in the rule file, it is possible to define some variables. The list of
  recognized variables is given later. For now, let's say that <i>maildir</i> is
  the default folder directory. This variable is used by the SAVE command when
  the argument is not an absolute path. Setting maildir = ~/mail; will direct
  the filter to use <i>~/mail</i> as the folder directory (default is
  <i>~/Mail</i>). Note the ~ substitution and the final ';'. It is not possible
  (currently) to modify the environment by setting PATH for instance.
<div class="Pp"></div>
Finally, there is a special construct to load patterns from a file. A pattern
  enclosed in double quotes means that the patterns to be applied should be
  taken from the specified file. The file is expected to be in the directory
  <i>mailfilter</i> if it is not an absolute path (~ substitution occurs). If
  the variable is not set <i>maildir</i> will be used. If by chance (!)
  <i>maildir</i> is not set either, the home directory is used. The file should
  contain one pattern per line, shell comments (#) being allowed at the
  beginning of each line.
<div class="Pp"></div>
An action may be followed by other rules. Hence the following is perfectly
  valid: From: 	ram		{ SAVE ram } 	/plc/i		{ SAVE plc } 	root		{ SAVE ~/admin }
  	/xyz/		{ DELETE } 	&quot;users&quot;		{ LEAVE } 	; Note the use of the file
  inclusion: all the users listed in file <i>users</i> will have their mail left
  in the system mailbox. The usual rules apply for these loaded patterns.
<h2 class="Ss" title="Ss" id="Selector_Combination"><a class="selflink" href="#Selector_Combination">Selector
  Combination</a></h2>
A single rule may have a various set of selectors. For instance, in the
  following rule: From: ram, To Cc: root, !Subject: /test/, From: raphael we
  have the following set { From, To Cc, !Subject }. The first two selectors are
  called <i>direct</i> selectors, !Subject: is called a <i>negated</i> selector.
  The To Cc: selector is a <i>group</i> selector decomposing into two
  <i>direct</i> selectors, while From: is an <i>atomic</i> selector. Finally,
  From: is also a selector with <i>multiple</i> occurrences. The <i>value</i> of
  a selector is its matching status logical value.
<div class="Pp"></div>
Let <i>D</i> be the set of direct selectors and <i>N</i> the set of negated
  selectors, which form a partition of <i>R</i>, the set of all the selectors in
  the rule. That is to say, <i>R</i> is the union of <i>D</i> and <i>N</i>, and
  <i>D</i> intersected with <i>N</i> is the empty set (trivial proof: a selector
  is either direct or negated). If either <i>D</i> or <i>N</i> is empty, then
  it's not a partition but in that case we have either <i>D</i> = <i>R</i> or
  else <i>N</i> = <i>R</i>.
<div class="Pp"></div>
Let's define the logical value of a set <i>S</i> as being the logical value the
  filter would return if those rules were actually written. Then the logical
  value of <i>D</i> is the logical value of each of its item with the AND
  logical operator distributed among them, i.e. the logical value of { a, b, c }
  is the value of (a AND b AND c). Let's write it AND( <i>D</i>). The logical
  value of each of the items is the logical value of the selector itself if it
  is not multiple, or it is the logical value of all the occurrences of the
  multiple selector within the rule, with the logical OR operation distributed
  among them. That is to say, in the above example, the value of From is true
  iff the From: fields contains <i>ram</i> OR <i>raphael</i>. Let's write that
  OR[From].
<div class="Pp"></div>
To be sound, we have to apply De Morgan's Law on <i>N</i>, hence the following
  rules: the logical value of <i>N</i> is OR(<i>N</i>) and given a negated
  selector <i>s</i>, its logical value is AND[<i>s</i>]. And finally, the
  logical value of <i>R</i> is that of <i>D</i> AND <i>N</i>, with by convention
  having the logical value of the empty set be <i>true</i>.
<div class="Pp"></div>
For those who do not know De Morgan's Law, here it is: given two logical
  propositions <i>p</i> and <i>q</i>, then the following identities occur: NOT
  (p AND q) &lt;=&gt; (NOT p) OR (NOT q) NOT (p OR q) &lt;=&gt; (NOT p) AND (NOT
  q) While we are in the logic of the propositions, note also that OR and AND
  are mutually distributive, that is to say, given three logical propositions
  <i>p</i>, <i>q</i> and <i>r</i>, we have: p AND (q OR r) &lt;=&gt; (p AND q)
  OR (p AND r) p OR (q AND r) &lt;=&gt; (p OR q) AND (p OR r) To be complete, OR
  and AND are associative with themselves and commutative. And the <i>B</i> set
  { 0, 1 } equipped with the set of operations (NOT, OR, AND) is an
  <i>algebra</i> (a Boolean one). I will spare you the definition of an algebra,
  which really has nothing to do in this manual page (which is for a mail agent,
  in case you don't remember :-).
<div class="Pp"></div>
The attentive reader will certainly have noted that I have not specified the
  logical value of a group selector. Well, given a group selector <i>G</i>, we
  decompose it into a <i>DG</i> and <i>NG</i> partition, <i>DG</i> being the
  subset of (atomic) direct selectors of <i>G</i> and <i>NG</i> being the subset
  of (atomic) negated selectors. Then the logical value of <i>DG</i> is OR(
  <i>DG</i>) and the logical value of <i>NG</i> is AND(<i>NG</i>); the global
  logical value of <i>G</i> being that of <i>DG</i> OR <i>NG</i>. In case either
  <i>DG</i> or <i>NG</i> is empty, then we don't have a partition, but by
  convention the value of the empty set is <i>false</i>, and one of the sets is
  equal to <i>G</i>. Note that within a group selector, the rules are exactly
  the dual of the rules within <i>R</i>.
<div class="Pp"></div>
Now the only rule which is not <i>logical</i> is whether a group selector
  belongs to <i>D</i> or <i>N</i>. I've chosen, for analogy reasons, to make the
  group selector belong to <i>D</i> if it does not start by '!' and to <i>N</i>
  otherwise. That is, !To Cc: belongs to <i>N</i> whilst Cc !To: belongs to
  <i>D</i>. Apart from that, order within the group selector is irrelevant: To
  Cc: is equivalent to Cc To:, so the behavior in the quotient set is sound.
<div class="Pp"></div>
Here are some examples: # Match anything: (not from ram OR not from root) is
  always true. From: !ram, !root
<div style="height: 1.00em;">&#x00A0;</div>
# Match anything but reject mails coming from ram OR root !From: ram, root
<div style="height: 1.00em;">&#x00A0;</div>
# Reject mails whose headers matching /^Re.*/ contain the word test !^Re.*:
  /\btest\b/
<div style="height: 1.00em;">&#x00A0;</div>
# Keep mails whose subject contains <i>test</i> AND <i>host</i> !Subject:
  !/test/, !/host/
<div style="height: 1.00em;">&#x00A0;</div>
# Matches if <i>ram</i> is listed in the <i>To</i> OR the <i>Cc</i> line To Cc:
  ram
<h2 class="Ss" title="Ss" id="Minimal_Header"><a class="selflink" href="#Minimal_Header">Minimal
  Header</a></h2>
A minimal set of selectors are guaranteed to be set, regardless of the actual
  header of the message. This is for the purpose of filtering only, no physical
  alteration is performed.
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>Envelope:</i></dt>
  <dd class="It-tag">This is the address found in the mail envelope, i.e. the
      address where the mail seems to originate from. This can be different from
      the <i>From:</i> address field if the mail originates from a
      <i>trusted</i> user, in sendmail's terminology. If you don't know what
      that is, simply ignore it.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>From:</i></dt>
  <dd class="It-tag">User who wrote the mail. If this line is missing, uses the
      address found in the first From line.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>Length:</i></dt>
  <dd class="It-tag">The physical length of the body, in bytes, once
      content-transfer-encoding (if any) has been removed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>Lines:</i></dt>
  <dd class="It-tag">The amount of lines in the body (decoded, if
    necessary).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>To:</i></dt>
  <dd class="It-tag">The main recipient(s) of the message. If this line is
      missing but a set of <i>Apparently-To:</i> lines is found, then those
      addresses are used instead. If no such line exists, then assume the mail
      was directed to the user (which seems a reasonable assumption :-).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>Sender:</i></dt>
  <dd class="It-tag">User who sent the mail. This may differ from the
      <i>From:</i> line. If no such field exists, then the address in the first
      From line is used (mail envelope).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>Relayed:</i></dt>
  <dd class="It-tag">This computed header is a comma-separated list of all the
      hosts where the message was relayed, in the proper transmission order.
      Each item in this list can be a machine name such as <i>mail.hp.com</i> or
      an IP address such as <i>[15.125.38.12]</i>. The list is derived from the
      <i>Received:</i> lines present in the message.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>Reply-To:</i></dt>
  <dd class="It-tag">Where any reply should be sent. If no <i>Reply-To:</i>
      field is present, then the <i>Return-Path</i> is used (with &lt;&gt;
      stripped out), or the <i>From:</i> line is parsed to extract the e-mail
      address of the author.</dd>
</dl>
<h2 class="Ss" title="Ss" id="Variables"><a class="selflink" href="#Variables">Variables</a></h2>
The mailagent supports user-defined variables, which are globals. They are set
  via the ASSIGN command and referred to with the %# macro. Assuming we set a
  variable <i>host</i>, then %#<i>host</i> would be replaced by the actual value
  of the variable. This enables some variable propagation across the rules.
<div class="Pp"></div>
For example, let's say the user receives cron outputs from various machines and
  wishes to save them on a per-machine basis, differentiating between daily
  outputs and weekly ones. Here is a solution: Subject: /output for host
  (\w+)/	{ ASSIGN host '%1'; REJECT }; Subject: /^Daily output/	{ SAVE
  %#host/daily.%D }; Subject: /^Weekly output/	{ SAVE %#host/weekly.%m-%d };
  Besides variable interpolation via the %# escape, it is also possible to
  perform substitutions and translations on the content of a variable (or a
  back-reference, i.e. a number between 1 and 99). The two commands SUBST and TR
  will respectively perform in-place substitutions and translations. In that
  case however, the name of the variable must be preceded by a single #. This
  differentiates the back-reference <i>1</i> from the variable <i>#1</i>,
  although <i>1</i> is a funny name for a variable. The need for # also prevents
  the common mistake of writing %#, as mailagent will loudly complain if the
  first parameter of SUBST or TR is not a digit between 1 and 99 or does not
  start with a #.
<div class="Pp"></div>
Here are some actions to canonicalize the host name into lower case and strip
  down the domain name, if any: { TR #host /A-Z/a-z/; SUBST #host
  /^([^.]*)\..*/$1/ }; Those actions are directly translated into their
  <i>perl</i> equivalent, and any error in the specification of the regular
  expression will be reported.
<div class="Pp"></div>
If the variable name begins with a colon ':', then the variable is made
  persistent. That is to say it will keep its value across different mailagent
  invocations. The variable is simply stored (with the leading ':' removed) in
  mailagent's database and is thus subject to the aging policy set up in the
  ~/.mailagent.
<div class="Pp"></div>
Within PERL commands or mail hooks using perl (see the MAIL HOOKS section), you
  can manipulate those (so-called) external variables via a set of interface
  functions located in the <i>extern</i> package (i.e. you must prefix each of
  the function name with its package name, <i>set</i> becoming
  <i>extern'set</i>). The following three interface functions are provided:
<dl class="Bl-tag">
  <dt class="It-tag">val(name)</dt>
  <dd class="It-tag">Return the value of the variable <i>name</i> (the leading
      ':' is not part of the name, in any of these three interface
    functions).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">set(name, value)</dt>
  <dd class="It-tag">Set the external variable <i>name</i> to hold <i>value</i>.
      No interpretation is done by the function on the actual content of the
      <i>value</i> you are providing.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">age(name)</dt>
  <dd class="It-tag">Returns the age of the variable, i.e. the elapsed time in
      seconds since the last modification made by <i>set</i>.</dd>
</dl>
<div class="Pp"></div>
There is currently no way for erasing a variable from the database. But if you
  do not use the variable any more, it will be removed when its age becomes
  greater than the maximum age specified by the <i>agemax</i> configuration
  variable.
<h2 class="Ss" title="Ss" id="Regular_Expressions"><a class="selflink" href="#Regular_Expressions">Regular
  Expressions</a></h2>
All the regular expressions follow the V8 syntax, as in <i>perl</i>, with all
  the <i>perl</i> extensions. If a bracketing construct (...) is used inside a
  rule, then the % <i>digit</i> macro matches the <i>digit</i>'s substring held
  inside the bracket. All those back-references are memorized on a per-rule
  basis, numbered from left to right. However, great care must be taken when
  using a back-reference in multiply present selectors, as all the matches will
  be performed up-to the first match, and back-references are computed on the
  fly while doing pattern matching.
<div class="Pp"></div>
For instance: To: /(.*)/, Subject: /Output from (\w+)/ { ASSIGN to '%1'; SAVE %2
  }; will save the To: field in variable 'to' and save the mail in a folder
  derived from the host name specified in the subject. However, if we say:
  Subject: /host (\w+)/, /from (\w+)/ { ASSIGN match '%1' }; then there will be
  only one back-reference set, and it will come from the first pattern matching
  if it succeeds, or from the second. Should the second or the first pattern
  have no bracketing construct and still match, then the back-reference would
  not be recorded at all, which means the following is probably not what you
  want: Subject: /from/, /host (\w+)/, To: /(.*)/ { SAVE %1; REJECT }; as if the
  /from/ pattern matches then /host (\w+)/ will not be checked (identical
  selectors are <i>or</i>'ed and that is optimized), then %1 would refer to the
  To: field whereas if /host (\w+)/ matches, then %1 will be the host name.
<div class="Pp"></div>
However, this behavior can be used to selectively store a news article which has
  been mailed to you in a folder whose name is the newsgroup name in dot form.
  Assuming we want to give priority to comp.lang.perl, we could say: Newsgroups:
  	/(comp.lang.perl)/, 	/(comp.mail.mh)/, 	/(comp.compilers)/, 	/([^,]*)/		{
  SAVE %1 }; An article cross-posted to both comp.lang.perl and comp.mail.mh
  would be saved in a comp.lang.perl folder, since this is what would match
  first. The last rules takes care of other articles: the folder used being
  whatever newsgroup appears first.
<div class="Pp"></div>
There is also a special macro %&amp;, which lists (it's a comma separated list)
  all the selectors specified via a regular expression which indeed matched. For
  instance: Re.*: /york/		{ ASSIGN which '%&amp;' }; would assign to
  <i>which</i> the list of all the fields matching the /Re.*/ pattern which
  contained 'york', be it a Received: field or a Resent-From: field (as both
  match the selector specification). Assuming both those fields contained the
  word <i>york</i>, the value of %&amp; would be 'Received,Resent-From;' (the
  fields are alphabetically sorted).
<div class="Pp"></div>
Should you have more than one such specified selector within a single rule, then
  it might be worth knowing that all the set of matching selectors are recorded
  within %&amp;, each set terminated with a ';'. If a negated selector is used,
  then %&amp; will record all the fields which did not contain the pattern,
  assuming the selection succeeded (otherwise nothing is recorded).
<h2 class="Ss" title="Ss" id="Available_Actions"><a class="selflink" href="#Available_Actions">Available
  Actions</a></h2>
The following actions are available as filtering commands. Case is irrelevant
  although the recommended style is to spell them upper-cased. As explained
  later, most of the actions record their exit status in a special variable
  which may be tested via the <b>-t</b> and <b>-f</b> options of ABORT, REJECT
  and RESTART. For every command returning such an exit status, the failure or
  success conditions are given at the end of each description. If nothing is
  specified, then the command does not return a meaningful status.
<dl class="Bl-tag">
  <dt class="It-tag">ABORT [<b>-tf</b>] [<i>mode</i>]</dt>
  <dd class="It-tag">Abort application of filtering rules immediately. See
      REJECT for the meaning of the optional parameters. (Does not modify
      existing status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">AFTER [<b>-sanc</b>] <i>(time) action</i></dt>
  <dd class="It-tag">Records a callback for after the specified <i>time</i>,
      where <i>action</i> will be performed. By default, a mailagent filtering
      action is assumed ( <b>-a</b> option), on the current mail message. A
      shell command ( <b>-c</b>) may be given instead, receiving the current
      mail message as standard input. Finally, a plain shell command may be run
      (with no input) using the <b>-s</b> option. The option <b>-n</b> may be
      used when the current mail message does not need to be kept for input. For
      instance: AFTER <b>-an</b> (1 day) DO ~/process:proc'run(%u) would call
      <i>proc'run</i> defined in the <i>~/process</i> file in one day from now,
      without giving any input (the action here does not require any).
    <div style="height: 1.00em;">&#x00A0;</div>
    When running mailagent commands, the initial working mode is set to
      _CALLOUT_. This may matter if you call APPLY for instance. If the recorded
      time is less or equal than the current time (which is <i>now</i>), the
      callback will occur when mailagent is done with the messages in its queue,
      before exiting. This allows for the following cute trick, found out by
      Randal Schwartz: AFTER (now)		# fork a copy I can mangle 	STRIP Reply-To
      \; RESYNC \; 	ANNOTATE -du Reply-To %2 \; RESYNC \; 	NOTIFY message %r \;
      DELETE \; 	; Note that the command is not called <i>AT</i> because the
      call will only be performed at the next mailagent invocation after the
      specified time has elapsed. Dates are specified using the same format as
      in SELECT. (Fails if the action cannot be recorded in the callout
    queue).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">ANNOTATE [<b>-du</b>] <i>field value</i></dt>
  <dd class="It-tag">Annotate message by adding <i>field</i> into the mail
      header, with the supplied <i>value</i>. This is like the MH command
      <i>anno</i>, but the annotation is performed at the end of the header,
      whereas MH does it at the top. Normally, an extra <i>field</i> is added,
      with the current date as field value.
    <div style="height: 1.00em;">&#x00A0;</div>
    This can be suppressed by using the <b>-d</b> option. If <i>value</i> is
      omitted, only the date field is generated (hence it is an error to use the
      <b>-d</b> option without supplying a <i>value</i>). As with all the
      commands which alter the header, a RESYNC is necessary for the filter part
      to actually see the new header.
    <div style="height: 1.00em;">&#x00A0;</div>
    The <b>-u</b> option means &quot;unique&quot;, and prevents ANNOTATE from
      executing if the specified <i>field</i> is already present in the header.
      Don't forget to RESYNC between successive ANNOTATE commands using this
      option if the <i>field</i> refers to a previous ANNOTATE target. (Fails
      when no annotation takes place)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">APPLY <i>rulefile</i></dt>
  <dd class="It-tag">Get the rules held in <i>rulefile</i> and apply them to the
      current message. The filter will begin in whatever mode you were when
      using this command, but no feed back will occur, i.e. any mode changing
      will be lost when returning from the command.
    <div style="height: 1.00em;">&#x00A0;</div>
    Variables (see the %# macro) are propagated back and forth through APPLY,
      meaning you see variables set by the caller, and you may change their
      values or create new variables for the caller to later use.
    <div style="height: 1.00em;">&#x00A0;</div>
    If mail is saved during the application of the rules, then the corresponding
      flag is set in the main filter (the one that started the APPLY command).
      You may nest them, of course. (Fails if mail is not saved by the rules
      held in <i>rulefile</i>)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">ASSIGN <i>var value</i></dt>
  <dd class="It-tag">Assign the value to the user-defined variable <i>var</i>,
      which may further be accessed as <i>'%#var'</i> for macro substitution or
      <i>#var</i> in the TR and SUBST commands in place of the variable name.
      Note that there is no leading <i>#</i> in front of the variable name. The
      <i>value</i> you provide is first ran through <i>perl</i> to see if it
      contains some arithmetic operations. If the evaluation is successful, the
      resulting value is used instead. If an error occurs in this evaluation
      process, then the literal value provided is used. To avoid the evaluation,
      you may enclose the whole value in simple quotes. Those will be trimmed
      before the assignment takes place. If you actually want simple quotes in
      the first AND last position, you have to double each of them. (Does not
      modify existing status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">BACK <i>command</i></dt>
  <dd class="It-tag">Execute <i>command</i> and take its output as new actions
      to be performed on the mail (hence performing something analogous to
      <i>`command`</i> in shell). If there is no output, nothing is done. BACK
      commands can be nested, although this may lead to surprises this manpage
      will not disclose (but I assure you it will be funny, assuming we have the
      same sense of humor... :-). Note that both the standard output and the
      standard error from the command are used.
    <div style="height: 1.00em;">&#x00A0;</div>
    If the command fails, the output is mailed back to the user and no action is
      performed. Furthermore, normal feedback does not occur here: any output
      from the command is taken as filter actions, which means the semantics of
      PASS, for instance, is changed: we do not take a body back but commands.
      (The execution status is that of the <i>command</i>)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">BEEP [<b>-l</b>] <i>count</i></dt>
  <dd class="It-tag">This command may be used to tune the amount of beeps
      emitted when biffing on the terminal, for each <i>%a</i> expansion. By
      default, that amount is set to 1. Using the <b>-l</b> option alters the
      beep count locally for the rule. Otherwise, the default amount is changed.
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that this simply expands %a into the suitable amount of Ctrl-G
      characters. Your terminal must be allowed to issue consecutive bells for
      this to work. Very often, terminals are configured so that the first bell
      received disables further beeps for some period, to avoid cascades of
      bells. If you use <i>xterm</i> for instance, you should use: xterm -xrm
      &quot;XTerm*BellSuppressTime: 0&quot; to enable consecutive bells.
      Otherwise, <i>xterm</i> will swallow them during 200 ms, hence making the
      BEEP command ineffective, apparently. (Does not modify existing
    status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">BEGIN [<b>-ft</b>] <i>state</i></dt>
  <dd class="It-tag">Enter a new state. An explicit REJECT or RESTART is
      necessary to abort the processing of the current rule. The processing
      begins in the state INITIAL. If the <b>-f</b> (resp. <b>-t</b>) flag is
      specified, then the state change only occurs if the last command status
      indicated a failure (resp. a success). A state name can contain
      alphanumeric characters and underscores. (Does not modify existing
    status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">BIFF [<b>-l</b>] <i>on|off|path</i></dt>
  <dd class="It-tag">Allow or disallow biffing dynamically. When biffing is
      turned on via the configuration file or via this command, a message is
      printed on some of the terminals where the user is logged when mail is
      received, as explained under the section <b>MAIL BIFFING</b>.
    <div style="height: 1.00em;">&#x00A0;</div>
    Instead of <i>on</i> or <i>off</i>, you can specify a file name (~
      substitution allowed) being the new path to be used for the biffing format
      template.
    <div style="height: 1.00em;">&#x00A0;</div>
    If you use the <b>-l</b> option, changes are made locally, for the duration
      of the rule only. If you REJECT to go to some other rule, your changes
      will be lost. The global value of the altered parameters is changed on the
      first local usage and restored when a new rule is entered. (Does not alter
      execution status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">BOUNCE <i>address(es)</i></dt>
  <dd class="It-tag">Bounce the message to the specified address(es) and acts as
      if a save had been done. The only difference with FORWARD is that no
      Resent-like lines are added to the header. If an address is specified in
      double quotes, it is taken as the name of a file to be loaded to get
      addresses (one address per line, shell comments (#) allowed). The file
      name resolving is the same as the one used for pattern loading. (Fails if
      mail cannot be resent)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">DO <i>routine</i> [<i>(arg1, arg2, ... , argn)</i>]</dt>
  <dd class="It-tag">Calls the perl <i>routine</i>, with the supplied arguments
      if any. This is a very low level hook into <i>mailagent's</i> internal.
      The routine can be specified by itself ( <i>package'name</i>,
      <i>package</i> being <i>main</i> by default), or identified by a leading
      <i>tag</i>, followed by a ':', then the routine name as before. The
      <i>tag</i> can be a path to a file where the routine is defined, or a
      command name (for user-defined commands which are loaded dynamically). For
      instance DO UNKIT:newcmd'unkit('true') would lookup the user-defined
      <i>UNKIT</i> command, load the file where it is defined (in the
      <i>newcmd</i> package), then call the routine with <i>'true'</i> as
      argument. The <i>package</i> specified determines where the loading is
      done, so be sure it is consistent with the definition in the file where
      the routine is defined. (Fails if the routine cannot be located and
      executed)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">DELETE</dt>
  <dd class="It-tag">Delete the current message. Actually, this does not do
      anything, it just marks the mail as saved. If no further action involving
      saving is done, then the mail will never show up in the mailbox. (Never
      fails)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">FEED [<b>-be</b>] <i>program</i></dt>
  <dd class="It-tag">Feed the whole message to a program and get the output back
      as the new message. Hence the program appears as a filter for the whole
      message. It does not tag the message as having been saved. A RESYNC is
      automatically done upon return. (Returns the status of <i>program</i>)
    <div style="height: 1.00em;">&#x00A0;</div>
    <b>WARNING:</b> Your program must be able to properly parse a MIME message
      and must deal with transfer-encoded bodies by itself. To make the program
      task simpler, you can supply the <b>-b</b> switch which will let mailagent
      decode the whole body for you, suppressing any Content-Transfer-Encoding
      header (implying &quot;binary&quot;). This is an invalid message format
      for sending the message, but it makes processing easier. You still have to
      parse the MIME parts yourself though.
    <div style="height: 1.00em;">&#x00A0;</div>
    Using <b>-b</b> does not prevent your program from outputing a valid message
      back, one that can be possibly sent on the network so you have two
      options: either you do not supply any Content-Transfer-Encoding in the
      headers, and mailagent will recode the body for you using the initial
      transfer encoding present in the message (a relatively safe option if you
      make only changes in the body at well-defined spots without introducing
      8-bit chars), or you can supply the Content-Transfer-Encoding yourself and
      perform the body encoding manually.
    <div style="height: 1.00em;">&#x00A0;</div>
    To be completely safe and minimize the work in your program, the <b>-e</b>
      switch will let mailagent analyse the message body you are returning and
      select the proper transfer encoding automatically. Since this will cause
      the whole body to be analysed, and it can be potentially huge, that
      behaviour must be explicitly asked for. If you need <b>-e</b> then you
      probably want <b>-b</b> as well (you can supply both by saying <b>-be</b>
      naturally).
    <div style="height: 1.00em;">&#x00A0;</div>
    If you do not supply any switch, mailagent will give you the message as-is
      and will get your message as-is without any additional magic.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">FORWARD <i>address(es)</i></dt>
  <dd class="It-tag">Forward mail to the specified address(es). This acts as if
      a save had been done, in order to avoid the DELETE. Usually when you
      forward a mail, you do not wish to keep it. The command adds Resent-like
      lines in the header. As for BOUNCE, file inclusion is possible (i.e. use
      an address <i>&quot;forward_list&quot;</i> to forward a mail to all the
      users listed in the file <i>forward_list</i>). (Fails if mail cannot be
      resent)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">GIVE <i>program</i></dt>
  <dd class="It-tag">Give the body of the message to the specified program by
      feeding its standard input. Any output is mailed to the user who runs the
      <i>mailagent</i>. Note that the message is not tagged as having been
      saved. (Returns the status of <i>program</i>)
    <div style="height: 1.00em;">&#x00A0;</div>
    <b>NOTE:</b> If the message had a body that was encoded for transport (using
      one of the base64 or quoted-printable transfer encoding), mailagent will
      transparently decode it and supply a version that can be properly handled.
      In other words, the program does not need to care about the body being
      encoded in the message, as it will get a plain one. (Since no headers are
      supplied, this is the only possible option).
    <div style="height: 1.00em;">&#x00A0;</div>
    Caution though for MIME messages: you should use PIPE for them to give a
      chance to the program to properly handle the body, but then it needs to be
      fully MIME-aware.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">KEEP <i>header_fields_list</i></dt>
  <dd class="It-tag">Keeps only the corresponding lines in the header of the
      mail. For instance, a &quot;KEEP From To Cc Subject&quot; will keep only
      the principal fields from the mail message. This is suitable for archiving
      mailing lists messages. You may add a ':' after each header field name if
      you wish, but that is not strictly necessary. Headers may be specified
      using shell-style regular expressions, and file inclusion is allowed to
      get headers from a file. (Does not modify existing status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">LEAVE</dt>
  <dd class="It-tag">Leave incoming mail in the system mailbox. This is the
      default action if no rule matched or if no saving occurred. This is not
      recommended on Debian systems. (Fails if mail cannot be saved)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">MACRO [<b>-rdp</b>] <i>name</i> [= (<i>value</i>,
    <i>type</i>)]</dt>
  <dd class="It-tag">Lets you specify user-defined macros, of the form
      %-(<i>name</i>). See the paragraph on user-defined macros for explanation
      about the available types (SCALAR, EXPR, CONST, FN, PROG, PROGC). A perl
      interface to the underlying user macros is available for your perl
      commands. The <b>-r</b> option is used to replace an existing macro
      (instead of pushing a new instance on the stack), the <b>-d</b> is to
      delete all the instances of a named macro (in that case it takes only the
      first argument), and <b>-p</b> pops the last instance of the macro from
      the stack and reverts to the previous definition, if any (otherwise, it
      acts as <b>-d</b>). If you wish to define a simple SCALAR macro, you may
      omit the <i>= (value,</i> <i>type)</i> part and simply continue with the
      macro value. (Does not modify existing status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">MESSAGE <i>file</i></dt>
  <dd class="It-tag">Send message <i>file</i> back to the sender of the message
      (as derived from the header of the message). The text of the message is
      run through the macro substitution mechanism (described later on). (Fails
      if message cannot be sent)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">NOP [<b>-ft</b>]</dt>
  <dd class="It-tag">No operation. If this seems a bit odd, think of it in terms
      of a ONCE command. (Does not alter existing status unless <b>-f</b> or
      <b>-t</b> is used, in which case it forces a <i>false</i> --failure-- or
      <i>true</i> success status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">NOTIFY <i>file</i> <i>address(es)</i></dt>
  <dd class="It-tag">Send a notification message <i>file</i> to a given address
      list. The text of the message is run through the macro substitution
      mechanism (described later on). As with FORWARD, file inclusion for
      address specification is possible. (Fails if message cannot be sent)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">ON <i>(day list) command</i></dt>
  <dd class="It-tag">Execute the specified filter command only on the specified
      day list. That list is a space-separated list of days, specified using the
      English names. Only the first three characters are taken into account,
      case-insensitively. Therefore, the shortest valid day specifications are
      <i>Mon, Tue, Wed, Thu, Fri, Sat</i> and <i>Sun</i>.
    <div style="height: 1.00em;">&#x00A0;</div>
    This command can be used in conjunction with SELECT to do time-based
      selective bouncing of messages to, for instance, your home address: ON
      (Mon Tue Wed Thu) SELECT (18:30 .. 23:00) BOUNCE me@home.net; ON (Fri)
      SELECT (18:30 .. 23:59) BOUNCE me@home.net; ON (Sat Sun) BOUNCE
      me@home.net; That would bounce messages only on week-ends and during the
      week, after 18:30, and until 23:00 (assuming that's bed time, other
      messages will be seen at work the next day). Note that on Fridays, we go
      as far as 23:59. (Propagates status from <i>command</i>. If the command is
      not executed, always return success)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">ONCE <i>(name, tag, period) command</i></dt>
  <dd class="It-tag">Execute the specified filter command once per
      <i>period</i>. The <i>name</i> and <i>tag</i> fields are used to record
      timestamps of the last ONCE command. More on this later. (Propagates
      status from <i>command</i>. If the command is not executed, always return
      success)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PASS <i>program</i></dt>
  <dd class="It-tag">Feed the body of the message to the specified program and
      get a new body back from the output of the program. Note that the message
      is not tagged as having been saved. (Returns the status of <i>program</i>)
    <div style="height: 1.00em;">&#x00A0;</div>
    <b>NOTE:</b> If the message had a body that was encoded for transport (using
      one of the base64 or quoted-printable transfer encoding), mailagent will
      transparently decode it and supply a version that can be properly handled.
      The body generated by the program will then be automatically encoded back
      using the same transfer encoding.
    <div style="height: 1.00em;">&#x00A0;</div>
    Caution though for MIME messages: you should use FEED for them to give a
      chance to the program to properly handle the body, but then it needs to be
      fully MIME-aware.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PERL <i>script</i> [<i>arguments</i>]</dt>
  <dd class="It-tag">Escape to a perl <i>script</i> to perform some actions on
      the message. This is fully described further in the manpage, and is very
      different from a <i>RUN perl script</i> command. (Returns failure if the
      script did not compile or returned a non-zero status).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PIPE [<b>-b</b>] <i>program</i></dt>
  <dd class="It-tag">Pipe the whole message to the specified program, but do not
      get anything back. Any output is mailed to the user who runs the
      <i>mailagent</i>. The message is not tagged as having been saved in any
      case, so you must explicitly DELETE it if piping was enough and it did not
      fail: &quot;REJECT -f&quot; is your friend here to avoid unwanted
      deletion. (Returns the status of <i>program</i>)
    <div style="height: 1.00em;">&#x00A0;</div>
    <b>WARNING:</b> Your program must be able to properly parse a MIME message
      and must deal with transfer-encoded bodies by itself. To make the program
      task simpler, you can supply the <b>-b</b> switch which will let mailagent
      decode the whole body for you, suppressing any Content-Transfer-Encoding
      header (implying &quot;binary&quot;). This is an invalid message format
      for sending the message, but it makes processing easier. You still have to
      parse the MIME parts yourself though.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">POST [<b>-lb</b>] <i>newsgroup(s)</i></dt>
  <dd class="It-tag">Post the message to the specified newsgroup(s) after having
      cleaned-up the header: mail-related fields like Received: or In-Reply-To:
      are removed, a valid From: line is generated, the original To: and Cc: are
      renamed with an X- prefix, the References: line is updated/generated if
      necessary based on existing In-Reply-To, and NNTP-specific fields are
      stripped so that the server can add its own.
    <div style="height: 1.00em;">&#x00A0;</div>
    Running POST successfully acts as a saving.
    <div style="height: 1.00em;">&#x00A0;</div>
    If the first name is <b>-l</b> as in &quot;POST -l comp.mail.mh&quot;, then
      a &quot;Distribution: local&quot; header is added to force a local
      delivery. Otherwise, the default <i>inews</i> distribution will be used
      (world, usually).
    <div style="height: 1.00em;">&#x00A0;</div>
    When the <b>-b</b> switch is given, a successful POST will result in biffing
      being activated (see section <b>MAIL BIFFING</b>) for the resulting news
      article.
    <div style="height: 1.00em;">&#x00A0;</div>
    If more than one newsgroup is specified, they should be space separated. It
      is possible to get a newsgroup list via file inclusion. (Fails if message
      cannot be posted)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PROCESS</dt>
  <dd class="It-tag">Run the mailagent processing which looks for @SH commands
      and executes them. This was described before in the section dealing with
      default rules. The action associated by default to a mail having
      [Cc]ommand as its subject is PROCESS. (Always returns success)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PROTECT [<b>-lu</b>] <i>mode</i></dt>
  <dd class="It-tag">Sets the default protection mode that should be set on
      created folders (or created files when saving into an MH folder or a
      directory). By default, permissions are governed by the UMASK command, but
      this lets you override the default. The specified <i>mode</i> should be
      preceded by a <b>0</b> as in <i>0644</i> to give the familiar octal
      permissions. Otherwise, it is interpreted as a decimal number, so beware!
    <div style="height: 1.00em;">&#x00A0;</div>
    The <b>-l</b> option may be used to specify a mode locally for one rule.
      Otherwise, the protection mode is set globally. The <b>-u</b> option
      unsets the global (or local when combined with <b>-l</b>) mode, reverting
      to the default behaviour where only the umask is taken into account by the
      system.
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that when saving into an MH folder, the PROTECT command takes
      precedence over the <i>Msg-Protect</i> field from your ~/.mh_profile file.
      (Does not alter execution status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PURIFY <i>program</i></dt>
  <dd class="It-tag">Feed the header into a program and get new header back.
      RESYNC is done automatically upon return. This may be used to indeed
      purify the header by removing all the verbose stuff added by so many mail
      transport agents (X-400 like lines for instance). Obviously, this does not
      flag the message as having been saved. (Returns the status of
      <i>program</i>)
    <div style="height: 1.00em;">&#x00A0;</div>
    If your program removes the Content-Transfer-Encoding header in a MIME
      message, mailagent will properly transform the message to have a
      non-encoded body. If you change the value of the Content-Transfer-Encoding
      header, mailagent will also correctly recode the body for you. The only
      supported encodings are base64 and quoted-printable.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">QUEUE</dt>
  <dd class="It-tag">Queue mail again. A successful queuing counts as if mail
      has been saved. Mail queued that way will not be processed during the next
      30 minutes. Note that unless mailagent is invoked on a regular basis by
      <i>cron</i>, the mail will remain in the queue until another mail arrives.
      (Fails when mail cannot be queued)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">RECORD [<b>-acr</b>] [<i>state</i>]
    [<i>(tag-list)</i>]</dt>
  <dd class="It-tag">Record message in the history and enters state _SEEN_ if
      the message was already present there. If the message is recorded for the
      first time, processing continues normally. Otherwise a REJECT is
      performed. This behavior may be somewhat modified by using some options.
      See UNIQUE for a complete description of the options and arguments.
      Naturally, when a <i>state</i> is specified, that overrides the default
      _SEEN_. A state name can contain alphanumeric characters and underscores.
    <div style="height: 1.00em;">&#x00A0;</div>
    When a <i>tag-list</i> (comma-separated list of names) is specified, the
      message is only recorded and checked against all those tags, but only
      them. Not specifying any tag list means any occurrence, whether it is
      tagged or not. See paragraph <b>Using Tags in Record and Unique</b> for
      more information. (Returns a failure status if mail was already
    recorded)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">REJECT [<b>-tf</b>] [<i>state</i>]</dt>
  <dd class="It-tag">Abort execution of current action, and continue matching.
      If <b>-t</b> is specified, the reject will occur only if the previous
      action was successfully completed (return status of true), whilst
      <b>-f</b> would cause the reject only when a failure occurred. If a
      <i>state</i> is specified, we enter that state before rejection. REJECT
      resets the matching flag, which means that if no further match occurs, the
      default action will apply. A state name can contain alphanumeric
      characters and underscores. (Does not alter execution status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">REQUIRE <i>file</i> [<i>package</i>]</dt>
  <dd class="It-tag">Behaves like the perl <i>require</i> operator by loading a
      perl file into memory. By default, the file is read in the <i>newcmd</i>
      package, but you may specify whatever package you wish to load it in. This
      command will only perform the loading once per (file, package) tuple.
      Unlike its perl equivalent, the file &quot;value&quot; is not important,
      i.e. it does not have to end with a statement returning a true value.
      (Fails if file cannot be loaded)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">RESTART [<b>-tf</b>] [<i>state</i>]</dt>
  <dd class="It-tag">Abort execution of current action and restart the matching
      process from the beginning. To avoid loops, each rule may be walked
      through once in a given state. See REJECT for the meaning of the optional
      parameters. RESTART resets the matching flag, which means that the default
      action will apply, should no further match occur. (Does not alter
      execution status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">RESYNC</dt>
  <dd class="It-tag">Re-synchronize header used for matching with the header of
      the mail. This is probably useful only when a SUBST or ANNOTATE command
      was run. (Does not alter execution status)
    <div style="height: 1.00em;">&#x00A0;</div>
    <b>NOTE:</b> At RESYNC time, mailagent will check whether the
      Content-Transfer-Encoding header was changed and will transparently recode
      the body if required, so that the whole message remains valid despite
      header mangling. It will also take care of updating Content-Length if
      required. Whenever you do change these important headers via SUBST or
      ANNOTATE, be sure to call RESYNC before disposing of the message or you
      run the risk of saving a corrupted version that will not be properly
      understood by your mail user agent.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">RUN <i>program</i></dt>
  <dd class="It-tag">Run the specified program and mail any output to the user
      who runs <i>mailagent</i>. This action does not flag the message as having
      been saved. (Returns the status of <i>program</i>)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">SAVE <i>folder</i></dt>
  <dd class="It-tag">Save message in the specified folder. If folder name starts
      with a '+', it is handled as an MH-style folder and <i>rcvstore</i> is
      emulated to deliver the message into that folder. If folder is a
      directory, message is delivered in a single file within that directory.
      See the <b>FOLDERS</b> section. (Fails if message cannot be saved)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">SELECT (<i>start .. end</i>) <i>command</i></dt>
  <dd class="It-tag">Execute the <i>command</i> only within the time selection
      period specified. Dates can be specified in a wide range of formats. The
      output of the <i>date</i>(1) command is an example of a valid
      specification. If the date, the year or the month is missing, then the
      current one is substituted in place of it. The following dates are valid
      specifications: '10:04:25', 'now' ,'April 1 1992', 'Dec 25', 'July 14
      1789, 07:40' (err... it's valid according to the grammar, but it's before
      the Epoch so it does not mean anything). Other fancy dates like 'last
      month - 5 minutes' or '3 weeks ago' are also enabled. (Isn't that great to
      have a <b>real</b> parser? The filtering rules could have been more
      elaborated if only I had known about this Berkeley <i>yacc</i> producing a
      <i>perl</i> parser...). (Returns the status of <i>command</i>, if run,
      otherwise returns true).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">SERVER [<b>-t</b>] [<b>-d </b><i>disabled
    commands</i>]</dt>
  <dd class="It-tag">Activate server processing. The body of the message is
      interpreted as a list of commands to execute. See section <b>GENERIC MAIL
      SERVER</b> for more information about the server itself. The <b>-t</b>
      option turns the server into <i>trusted mode</i>, where <i>powers</i> may
      be gained. The <b>-d</b> option must be followed by a list of disabled
      commands, separated by commas with no intervening spaces between
    them.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">SPLIT [<b>-adeiw</b>] <i>folder</i></dt>
  <dd class="It-tag">Split a mail in digest format into the specified folder
      (same naming conventions as in SAVE). If no folder is specified, each
      digest item is queued and will be analyzed as a single mail by itself. The
      <b>-d</b> option deletes the digest header. The <b>-i</b> option means
      split is done in-place and the original mail is discarded. All the options
      may be used simultaneously provided they are stuck together at the
      beginning (option parsing being really rudimentary).
    <div style="height: 1.00em;">&#x00A0;</div>
    If the mail is not in digest format and a folder is specified, then it is
      saved in that folder. Otherwise, the SPLIT action fails and nothing occurs
      (the filter continues its processing though). The SPLIT command will
      correctly burst RFC-934 digest messages and will try to do its best
      otherwise. If the digest was not RFC-934 compliant and there is a chance
      SPLIT might have produced something incorrect, then the original message
      is also saved if <b>-i</b>, otherwise it is not tagged as saved (so that
      the default LEAVE command may apply). The <b>-w</b> (watch) requests
      special care and will detect every non RFC-934 digest, even when the
      non-compliance is otherwise harmless; furthermore, any trailing garbage
      longer that 100 bytes will be saved as a digest item by itself.
    <div style="height: 1.00em;">&#x00A0;</div>
    The <b>-a</b> option annotates every digest item with an X-Digest-To: header
      line, which is the concatenation of the To: and Cc: fields of the original
      digest message. This may be used for instance to burst the digest into the
      queue and then re-process each of its items according to this added field.
      Finally, the <b>-e</b> option will discard the digest header only if its
      body is empty (i.e. the moderator did not include any leading comment).
      (Returns success if mail was in digest format and correctly split without
      any error)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">STORE <i>folder</i></dt>
  <dd class="It-tag">Save message in the specified folder and leave a copy in
      the system mailbox. The <i>folder</i> parameter follows the same naming
      conventions as in SAVE. Again, because of locking issues, leaving mail in
      the mailbox is not recommended on Debian machines. (Fails if message
      cannot be saved either in the <i>folder</i> or in the mailbox)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">STRIP <i>header_fields_list</i></dt>
  <dd class="It-tag">Remove the corresponding lines in the header of the mail.
      For instance, a &quot;STRIP Newsgroups Apparently-To&quot; will remove the
      appropriate lines to wipe out any Newsgroups: or Apparently-To: header.
      You may add a ':' after each header field name if you wish, but that is
      not strictly necessary. Headers may be specified via shell-style regular
      expressions or via &quot;file&quot; inclusion. (Does not alter execution
      status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">SUBST <i>var/header expression</i></dt>
  <dd class="It-tag">Substitutes the expression on the specified user-defined
      variable (name starting with a #) or back-reference (digit), or header
      field (optionally ending with ':'). For instance SUBST #foo /w/y/g would
      substitute in user-defined variable <i>foo</i> all the <i>w</i> by
      <i>y</i>. See also ASSIGN and TR.
    <div style="height: 1.00em;">&#x00A0;</div>
    For substitutions on header fields, like: SUBST Subject: /\[foo\]\s+//;
      matching header lines will be reformatted when the substitution is
      successful, which likely means original continuations will not be
      preserved. The target of the substitution is the whole header, with
      continuations normalized to one space. You are therefore guaranteed to be
      independent from the actual header formatting in the original.
    <div style="height: 1.00em;">&#x00A0;</div>
    Do not forget to issue a RESYNC after a header field SUBST, since some
      routines (like POST) probe into the parsed header hash table to generate
      the saved message.
    <div style="height: 1.00em;">&#x00A0;</div>
    (Fails if error in <i>expression</i>)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">TR <i>var/header translation</i></dt>
  <dd class="It-tag">Perform the translation on the specified variable,
      back-reference or header field. For instance TR 1 /A-Z/a-z/ would
      canonicalize content of reference 1 into lowercase. Successfully
      transliterated headers are reformatted, even when their overall size is
      not changed. See also ASSIGN and SUBST. (Fails if error in
      <i>translation</i>)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">UMASK [<b>-l</b>] <i>mode</i></dt>
  <dd class="It-tag">Changes the process's umask to the specified <i>mode</i>,
      which can be decimal, octal (if preceded by '0') or hexadecimal (starting
      with '0x'). The octal notation is the clearest way to specify the umask
      anyway. Aren't rumors saying that octal was invented for that purpose
      only? ;-) Use the <b>-l</b> option to change the umask for the duration of
      the current action rule only. Note that the default umask specified in
      your config file is used to reset <i>mailagent</i>'s umask at the start of
      each mail processing. (Does not alter execution status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">UNIQUE [<b>-acr</b>] [<i>state</i>]
    [<i>(tag-list)</i>]</dt>
  <dd class="It-tag">Record message in the history and tag message as saved if
      it was already present there. If the message is recorded for the first
      time, processing continues normally. Otherwise a REJECT is performed. If
      <b>-r</b> was used, a RESTART is used instead whilst <b>-a</b> would run
      an ABORT. For instance, to remove duplicate messages from mailing lists,
      run a UNIQUE <b>-a</b> before saving the mail. The <b>-c</b> option may be
      used alone to actually prevent the command from disturbing the execution
      flow, and to later use the return status to see what happened: UNIQUE
      returns a failure status if the message was already recorded. If an
      optional <i>state</i> argument is given, then the automaton will enter
      that state if the mail was previously in the database. See also RECORD,
      and the paragraph entitled <b>Using Tags in Record and</b> <b>Unique</b>
      for more information about the <i>tag-list</i>. (Fails if mail was already
      recorded)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">VACATION [<b>-l</b>] <i>on|off|path</i>
    [<i>period</i>]</dt>
  <dd class="It-tag">Allow or disallow a vacation message. When vacation mode is
      turned on via the configuration file, a message is sent whenever the user
      receives a mail meeting some requirements, as explained under the section
      <b>VACATION MODE</b>. One of the conditions is that the vacation flag
      modified by this command be true. This makes it easy to disallow vacation
      messages, ever, to a group of people for instance.
    <div style="height: 1.00em;">&#x00A0;</div>
    Instead of <i>on</i> or <i>off</i>, you can specify a file name (~
      substitution allowed) being the new path to be used for locating the
      vacation file. Optionally, you may specify a last parameter, which will be
      taken as the period to apply when sending the vacation message. Changes to
      the vacation message <i>path</i> are forbidden when the configuration
      variable <i>vacfixed</i> is set to ON.
    <div style="height: 1.00em;">&#x00A0;</div>
    If you use the <b>-l</b> option, changes are made locally, for the duration
      of the rule only. If you REJECT to go to some other rule, your changes
      will be lost. The global value of the altered parameters is changed on the
      first local usage and restored when a new rule is entered. (Does not alter
      execution status)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">WRITE <i>folder</i></dt>
  <dd class="It-tag">Write the message in the specified folder, removing any
      pre-existing folder with the same name. Hence, successive WRITE commands
      will overwrite the previous one. This is useful to store output of system
      commands ran by <i>cron</i>. Don't try to use it with an MH folder or a
      directory folder or it will behave like SAVE. (Fails if message cannot be
      written)</dd>
</dl>
<h2 class="Ss" title="Ss" id="Execution_Status"><a class="selflink" href="#Execution_Status">Execution
  Status</a></h2>
Almost all the actions modify a variable which keeps track of the execution
  status (analogous to the $? variable in the shell). This variable can be
  tested via the <b>-t</b> or <b>-f</b> option of the REJECT command for
  instance. To give but a single example, the SAVE action would return
  <i>failed</i> if it could not save the mail in the specified folder. If that
  SAVE command was followed by a &quot;REJECT -f FAILED&quot;, then the
  execution of the current rule would stop and the automaton would continue to
  analyze the mail in the FAILED state.
<div class="Pp"></div>
Some of the actions however do not modify this last execution status. Typically,
  those are actions which make decisions based on that status, or simply actions
  which may never fail. Those special actions are: ABORT, ASSIGN, BEGIN, KEEP,
  MACRO, NOP, REJECT, RESTART, RESYNC, STRIP and VACATION.
<div class="Pp"></div>
It is unfortunate that ONCE or SELECT commands cannot make the difference
  between a non-execution and a successful execution of the specified command.
  There may be a change in the way this scheme works, but it should remain
  backward compatible.
<h2 class="Ss" title="Ss" id="Perl_Escape"><a class="selflink" href="#Perl_Escape">Perl
  Escape</a></h2>
By using the PERL command, you have the ability to perform filtering and other
  sophisticated actions directly in <i>perl</i>. This is really different from
  what you could do by feeding your mail to a perl script. First of all, no
  extra process is created: the script is loaded directly into mailagent and
  compiled in a special package called <i>mailhook</i>. Secondly, you have a
  perl interface to all the filtering commands: each filtering action is
  associated to a perl function (spelled lower-cased). Finally, some pre-defined
  variables are set for you by mailagent.
<div class="Pp"></div>
Before we go any further, please note that as there is no extra process created,
  you <b>must not</b> call the perl <i>exit</i> function. Use <i>&amp;exit</i>
  instead, so that the exit may be trapped. <i>&amp;exit</i> takes one argument,
  the exit code. If you use 0, this is understood as a success, any other value
  meaning failure (i.e. the PERL command will return a failure status). Using
  the perl <i>exit</i> function directly would kill <i>mailagent</i> and would
  probably incur some mail losses.
<div class="Pp"></div>
The scripts used should remain simple. In particular, you should avoid the use
  of the <i>package</i> directive or define functions with a package name other
  than <i>mailhook</i> (i.e. the package where your script is loaded). Failure
  to do so may raise some name clashes with <i>mailagent</i>'s own routines. In
  particular, avoid the <i>main</i> package. Note that since the compilation
  environment is set-up to <i>mailhook</i>, not specifying package names in your
  variables and subroutine is fine (in fact, it's meant to work that way).
<div class="Pp"></div>
Your script is free to do whatever it wants to the mail. Most of the time
  however, you end up using the <i>mailagent</i> primitives to save the mail or
  forward it (but you are free to redesign your own and call them instead, of
  course). The interface is simple: each function takes but one argument, a
  string, which is the arguments to the command, if any. For instance, in a perl
  escape script, you would express: { SAVE list; FORWARD &quot;users&quot;; FEED
  ~/bin/newmail -tty; REJECT } with: &amp;save('list');
  &amp;forward('&quot;users&quot;'); &amp;feed('~/bin/newmail -tty');
  &amp;reject; The rule is simple: each command is replaced by a function call,
  with the remaining parameters enclosed in a string, if any. Alternatively, you
  may specify parameters as a list: all the arguments you provide are joined
  into a big happy string, using a space character as separator. The macro
  substitution mechanism is then ran on this resulting argument string.
<div class="Pp"></div>
Each function returns a boolean success status of the command (i.e. 1 means
  success). For those functions which usually do not modify the filter's last
  execution status variable, a success is always returned. This makes it
  possible to (intuitively) write: &amp;exit(0) if &amp;save('uucp');
  &amp;bounce('root') || &amp;save('emergency'); and get the expected result.
  The mail will be saved in the emergency folder only when saving in uucp folder
  failed and the mail could not be bounced to root.
<div class="Pp"></div>
It is important to understand that these commands have <i>exactly</i> the same
  effect on the filtering process when they are run from a perl escape script or
  from within the rule file as regular actions. A <i>&amp;reject</i> call will
  simply abandon the execution of the current perl script and the filter
  automaton will regain control and attempt a new match. But <i>perl</i> brings
  you much more power, in particular system calls, control structures like
  <b>if</b> and <b>for</b>, raw regular expressions, etc...
<div class="Pp"></div>
The special <i>perl</i> @INC array (which controls the search path for
  <i>require</i>) is slightly modified by prepending mailagent's own private
  library path. This leaves the door open for future mailagent library perl
  scripts which may be required by the perl script. Furthermore, the following
  special variables are set-up by perl before invoking your script:
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>@ARGV</i></dt>
  <dd class="It-tag">The arguments of the script, which were given by the PERL
      command. This array is set up the exact same way you would expect it to be
      set up if you invoked the command directly from the shell, excepted that
      <i>@ARGV[0]</i> is the name of the script (since you cannot use perl's
      <i>$0</i> to get at it; that would give you mailagent's name).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$address</i></dt>
  <dd class="It-tag">The address part of the From: line.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$cc</i></dt>
  <dd class="It-tag">The raw content of the Cc: line.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>@cc</i></dt>
  <dd class="It-tag">The list of addresses on the Cc: line, with comments
      suppressed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$envelope</i></dt>
  <dd class="It-tag">The mail envelope, as computed using the first From line of
      the message.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$friendly</i></dt>
  <dd class="It-tag">The comment part of the From: line, if any.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$from</i></dt>
  <dd class="It-tag">The content of the From: line, with address and comment
      part.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>%header</i></dt>
  <dd class="It-tag">This table, indexed by field name, returns the raw content
      on the corresponding header line. See below.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$msgpath</i></dt>
  <dd class="It-tag">The full path name of the folder (or message within an MH
      folder) where the last saving operation has occurred. This is intended to
      be used if you wish to construct your own mail reception
    notification.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$length</i></dt>
  <dd class="It-tag">The message length, in bytes.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$lines</i></dt>
  <dd class="It-tag">The number of lines in the message.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$login</i></dt>
  <dd class="It-tag">The login name of the address on the From: line.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$precedence</i></dt>
  <dd class="It-tag">The content of the Precedence: line, if any at all.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>@relayed</i></dt>
  <dd class="It-tag">The list of host names (possibly raw IP addresses if no DNS
      mapping) listed in the (computed) Relayed: header line.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$reply_to</i></dt>
  <dd class="It-tag">The e-mail address where a reply should be sent to, with
      comment suppressed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$sender</i></dt>
  <dd class="It-tag">The sender of the message (may have a comment), derived in
      the same way the Sender: line is computed by mailagent.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$subject</i></dt>
  <dd class="It-tag">The subject of the message.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$to</i></dt>
  <dd class="It-tag">The raw content of the To: line.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>@to</i></dt>
  <dd class="It-tag">The list of addresses on the To: line, with comments
      suppressed.</dd>
</dl>
<div class="Pp"></div>
The associative array <i>%header</i> gives you access to all the fields in the
  header of the message. For instance, <i>$to</i> is really the value of
  <i>$header{'To'}</i>. The key is specified using a normalized case, i.e. the
  first letter of each word is uppercased, the remaining being lowercased. This
  is independent of the actual physical representation in the message itself.
<div class="Pp"></div>
The pseudo keys <i>Head</i>, <i>Body</i> and <i>All</i> respectively gives you
  access to the raw header of the message, the body and the whole message. The
  <i>%header</i> array is really a reference to the <i>mailagent</i>'s internal
  data structure, so modifying the values will influence the filtering process.
  For instance, the SAVE command writes the <i>Head</i>, the <i>X-Filter:</i>
  line, the end of header (a single newline) and then the <i>Body</i> (this is
  an example only, not a documented feature :-). The <i>=Body=</i> key is
  special: it is a Perl reference to a scalar containing the body with any
  content transfer encoding removed.
<div class="Pp"></div>
Note that the <i>$msgpath</i> variable holds only a snapshot of the folder path
  at the time where the PERL escape was called. If you perform your own savings
  in perl, then you need to look at the <i>$main'folder_saved</i> variable
  instead to get the up-to-date folder path value.
<div class="Pp"></div>
As a final note, resist the temptation of reading the internals of the mailagent
  and directly calling the routines you need. If it is not documented in the
  manual page, it may be changed without notice by any further patch. (And this
  does not say that documented features may not change also... It's just more
  unlikely, and patches would clearly state that, of course.)
<h2 class="Ss" title="Ss" id="Program_Environment"><a class="selflink" href="#Program_Environment">Program
  Environment</a></h2>
All the programs started by mailagent via RUN and friends inherit the following
  environment variables: HOME, USER and NAME, respectively set from the
  configuration parameters <i>home</i>, <i>user</i> and <i>name</i>. If the
  mailagent is invoked by the <i>filter</i>, then the PATH is also set according
  to the configuration file (if you are using the C filter) or to whatever you
  set PATH (if you are using the shell filter).
<div class="Pp"></div>
All the programs are executed from within the <i>home</i> directory. This
  includes scripts started via the PERL command and mail hooks. The latter will
  be described in detail further down.
<h2 class="Ss" title="Ss" id="File_inclusion"><a class="selflink" href="#File_inclusion">File
  inclusion</a></h2>
Some commands like FORWARD or KEEP allow you to specify a file name between
  double quotes to actually load parameters from this file. Unless a full path
  is given, the following method is used to locate the file: first in the
  location pointed to by the <i>mailfilter</i> variable if set, otherwise in
  <i>maildir</i> and finally in the home directory. Note that this is not a
  search path in the sense that if <i>mailfilter</i> is defined and the file is
  not there, an error will be reported.
<div class="Pp"></div>
The file should list each parameter (be it an address, a header or a pattern) on
  a line by itself. Shell-style comments (#) are allowed within that file and
  leading white spaces are trimmed (but not trailing spaces).
<h2 class="Ss" title="Ss" id="Macros_Substitutions"><a class="selflink" href="#Macros_Substitutions">Macros
  Substitutions</a></h2>
All the commands go through a macro substitution mechanism before being
  executed. The following macros are available:
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag">%%</dt>
  <dd class="It-tag">A real percent sign</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%A</dt>
  <dd class="It-tag">The internet address extracted out of the <i>From:</i>
      field ( <i>a.b.c</i> in <i>u@a.b.c</i>), converted to lower-case.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%C</dt>
  <dd class="It-tag">CPU name on which mailagent runs. That is a fully qualified
      hostname with the domain name, e.g. <i>lyon.eiffel.com</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%D</dt>
  <dd class="It-tag">Day of the week (0-6)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%H</dt>
  <dd class="It-tag">Host name (name of the machine on which the
      <i>mailagent</i> runs), without any domain name. Always in lower-case,
      regardless of the machine name.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%I</dt>
  <dd class="It-tag">The internet domain name extracted out of the <i>From:</i>
      field ( <i>b.c</i> in <i>u@a.b.c</i>), converted to lower-case.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%L</dt>
  <dd class="It-tag">Length of the body part, in bytes, with
      content-transfer-encoding removed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%N</dt>
  <dd class="It-tag">Full name of the sender (login name if none)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%O</dt>
  <dd class="It-tag">The organization name extracted out of the <i>From:</i>
      field ( <i>b</i> in <i>u@a.b.c</i>), converted to lower-case.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%R</dt>
  <dd class="It-tag">Subject of the original message with leading Re:
    suppressed</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%S</dt>
  <dd class="It-tag">Re: subject of original message</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%T</dt>
  <dd class="It-tag">Time of the last modification on mailed file (commands
      MESSAGE and NOTIFY)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%U</dt>
  <dd class="It-tag">Full name of the user</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%Y</dt>
  <dd class="It-tag">Full year, with four digits (so-called <i>yyyy
    format</i>)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%_</dt>
  <dd class="It-tag">A white space (useful to put white spaces in single
      patterns)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%&amp;</dt>
  <dd class="It-tag">List of selectors which incurred match (among those
      specified via a regular expression such as 'X-*: /foo/i'. If we find the
      <i>foo</i> substring in the X-Mailer: header line, then %&amp; will be set
      to this value). Values in the list are comma separated.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%~</dt>
  <dd class="It-tag">A null character, wiped out from the resulting string.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%<i>digit</i></dt>
  <dd class="It-tag">Value of the corresponding back reference from the last
      match.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%#<i>var</i></dt>
  <dd class="It-tag">Value of user-defined variable <i>var</i></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%=<i>var</i></dt>
  <dd class="It-tag">Value of the mailagent configuration variable <i>var</i> as
      specified in the <i>~/.mailagent</i> file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%d</dt>
  <dd class="It-tag">Day of the month (01-31)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%e</dt>
  <dd class="It-tag">The user's e-mail address (yours!).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%f</dt>
  <dd class="It-tag">Contents of the &quot;From:&quot; line, something like %N
      &lt;%r&gt; or %r (%N) depending on how the mailer is configured.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%h</dt>
  <dd class="It-tag">Hour of the day (00-23)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%i</dt>
  <dd class="It-tag">Message ID, if available (otherwise, this is a null
    string)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%l</dt>
  <dd class="It-tag">Number of lines in the message, once
      content-transfer-encoding has been removed</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%m</dt>
  <dd class="It-tag">Month of the year (01-12)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%n</dt>
  <dd class="It-tag">Lower-case login name of sender</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%o</dt>
  <dd class="It-tag">Organization (where <i>mailagent</i> runs)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%r</dt>
  <dd class="It-tag">Return address of message</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%s</dt>
  <dd class="It-tag">Subject of original message</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%t</dt>
  <dd class="It-tag">Current hour and minute (in HH:MM format)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%u</dt>
  <dd class="It-tag">Login name of the user</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%y</dt>
  <dd class="It-tag">Year (last two digits)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%[To]</dt>
  <dd class="It-tag">Value of the header field (here To:)</dd>
</dl>
<h2 class="Ss" title="Ss" id="User-defined_Macros"><a class="selflink" href="#User-defined_Macros">User-defined
  Macros</a></h2>
The mailagent lets you define your own macros in two ways: at the filter level
  via the MACRO command, or at the perl level in your own commands or perl
  actions.
<div class="Pp"></div>
Once defined, a user macro (say <i>foo</i>) can be substituted by using
  <i>%-(foo)</i>. In the case of a single-letter macro, that can be optimized
  into <i>%-f</i> for instance, i.e. the parenthesis can be omitted.
<div class="Pp"></div>
There are six types of macros:
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag">SCALAR</dt>
  <dd class="It-tag">A scalar value is given, e.g: <i>red</i>. The macro's value
      is the literal scalar value, no further interpretation is performed on the
      data.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">EXPR</dt>
  <dd class="It-tag">A perl expression will be <i>eval</i>ed to get the value,
      e.g: <i>$red</i>. Note that the evaluation will be performed within the
      <i>usrmac</i> package, so if you are referring to a variable in another
      package, it would be wise to specify it, as in <i>$foo'bar</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">CONST</dt>
  <dd class="It-tag">It's really the same as EXPR, but the value is known to be
      a constant. So the first time a substitution is made, the expression will
      be evaluated, and then its result is cached.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">FN</dt>
  <dd class="It-tag">A perl function name (without the leading &amp;), such as
      <i>main'do_this</i>. The function will be called with a single parameter:
      the name of the macro itself. That leaves the door open for further
      user-defined conventions by forcing evaluation through one single perl
      function.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PROG</dt>
  <dd class="It-tag">A program to run to get the actual value. Only trailing
      newline is chopped, others are preserved. The program is forked each time.
      In the argument list given to the program, %n is expanded as the macro
      name we are trying to evaluate. If you specify that in the filtering
      rules, don't forget to escape the first %.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">PROGC</dt>
  <dd class="It-tag">Same as PROG really, but the program is forked only once
      and the value is cached for later perusal.</dd>
</dl>
<div class="Pp"></div>
At the perl level, four functions let you manipulate and define your macros (all
  part of the <i>usrmac</i> package):
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>new(name, value, type)</i></dt>
  <dd class="It-tag">Replace or create a %-(name) macro. For instance:
      new('foo', &quot;$mailhook'header{'X-Foo'}&quot;, 'EXPR'); would create a
      new macro <i>foo</i> that would expand into the value of an hypothetical
      <i>X-Foo</i> header.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>delete(name)</i></dt>
  <dd class="It-tag">Delete all values recorded for the macro.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>push(name, value, type)</i></dt>
  <dd class="It-tag">Stack a new macro, creating it if necessary.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>pop(name)</i></dt>
  <dd class="It-tag">Remove last macro definition on the stack.</dd>
</dl>
<div class="Pp"></div>
One macro stack is allocated for each macro, so that some kind of crude dynamic
  scoping may be implemented. Creating a macro via <i>push</i> is like taking a
  local variable in perl, while creating one by <i>new</i> is simply assigning
  to a variable. Likely, <i>pop</i> is like exiting a block with a local
  variable definition and <i>delete</i> frees <i>all</i> the macro bearing that
  name, i.e. it deletes the whole stack.
<div class="Pp"></div>
At the filter level, the MACRO command has three options. By default, the
  command defines a new macro by using <i>push</i>, and the other options each
  let you access one of the other interface functions. Note that macro
  definitions persist across APPLY commands.
<h2 class="Ss" title="Ss" id="User-defined_Logging"><a class="selflink" href="#User-defined_Logging">User-defined
  Logging</a></h2>
Most of the time when writing a new mailagent filtering command or an perl hook,
  you will have a need for specific logging, either to report a problem or to
  keep track of what you are performing.
<div class="Pp"></div>
Normally, logs are appended into the <i>agentlog</i> file by calling
  <i>&amp;main'add_log(string)</i> (see subsection <b>General Purpose
  Routines</b>). For plain mailagent actions, this is fine.
<div class="Pp"></div>
But mailagent lets you define alternate logging files, referred to by name. This
  generic logging interface is defined in the <i>usrlog</i> package:
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>new(name, file, flag)</i></dt>
  <dd class="It-tag">Records a new log file known as <i>name</i> and done in
      <i>file</i>. If the pathname given for this file is not absolute, it is
      rooted under the <i>logdir</i> directory. If <i>flag</i> is set to true,
      any logging done to this file will also be copied to the default
      system-wide logfile. Nothing is done if a logfile with the same name has
      already been defined.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>delete(name)</i></dt>
  <dd class="It-tag">Deletes the logfile known as <i>name</i>. Further logging
      done to that file is redirected to the default logfile.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>main'usr_log(name, string)</i></dt>
  <dd class="It-tag">Adds an entry to the logfile <i>name</i>. The default
      logfile is known as <i>default</i> and cannot be redefined nor deleted.
      Note that this function is available from the <i>main</i> package. Calling
      it with <i>name</i> set to the string <i>'default'</i> is mostly
      equivalent to calling directly <i>main'add_log</i> with the notable
      exception that the <b>-i</b> mailagent option will not be honored in that
      case. This may or may not be useful to you.</dd>
</dl>
<div class="Pp"></div>
If you call <i>&amp;main'usr_log</i> with a non-existent logfile name, logging
  is redirected to the default system-wide logfile defined in your
  <i>~/.mailagent</i>.
<h2 class="Ss" title="Ss" id="Dynamically_Loading_New_Code"><a class="selflink" href="#Dynamically_Loading_New_Code">Dynamically
  Loading New Code</a></h2>
In you perl routines (user-defined commands, perl hooks, etc...), you may feel
  the need to dynamically load some new code into mailagent. You have direct
  access to the internal routine used by mailagent to implement the REQUIRE
  command or load your new filtering commands for example.
<div class="Pp"></div>
Using the so-called <i>dynload</i> interface buys you some extra features:
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">The mailagent public library path is automatically
      prepended to the @INC array, which lets you define your own system-wide or
      private perl library files (the private library path is defined by the
      <i>perlib</i> configuration variable, the public library path was defined
      at installation time).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Like perl's <i>require</i>, mailagent keeps track of which
      files were loaded into which packages and will not reload the same file in
      the same package twice.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">It is possible to make sure that a specific function be
      defined in the loaded file, with an error reported if this is not the
      case.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">You benefit from the default logging done by <i>dynload</i>
      when some error occurs.</dd>
</dl>
<div class="Pp"></div>
In order to do all this, you call: <i>&amp;dynload'load(package, file,
  function)</i> specifying the package into which you wish to load the file, and
  optionally the name of a function that must be defined once the file has been
  loaded (leave this field to <i>undef</i> if you do not have such a
  constraint). The routine returns <i>undef</i> if the file cannot be loaded
  (non-existent file, most probably), <b>0</b> if the file was loaded but
  contained a syntax error or did not define the specified function, and
  <b>1</b> for success.
<h2 class="Ss" title="Ss" id="Using_Once_Commands"><a class="selflink" href="#Using_Once_Commands">Using
  Once Commands</a></h2>
The ONCE constructs lets you specify a given command to be run once every period
  (day, week...). The command is identified by a <i>name</i> and a <i>tag</i>,
  the combination of the two being unique. Why not just a single identifier?
  Well, that would be fine, but assume you want to send a message in reply to
  someone once every week. You could use the e-mail address of the person as the
  command identifier. But what if you also want to send another message to the
  same address, this time once a month?
<div class="Pp"></div>
Here is a prototypical usage of a ONCE, which acts like the vacation program,
  excepted that it sends a reply only once a day for a given address: { ONCE
  (%r, message, 1d) MESSAGE ~/.message }; This relies on the macro substitution
  mechanism to send only once a day the message held in <i>~/.message</i>. Do
  not use the tag <i>vacation</i>, unless you know what you are doing: this is
  the tag used internally by mailagent in vacation mode. Recall that no selector
  nor pattern is understood as &quot;Subject: *&quot;, hence the rule is always
  executed because that pattern always matches.
<div class="Pp"></div>
The timestamps associated with each commands are kept in files under the Hash
  directory. The name is used as a hashing key to compute the name of the file
  (the two first letters are used). Inside the file, timestamps are sorted by
  name, then by tag. Of course, you could say (inverting tag and name): { ONCE
  (message, %r, 1d) MESSAGE ~/.message }; but that would be likely to be less
  efficient, as the first hashing would be done on a fixed word, hence all the
  timestamps would be located in the file <i>Hash/m/e</i> (where <i>Hash</i> is
  the name of your hashing directory, which is the <i>hash</i> parameter in the
  configuration file).
<h2 class="Ss" title="Ss" id="Using_Tags_in_Record_and_Unique"><a class="selflink" href="#Using_Tags_in_Record_and_Unique">Using
  Tags in Record and Unique</a></h2>
Both the RECORD and UNIQUE commands let you specify a comma-separated tag list
  between '(' and ')'. For each tag present in the list, there is a separate
  entry in the database associated with the message ID. When the message is
  recorded for at least one of the tags, the command &quot;fails&quot;. Not
  specifying any tags means looking for any occurrence of that message ID,
  whether it is tagged or not.
<div class="Pp"></div>
This is very useful when receiving mail cross-posted to distinct mailing lists
  and you want to save one instance of the message in each folder, but still
  guard against duplicates. You may say: To Cc: unix-wizards	{ 	UNIQUE
  (wizards); 	SAVE wizards; 	REJECT; }; To Cc: majordomo-users	{ 	UNIQUE
  (majordomo); 	SAVE majordomo; 	REJECT; }; and only one instance of the message
  will end up in each folder. When you have folders with conflicting interests,
  you might use a tag list, instead of a single tag. For instance, assuming you
  wish to keep a single copy for messages cross-posted to both <i>dist-users</i>
  and <i>agent-users</i>, but have a separate copy if also cross-posted to
  <i>majordomo-users</i>, then say: To Cc: majordomo-users	{ 	UNIQUE
  (majordomo); 	SAVE majordomo; 	REJECT; }; To Cc: dist-users { 	UNIQUE (dist,
  agent); 	SAVE dist-users; 	REJECT; }; To Cc: agent-users { 	UNIQUE (dist,
  agent); 	SAVE dist-users; 	REJECT; }; If you have some rule using UNIQUE
  without any tags, it will match when at least one instance of the message has
  been recorded, no matter what tag (if any at all) was used in the first place.
<h2 class="Ss" title="Ss" id="Specifying_A_Period"><a class="selflink" href="#Specifying_A_Period">Specifying
  A Period</a></h2>
The period parameter of the ONCE commands or the <i>vacperiod</i> parameter of
  your configuration file has the following format: a number followed by a
  modifier. The modifier is an atomic period like a day or a week, the number is
  the number of atomic periods the final period should be equal to. The
  available modifiers are:
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag">m</dt>
  <dd class="It-tag">minute</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">h</dt>
  <dd class="It-tag">hour (60 minutes)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">d</dt>
  <dd class="It-tag">day (24 hours)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">w</dt>
  <dd class="It-tag">week (7 days)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">M</dt>
  <dd class="It-tag">month (30 days)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">y</dt>
  <dd class="It-tag">year (365 days)</dd>
</dl>
<div class="Pp"></div>
All the periods are converted internally in seconds, although you do not really
  care... Examples of valid periods range from &quot;1m&quot; to
  &quot;136y&quot; on a 32 bits machine (why ?).
<h2 class="Ss" title="Ss" id="Timeouts"><a class="selflink" href="#Timeouts">Timeouts</a></h2>
In order to avoid having a <i>mailagent</i> waiting for a command forever, a
  maximum execution time of one hour is allowed by default. Past that amount of
  time, the child is sent a SIGTERM signal. If it does not die within the next
  30 seconds, a SIGKILL is sent. Output from the program, if any so far, is
  mailed back to the user. This default behaviour may be altered by setting a
  proper <i>runmax</i> variable in your configuration file to allow more time
  for the command to complete.
<div class="Pp"></div>
There is also a <i>filter</i> queue timeout. In order to moderate system load,
  the C <i>filter</i> program waits 60 seconds by default (or whatever
  <i>queuewait</i> was set to in the config file) before launching
  <i>mailagent</i>. To avoid conflicts, messages queued by the first filter
  (which will then sleep for <i>queuewait</i> seconds) are not processed by
  <i>mailagent</i>'s <b>-q</b> option until they are at least <i>queuehold</i>
  seconds old. Another queue-related parameter is <i>queuelost,</i> the amount
  of seconds after which <i>mailagent</i> will flag messages as &quot;lost&quot;
  when listing the queue.
<div class="Pp"></div>
Finally, the locking timeout policy may also be configured. By default, a lock
  is broken when it is one hour old (configured by the <i>lockhold</i> variable)
  and <i>mailagent</i> will only make <i>lockmax</i> attempts, spaced by
  <i>lockdelay</i> seconds to acquire the lock. It will then proceed whether or
  not it got that lock. If you want a secure locking policy, make sure
  <i>lockmax</i> times <i>lockdelay</i> is greater than <i>lockhold</i>, that
  parameter being &quot;large&quot; enough.
<h2 class="Ss" title="Ss" id="Avoiding_Loops"><a class="selflink" href="#Avoiding_Loops">Avoiding
  Loops</a></h2>
The <i>mailagent</i> leaves an &quot;X-Filter:&quot; header on each filtered
  message, which in turn is used to detect loops. If a message already filtered
  is to be processed, the <i>mailagent</i> enters a special state _SEEN_. This
  state is special in the sense it is built-in, it is not matched by ALL, and
  some actions are not made available, namely: BACK, BOUNCE, FEED, FORWARD,
  GIVE, NOTIFY, PASS, PIPE, POST, PURIFY, QUEUE and RUN. Also note that although
  the ONCE and SELECT constructs are enabled, they will not let you execute
  disallowed commands. Otherwise, the _SEEN_ state behaves like any other state
  you can select or negate, so a &lt;!_SEEN_&gt; guard will not select the rule
  when we are in state _SEEN_.
<div class="Pp"></div>
The _SEEN_ state makes it easy to deal with mails which loop because of an alias
  loop you have no control on. If no action is found in the _SEEN_ state, the
  mail is left in the mailbox, as usual. Moreover, if no saving is done, a LEAVE
  is executed. This is the normal behavior.
<div class="Pp"></div>
The &quot;X-Filter:&quot; header is only added when the message is saved.
  Actions such as PIPE or GIVE do not flag the message as being saved and
  therefore they do <b>not</b> add that header line. You can add one via
  ANNOTATE if you wish to prevent loops, in case the program to which you are
  feeding the message might return it to you in some strange way.
<h2 class="Ss" title="Ss" id="Message_Files"><a class="selflink" href="#Message_Files">Message
  Files</a></h2>
The text of the message to be sent back (for MESSAGE or NOTIFY) is read from a
  file and passed through the macro substitution mechanism. The special macro
  <i>%T</i> is set to the date of last modification made on that file. The
  format is <i>month/day</i>, and the year is added before the month only if it
  differs from the current year.
<div class="Pp"></div>
At the head of the message, you may put header lines. Those lines will overwrite
  the default supplied lines. That may be useful to change the default subject
  or add some additional fields like the name of your organization. The end of
  your header is given by the first blank line encountered. If the top of the
  message you wish to send looks like a mail header, you may protect it by
  adding a blank line at the very top of the file. This dummy line will be
  removed from the message and the whole file will be sent as a body part.
<div class="Pp"></div>
Here is an example of a vacation file. We add a carbon copy as well as the name
  of our organization in the header: Cc: ram Organization: %o Precedence: bulk
<div style="height: 1.00em;">&#x00A0;</div>
[Last revision made on %T]
<div style="height: 1.00em;">&#x00A0;</div>
Dear %N:
<div style="height: 1.00em;">&#x00A0;</div>
I've received your mail regarding &quot;%R&quot;. It will be read as soon as I
  come back from vacation.
<div style="height: 1.00em;">&#x00A0;</div>
Sincerely, -- %U &lt;%u@%C&gt;
<h1 class="Sh" title="Sh" id="VACATION_MODE"><a class="selflink" href="#VACATION_MODE">VACATION
  MODE</a></h1>
When it's time to take some vacation, it is possible to set up mailagent in
  vacation mode. Every <i>vacperiod</i>, the message <i>vacfile</i> will be sent
  back to the user (with macros substitutions) if the user is explicitly listed
  in the <i>To</i> or <i>Cc</i> field and if the sender is not a special user (
  <i>root</i>, <i>uucp</i>, <i>news</i>, <i>daemon</i>, <i>postmaster</i>,
  <i>newsmaster</i>, <i>usenet</i>, <i>Mailer-Daemon</i>, <i>Mailer-Agent</i> or
  <i>nobody</i>). Matches are done in a case insensitive manner, so
  <i>MAILER-DAEMON</i> will also be recognized as a special user. Furthermore,
  any message tagged with a <i>Precedence:</i> field set to <i>bulk</i>,
  <i>list</i> or <i>junk</i> will not trigger a vacation message. This built-in
  behavior can of course be overloaded by suitable rules (by testing and issuing
  the vacation message yourself via MESSAGE).
<div class="Pp"></div>
Internally, mailagent uses a ONCE command tagged <i>(%r, vacation,
  $vacperiod)</i>. This implies you must not use the <i>vacation</i> tag in your
  own ONCE commands, unless you know what you are doing.
<div class="Pp"></div>
Besides, the vacation message is sent only if no &quot;VACATION off&quot;
  commands were issued, or if another &quot;VACATION on&quot; overwrote the
  previous one. Note that whether a rule matched or not is irrelevant to the
  algorithm. By default, of course, the vacation message is allowed when the
  <i>vacation</i> configuration parameter is set to <i>on</i>.
<div class="Pp"></div>
If you are not pleased by the fact that a vacation message is sent to people who
  addressed you a carbon copy only, then you may write at the top of your rule
  file: Cc: ram { VACATION off; REJECT }; Of course, you have to substitute your
  own login name in place of <i>ram</i>. You cannot use the same scheme to allow
  vacation messages to special users like <i>root</i>, because the test for
  &quot;specialness&quot; occurs after the vacation mode flag. This is construed
  as a feature as it prevents stupid mistakes, like using <i>r*</i> instead of
  <i>ram</i> in the previous rule.
<div class="Pp"></div>
You may also want to setup a different vacation message, meant only for people
  in your organization given the sensitive nature of the information revealed
  ;-). A simple way of doing that is: From: /^\w+$/, /^\w+@\w+$/,
  /^[\w.-]+@.*\.hp\.com$/i 	{ VACATION ~/.hp_vacation 1w; REJECT HP }; Assuming
  the domain of my organization is <i>.hp.com</i> and that messages not bearing
  any domain are local messages, the above rule sets up the file
  <i>~/.hp_vacation</i>, sent once a week, for all HP employees.
<div class="Pp"></div>
The VACATION command will not let you change the message path (but will allow
  frequency changes anyway) when the <i>vacfixed</i> configuration variable is
  set to ON. This is meant to be used in emergency situations, when only one
  vacation message will fit. For instance, when you are on a sick leave, a
  simple trigger message to your mailagent from home could change your
  <i>~/.mailagent</i> configuration to force the <i>~/.i_am_sick</i> message,
  regardless of what the various rules have to say. Actually, this is precisely
  why this feature was added, amazing... :-)
<h1 class="Sh" title="Sh" id="VARIABLES"><a class="selflink" href="#VARIABLES">VARIABLES</a></h1>
The following variables are paid attention to: they may come from the
  environment or be set in the rule file:
<dl class="Bl-tag">
  <dt class="It-tag"><i>mailfilter</i></dt>
  <dd class="It-tag">indicates where loaded patterns are to be looked for, if
      the name of the file is not fully qualified. If it is not set,
      <i>maildir</i> will be used instead. If <i>maildir</i> is not set either,
      the home directory is used.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>maildir</i></dt>
  <dd class="It-tag">is the location of your mail folders. Any relative path is
      understood as starting from <i>maildir</i>. If it is not set,
      <i>~/Mail</i> is used.</dd>
</dl>
<div class="Pp"></div>
Those variables remain active while in the scope of the rule file. Should an
  alternate rule file be used (via rules hook or the APPLY command), the current
  values are propagated to the new rule set unless overridden in the alternate
  rule file. In any case, the previous value is restored when control is
  transferred back to the previous set of rules. That is, those variables are
  dynamically instead of statically scoped.
<h1 class="Sh" title="Sh" id="AUTOMATIC_ACKNOWLEDGMENTS"><a class="selflink" href="#AUTOMATIC_ACKNOWLEDGMENTS">AUTOMATIC
  ACKNOWLEDGMENTS</a></h1>
Anywhere in the mail, there can be an @RR left-justified line which will send
  back an acknowledgment to the sender of the mail. The @RR may optionally be
  followed by an address, in which case the acknowledgment will be sent to that
  address instead. In fact (but let's keep that a secret), this is a way for me
  to be able to see who runs my mailagent program and who doesn't...
<div class="Pp"></div>
The <i>sendmail</i> program usually implements such a feature via a
  Return-Receipt-To: header line, which sends the whole header back upon
  successful delivery. However, this is not implemented on all mail transport
  agents, and @RR is a good alternative :-).
<h1 class="Sh" title="Sh" id="NOTA_BENE"><a class="selflink" href="#NOTA_BENE">NOTA
  BENE</a></h1>
Throughout this manual page, I have always written header fields with the first
  letter of each word uppercased, as in <i>Return-Receipt-To</i>. But RFC-822
  does not impose this spelling convention, and a mailer could legally rewrite
  the previous field as <i>return-receipt-to</i> (and in fact so does
  <i>sendmail</i> in its own private mail queue files).
<div class="Pp"></div>
However, you must always specify the headers in what could be called a
  <i>normalized</i> case (for headers anyway). The mailagent will correctly
  recognize <i>cc:</i>, <i>CC:</i> or <i>Cc:</i> in a mail message and will
  allow you to select those fields via the normalized <i>Cc:</i> selector. In
  fact, it operates the normalization for you, and a <i>cc:</i> selector would
  not be recognized as such. Of course, no physical alteration is ever made on
  the header itself.
<div class="Pp"></div>
This is also true for headers specified in the STRIP or KEEP command. If you
  write <i>STRIP Cc</i>, it will correctly remove any <i>cc:</i> line. Likewise,
  if you use regular expressions to specify a selector, <i>Re.*:</i> would match
  both original <i>received:</i> and <i>Return-path:</i> fields, internally
  known through their normalized representation.
<h1 class="Sh" title="Sh" id="MAIL_HOOKS"><a class="selflink" href="#MAIL_HOOKS">MAIL
  HOOKS</a></h1>
The mail hooks allow mailagent to transparently invoke some scripts or perform
  further processing on the message. Those hooks are activated via the SAVE,
  STORE or LEAVE commands. Namely, saving in a folder whose executable bit is
  set will raise a special processing. By default, the folder is taken as a
  program where the mail should be piped to. If the &quot;folder&quot; program
  returns a zero status, then the message is considered <i>saved</i> by the
  mailagent. Otherwise, all the processing attached to failed save commands is
  started (including emergency saving attempts). Executable folders provide a
  transparent way (from the rule file point of view) to deal with special kind
  of messages.
<div class="Pp"></div>
In fact, five different types of hooks are available. The first one is the plain
  executable folder we have just spoken about. But in fact, here is what really
  happens when a saving command detects an executable folder: the mailagent
  scans the first line of the folder (in fact, the first 128 bytes) and looks
  for something starting with #: and followed by a single word, describing a
  special kind of hook. This is similar in the way the kernel deals with the #!
  hook in executable programs. If no #: is found or #: is followed by some
  garbage, then <i>mailagent</i> decides it is a simple program and feeds the
  mail message to this program. End of the story.
<div class="Pp"></div>
But if the #: token is followed (spaces allowed, case is irrelevant) by one of
  the following words, then special actions are taken:
<dl class="Bl-tag">
  <dt class="It-tag"><i>rules</i></dt>
  <dd class="It-tag">The file holds a set of mailagent rules which are to be
      applied. A new mailagent process is created to actually deal with those
      and the exit status is propagated back to the original mailagent.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>audit</i></dt>
  <dd class="It-tag">This is similar in spirit to what Martin Streicher's
      audit.pl package does, hence the name of this hook. The special variables
      which are set up by the PERL filter commands are initialized and the
      script is loaded in the special <i>mailhook</i> package name space, which
      also gives you an interface to the mailagent's own routines. You may
      safely use the <i>exit</i> function here, since an extra <i>fork</i> is
      done. This is the only difference between an <i>audit</i> and a
      <i>perl</i> hook.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>deliver</i></dt>
  <dd class="It-tag">Same thing as for the <i>audit</i> hook, but the standard
      output of your script is monitored by <i>mailagent</i> and understood as
      mailagent filtering commands. Upon successful return, a mailagent process
      will be invoked to actually execute those commands on the message. Again,
      this is similar in spirit to Chip Salzenberg's <i>deliver</i> package and
      gave the name of this hook.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>perl</i></dt>
  <dd class="It-tag">This hook is the same as <i>audit</i> but it is executed
      without forking a new mailagent, and you have the perl interface to
      mailagent's filtering commands. There is no difference with the PERL
      command, because it is implemented that way, by calling a mailagent and
      forcing the PERL command to be executed. This is similar in spirit to
      Larry Wall's famous <i>perl</i> language and it is responsible for the
      name of this hook :-).</dd>
</dl>
<div class="Pp"></div>
As mentioned earlier in this manual page, the hook is invoked from with the
  <i>home</i> directory specified in your ~/.mailagent (which may differ from
  your real home directory, as far as <i>mailagent</i> or <i>mailhook</i> are
  concerned).
<div class="Pp"></div>
For those hooks which are finally ran by perl, the special @INC array has
  mailagent's own private library path prepended to it, so that <i>require</i>
  first looks in this place.
<h1 class="Sh" title="Sh" id="FOLDERS"><a class="selflink" href="#FOLDERS">FOLDERS</a></h1>
A folder is a file or a directory which can be the target of a delivery by the
  mailagent, that is to say the argument of SAVE-like commands.
<h2 class="Ss" title="Ss" id="Folder_Format"><a class="selflink" href="#Folder_Format">Folder
  Format</a></h2>
By default, mails are written into folders according to the standard UNIX-style
  mailbox format: each mail starts with a leading <i>From</i> line bearing the
  sender's address and the date. However, by setting the <i>mmdf</i> parameter
  from the <i>~/.mailagent</i> to ON, the <i>mailagent</i> will be able to save
  messages in MMDF format: each message is sandwiched between two lines of four
  Ctrl-A characters (ASCII code 1) and the leading <i>From</i> line is removed.
<div class="Pp"></div>
When MMDF mode is activated, each folder will be scanned to see if it is a
  UNIX-style or MMDF-style mailbox and the message will be saved accordingly.
  When saving to a new folder, the default is to create a UNIX-style mailbox,
  unless the <i>mmdfbox</i> configuration variable was set to ON, in which case
  the MMDF format prevails.
<div class="Pp"></div>
Note that the MMDF format is also the standard for MH packed folders, so by
  enabling the MMDF mode, you can actually deliver directly to those packed
  folders. The MH command <i>inc</i> is able to incorporate mail from either
  form anyway, i.e. it does not matter whether the folder is in UNIX format
  (also called UUCP-style) or in MMDF format.
<div class="Pp"></div>
MH-style folders are also supported. It is mainly a directory in which messages
  are stored in individual files. To save directly into an MH folder, simply
  prefix the folder name with '+', just as you would do with MH commands. The
  unseen sequences specified in your MH profile (the <i>mhprofile</i> parameter
  in your <i>~/.mailagent</i>, default is <i>~/.mh_profile</i>) will be
  correctly updated, as <i>rcvstore</i> would.
<div class="Pp"></div>
When the target folder is a directory, mailagent attempts the delivery in an
  individual numbered file. If a prefix file is present (config parameter
  <i>msgprefix</i>, default is <i>.msg_prefix</i>), its first line is used to
  specify the base name of the message, then a number is appended to give the
  name of the message file to use. That is, if there is no such file, the folder
  will look like an MH one, without any MH sequence file though.
<h2 class="Ss" title="Ss" id="Folder_Compression"><a class="selflink" href="#Folder_Compression">Folder
  Compression</a></h2>
If you have one or more of the widely available file compression utilities such
  as <i>compress</i> or <i>gzip</i> in your PATH (as set up by
  <i>~/.mailagent</i>), then you may wish to use folder compression to save some
  disk space, especially when you are away for some time and do not want to see
  your mail fill-up the filesystem.
<div class="Pp"></div>
To achieve folder compression, you have to set up a file, referred to by the
  <i>compress</i> configuration variable. This file must list folder names, one
  per line, with blank lines ignored and shell-style (#) comments allowed. You
  may use shell-style patterns to specify the folders, and the match will be
  attempted on the full pathname of the folder (~ substitution occurs). If you
  do not specify a pattern starting with a leading '/' character, then the match
  will be attempted on the basename of the folder (i.e. the last component of
  the folder path). If you want to compress all your folders, then simply put a
  single '*' inside this file.
<div class="Pp"></div>
Mailagent uses the filename extension to determine what compression scheme is
  used for a particular folder. The file referred to by the <i>compspecs</i>
  configuration variable (default is $spool/compressors) is used to define the
  commands that mailagent will use to perform the compress, uncompress, and cat
  operations for a particular extension.
<div class="Pp"></div>
The <i>compressors</i> file holds lines of the following form: <i>tag extension
  compression_prog uncompress_prog cat_prog</i> where:
<dl class="Bl-tag">
  <dt class="It-tag"><i>tag</i></dt>
  <dd class="It-tag">is the logical name for the compression scheme. This is
      typically the same as the name of the program used to provide the
      compression, but could be different for some unforeseen reason. This must
      be unique across all records in the file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>extension</i></dt>
  <dd class="It-tag">is the extension to recognize as belonging to the specified
      tag. This must be unique across all records in the file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>compression_prog</i></dt>
  <dd class="It-tag">is the name of the command to run to compress a folder. The
      program must replace the uncompressed file with the compressed one with
      the extension appended to the filename (like <i>compress</i> or
      <i>gzip</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>uncompression_prog</i></dt>
  <dd class="It-tag">is the name of the command to run to uncompress a folder.
      The program must replace the compressed file with the uncompressed one
      without the extension (like <i>uncompress</i> or <i>gunzip</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>cat_prog</i></dt>
  <dd class="It-tag">is the name of the command to output the uncompressed
      contents of a compressed folder to stdout (like <i>zcat</i> or
      <i>gzcat</i>).</dd>
</dl>
<div class="Pp"></div>
The fields are separated by <b>TABS</b> to allow for the use of space characters
  in the command fields.
<div class="Pp"></div>
If the file referred to by the <i>compspecs</i> configuration variable cannot be
  accessed for whatever reason, a default entry is hard-wired into mailagent
  (knows about both <i>compress</i> and <i>gzip</i> programs): compress
  &lt;TAB&gt; .Z &lt;TAB&gt; compress &lt;TAB&gt; uncompress &lt;TAB&gt; zcat
  gzip &lt;TAB&gt; .gz &lt;TAB&gt; gzip &lt;TAB&gt; gunzip &lt;TAB&gt; gunzip -c
<div class="Pp"></div>
If you wish to add more compressors, you can copy the default <i>compressors</i>
  file from mailagent's private library directory and setup a correct entry for
  your alternate compressor. Keep in mind that the trailing extension needs to
  be unique amongst all the listed programs, since that extension is used to
  determine the type of compression performed on the folder.
<div class="Pp"></div>
If the folder is created without any existing compressed form around, a default
  compressor is selected for you, as defined by the <i>comptag</i> configuration
  variable. That refers to the tag name of the <i>compspecs</i> file, i.e. the
  first word on the line (usually the name of the compression program, but not
  necessarily).
<div class="Pp"></div>
When attempting delivery, mailagent will check the folder name against the list
  of patterns in the compress file. If there is a match, the folder is flagged
  as compressed. Then mailagent attempts decompression if there is already a
  compressed form (ie. the file has a recognized filename extension) and if no
  uncompressed form is present. Delivery is then made to the uncompressed
  folder. However, re-compression is not done immediately, since it is still
  possible to get messages to that folder in a single batch delivery. Should
  disk space become so tight that decompression of other folders is impossible,
  mailagent will re-compress the folders it has already uncompressed. Otherwise,
  it waits until the last moment.
<div class="Pp"></div>
If for some reason there is a compressed folder which cannot be decompressed,
  mailagent will deliver the mail to the plain folder. Further delivery to that
  folder will be faced with both a compressed and a plain version of the folder,
  and that will get you a warning in the log file, but delivery will be made
  automatically to the plain file.
<div class="Pp"></div>
On newly created folders the <i>comptag</i> configuration variable is referenced
  to determine the compression type to use for the folder.
<h1 class="Sh" title="Sh" id="MAIL_BIFFING"><a class="selflink" href="#MAIL_BIFFING">MAIL
  BIFFING</a></h1>
If you are receiving and processing mail on your own machine, then you have
  access to local mail biffing where <i>mailagent</i> can warn you about new
  messages and tell you about where they have been saved, printing a small
  subset of the header and the first few lines of the body.
<div class="Pp"></div>
To use biffing, all you need is the setting of the few biff parameters in your
  <i>~/.mailagent</i> and make sure <i>biff</i> is set to ON. Actually, this is
  the only parameter you need to set to get minimal default biffing behaviour.
  Don't forget to run the shell command &quot; <i>biff y</i>&quot; on the
  terminals where you want to get notification (you may do that on several ttys,
  one for each virtual display for instance).
<div class="Pp"></div>
Upon mail reception and saving on a folder or posting to a newsgroup,
  <i>mailagent</i> locates all the ttys where you are logged on, then selects
  those where biffing was requested, finally emitting a message and making a
  beeping sound (if your terminal supports this and you are using the standard
  format--see below).
<h2 class="Ss" title="Ss" id="Customizing_Biffing_Output"><a class="selflink" href="#Customizing_Biffing_Output">Customizing
  Biffing Output</a></h2>
Should the default format not suit your needs, you may customize the biffing
  message freely, setting the <i>biffmsg</i> parameter to point to the file
  where the format is stored. Standard macros substitutions will be performed on
  your message, the following macro set superseding and completing the standard
  set:
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag">%-A</dt>
  <dd class="It-tag">Same as writing %-H, new line, %-B</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%-B</dt>
  <dd class="It-tag">The body part of the biffing message, with
      content-transfer-encoding removed. If the message is a MIME multipart one,
      the text/plain part is shown. If only a text/html part is available, the
      HTML markup is stripped for biffing.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%-H</dt>
  <dd class="It-tag">The header part of the biffing message. If shows only
      From:, To: Subject: and Date: headers, or whatever you have set the
      <i>biffhead</i> configuration variable to. All headers are showed as one
      line of text, regardless of their actual length. There will be three
      trailing dots at the end to signal that truncation occurred. For a news
      article (biffing after a POST -b), the To: and Cc: fields are never shown,
      even if specified in <i>biffhead</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%-T</dt>
  <dd class="It-tag">Same as %-B, but trimming is activated. The purpose of
      trimming is to remove any leading quotation in the message, to get only
      the most meaningful part. This assumes the quoting character is a single
      non-alphanumeric character. The leading attribution line that may
      introduce the quotation can be also removed, and a minimum length for the
      quotation can be set in the configuration file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%B</dt>
  <dd class="It-tag">The relative path under %d of the message folder, full path
      (%p) if not saved under that directory. The newsgroup name for news
      articles.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%D</dt>
  <dd class="It-tag">The directory where the message is stored. If an MH folder,
      this is the folder full path. The home directory is replaced by a ~. Empty
      for news articles.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%F</dt>
  <dd class="It-tag">The base name (last path component) of the message. For an
      MH message, this is the message number. Empty for news articles.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%P</dt>
  <dd class="It-tag">The folder path. It has the correct semantics for MH and
      directory folders, i.e. it points to the folder directory itself.
      Otherwise, the same as %p.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%a</dt>
  <dd class="It-tag">Alarm characters (^G). May expand to more than one under
      the control of the BEEP filtering command. Use %b if you only want a
      single bell.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%b</dt>
  <dd class="It-tag">A beeping character (^G). As opposed to %a, this only
      expands to give <b>one</b> bell.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%d</dt>
  <dd class="It-tag">Full path where folders such as the one being saved into
      are stored if not qualified (i.e. your MH path for MH folders, of
      something like <i>~/Mail</i> for other folders). Empty for news
    articles.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%f</dt>
  <dd class="It-tag">Folder where mail was saved, home replaced by ~ for short.
      The newsgroup when article was posted for news.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%m</dt>
  <dd class="It-tag">A '+' sign if the folder is an MH one, empty
    otherwise.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%p</dt>
  <dd class="It-tag">The full path name (same as %f) of the message, but without
      any ~ shortcut. The newsgroup name for news articles.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">%t</dt>
  <dd class="It-tag">The type of message: usually &quot;mail&quot;, but set to
      &quot;article&quot; for biffing after a POST command.</dd>
</dl>
<div class="Pp"></div>
You can get the standard macro expansion by using <i>%:f</i> for instance, since
  the <i>%f</i> macro is superseded. The <i>%:</i> form lets you obtain the
  standard macro definition anyway, no matter what, so you don't have to
  remember whether a given macro is superseded in this context or not. Besides,
  it is safer since new macros may be added here without notice. Note that
  macros related to the message content all start with <i>%-</i> and therefore
  are not conflicting with standard one.
<div class="Pp"></div>
Here is the format you need to use to get the same behaviour as the default
  hardwired format: %b New %t for %u has arrived in %f: ---- %-A ----%b Note
  that the string <i>...more...</i> appears at the end of the body when it has
  not been completely printed out on the screen and the remaining lines are not
  blank or similar.
<h2 class="Ss" title="Ss" id="Trimming_Leading_Quotation"><a class="selflink" href="#Trimming_Leading_Quotation">Trimming
  Leading Quotation</a></h2>
It is a standard practice, when replying to a message, to include an excerpt of
  the sentences being replied-to, using a non-alphanumeric character such as
  '&gt;' to prefix quoted lines. Something like: Quoting John Doe: &gt; This is
  quoted material. &gt; Another line from John's mail.
<div style="height: 1.00em;">&#x00A0;</div>
This is part of the reply to John. The leading &quot;Quoting ...&quot; line,
  called the <i>attribution</i> line, is optional and may be missing or take
  another free form.
<div class="Pp"></div>
However, when biffing, this may be seen as useless noise, especially nowadays
  where people freely quote more and more in their replies. Since the biff
  message only shows the top lines of the message, it may be desirable to
  automatically trim those quoted lines.
<div class="Pp"></div>
Via the <i>%-T</i> macro in the customized biff format, you may request trimming
  of the leading quotation material, keeping the attribution line or not, and
  even replace trimmed material with a notification that so many lines have been
  removed.
<div class="Pp"></div>
All this customization is done from the <i>~/.mailagent</i> configuration file,
  using the <i>bifftrim</i>, <i>bifftrlen</i> and <i>biffquote</i> variables.
<div class="Pp"></div>
You first need to turn trimming on by using a customized biff format using the
  <i>%-T</i> macro. By setting <i>bifftrlen</i> to 3, you may request that only
  quotations of at least 3 lines be trimmed. Turning <i>bifftrim</i> off will
  remove the trimming notification, whilst turning <i>biffquote</i> off will
  also strip the attribution line, when present.
<div class="Pp"></div>
For instance, assuming the following settings: bifftrim : ON bifftrlen: 2
  biffquote: OFF then the above example would produce the following biffing
  output (header of the message not withstanding): [trimmed 3 lines starting
  with a leading '&gt;' character &amp; attribution line] This is part of the
  reply to John. because the blank line following the quoted material is counted
  as being part of the quotation. The &quot;[trimmed ..]&quot; message can be
  turned off by setting <i>bifftrim</i> to OFF.
<div class="Pp"></div>
The trimming algorithm considers the first line of the body to see if it starts
  with a non-alphanumeric character. If it does, then all the following lines
  starting with that same character, or any blank line is removed, up to the
  first non-blank line starting with another character. Optionally, the first
  line (and that line only) is skipped if the second one starts with a
  non-alphanumeric character, and the first line is taken as being the
  attribution line.
<h2 class="Ss" title="Ss" id="Using_Compact_MH-style_Biffing"><a class="selflink" href="#Using_Compact_MH-style_Biffing">Using
  Compact MH-style Biffing</a></h2>
The so-called <i>MH-style</i> biffing is a way of presenting a compacted body
  where all the lines are joined together into a big happy string with
  successive spaces turned into a single space character. To enable it, you need
  to set the <i>biffmh</i> variable to ON.
<div class="Pp"></div>
Since this compacting is output verbatim on the tty, line breaks will occur
  randomly and this may make reading difficult. You may request an automatic
  reformatting of the compacted body by turning <i>biffnice</i> to ON and the
  biff output will fit nicely within the terminal.
<div class="Pp"></div>
Unfortunately, it is not possible to customize the amount of columns that should
  be used for formatting: since you may biff to any tty you are logged on, that
  would force <i>mailagent</i> to probe the tty for its column size, for each
  possible tty where output may go, and there is no reliable portable way of
  doing that. Sorry.
<h1 class="Sh" title="Sh" id="EXTENDING_FILTERING_COMMANDS"><a class="selflink" href="#EXTENDING_FILTERING_COMMANDS">EXTENDING
  FILTERING COMMANDS</a></h1>
Once you've reached the <i>expert</i> level, and provided you have a fair
  knowledge of <i>perl</i>, you may feel the need for more advanced commands
  which are not part of the standard set. This section explains how you can
  achieve this dynamically, without the need of diving deep inside the source
  code.
<div class="Pp"></div>
Once you have extended the filtering command set, you may use those commands
  inside the rule file as if they were built-in. You may even choose to redefine
  the standard commands if they do not suit you (however, if you wish to do
  that, you should know exactly what you are doing, or you may start losing some
  mail or get an unexpected behavior -- this also voids your warranty :-).
<div class="Pp"></div>
The ability to provide external commands without actually modifying the main
  source code is, I believe, a strong point in favor of having a program written
  in an interpreted language like <i>perl</i>. This of course once you have
  convinced yourself that it is a Good Thing to customize and extend a program
  in the same language as the one used for the core, meaning usually a fairly
  low-level language with fewer user-friendly hooks.
<h2 class="Ss" title="Ss" id="Overview"><a class="selflink" href="#Overview">Overview</a></h2>
In order to implement a new command, say FOLD, you will need to do the
  following:
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Write a perl subroutine to implement the FOLD action and
      put that into an external file. Say we write the subroutine <i>fold</i>
      and we store that in a <i>fold.pl</i> file. This is naturally the
      difficult part, where you need to know some basic things about mailagent
      internals.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Choose where you want to store your <i>fold.pl</i> file.
      Then check the syntax with <i>perl -c</i>, just to be sure...</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Edit the <i>newcmd</i> file (as given by the configuration
      file) to record your new command. Then make sure this file is tightly
      protected. You must own it, and it should not be writable by any other
      individual but you.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Additionally, you may want to specify whether FOLD is to
      modify the existing execution status and whether or not it will be allowed
      within the special _SEEN_ state.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Write some rules using the new FOLD command. This is the
      <i>easy</i> part! Note that your command may also be used within perl
      hooks as if it were a builtin command (this means there is an interface
      function built for you within the <i>mailhook</i> package).</dd>
</dl>
<div class="Pp"></div>
In the following sections, we're going to describe the syntax of the
  <i>newcmd</i> file, and we'll then present some low-level internal variables
  which may be used when implementing new commands.
<h2 class="Ss" title="Ss" id="New_Command_File_Format"><a class="selflink" href="#New_Command_File_Format">New
  Command File Format</a></h2>
The <i>newcmd</i> file consists of a series of lines, each line describing one
  command. Blank lines are ignored and shell-style comments introduced by the
  sharp (#) character are allowed.
<div class="Pp"></div>
Each line is formed by 3 principal fields and 2 optional ones; fields are
  separated by spaces or tabs. Here is a skeleton: &lt;cmd_name&gt; &lt;path&gt;
  &lt;function&gt; &lt;status_flag&gt; &lt;seen_flag&gt; The <i>cmd_name</i> is
  the name of the command you wish to add. In our previous example, it would be
  FOLD. The next field, <i>path</i>, tells mailagent where the file containing
  the command implementation is located. Say we store it in
  <i>~/mail/cmds/fold.pl</i>. The <i>function</i> field is the name of the
  <i>perl</i> function implementing FOLD, which may be found in <i>fold.pl</i>.
  Here, we named our function <i>fold</i>. Note that if your function has its
  name within the <i>newcmd</i> package, which is the default behavior if you do
  not specify any, then there is no need to prefix the function name with the
  package. Otherwise, you must use a fully qualified name.
<div class="Pp"></div>
The last two fields are optional, and are boolean values which may be specified
  by <i>true</i> or <i>yes</i> to express truth, and <i>false</i> or <i>no</i>
  to express falsehood. If <i>status_flag</i> is set to true, then the command
  will modify the last execution status variable. If <i>seen_flag</i> is true,
  then the command may be used when the filter is in _SEEN_ state. The default
  values are respectively <i>true</i> and <i>false</i>.
<div class="Pp"></div>
So in our example, we would have written: FOLD ~/mail/cmds/fold.pl fold no yes
  to allow FOLD even in _SEEN_ state and have it executed without modifying the
  current value of the <i>last-command-status</i> variable.
<h2 class="Ss" title="Ss" id="Writing_An_Implementation"><a class="selflink" href="#Writing_An_Implementation">Writing
  An Implementation</a></h2>
Your perl function will be loaded when needed into the special package
  <i>newcmd</i>, so that its own name-space is protected and does not
  accidentally conflict with other mailagent routines or variables. When you
  need to call the perl interface of some common mailagent functions, you will
  have to remember to use the fully qualified routine name, for instance
  <i>&amp;mailhook'leave</i> to actually execute the LEAVE command.
<div class="Pp"></div>
(Normally, in PERL hooks, there is no need for this prefixing since the perl
  script is loaded in the <i>mailhook</i> package. When you are extending your
  mailagent, you should be extra careful however, and it does not really hurt to
  use this prefixing. You are free to use the perl <i>package</i> directive
  within your function, hence switching to the <i>mailhook</i> package in the
  body of the routine but leaving its name in the <i>newcmd</i> package.)
<div class="Pp"></div>
Since mailagent will dynamically load the implementation of your command the
  first time it is run, by loading the specified perl script into memory and
  evaluating it, I suggest you put each command implementation in a separate
  file, to avoid storing potentially unneeded code in memory.
<div class="Pp"></div>
Each command is called with one argument, namely the full command string as read
  from the filter rules. Additionally, the special <i>@ARGV</i> array is set by
  performing a shell-style parsing of the command line (which will fail if
  quotes are mismatched, but then you can do the parsing by yourself since you
  get the command line). At the end of your routine, you must return a failure
  status, i.e. <b>0</b> for success and <b>1</b> to signal failure.
<div class="Pp"></div>
Those are your only requirements. You are free to do whatever you want inside
  the routine. To ease your task however, some variables are pre-computed for
  you, the same ones that are made available within mail hooks, only they are
  defined within the <i>newcmd</i> package this time. There are also a few
  special variables which you need to know about, and a set of standard routines
  you may want to call. Please avoid calling something which is not documented
  here, since it may change without prior notice. If you would like to use one
  routine and it is not documented in this manual page, please let me know.
<div class="Pp"></div>
Each command is called from within an <i>eval</i> construct, so you may safely
  use <i>die</i> or call external library routines that use <i>die</i>. If you
  use <i>require</i>, be aware that mailagent is setting up a special
  <i>@INC</i> array by putting its private library path first, so you may place
  all your <i>mailagent</i>-related library files in this place.
<h2 class="Ss" title="Ss" id="Special_Variables"><a class="selflink" href="#Special_Variables">Special
  Variables</a></h2>
The following special variables (some of them marked read-only, meaning you
  shouldn't modify them, and indeed you can't) made available directly within
  the <i>newcmd</i> package, are pre-set by the filter automaton, and are used
  to control the filtering process:
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$mfile</i></dt>
  <dd class="It-tag">The base name of the mail file being processed. This
      variable is read-only. It is mainly used in log messages, as in [$mfile]
      to tag each log, since a single mailagent process may deal with multiple
      messages.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$ever_saved</i></dt>
  <dd class="It-tag">This is a boolean, which should be <i>set</i> to <b>1</b>
      once a successful saving operation has been completed. If at the end of
      the filtering, this variable is still <b>0</b>, then the default LEAVE
      will be executed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$folder_saved</i></dt>
  <dd class="It-tag">The value of that variable governs the <i>$msgpath</i>
      convenience variable set for PERL escapes. It is updated whenever a
      message is written to a file, to hold the path of the written file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$cont</i></dt>
  <dd class="It-tag">This is the continuation status, a variable of the utmost
      importance when dealing with the control flow. Four constants from the
      <i>main</i> package can be used to specify whether we should continue with
      the current rule ($FT_CONT), abandon current rule ($FT_REJECT), restart
      filtering from the beginning ($FT_RESTART) or simply abort processing
      ($FT_ABORT). More on this later.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$lastcmd</i></dt>
  <dd class="It-tag">The last failure status recorded by the last command (among
      those which do modify the execution status). You should not have to update
      this by yourself unless you are implementing some encapsulation for other
      commands, like BACK or ONCE, since by default <i>$lastcmd</i> will be set
      to the value you return at the end of the command.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>$wmode</i></dt>
  <dd class="It-tag">This records the current state of the filter automaton
      (working mode), in a literal string form, typically modified by the BEGIN
      command or as a side effect, as in REJECT for instance.</dd>
</dl>
<div class="Pp"></div>
All the special variables set-up for PERL escapes are also installed within the
  <i>newcmd</i> package. Those are <i>$login</i>, <i>%header</i>, etc... You may
  peruse them at will.
<div class="Pp"></div>
Other variables you might have a need for are configuration parameters, held in
  the <i>~/.mailagent</i> configuration file. Well, the rule is simple. The
  value of each parameter <i>param</i> from the configuration file is held in
  variable <i>$cf'param</i>. Variable <i>$main'loglvl</i> is the copy of
  <i>$cf'level</i>, since it's always shorter to type in <i>$'loglvl</i> after
  each call to the logging routine <i>&amp;add_log</i>.
<div class="Pp"></div>
There is one more variable worth knowing about: <i>$main'FILTER</i>, which is
  the suitable X-Filter line that should be appended in <b>all</b> the mail you
  send via mailagent, in order to avoid loops. Also when you save mails to a
  folder, it's wise adding this line in case a problem arises: you may then
  identify the culprit.
<h2 class="Ss" title="Ss" id="Rule_Environment"><a class="selflink" href="#Rule_Environment">Rule
  Environment</a></h2>
An action might have a legitimate desire of altering the environment for the
  scope of one rule only, reverting to the previous value when exiting the rule.
  Or you might want to change the value forever.
<div class="Pp"></div>
When we speak about altering the environment, we refer to the one set up via the
  configuration file, whose values end-up in the <i>cf</i> package. Well, some
  of those variables are copied in the <i>env</i> package before filtering of a
  message starts (under the control of the <i>@env'Env</i> array).
<div class="Pp"></div>
All rules should then refer to the version in the <i>env</i> package, and not in
  the <i>cf</i> package, to see alterations. Global changes are made by
  affecting directly to the variable in the <i>env</i> package, while local
  changes are requested by calling the <i>&amp;env'local</i> routine.
<div class="Pp"></div>
For instance, the <i>cf'umask</i> value is copied as <i>env'umask</i> because
  <i>umask</i> is held in <i>@env'Env</i>. Global changes are made by setting
  that copy directly, while local changes may be made with:
  	&amp;env'local('umask', 0722); to set-up a new local value. The first time
  <i>&amp;env'local</i> is called on a variable, its value is saved somewhere,
  and will be restored upon exiting the scope of the rule. Then the new value is
  affected to the variable.
<div class="Pp"></div>
Variables requiring a side effect when their value is changed (such as the umask
  variable, which requires a system call to let the kernel see the change) may
  specify it by accessing the <i>%env'Spec</i> array, the key being the name of
  the variable requiring a side effect, the value being interpreted as a bit of
  perl code ran once the original value is restored. For instance, we say
  somewhere (in <i>&amp;env'init</i>): 	package env; 	$Spec{'umask'} =
  'umask($umask)'; to update the kernel view when leaving scope. Note that the
  side effect is evaluated once the variable has recovered its original value,
  and within the <i>env</i> package.
<div class="Pp"></div>
Internally, the <i>&amp;analyze_mail</i> routine calls <i>&amp;env'setup</i>
  before starting its processing to initialize the <i>env</i> package, and
  <i>&amp;env'cleanup</i> at the end before returning. Before running the
  actions specified on a rule match, <i>&amp;apply_rules</i> calls
  <i>&amp;env'restore</i> to ensure a coherent view of the environment while
  running the actions for that particular rule.
<h2 class="Ss" title="Ss" id="Altering_Control_Flow"><a class="selflink" href="#Altering_Control_Flow">Altering
  Control Flow</a></h2>
When you want to alter control flow to perform a REJECT, a RESTART or an ABORT,
  you have three choices. If you wish to control that action via an option, the
  same way the standard UNIQUE does (with <b>-c</b>, <b>-r</b> or <b>-a</b>),
  you may call <i>&amp;main'alter_execution(option, state)</i> giving it two
  parameters: the option letter and the state you wish to change to before
  altering the control flow.
<div class="Pp"></div>
You may also want to directly alter the <i>$wmode</i> and <i>$cont</i>
  variables, but then you'll have to do your own logging if you want some. Or
  you may call low-level routines <i>&amp;main'do_reject</i>,
  <i>&amp;main'do_restart</i> and <i>&amp;main'do_abort</i> to perform the
  corresponding operation (with logging).
<div class="Pp"></div>
Remember that the _SEEN_ state is special and directly handled at the filter
  level, and the filter begins in the INITIAL state. The default action is to
  continue with the current rule, which is why there is no routine to perform
  this task.
<div class="Pp"></div>
The preferred way is to invoke the <i>mailhook</i> interface functions,
  <i>&amp;mailhook'begin</i>, <i>&amp;mailhook'reject</i>, etc..., and that will
  work even if you redefine those functions yourself. Besides, that's the only
  interface which is likely not to be changed by new versions.
<h2 class="Ss" title="Ss" id="General_Purpose_Routines"><a class="selflink" href="#General_Purpose_Routines">General
  Purpose Routines</a></h2>
The following is a list of all the general routines you may wish to call when
  performing some low-level tasks. Note that this information is
  version-dependent. Since I document them, I'll try to keep them in new
  versions, but I cannot guarantee I will not have to slightly change some of
  their semantics. There is a good chance you will never have to worry about
  that anyway.
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;header'format(rfc822-field)</i></dt>
  <dd class="It-tag">Return a formatted RFC822 field to fit in 78 columns, with
      proper continuations introduced by eight spaces.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;header'normalize(rfc822-header-name)</i></dt>
  <dd class="It-tag">Normalize case in RFC822 header and return the new header
      name with every first letter uppercased.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;header'reset</i></dt>
  <dd class="It-tag">This is part of an RFC822 header validation, mainly used
      when splitting a digest. This resets the recognition automaton (see
      &amp;header'valid).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;header'valid(line)</i></dt>
  <dd class="It-tag">Returns a boolean status, indicating if all the lines given
      so far to this function since the last <i>&amp;header'reset</i> are part
      of a valid RFC822 header. The function understands the first From line
      which is part of UNIX mails. At any time, the variable
      <i>$header'maybe</i> may be checked to see if so far we have found at
      least one essential mail header field.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'acs_rqst(file)</i></dt>
  <dd class="It-tag">Perform a .lock locking on the file, returning 0 on success
      and -1 on failure. If an old lock was present, it is removed (time limit
      set to one hour). Use <i>&amp;main'free_file</i> to release the lock.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'add_log(string)</i></dt>
  <dd class="It-tag">Add the <i>string</i> to the logfile. The usual idiom is to
      postfix that call with the <i>if $'loglvl &gt; value</i>, where
      <i>value</i> is the logging level you wish to have before emitting that
      kind of log ( <i>$'loglvl</i> is a short form for
    <i>$main'loglvl</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'free_file(file)</i></dt>
  <dd class="It-tag">Remove a .lock on a file, obtained by
      <i>&amp;main'acs_rqst</i>. It returns 0 if the lock was successfully
      removed, -1 if it was a stale lock (obtained by someone else).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'header_found(file)</i></dt>
  <dd class="It-tag">Scan the head of a file and try to determine whether there
      is a mail header at the beginning or not. Return true if a header was
      found.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'history_record</i></dt>
  <dd class="It-tag">Record the message ID of the current message and return 0
      if the message had not been previously seen, 1 if it is a duplicate.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'hostname</i></dt>
  <dd class="It-tag">Return the value of the hostname, lowercased, with possible
      domain name appended to it. The hostname is cached, since its value must
      initially be obtained by forking. (see also
    <i>&amp;main'myhostname</i>)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'internet_info(email-address)</i></dt>
  <dd class="It-tag">Parse an e-mail internet address and return a three-element
      array containing the host, the domain and the country part of the internet
      host. For instance, if the address is <i>user@d.c.b.a</i>, it will return
      <i>(c, b, a)</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'login_name(email-address)</i></dt>
  <dd class="It-tag">Parse the e-mail internet address and return the login
      name.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'macros_subst(*line)</i></dt>
  <dd class="It-tag">Perform in-place macro substitution (line passed as a type
      glob) using the information currently held in the <i>%main'Header</i>
      array. Do <i>not</i> pass <i>*_</i> as a parameter, since internally
      <i>macros_subst</i> uses a local variable bearing that name to perform the
      substitutions and you would end up with an unmodified version. If you
      really want to pass <i>*_</i>, then you must use the returned value from
      <i>macros_subst</i> which is the substituted text, but that's less
      efficient than having it modified in place.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'makedir(pathname, mode)</i></dt>
  <dd class="It-tag">Make directory, creating all the intermediate directories
      needed to make <i>pathname</i> a valid directory. Has no effect if the
      directory already exists. The mode parameter is optional, 0700 is used
      (octal number) if not specified.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'myhostname</i></dt>
  <dd class="It-tag">Returns the hostname of the current machine, without any
      domain name. The hostname is cached, since its value must initially be
      obtained by forking.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'run_command(filter-command)</i></dt>
  <dd class="It-tag">Execute the single filter command specified and return the
      continuation status, which should normally be affected to the <i>$cont</i>
      variable. You will need this routine when trying to implement commands
      which encapsulate other commands, like ONCE or SELECT.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'seconds_in_period(period)</i></dt>
  <dd class="It-tag">Return the number of seconds in the period specified. See
      section <i>Specifying</i> <i>A Period</i> to get valid period
    strings.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'shell_command(program, input,
    feedback)</i></dt>
  <dd class="It-tag">Run a shell command and return a failure status (0 for OK).
      The input parameter may be one of the following constants (defined in the
      <i>main</i> package): $NO_INPUT to close standard input, $BODY_INPUT to
      pipe the body of the current message, $MAIL_INPUT to pipe the whole mail
      as-is, $MAIL_INPUT_BINARY to pipe the whole mail after having removed any
      content transfer-encoding and $HEADER_INPUT to pipe the message header.
      The feedback parameter may be one of $FEEDBACK or $NO_FEEDBACK depending
      whether or not you wish to use the standard output to alter the
      corresponding part of the message. If no feedback is wanted, the output of
      the command is mailed back to the user. The $FEEDBACK_ENCODING is handled
      like $FEEDBACK but will tell mailagent to look at the best suitable body
      encoding when the input is the whole message.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'parse_address(rfc822-address)</i></dt>
  <dd class="It-tag">Parse an RFC822 e-mail address and return a two-elements
      array containing the internet address and the comment part of that
      address.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>&amp;main'xeqte(filter-actions)</i></dt>
  <dd class="It-tag">Execute a series of actions separated by the ';' character,
      calling <i>run_command</i> to actually perform the job. Return the
      continuation status. Note that $FT_ABORT will <i>never</i> be returned,
      since mailagent usually stops after having executed one set of actions,
      only continuing if it saw an RESTART or a REJECT. What ABORT does is
      skipping the remaining commands on the line and exiting as if all the
      commands had been run. You could say <i>xeqte</i> is the equivalent of the
      <i>eval</i> function in perl, since it interprets a little filter script
      and returns control to the caller once finished, and ABORT is perl's
      <i>die</i>.</dd>
</dl>
<div class="Pp"></div>
You may also use the three functions from the <i>extern</i> package which
  manipulate persistent variables (already documented in the section dealing
  with variables) as well as the user-defined macro routines.
<h2 class="Ss" title="Ss" id="Example"><a class="selflink" href="#Example">Example</a></h2>
Writing your own commands is not easy, since it requires some basic knowledge
  regarding mailagent internals. However, once you are familiar with that, it
  should be relatively straightforward.
<div class="Pp"></div>
Here is a small example. We want to write a command to bounce back a mail
  message to the original sender, the way sendmail does, with some leading text
  to explain what happened. The command would have the following syntax:
  SENDBACK <i>reason</i> and we would like that command to modify the existing
  status, returning a failure if the mail cannot be bounced back. Since this
  command actually sends something back, we do not want it to be executed in the
  _SEEN_ state. Here is my implementation (untested): sub sendback {
  	local($cmd_line) = @_; 	local($reason) = join(' ', @ARGV[1..$#ARGV]); 	unless
  (open(MAILER, &quot;|/usr/lib/sendmail -odq -t&quot;)) {
  		&amp;'add_log(&quot;ERROR cannot run sendmail to send message&quot;) 			if
  $'loglvl; 		return 1; 	} 	print MAILER &lt;&lt;EOF; From: mailagent To:
  $header{'Sender'} Subject: Returned mail: Mailagent failure $main'FILTER
<div style="height: 1.00em;">&#x00A0;</div>
<br/>
 --- Transcript Of Session
<div style="height: 1.00em;">&#x00A0;</div>
$reason
<div style="height: 1.00em;">&#x00A0;</div>
<br/>
 --- Unsent Message Follows
<div style="height: 1.00em;">&#x00A0;</div>
$header{'All'} EOF 	close MAILER; 	$ever_saved = 1;	# Don't want it in mailbox
  	$? == 0 ? 0 : 1;	# Failure status } Assuming this command is put into
  ~/mail/cmds/sendback.pl, the line describing it in the <i>newcmd</i> file
  would be: SENDBACK ~/mail/cmds/sendback.pl sendback yes no Now this command
  may be used freely in any rule, and will be logged as a user-defined command
  by the command dispatcher. Who said it was not easy to do? :-)
<div class="Pp"></div>
Note the use of the $ever_saved variable to mark the mail as saved once it has
  been bounced. Indeed, should the SENDBACK action be the only one action to be
  run, we do not want mailagent to LEAVE the mail in the mailbox because it has
  never been saved (this default behavior being a precaution only -- better safe
  than sorry).
<h2 class="Ss" title="Ss" id="Conclusion"><a class="selflink" href="#Conclusion">Conclusion</a></h2>
If along the way you imagine some useful commands which could be made part of
  the standard command set, please e-mail them to me and I'll consider
  integrating them. In the future, I would also like to provide a standard
  library of perl scripts to implement some weird commands which could be needed
  in special cases.
<div class="Pp"></div>
Note that you may also use the information presented here inside the perl escape
  scripts. Via the <i>require</i> operator, it is easy to get the new command
  implementation into your script and perform the same task. You will maybe need
  to set up @ARGV by yourself if you rely on that feature in your command
  implementation.
<div class="Pp"></div>
Command extension can also be viewed as a way to reuse some other perl code, the
  mailagent providing a fixed and reliable frame and the external program
  providing the service. One immediate extension would be mailing list handling,
  using this mechanism to interface with some mailing list management software
  written in perl.
<h1 class="Sh" title="Sh" id="GENERIC_MAIL_SERVER"><a class="selflink" href="#GENERIC_MAIL_SERVER">GENERIC
  MAIL SERVER</a></h1>
One nice thing about mailagent is that it provides you with the basic tools to
  implement a generic mail server. Indeed, via the SERVER command, you can
  process a mail message, extract and then execute some predefined commands. For
  instance, you may implement an archive server, or a mailing list manager,
  etc...
<div class="Pp"></div>
The major limitation currently is that only plain commands are accepted, or
  commands taking some additional info as <i>standard input</i> or equivalent.
  There is no notion of modes, with separate command sets for each mode or
  limited name-space visibility, at least for now, so it is not easy (albeit
  possible) to implement an ftpmail server, for instance, since this implies the
  notion of mode.
<h2 class="Ss" title="Ss" id="Overview"><a class="selflink" href="#Overview">Overview</a></h2>
In order to implement a mail server command (say send <i>file</i>, which would
  send an arbitrary file from the file system in a separate mail message), you
  need to do the following:
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Think about the command from a security point of view.
      Here, the command we want to implement is a potentially dangerous one
      since it can give access to any file on the machine the individual running
      <i>mailagent</i> has access to. So we want to restrict that command to a
      limited number of trusted people, who will be granted the <i>power</i> to
      run this command. More on this later.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Choose whether you want to implement the command in perl or
      in another programming language. If you do the latter, your command will
      be known as a <i>shell</i> command (i.e. a command runnable directly from
      a shell), while in the former case, you have the choice of making it
      appear as a <i>shell</i> command, or have it hooked to the
      <i>mailagent</i> in which case it is known as a <i>perl</i> command. In
      that last case, your command will be dynamically loaded into mailagent
      with all the advantages that brings you. Here, we are going to write our
      command as a shell script.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Write the command itself. That's the most difficult part in
      this scheme. Later on, we will see a straightforward implementation of the
      <i>send</i> command.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Edit the <i>comserver</i> file (defined in your
      <i>~/.mailagent</i>) to record your new command. Then make sure this file
      is tightly protected. You must own it, and be the only one allowed to
      modify it.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Additionally, you may want to hide some of the arguments in
      the session transcript (more on this later), allow the command to take a
      flow of data as its <i>standard input</i>, assign a path to the command,
      etc... All those parameters take place in your <i>comserver</i> file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Start using the command... which of course is the nicest
      part in this scheme!</dd>
</dl>
<div class="Pp"></div>
In the following sections, we'll learn about the syntax of the <i>comserver</i>
  file, what <i>powers</i> are, how the session transcript is built, what the
  command environment is, etc...
<h2 class="Ss" title="Ss" id="Builtin_Commands_Overview"><a class="selflink" href="#Builtin_Commands_Overview">Builtin
  Commands Overview</a></h2>
The mail server has a limited set of builtin commands, dealing with user
  authentication and command environment settings. User authentication is
  password based and is not extremely strong since passwords are specified in
  clear within the mail message itself, which could be easily intercepted.
<div class="Pp"></div>
The server maintains the notion of <i>powers</i>. One user may have more than
  one power at a time, each power granting only a limited access to some
  sensitive area. A few powers are hardwired in the server, but the user may
  create new ones when necessary. Those powers are software-enforced, meaning
  the command must check for itself whether is has the necessary power(s) to
  perform correctly.
<div class="Pp"></div>
Powers are protected by a password and a clearance file. Having the good
  password is not enough, you have to be cleared in order to (ab)use it. The
  clearance file is a list of e-mail address patterns, using the shell
  metacharacters scheme, someone being cleared if and only if his e-mail address
  matches at least one of the patterns from the clearance file. The more use you
  will make of metacharacters, the weaker this clearance scheme will be, so be
  careful.
<div class="Pp"></div>
Your commands and the output resulting from their execution is normally mailed
  back to you as a session transcript. For security reasons, passwords are
  hidden from the command line. Likewise, failure to get a power will not
  indicate whether you lacked authorization or whether your password was bad.
<div class="Pp"></div>
A user with the <i>system</i> power is allowed to create new powers, delete
  other powers, change power passwords, and list, remove or change power
  clearances. This is somehow an important power which should be detained by a
  small number of users with very strict clearance (no meta-characters in the
  address, if possible). A good password should also protect that power.
<div class="Pp"></div>
However, a user with the <i>system</i> power is not allowed to directly get
  another power without specifying its password and being allowed to do so by
  the associated clearance file. But it would be possible to achieve that
  indirectly by removing the power and creating a new one bearing the same name.
  In order to control people with the <i>system</i> power and also for some
  tricky situation, there is another more god-like power: the <i>root</i> power.
<div class="Pp"></div>
A user with the <i>root</i> power can do virtually anything, since it instantly
  grants that individual <i>all</i> the powers available on the server (but
  <i>security</i>). The only limitation is that <i>root</i> cannot remove the
  <i>root</i> power alone. One needs to specify the <i>security</i> password
  (another hardwired power) in order to proceed. Needless to say, only
  <b>one</b> individual should have both <i>root</i> and <i>security</i>
  clearance, and only one individual should know the <i>security</i> password
  and be listed in the clearance file. The <i>system</i> power cannot harm any
  of those two powers. Eventually, more than one user could have the <i>root</i>
  power, but do not grant that lightly...
<div class="Pp"></div>
Getting the <i>root</i> power is necessary when <i>system</i> has messed with
  the system configuration in an hopeless way, or when a long atomic sequence of
  commands has to be issued: <i>root</i> is not subject to the maximum number of
  command that can be issued in one single message.
<div class="Pp"></div>
In case you think this <i>mailagent</i> feature is dangerous for your account,
  do not create the <i>root</i> and <i>security</i> powers, and do not write any
  sensitive commands.
<h2 class="Ss" title="Ss" id="Builtin_Commands_Definition"><a class="selflink" href="#Builtin_Commands_Definition">Builtin
  Commands Definition</a></h2>
Now let's have a look at those builtin commands. Passwords of sensitive commands
  will be concealed in the session transcript. Some commands accept input by
  reading the mail message up to the <i>EOF</i> marker, which is a simple EOF
  string on a line by itself (analogous with shell's <i>here</i>
  <i>documents</i>).
<div style="height: 1.00em;">&#x00A0;</div>
<dl class="Bl-tag">
  <dt class="It-tag"><i>addauth power password</i></dt>
  <dd class="It-tag">Add users to clearance file for <i>power</i>. If the power
      password is given, no special power is needed, otherwise the <i>system</i>
      power is required. For <i>root</i> or <i>security</i> powers, the
      corresponding power is required, or the <i>password</i> must be specified.
      The command reads the standard input up to the EOF marker to get the new
      users.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>approve password command</i></dt>
  <dd class="It-tag">Records the password in the command environment, then
      executes the command. If a power is required and not yet obtained, the
      command will look for the password in the environment and try to get the
      relevant power using that password. Hence, approved command (with proper
      password) will transparently execute without the hassle of requesting the
      power, issuing the command and then releasing the power. It is up to the
      command to perform the <i>approve</i> password test by looking at the
      <i>approve</i> variable in the command environment (see below). Since
      clearance checks (such as those performed when requesting a power) are not
      performed, no sensitive command should ever deal with the <i>approve</i>
      construct.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>delpower power password [security]</i></dt>
  <dd class="It-tag">Delete a power from the system, and its associated
      clearance list. The <i>system</i> power is required to delete most powers
      except <i>root</i> and <i>security</i>. The <i>security</i> power may only
      be deleted by itself and the <i>root</i> power may only be deleted when
      the <i>security</i> password is also specified.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>getauth power password</i></dt>
  <dd class="It-tag">Get current clearance file for a given power. No special
      power required if the password is given or the power is already detained.
      Otherwise, the system power is needed for all powers but <i>root</i> or
      <i>security</i> where the corresponding power is mandatory.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>newpower power password [alias]</i></dt>
  <dd class="It-tag">Add a new power to the system. The command then reads the
      standard mail input until the EOF marker to get the power clearance list.
      The <i>system</i> power is required to create a new power, unless it's
      <i>root</i> or <i>security</i>: The <i>security</i> power is required to
      create <i>root</i> and the <i>root</i> power is required to create
      <i>security</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>passwd power old new</i></dt>
  <dd class="It-tag">Change power password. It does not matter if you already
      hold the corresponding power, you must give the proper old password. See
      also the <i>password</i> command.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>password power new</i></dt>
  <dd class="It-tag">Change power password. The corresponding power is required,
      or you have to get the <i>system</i> power. To change the <i>root</i> or
      <i>security</i> passwords, you need the corresponding power.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>power name password</i></dt>
  <dd class="It-tag">Ask for a new power. Of course, <i>root</i> does not need
      to request for any other power but <i>security</i>, less give any
      password. This command is not honored when the server is not in trusted
      mode, unbeknownst to the user: the error message in the transcript file is
      no different from the one obtained with an invalid password.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>powers regexp</i></dt>
  <dd class="It-tag">List all the powers matching the perl regular expression,
      along with their respective clearance file. The <i>system</i> power is
      required to get the list. The <i>root</i> or <i>security</i> power are
      required to get access to the <i>root</i> or <i>security</i> information,
      respectively. If no arguments are given, all the powers are listed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>release power</i></dt>
  <dd class="It-tag">Get rid of some power.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>remauth power password</i></dt>
  <dd class="It-tag">Remove users from clearance file, getting the list by
      reading the standard mail input until the EOF marker. This command does
      not require any special power if the proper password is given or if the
      power is already detained. Otherwise, the <i>system</i> power is needed.
      For <i>root</i> and <i>security</i> clearance, the corresponding power is
      needed as well.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>set variable value</i></dt>
  <dd class="It-tag">Set the variable to the corresponding value. Useful to
      alter internal variables like the EOF marker value, or change some command
      environment. The user may define his own variables for his commands. For
      <i>flag</i>-type variable, a value of <i>on</i>, <i>yes</i> or <i>true</i>
      sets the variable to <i>1</i>, any other string sets it to <i>0</i>
      (false). Used all by itself as <i>set</i>, the list of all the defined
      variables along with their respective values is returned.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>setauth power password</i></dt>
  <dd class="It-tag">Replace power clearance file with one obtained from
      standard mail input up to the EOF mark. The <i>system</i> power is needed
      unless you specify the proper password or the power is already yours. As
      usual, <i>root</i> or <i>security</i> clearances can only be changed when
      the power is detained.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>user [e-mail [command]]</i></dt>
  <dd class="It-tag">Execute command by assuming the e-mail identity specified.
      Powers are lost while executing the command. The e-mail identity may be
      checked by the command itself, which may impose further restrictions on
      the execution, like getting user-defined powers. Note that this command
      only modifies the global environment, and that it's up to the
      <i>command</i> implementation to make use of that information. If no
      command is specified, the new identity is assumed until changed by another
      <i>user</i> command and all the powers currently held by the user are
      released. If no <i>e-mail</i> address is given, the original user ID is
      restored.</dd>
</dl>
<h2 class="Ss" title="Ss" id="Command_Environment"><a class="selflink" href="#Command_Environment">Command
  Environment</a></h2>
There are six types of commands and variables that can be specified in server
  mode. Two of them, <i>end</i> and <i>help</i> types are special and handled
  separately. Two types <i>var</i> and <i>flag</i> refer to variables and the
  last two types <i>perl</i> and <i>shell</i> refer to commands.
<div class="Pp"></div>
Whenever mailagent fires a server command, it sets up an environment for that
  command: if it is a <i>perl</i>-type command, then a set of perl variables are
  set before loading the command; if it is a <i>shell</i>-type command, some
  environment variables are initialized and file descriptor #3 is set up to
  point directly to the mailagent session transcript.
<div class="Pp"></div>
A <i>shell</i>-type command is forked, whilst a <i>perl</i>-type command is
  loaded directly in <i>mailagent</i> within the <i>cmdenv</i> package. This
  operates much like the PERL filtering command, only the target package differs
  and a distinct set of variables is preset.
<div class="Pp"></div>
Some commands collect additional data up to an end-of-file marker (by default
  the string <b>EOF</b> on a line by itself) and those data are fed to shell
  commands via <i>stdin</i> and to perl commands via the <i>@buffer</i> variable
  set up in the environment package named <i>cmdenv</i> (in which the command is
  loaded and run).
<div class="Pp"></div>
If you define your own variables (types <i>var</i> or <i>flag</i>), you may use
  the builtin <i>set</i> command to modify their values. Note that no default
  value can be provided when defining your variable. A suitable default value
  must be set within commands making use of them, with the advantage that
  different default values may be used by different commands.
<div class="Pp"></div>
The following <i>environment</i> variables are defined. Most are read-only,
  unless notified otherwise, in which case the builtin <i>set</i> command may be
  used on them.
<dl class="Bl-tag">
  <dt class="It-tag"><i>approve</i></dt>
  <dd class="It-tag">The approve password for <i>approve</i> commands, empty if
      not within a builtin <i>approve</i> construct.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>auth</i></dt>
  <dd class="It-tag">A flag set to true when a valid envelope was found in the
      mail message. When this flag is false, the server cannot be put in trusted
      mode.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>cmd</i></dt>
  <dd class="It-tag">The command line, as written in the message.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>collect</i></dt>
  <dd class="It-tag">Internal flag set to true while collecting input from a
      here-document. It is normally reset to false before calling the
    command.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>debug</i></dt>
  <dd class="It-tag">True when debug mode is activated (may be set).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>disabled</i></dt>
  <dd class="It-tag">A comma separated list of disabled commands, with no space
      between them. This is initialized when the SERVER command is invoked and
      the <b>-d</b> option is used.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>eof</i></dt>
  <dd class="It-tag">The current end-of-file marker for here-document commands.
      By default set to 'EOF' (may be changed).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>errors</i></dt>
  <dd class="It-tag">Number of errors so far.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>jobnum</i></dt>
  <dd class="It-tag">The job number assigned to the current mailagent.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>log</i></dt>
  <dd class="It-tag">What was logged in the transcript, with some args possibly
      concealed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>name</i></dt>
  <dd class="It-tag">The command name.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>pack</i></dt>
  <dd class="It-tag">Packing mode for file sending (may be set).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>path</i></dt>
  <dd class="It-tag">Destination address for file sending or notification (may
      be set).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>powers</i></dt>
  <dd class="It-tag">A colon (:) separated list of powers the user currently has
      successfully requested and got.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>requests</i></dt>
  <dd class="It-tag">Number of requests processed so far.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>trace</i></dt>
  <dd class="It-tag">True when shell commands want to be traced in transcript
      (may be set).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>trusted</i></dt>
  <dd class="It-tag">True when server is in trust mode, where powers may be
      gained. This is activated by the <b>-t</b> option of the SERVER command,
      provided a valid mail envelope was found.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>uid</i></dt>
  <dd class="It-tag">Address of the sender of the message, where transcript is
      to be sent. By extension, the real user ID for the server, which is the
      base of the power clearance mechanism.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>user</i></dt>
  <dd class="It-tag">The effective user ID, originally the same as the uid, but
      may be changed via the <i>user</i> builtin command.</dd>
</dl>
<h2 class="Ss" title="Ss" id="Session_Transcript"><a class="selflink" href="#Session_Transcript">Session
  Transcript</a></h2>
A session transcript is mailed back automatically to the user who requested a
  server access. This transcript shows the commands ran by the user and their
  status: <i>OK</i> or <i>FAILED</i>. Between those two lines, the transcript
  show any output explicitly made by the command to the transcript. Typically,
  the transcript may be used to forward error messages back to the user, but
  even commands executing correctly may want to issue an explicit message,
  stating what has just been done.
<div class="Pp"></div>
A perl command may access the transcript via the <i>MAILER</i> file handle,
  defined in the <i>cmdenv</i> package, whilst a shell command may access it via
  its file descriptor #3.
<div class="Pp"></div>
Note that the session transcript is mailed to the <i>sender</i> of the message,
  i.e. whoever the envelope header line says it is. As far as the server is
  concerned, this e-mail address is used as the user ID, just like a plain login
  name can be thought of as the user id. For sensitive commands, authentication
  based on that information is really weak. A more &quot;secure&quot;
  authentication is provided by the server powers, which is password-based.
  Unfortunately, the clear password has to be transmitted in the message itself
  and could be eavesdropped.
<h2 class="Ss" title="Ss" id="Recording_New_Commands_and_Variables"><a class="selflink" href="#Recording_New_Commands_and_Variables">Recording
  New Commands and Variables</a></h2>
Server commands and variables are defined in the <i>comserver</i> file defined
  in your <i>~/.mailagent</i>. The format of the file is that of a table with
  items on a row separated by tabs characters. Each line defines one command or
  variable. Any irrelevant field may be entered as a single '-' (minus)
  character. The format allows for shell-style (#) comments.
<div class="Pp"></div>
Each row has the following fields: <i>name type hide collect-data path extra</i>
  where:
<dl class="Bl-tag">
  <dt class="It-tag"><i>name</i></dt>
  <dd class="It-tag">is the name of the command or variable as recognized by the
      server.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>type</i></dt>
  <dd class="It-tag">is one of <i>perl</i>, <i>shell</i>, <i>var</i>,
      <i>flag</i>, <i>help</i> or <i>end</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>hide</i></dt>
  <dd class="It-tag">indicates which arguments in the command are to be hidden
      (the command name being argument zero) in the session transcript. Use '-'
      if no arguments need to be hidden. Typically, this is used to hide clear
      passwords in commands. If more than one argument has to be hidden, then a
      list of numbers separated by a ',' (comma) may be specified, with <b>no
      spaces</b> between them. For instance '2,4' would hide arguments 2 and 4
      in the transcript.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>collect-data</i></dt>
  <dd class="It-tag">is a flag (specify as either 'y' or 'n', but you may use
      complete words 'yes' or 'no') indicating whether the command collects
      additional data in a here-document until the EOF marker. Alternatively,
      you may specify '-' in place of 'n'.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>path</i></dt>
  <dd class="It-tag">specifies the path of the command (~name substitution
      allowed). If not relevant (e.g. when defining a variable) or when you want
      to leave it blank, use '-'. If a blank path is specified for a <i>perl</i>
      or <i>shell</i> command, then the implementation of that command is
      expected to be found in <i>servdir</i>, as defined in <i>~/.mailagent</i>.
      If the command name is <i>cmd</i> for instance, then perl command are
      expected there in a file named <i>cmd</i> of <i>cmd.pl</i>, whereas shell
      commands are expected to be found in a <i>cmd</i> of <i>cmd.sh</i> file.
      Note that a command is disabled if it cannot be located at the time the
      <i>comserver</i> file is parsed.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>extra</i></dt>
  <dd class="It-tag">is any extra parameter needed for the command. Unlike other
      fields, this should be left blank if not needed. Anything up to the end of
      the line is grabbed by this field. Perl commands should specify the name
      of the perl function to call to execute the command; if none is specified,
      the name of the command itself is called. Shell commands may use that
      field to supply additional options, which will be inserted right after the
      command name and before any other user-supplied arguments. Others should
      leave this alone.</dd>
</dl>
<h2 class="Ss" title="Ss" id="Special_Command_Types"><a class="selflink" href="#Special_Command_Types">Special
  Command Types</a></h2>
There are currently two special command types.
<div class="Pp"></div>
The simplest is the <i>end</i> type. This is used to specify commands which may
  end the server processing. By default, processing continues until the end of
  the file is reached or a signature delimiter '--' is found. For instance, you
  may wish to define the command <i>quit</i> and give it the <i>end</i> type. As
  soon as the server reaches that command, it aborts processing and discards the
  remaining of the message.
<div class="Pp"></div>
The <i>help</i> type is usually attached to an <i>help</i> command and prints
  help on a command basis, help for each command being stored under the
  <i>helpdir</i> variable (defined in your ~/.mailagent) in a file bearing the
  same name as the command itself. For example, assuming a command <i>shoot</i>,
  its help file would be expected in <i>helpdir/shoot</i>. If no file is found
  there, mailagent looks in its public library (/usr/share/mailagent) for an
  help file. Help is provided only when the help file exists and is not
  zero-sized.
<h2 class="Ss" title="Ss" id="Creating_the_Root_Power"><a class="selflink" href="#Creating_the_Root_Power">Creating
  the Root Power</a></h2>
In order to bootstrap the server, you need to create the root power. All the
  other powers may then be created by using the server interface, which ensures
  consistency and logs your actions. If you don't plan using powers at all, you
  may skip that section.
<div class="Pp"></div>
First, you need to pick up a good password for the <i>root</i> power. Someone
  with the <i>root</i> power can do virtually anything with the server, so be
  careful. Let's assume you choose <i>root-pass</i> as a password.
<div class="Pp"></div>
Edit <i>passwd</i> (defined in your <i>~/.mailagent</i>) and add the following
  line: root:&lt;root-pass&gt;: i.e. enter the password in clear between '&lt;'
  and '&gt;'. It won't stay in that form for long, but this is the easiest way
  to bootstrap it. Protect the <i>passwd</i> file tightly (read-write
  permissions only for you). Then create a <i>powerdir/root</i> file, protect it
  the same way and add your e-mail address to it, on a line by itself. That
  <b>must</b> be the address that will show up in the <i>From:</i> line of your
  mails. Since clearance files support shell-style patterns, you may use
  <i>login@*domain.top</i> to allow mails from your login from any machine in
  your domain.
<div class="Pp"></div>
You are almost done. Now simply issue the following command: mailagent -i -e
  'SERVER -t' and feed its standard input with: From <i>your e-mail address</i>
  From: <i>your e-mail address</i>
<div style="height: 1.00em;">&#x00A0;</div>
power root root-pass password root root-pass ^D Note that the first <i>From</i>
  line is mandatory here, since it's the envelope on which authentication is
  based. Since we're feeding mailagent with an handcrafted message, we must
  provide a valid envelope or the server will not switch into trusted mode...
<div class="Pp"></div>
The side effect of re-instantiating your password will be to crypt it in the
  <i>passwd</i> file, so that anybody looking at that file cannot guess your
  <i>root</i> password, hopefully.
<div class="Pp"></div>
Once you have a valid <i>root</i> power installed, you may create the
  <i>system</i> power by using <i>newpower</i>. Further powers may then be
  created and deleted using the <i>system</i> power only.
<div class="Pp"></div>
You should also create the <i>security</i> power and give it a different
  password than the <i>root</i> password. This is really needed only if you wish
  to remotely administrate the server. If you have local access and things get
  corrupted, it's always possible to change the root password manually by
  repeating this bootstrapping sequence.
<div class="Pp"></div>
Note that clearance checks are made using the envelope address of the message,
  which is a little harder to forge than plain header fields like
  <i>Sender:</i>. The envelope is extracted by looking at the first header line,
  which on Unix systems looks like: 	From <i>envelope-address send-date</i> and
  is inserted by the mail transport agent (MTA). If you are using
  <i>sendmail</i> as the MTA, then only <i>trusted</i> users declared in the
  <i>sendmail.cf</i> file are able to create a &quot;fake&quot; envelope
  address, a feature typically used by mailing list dispatchers, since that
  address is then used as the bounce target in case the mail cannot be
  delivered. If that first header line is absent, the sender is computed using
  the <i>Sender:</i> field if present, then the <i>From:</i> field, but the
  <i>auth</i> variable is set to false and the server will not switch into
  trusted mode; in other words, it will not be possible to gain powers in that
  session.
<div class="Pp"></div>
Moreover, since the session transcript is sent to that same envelope address
  used to authenticate the eligibility for a power, the server feature can
  hardly be used to retrieve confidential information held at the site where the
  <i>mailagent</i> is run since the information would be sent to one of the
  users cleared for that power. It is the responsibility of you, the user, to
  make sure this cannot happen or you could get into legal troubles.
<div class="Pp"></div>
Finally, sensitive commands should be protected by a proper power, and great
  care should be taken in writing the command implementation to ensure the
  security cannot be circumvented. But no, this mailagent feature is not
  believed to be dangerous for the system or site it is used on, since a
  determined user could implement one trivially via a five line shell script. If
  security is really an issue, <i>.forward</i> files using the piping feature
  should be prohibited and access to <i>cron</i> forbidden in order to avoid
  automatic mail processing (since it would be possible to have cron invoke a
  <i>mailagent</i> process -or any other program for that matter- to process the
  incoming mail in a comparable way).
<h2 class="Ss" title="Ss" id="Example"><a class="selflink" href="#Example">Example</a></h2>
Here is an example showing the steps involved in creating a <i>shell</i>
  command, which would take a script by collecting lines until an EOF mark and
  feed it to a real shell for execution. Since allowing this feature without any
  safeguards would be a real security hole, we protect that by requesting the
  power <i>shell</i> before allowing the execution.
<div class="Pp"></div>
Here is my implementation of the <i>shell</i> command (available in the
  mailagent distribution under <i>misc/shell</i>): #!/bin/sh
<div style="height: 1.00em;">&#x00A0;</div>
# Execute commands from stdin, as transmitted by the mailagent server. # File
  descriptor #3 is a channel to the session transcript.
<div style="height: 1.00em;">&#x00A0;</div>
# Make sure we have the shell power. # Don't even allow the root power to bypass
  that for security reasons. case &quot;:$powers:&quot; in *:shell:*) ;; *)
  	echo &quot;Permission denied.&quot; &gt;&amp;3 	exit 1 	;; esac
<div style="height: 1.00em;">&#x00A0;</div>
# Perhaps a shell was defined... Otherwise, use /bin/sh case &quot;$shell&quot;
  in '') shell='/bin/sh';; esac
<div style="height: 1.00em;">&#x00A0;</div>
# Normally, a shell command has its output included in the transcript only in #
  case of error or when the user requests the trace. Here however, we need to #
  see what happened, so everything is redirected to the session transcript.
<div style="height: 1.00em;">&#x00A0;</div>
exec $shell -x &gt;&amp;3 2&gt;&amp;3
<div class="Pp"></div>
Note how we make access to the <i>$powers</i> and <i>$shell</i> environment
  variable. That last one is user-defined to allow dynamic set-up of a shell.
<div class="Pp"></div>
Assuming we store that command under <i>servdir/shell.sh</i> (don't forget to
  add the execution bit on the file...), here is how we declare it and its
  variable in the <i>comserver</i> file. shell	shell	-	y	- shell	var	-	-	- This
  example shows that there is a separate name-space for variables and commands.
  Moreover, the command bears the same name as its type -- don't let that
  confuse you :-).
<div class="Pp"></div>
Now, assuming you have already created a <i>system</i> power and protected it
  with a password (let's assume <i>sys-pass</i> for the purpose of this
  example), you need to create the shell power. Although you could do it
  manually (like when you handcrafted the <i>root</i> power), it's better to use
  the SERVER interface since it ensures consistency.
<div class="Pp"></div>
In order to create the <i>shell</i> power required to use the newly created
  <i>shell</i> command, you need to add the following rule to your rule file:
  Subject: Server		{ SAVE server; SERVER -t }; which will save all server mail
  in a dedicated folder and process them. Note the <b>-t</b> option, which
  allows trusted mode, in which powers may be gained. Now send yourself the
  following mail: Subject: Server power system sys-pass newpower shell
  shell-pass ram@acri.fr EOF which requests for the <i>system</i> power (needed
  to created most powers), and then creates a new power <i>shell</i>, assigning
  <i>shell-pass</i> as its password and clearing <i>ram@acri.fr</i> for it. Note
  the here-document fill-in for the newpower command, up to the EOF marker. Of
  course, you need to replace the address by your real address.
<div class="Pp"></div>
You will receive a session transcript along these lines:
<br/>
 ---- Mailagent session transcript for ram@acri.fr ----
<div style="height: 1.00em;">&#x00A0;</div>
----&gt; power system ******** OK.
<div style="height: 1.00em;">&#x00A0;</div>
====&gt; newpower shell ******** OK.
<div style="height: 1.00em;">&#x00A0;</div>
====&gt; -- End of processing (.signature)
<div style="height: 1.00em;">&#x00A0;</div>
<br/>
 ---- End of mailagent session transcript ---- Note the concealed passwords, and
  the prompt change once the system power has been granted. Since my mailer
  automatically appends a signature, the processing stops on it.
<div class="Pp"></div>
Now let's use this new command... Send yourself the following mail: Subject:
  Server set shell /bin/ksh set eof END shell ls -l /etc/passwd END power shell
  shell-pass shell ls -l /etc/passwd END If you everything is right, you should
  receive back a transcript looking like this:
<br/>
 ---- Mailagent session transcript for ram@acri.fr ----
<div style="height: 1.00em;">&#x00A0;</div>
----&gt; set shell /bin/ksh OK.
<div style="height: 1.00em;">&#x00A0;</div>
----&gt; set eof END OK.
<div style="height: 1.00em;">&#x00A0;</div>
----&gt; shell Permission denied. Command returned a non-zero status (1).
  FAILED.
<div style="height: 1.00em;">&#x00A0;</div>
----&gt; power shell ******** OK.
<div style="height: 1.00em;">&#x00A0;</div>
====&gt; shell + ls -l /etc/passwd -rw-r--r-- 1 root system 691 Oct 01 14:24
  /etc/passwd OK.
<div style="height: 1.00em;">&#x00A0;</div>
====&gt; -- End of processing (.signature)
<div style="height: 1.00em;">&#x00A0;</div>
<br/>
 ---- End of mailagent session transcript ---- The first invocation of the
  <i>shell</i> command fails since we lack the <i>shell</i> power. The string
  &quot;Permission denied.&quot; is echoed by the command itself into file
  descriptor #3 and makes it to the transcript.
<h2 class="Ss" title="Ss" id="Conclusion"><a class="selflink" href="#Conclusion">Conclusion</a></h2>
The generic mail server implemented in mailagent can be used to implement a
  mailing list manager, a vote server, an archive server, etc... Unfortunately,
  it does not currently have the notion of state, with a command set dedicated
  to each state, so it is not possible to implement an intelligent archive
  server.
<div class="Pp"></div>
If you implement new simple server commands and feel they are generic enough to
  be contributed, please send them to me and I will gladly integrate them.
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="selflink" href="#EXAMPLES">EXAMPLES</a></h1>
Here are some examples of rule files. First, if you do not specify a rule file
  or if it is empty, the following built-in rule applies: All: /^Subject:
  [Cc]ommand/ { LEAVE; PROCESS }; Every mail is left in the mailbox. Besides,
  mail with &quot;Subject: Command&quot; anywhere in the message are processed.
<div class="Pp"></div>
The following rule file is the one I am currently using: maildir = ~/mail;
<div style="height: 1.00em;">&#x00A0;</div>
All: /^Subject: [Cc]ommand/	{ SAVE cmds; PROCESS };
<div style="height: 1.00em;">&#x00A0;</div>
To: /^gue@eiffel.fr/		{ POST -l mail.gue }; Apparently-To: ram, Newsgroups:
  mail.gue		{ BOUNCE gue@eiffel.fr };
<div style="height: 1.00em;">&#x00A0;</div>
&lt;_SEEN_&gt; 	Apparently-To: ram, 	Newsgroups: mail.gue	{ DELETE };
<div style="height: 1.00em;">&#x00A0;</div>
From: root, To: root		{ BEGIN ROOT; REJECT }; &lt;ROOT&gt; /^Daily run output/	{
  WRITE ~/var/log/york/daily.%D }; &lt;ROOT&gt; /^Weekly run output/	{ WRITE
  ~/var/log/york/weekly }; &lt;ROOT&gt; /^Monthly run output/	{ WRITE
  ~/var/log/york/monthly };
<div style="height: 1.00em;">&#x00A0;</div>
From: ram		{ BEGIN RAM; REJECT }; &lt;RAM&gt; To: ram		{ LEAVE }; &lt;RAM&gt;
  X-Mailer: /mailagent/	{ LEAVE }; &lt;RAM&gt;			{ DELETE };
<div class="Pp"></div>
The folder directory is set to <i>~/mail</i>. All command mails are saved in the
  folder <i>~/mail/cmds</i> and processed. They do not show up in my mailbox.
  Mails directed to the <i>gue</i> mailing list (French Eiffel's Users Group,
  namely Groupe des Utilisateurs Eiffel) are posted on the local newsgroup
  <i>mail.gue</i> and do not appear in my mailbox either. Any follow-up made on
  this group is mailed to me by <i>inews</i> (and not directly to the mailing
  list, because those mails would get back to me again and be fed to the
  newsgroup, which in turn would have them mailed back to the list, and so on,
  and so forth). Hence the next rule which catches those follow-ups and bounces
  them to the mailing list. Those mails will indeed come back, but the _SEEN_
  rule will simply delete them.
<div class="Pp"></div>
On my machine, the mails for <i>root</i> are forwarded to me. However, everyday,
  the <i>cron</i> daemon starts some processes to do some administration
  clean-up (rotating log files, etc...), and mails the results back. They are
  redirected into specific folders with the WRITE command, to ensure they do not
  grow up without limit. Note the macro substitution for the daily output (on
  Mondays, the output is stored in <i>daily.1</i> for instance).
<div class="Pp"></div>
The next group of rules prevents the mail system from sending back mails when I
  am in a group alias expansion. This is a <i>sendmail</i> option which I
  disabled on my machine. Care is taken however to keep mails coming from the
  mailagent which I receive as a blind carbon copy.
<h1 class="Sh" title="Sh" id="CAVEAT"><a class="selflink" href="#CAVEAT">CAVEAT</a></h1>
In order to limit the load overhead on the system, only <b>one</b> mailagent
  process is allowed to run the commands. If some new mail arrives while another
  mailagent is running, that mail is queued and will be processed later by the
  <i>main</i> mailagent.
<div class="Pp"></div>
For the same reason, messages sent back by mailagent are queued by
  <i>sendmail</i>, to avoid the cost of mail transfer while processing commands.
<h1 class="Sh" title="Sh" id="SECURITY"><a class="selflink" href="#SECURITY">SECURITY</a></h1>
First, let me discuss what <i>security</i> means here. It does <b>not</b> mean
  system safety against intruder attacks. If your system allows <i>.forward</i>
  hooks and/or <i>cron</i> jobs to be set by regular users, then your system is
  not secure at all. Period. So we're not bothering with security at the system
  level, but rather at your own account level where all sort of precious data is
  held.
<div class="Pp"></div>
To avoid any pernicious intrusion via Trojan horses, the C <i>filter</i> will
  refuse to run if the configuration file <i>~/.mailagent</i> or the rule file
  specified are world writable or not owned by the user. Those tests are
  enforced even if the <i>filter</i> does not run setuid, because they
  compromise the security of your account. The <i>mailagent</i> will also
  perform some of those checks, in case it is not invoked via the C
  <i>filter</i>.
<div class="Pp"></div>
Indeed, if someone can write into your <i>~/.mailagent</i> file, then he can
  easily change your <i>rules</i> configuration parameter to point to another
  faked rule file and then send you a mail, which will trigger mailagent,
  running as you. Via the RUN command, this potential intruder could run any
  command, using your privileges, and could set a Trojan horse for later
  perusal. Applying the same logic, the rule file must also be protected
  tightly.
<div class="Pp"></div>
And, no surprise, the same rules apply for your <i>newcmd</i> file, which is
  used to describe extended filtering commands. Otherwise it would allow someone
  to quietly redefine a commonly used standard command like LEAVE and later be
  able to assume your identity.
<div class="Pp"></div>
Versions after 3.0 PL44 come with an improved (from a security point of view) C
  <i>filter</i> that will not only perform the aforementionned checks but will
  also ensure that the <i>perl</i> executable and the <i>mailagent</i> script it
  is about to exec are not loosely protected (when <i>execsafe</i> is ON or when
  running with superuser privileges). Furthermore, if the <i>filter</i> is set
  up in your <i>.forward</i> as described in this man page, it will be able to
  check itself for safety and will warn you loundly if it can be tampered with,
  which could defeat all security checks.
<div class="Pp"></div>
Mailagent was also extended so that all programs executed via RUN and friends,
  as well as mail hooks, are checked for obvious protection flaws before being
  actually run Interpreted scripts (starting with the #! magic token) and perl
  scripts following the magic &quot;exec perl if $under_shell&quot; incantation
  are specially checked for further security of the relevant interpretor. Those
  checks are performed systematically (when <i>execsafe</i> is ON or when
  running with superuser privileges) even if the <i>secure</i> parameter was not
  set to ON. Also, all files about to be <i>exec()</i>ed are checked using the
  same extended check method used when <i>secure</i> is ON (ownership tests are
  skipped however when checking for <i>exec()</i>-ness of a file).
<h1 class="Sh" title="Sh" id="FILES"><a class="selflink" href="#FILES">FILES</a></h1>
<dl class="Bl-tag">
  <dt class="It-tag">~/.mailagent</dt>
  <dd class="It-tag">configuration file for mailagent.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">~/agent.trace</dt>
  <dd class="It-tag">trace dump from a PROCESS command when error cannot be
      mailed back.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">~/mbox.filter</dt>
  <dd class="It-tag">mailbox used by <i>filter</i> in case of error</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">~/mbox.urgent</dt>
  <dd class="It-tag">mailbox used by <i>mailagent</i> in case of error</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">~/mbox.&lt;username&gt;</dt>
  <dd class="It-tag">mailbox used if writing access is denied in the mail spool
      directory</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">/usr/share/mailagent/mailagent</dt>
  <dd class="It-tag">directory holding templates and samples.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Log/agentlog</dt>
  <dd class="It-tag">mailagent's log file.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Spool/agent.wait</dt>
  <dd class="It-tag">list of mails waiting to be processed and stored outside of
      mailagent's queue directory. Even when logically empty, this file is kept
      around and still holds one blank line to reserve a block on the
      filesystem.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Queue/qmXXXXX</dt>
  <dd class="It-tag">mail spooled by <i>filter</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Queue/fmXXXXX</dt>
  <dd class="It-tag">mail spooled by <i>mailagent</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Queue/cmXXXXX</dt>
  <dd class="It-tag">mail spooled by the AFTER command.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">Hash/X/Y</dt>
  <dd class="It-tag">hash files used by RECORD, UNIQUE, ONCE commands and
      vacation mode.</dd>
</dl>
<h1 class="Sh" title="Sh" id="BUGS"><a class="selflink" href="#BUGS">BUGS</a></h1>
There is a small chance that mail arrives while the <i>main</i> mailagent is
  about to finish its processing. That mail will be queued and not processed
  until another mail arrives (the <i>main</i> mailagent always processes the
  queue after having dealt with the message that invoked it).
<div class="Pp"></div>
A version number must currently contain a dot. Moreover, an old system (i.e. a
  system with an <i>o</i> in the patches column) must have a version number, so
  that mailagent can compute the name of the directory holding the patches.
<div class="Pp"></div>
The lock file is deliberately ignored when <b>-q</b> option is used (in fact, it
  is ignored whenever an option is specified). This may result in having mails
  processed more than once.
<div class="Pp"></div>
Mailagent is at the mercy of any <i>perl</i> bug, and there is little I can do
  about it. Some spurious warnings may be emitted by the data-loaded version,
  although they do not appear with the plain version.
<div class="Pp"></div>
Parsing of the rule file should be done by a real parser and not lexically. Or
  at least, it should be possible to escape otherwise meaningful characters like
  ';' or '}' within the rules.
<h1 class="Sh" title="Sh" id="AUTHOR"><a class="selflink" href="#AUTHOR">AUTHOR</a></h1>
Raphael Manfredi &lt;Raphael_Manfredi@pobox.com&gt;.
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="selflink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
maildist(1), mailhelp(1), maillist(1), mailpatch(1), perl(1).</div>
<table class="foot">
  <tr>
    <td class="foot-date">Version 3.1-81</td>
    <td class="foot-os"></td>
  </tr>
</table>
</body>
</html>
