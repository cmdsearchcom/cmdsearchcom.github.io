<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 16:10:02 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>fiologparser_hist.py(1) General Commands Manual
fiologparser_hist.py(1)</p>

<p style="margin-top: 1em">NAME <br>
fiologparser_hist.py - Calculate statistics from fio
histograms</p>

<p style="margin-top: 1em">SYNOPSIS <br>
fiologparser_hist.py [options] [clat_hist_files]...</p>

<p style="margin-top: 1em">DESCRIPTION <br>
fiologparser_hist.py is a utility for converting
*_clat_hist* files generated by fio into a CSV of latency
statistics including minimum, average, maximum latency, and
50th, 95th, <br>
and 99th percentiles.</p>

<p style="margin-top: 1em">EXAMPLES <br>
$ fiologparser_hist.py *_clat_hist* <br>
end-time, samples, min, avg, median, 90%, 95%, 99%, max <br>
1000, 15, 192, 1678.107, 1788.859, 1856.076, 1880.040,
1899.208, 1888.000 <br>
2000, 43, 152, 1642.368, 1714.099, 1816.659, 1845.552,
1888.131, 1888.000 <br>
4000, 39, 1152, 1546.962, 1545.785, 1627.192, 1640.019,
1691.204, 1744</p>

<p style="margin-top: 1em">OPTIONS <br>
--help Print these options.</p>

<p style="margin-top: 1em">--buff_size=int <br>
Number of samples to buffer into numpy at a time. Default is
10,000. This can be adjusted to help performance.</p>

<p style="margin-top: 1em">--max_latency=int <br>
Number of seconds of data to process at a time. Defaults to
20 seconds, in order to handle the 17 second upper bound on
latency in histograms reported by fio. This should <br>
be increased if fio has been run with a larger maximum
latency. Lowering this when a lower maximum latency is known
can improve performance. See NOTES for more details.</p>

<p style="margin-top: 1em">-i, --interval=int <br>
Interval at which statistics are reported. Defaults to 1000
ms. This should be set a minimum of the value for
log_hist_msec as given to fio.</p>

<p style="margin-top: 1em">-d, --divisor=int <br>
Divide statistics by this value. Defaults to 1. Useful if
you want to convert latencies from milliseconds to seconds
(divisor=1000).</p>

<p style="margin-top: 1em">--warn Enables warning messages
printed to stderr, useful for debugging.</p>

<p style="margin-top: 1em">--group_nr=int <br>
Set this to the value of FIO_IO_U_PLAT_GROUP_NR as defined
in stat.h if fio has been recompiled. Defaults to 19, the
current value used in fio. See NOTES for more details.</p>

<p style="margin-top: 1em">NOTES <br>
end-times are calculated to be uniform increments of the
--interval value given, regardless of when histogram samples
are reported. Of note:</p>

<p style="margin-top: 1em">Intervals with no samples are
omitted. In the example above this means &quot;no statistics
from 2 to 3 seconds&quot; and &quot;39 samples influenced
the statistics of the interval from 3 <br>
to 4 seconds&quot;.</p>

<p style="margin-top: 1em">Intervals with a single sample
will have the same value for all statistics</p>

<p style="margin-top: 1em">The number of samples is
unweighted, corresponding to the total number of samples
which have any effect whatsoever on the interval.</p>

<p style="margin-top: 1em">Min statistics are computed
using value of the lower boundary of the first bin (in
increasing bin order) with non-zero samples in it. Similarly
for max, we take the upper bound&acirc; <br>
ary of the last bin with non-zero samples in it. This is
semantically identical to taking the 0th and 100th
percentiles with a 50% bin-width buffer (because percentiles
are com&acirc; <br>
puted using mid-points of the bins). This enforces the
following nice properties:</p>

<p style="margin-top: 1em">min &lt;= 50th &lt;= 90th &lt;=
95th &lt;= 99th &lt;= max</p>

<p style="margin-top: 1em">min and max are strict lower and
upper bounds on the actual min / max seen by fio (and
reported in *_clat.* with averaging turned off).</p>

<p style="margin-top: 1em">Average statistics use a
standard weighted arithmetic mean.</p>

<p style="margin-top: 1em">Percentile statistics are
computed using the weighted percentile method as described
here:
https://en.wikipedia.org/wiki/Percentile#Weighted_percentile.
See weights() method for <br>
details on how weights are computed for individual samples.
In process_interval() we further multiply by the height of
each bin to get weighted histograms.</p>

<p style="margin-top: 1em">We convert files given on the
command line, assumed to be fio histogram files, An
individual histogram file can contain the histograms for
multiple different r/w directions <br>
(notably when --rw=randrw). This is accounted for by
tracking each r/w direction separately. In the statistics
reported we ultimately merge *all* histograms (regardless of
r/w <br>
direction).</p>

<p style="margin-top: 1em">The value of *_GROUP_NR in
stat.h (and *_BITS) determines how many latency bins fio
outputs when histogramming is enabled. Namely for the
current default of GROUP_NR=19, we get <br>
1,216 bins with a maximum latency of approximately 17
seconds. For certain applications this may not be
sufficient. With GROUP_NR=24 we have 1,536 bins, giving us a
maximum <br>
latency of 541 seconds (~ 9 minutes). If you expect your
application to experience latencies greater than 17 seconds,
you will need to recompile fio with a larger GROUP_NR, e.g.
<br>
with:</p>

<p style="margin-top: 1em">sed -i.bak &rsquo;s/^#define
FIO_IO_U_PLAT_GROUP_NR 190#define FIO_IO_U_PLAT_GROUP_NR
24/g&rsquo; stat.h <br>
make fio</p>

<p style="margin-top: 1em">Quick reference table for the
max latency corresponding to a sampling of values for
GROUP_NR:</p>

<p style="margin-top: 1em">GROUP_NR | # bins | max latency
bin value <br>
19 | 1216 | 16.9 sec <br>
20 | 1280 | 33.8 sec <br>
21 | 1344 | 67.6 sec <br>
22 | 1408 | 2 min, 15 sec <br>
23 | 1472 | 4 min, 32 sec <br>
24 | 1536 | 9 min, 4 sec <br>
25 | 1600 | 18 min, 8 sec <br>
26 | 1664 | 36 min, 16 sec</p>

<p style="margin-top: 1em">At present this program
automatically detects the number of histogram bins in the
log files, and adjusts the bin latency values accordingly.
In particular if you use the <br>
--log_hist_coarseness parameter of fio, you get output files
with a number of bins according to the following table (note
that the first row is identical to the table above):</p>

<p style="margin-top: 1em">coarse &nbsp;GROUP_NR <br>
19 20 21 22 23 24 25 26 <br>
------------------------------------------------------- <br>
0 [[ 1216, 1280, 1344, 1408, 1472, 1536, 1600, 1664], <br>
1 [ 608, 640, 672, 704, 736, 768, 800, 832], <br>
2 [ 304, 320, 336, 352, 368, 384, 400, 416], <br>
3 [ 152, 160, 168, 176, 184, 192, 200, 208], <br>
4 [ 76, 80, 84, 88, 92, 96, 100, 104], <br>
5 [ 38, 40, 42, 44, 46, 48, 50, 52], <br>
6 [ 19, 20, 21, 22, 23, 24, 25, 26], <br>
7 [ N/A, 10, N/A, 11, N/A, 12, N/A, 13], <br>
8 [ N/A, 5, N/A, N/A, N/A, 6, N/A, N/A]]</p>

<p style="margin-top: 1em">For other values of GROUP_NR and
coarseness, this table can be computed like this:</p>

<p style="margin-top: 1em">bins =
[1216,1280,1344,1408,1472,1536,1600,1664] <br>
max_coarse = 8 <br>
fncn = lambda z: list(map(lambda x: z/2**x if z % 2**x == 0
else nan, range(max_coarse + 1))) <br>
np.transpose(list(map(fncn, bins)))</p>

<p style="margin-top: 1em">If you have not adjusted
GROUP_NR for your (high latency) application, then you will
see the percentiles computed by this tool max out at the max
latency bin value as in the <br>
first table above, and in this plot (where GROUP_NR=19 and
thus we see a max latency of ~16.7 seconds in the red
line):</p>


<p style="margin-top: 1em">https://www.cronburg.com/fio/max_latency_bin_value_bug.png</p>

<p style="margin-top: 1em">Motivation for, design
decisions, and the implementation process are described in
further detail here:</p>


<p style="margin-top: 1em">https://www.cronburg.com/fio/cloud-latency-problem-measurement/</p>

<p style="margin-top: 1em">AUTHOR <br>
fiologparser_hist.py and this manual page were written by
Karl Cronburg &lt;karl.cronburg@gmail.com&gt;.</p>

<p style="margin-top: 1em">REPORTING BUGS <br>
Report bugs to the fio mailing list
&lt;fio@vger.kernel.org&gt;.</p>

<p style="margin-top: 1em">August 18, 2016
fiologparser_hist.py(1)</p>
<hr>
</body>
</html>
