<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
  </style>
  <title>avenger(1)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">avenger(1)</td>
    <td class="head-vol">Mail Avenger 0.8.4</td>
    <td class="head-rtitle">avenger(1)</td>
  </tr>
</table>
<div class="manual-text">
<h1 class="Sh" title="Sh" id="NAME"><a class="selflink" href="#NAME">NAME</a></h1>
avenger - Mail Avenger
<h1 class="Sh" title="Sh" id="DESCRIPTION"><a class="selflink" href="#DESCRIPTION">DESCRIPTION</a></h1>
Mail Avenger is a highly-configurable MTA-independent SMTP (Simple Mail
  Transport Protocol) server designed to let you filter and fight SPAM
  <i>before</i> accepting incoming mail from a client machine. <i>avenger</i> is
  the script run on behalf of each user to decide whether to accept incoming
  mail.
<div class="Pp"></div>
When a client attempts to send mail to a user on the system, the avenger SMTP
  daemon, asmtpd, runs avenger to process the file <i>.avenger/rcpt</i> in the
  user's home directory. That file, a shell script with access to special
  functions, determines how the SMTP server should proceed. The possible
  outcomes are:
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Provisionally accept the mail, falling back to
      system-default rules</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Accept the mail immediately with no further checks</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Reject the mail immediately</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Defer the mail, telling the client to re-send it later</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Redirect the processing to another local name. The name can
      be another email address belonging to the current user, or an email
      address belonging to the special <b>AvengerUser</b> user. In the later
      case, avenger will be re-run with a different user ID, and hence can, for
      example, employ utilities that maintain state across multiple users
      (assuming they all redirect processing the same way).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">&#x2022;</dt>
  <dd class="It-tag">Run a &quot;bodytest&quot; rule. With this outcome, the the
      SMTP transaction continues on to receive the entire contents of the mail
      message, after which a program is run on the contents of the mail message.
      That program can decide, based on the contents, whether to accept, reject,
      defer, or silently discard the message.</dd>
</dl>
<div class="Pp"></div>
Mail Avenger should typically be configured to have a <b>Separator</b>
  character, allowing each user to maintain multiple email addresses. With
  sendmail, <b>Separator</b> is typically &quot;+&quot;, with qmail it is
  typically &quot;-&quot;. If the separator is &quot;+&quot;, then any email
  sent to <b>user+</b><i>ext</i><b></b><b>@your</b><b>-host</b> will be
  processed by files in <b>user</b>'s <i>.avenger</i> directory.
<div class="Pp"></div>
Avenger first checks for a file named <i>rcpt+</i><i>ext</i> in a user's
  <i>.avenger</i> directory, then for <i>rcpt+default</i>. If <i>ext</i> itself
  contains the separator character, for example
  <b>user+</b><i>ext1</i><b>+</b><i>ext2</i><b></b><b>@your</b><b>-host</b>,
  avenger will check first for <i>rcpt+</i><i>ext1</i><i>+</i><i>ext2</i>, then
  for <i>rcpt+</i><i>ext1</i><i>+default</i>, then for <i>rcpt+default</i>. The
  same algorithm is extended for arbitrarily many separator characters. (If
  separator is &quot;-&quot;, simply replace &quot;+&quot; with &quot;-&quot;
  throughout the above description, including in the names of files such as
  <i>rcpt-default</i>.)
<div class="Pp"></div>
If mail is rejected by the recipient checks but the sender address of a message
  is local and <b>UserMail</b> is 1 in <i>asmtpd.conf</i> (which is not the
  default), then before rejecting mail, avenger will be run on behalf of the
  sending user. In this case, the address will be parsed as above, but avenger
  will look for rules in files beginning <i>mail</i> instead of <i>rcpt</i>.
  This mechanism can be used by local users who want to relay mail through the
  server from an untrusted IP address.
<div class="Pp"></div>
Using the <i>mail</i> configuration files, each user can, for instance,
  configure a <i>mail+...</i> file to accept mail from an IP address he or she
  trusts, even if that address is not trusted by all users. (Alternatively,
  using tools such as macutil, a user might set up relaying of mail in which the
  envelope sender contains a cryptographic code, checked by the <i>mail+...</i>
  script.)
<div class="Pp"></div>
Error output of an avenger script <i>rcpt+</i><i>ext</i> or
  <i>mail+</i><i>ext</i> is redirected to a file called <i>log+</i><i>ext</i> in
  the same directory, for use in debugging.
<h1 class="Sh" title="Sh" id="AVENGER_SYNTAX"><a class="selflink" href="#AVENGER_SYNTAX">AVENGER
  SYNTAX</a></h1>
Avenger configuration files are simply shell scripts, using the syntax described
  in <i>sh</i>(1). Each line of the file contains a variable assignment,
  command, or function to run. Scripts can additionally make use of a number of
  avenger-specific functions and variables. This section describes avenger
  functions. The next two sections describe variables.
<dl class="Bl-tag">
  <dt class="It-tag"><b>errcheck</b></dt>
  <dd class="It-tag">Certain error conditions result in Mail Avenger rejecting
      mail by default, unless the message is explicitly accepted through an
      <b>accept</b> or successful <b>bodytest</b> check. These conditions are
      indicated by the <b>MAIL_ERROR</b> environment variable described below.
      If your script either rejects mail or falls through to the default
      behavior, there is often no reason to run tests on a message that will end
      up being rejected either way. <b>errcheck</b> exits immediately with the
      default error if the default would be to reject or defer the mail.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>accept</b> [<i>message</i>]</dt>
  <dd class="It-tag">Immediately accepts the message (without falling back to
      any default rules). If message is supplied, it will be returned to the
      SMTP client. The default message is &quot;ok&quot;.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>reject</b> [<i>message</i>]</dt>
  <dd class="It-tag">Reject the mail, with <i>message</i>. (The default message
      is &quot;command rejected for policy reasons&quot;).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>defer</b> [<i>message</i>]</dt>
  <dd class="It-tag">Reject the mail with a temporary error code, so that a
      legitimate mail client will attempt to re-send it later. The default for
      <i>message</i> is &quot;temporary error in processing&quot;.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>bodytest</b> <i>command</i> [<i>arg</i> ...]</dt>
  <dd class="It-tag">Accept the current SMTP &quot;RCPT&quot; command. However,
      once the whole mail message has been received with the SMTP
      &quot;DATA&quot; command, run <i>command</i> with the message as its
      standard input. Depending on the exit status of <i>command</i> return to
      the client's &quot;DATA&quot; command either success, temporary, or
      permanent failure. Exit code 0 means accept the mail, 100 means reject,
      111 means reject with a temporary error code (i.e., defer the mail). See
      the description of <b>bodytest</b> in the asmtpd/avenger interface
      description for more information on <b>bodytest</b> (since this function
      directly invokes <b>bodytest</b> in asmtpd).
    <div style="height: 1.00em;">&#x00A0;</div>
    Error output from <i>command</i> will be redirected to the same log file as
      output from the <i>rcpt+...</i> avenger script invoking the
      <b>bodytest</b> function. Standard output of <i>command</i> will be
      included as a diagnostic the bounce message if the exit code defers or
      rejects the mail.
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that <i>command</i> and the arguments passed to <b>bodytest</b> will be
      run by the shell. Thus, it is important not to pass any arguments that
      might contain shell metacharacters such as &quot;&gt;&quot; and
      &quot;$&quot;.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>redirect</b> <i>local</i></dt>
  <dd class="It-tag">Finish processing, and re-run avenger as if mail were being
      sent to a different username <i>local</i> (possibly belonging to the
      special <b>AvengerUser</b> user). See the description of <b>redirect</b>
      in the asmtpd/avenger interface description for more information on
      <b>redirect</b> (since this function directly invokes <b>redirect</b> in
      asmtpd).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>greylist</b> [<i>sender-key</i>]</dt>
  <dd class="It-tag">This command defers mail the first time mail is received
      from a particular sender at a particular IP address. However, after a
      certain interval, <b>greylist_delay</b>, if the client re-sends the mail,
      it will be accepted. Furthermore, from that point on, all mail will be
      immediately accepted from that sender and IP address, unless the sender
      stops sending mail for a period of <b>greylist_ttl2</b> or more. If,
      however, after sending the initial, defered piece of mail, the client does
      not try again within a period of <b>greylist_ttl1</b>, then any record of
      the client will be erased, and the next time it tries to send mail it will
      be defered again.
    <div style="height: 1.00em;">&#x00A0;</div>
    The parameters can be tuned by setting variables in the script. The default
      values are:
    <div style="height: 1.00em;">&#x00A0;</div>
    <pre>
    greylist_delay=30m  # Time to wait before allowing message
    greylist_ttl1=5h    # How long to remember first-time senders
    greylist_ttl2=36D   # How long to remember ok senders
    </pre>
    <div style="height: 1.00em;">&#x00A0;</div>
     <b>m</b> means minutes, <b>h</b> hours, and <b>D</b> days. For a complete
      list of allowed suffixes, see the documentation for <i>dbutil</i>(1) (in
      particular for the <b>--expire</b> option).
    <div style="height: 1.00em;">&#x00A0;</div>
     <i>sender-key</i>, if supplied, is used to identify the sender. The default
      value is &quot;$CLIENT_IP $RECIPIENT $SENDER&quot;. If, for example, you
      wanted to record only the first 24-bits of IP address and didn't care
      about the recipient, you could use the command:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><b>greylist &quot;${CLIENT_IP%.*}
  </b><b>$SENDER</b> <b>&quot;</b></div>
</div>
<div style="margin-left: 4.00ex;"></div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>setvars</b></dt>
  <dd class="It-tag">All functions that set a variable by means of an external
      query to asmtpd are performed asynchronously. <b>setvars</b> actually
      waits for results and sets the values of those variables. In this way, a
      number of potentially slow requests (such as DNS lookups) can be initiated
      concurrently, and their latencies overlapped. However, one must remember
      to call <b>setvars</b>, or else variables that should contain the results
      of operations will remain unset.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>dns</b> <i>var</i> <i>type</i> <i>domain-name</i></dt>
  <dd class="It-tag">Performs a DNS lookup of <i>domain-name</i> for records of
      type <i>type</i>, and assigns the result to variable <i>var</i> when you
      call <b>setvars</b>. <i>type</i> must be one of <b>a</b>, <b>mx</b>,
      <b>ptr</b>, or <b>txt</b> (lower-case only).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>rbl</b> [<b>-ipf</b>] <i>var</i> <i>domain</i></dt>
  <dd class="It-tag">Looks up the current mail sender in a real-time blackhole
      list (RBL). <i>domain</i> is the domain name of the RBL (e.g.,
      &quot;bl.spamcop.net&quot;). If the sender is listed, set <i>var</i> to
      the result of the DNS lookup when you next call <b>setvars</b>. <b>-i</b>
      looks up the sender's IP address (the default if no options are
      specified). <b>-p</b> looks up the sender's domain name (verified DNS PTR
      record). <b>-f</b> looks up the envelope sender domain name in the
    RBL.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>spf0</b> <i>var</i> [<i>spf-mechanism</i> ...]</dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>spf</b> <i>var</i> [<i>spf-mechanism</i> ...]</dt>
  <dd class="It-tag">Tests the sender against an arbitrary query formulated in
      the SPF language. This is a powerful way to whitelist or blacklist
      particular senders. For example, suppose you want to accept any mail from
      machines in the list maintained by trusted-forwarder.org, accept mail from
      any machine name ending &quot;yahoo.com&quot; reject any mail from users
      in the spamcop RBL, and for other users fall back to the default
      system-wide rules. You might use the following <i>rcpt</i> file:
    <div style="height: 1.00em;">&#x00A0;</div>
    <pre>
    spf MYSPF +include:spf.trusted-forwarder.org \
        +ptr:yahoo.com -exists:%{ir}.bl.spamcop.net ?all
    setvars
    case &quot;$MYSPF&quot; in
        pass)
            accept &quot;I like you&quot;
            ;;
        fail)
            reject &quot;I don't like you&quot;
            ;;
        error)
            # Note, could instead fall through to default here
            defer &quot;Temporary DNS error&quot;
            ;;
    esac
    </pre>
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that commands <b>spf0</b> and <b>spf</b> are synonymous, but <b>spf</b>
      is deprecated, because in a later release of Mail Avenger <b>spf</b> will
      become synonymous with <b>spf1</b>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>spf1</b> <i>var</i> [<i>spf-mechanism</i> ...]</dt>
  <dd class="It-tag">Performs the same tests as the <b>spf</b> directive, but
      returns the result strings <b>None</b>, <b>Neutral</b>, <b>Pass</b>,
      <b>Fail</b>, <b>SoftFail</b>, <b>TempError</b>, and <b>PermError</b>
      instead of <b>none</b>, <b>neutral</b>, <b>pass</b>, <b>fail</b>,
      <b>softfail</b>, <b>error</b>, and <b>unknown</b>.</dd>
</dl>
<h1 class="Sh" title="Sh" id="AVENGER_VARIABLES"><a class="selflink" href="#AVENGER_VARIABLES">AVENGER
  VARIABLES</a></h1>
These variables are set by the avenger script. In addition, asmtpd sets a number
  of environment variables before running avenger. These are documented in the
  next section, ENVIRONMENT.
<dl class="Bl-tag">
  <dt class="It-tag"><b>FILEX</b></dt>
  <dd class="It-tag">The extension on the file currently being processed. For
      example, if file <i>rcpt+ext</i> is being processed, will be set to
      &quot;+ext&quot;. Empty when processing just <i>rcpt</i> (or <i>mail</i>).
      May also contain <i>default</i> when a default rule file for some suffix
      is being run.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>PREFIX</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SUFFIX</b></dt>
  <dd class="It-tag">Assuming the separator is &quot;+&quot;, when processing a
      file <i>rcpt+base+default</i> or <i>mail+base+default</i>, <b>PREFIX</b>
      is set to <i>base</i>, while <b>SUFFIX</b> is set to the portion of the
      name for which <i>default</i> was substituted. When the file does not end
      with <i>default</i>, <b>SUFFIX</b> is empty. When the file is just
      <i>rcpt</i> with no extension, both <b>PREFIX</b> and <b>SUFFIX</b> are
      empty. When <b>SUFFIX</b> itself contains a &quot;+&quot; character,
      <b>SUFFIX1</b> contains to the part of <b>SUFFIX</b> after the first
      &quot;+&quot; character, <b>SUFFIX2</b> contains the part after the second
      &quot;+&quot;, and so on for each &quot;+&quot; character in suffix.</dd>
</dl>
<h1 class="Sh" title="Sh" id="ENVIRONMENT"><a class="selflink" href="#ENVIRONMENT">ENVIRONMENT</a></h1>
<dl class="Bl-tag">
  <dt class="It-tag"><b>AUTH_USER</b></dt>
  <dd class="It-tag">If Mail Avenger was compiled with SASL support (which is
      not the default, unless you supplied the <b>--enable-sasl</b> argument to
      &quot;configure&quot;), and if the client successfully authenticates to
      the server using SASL, then <b>AUTH_USER</b> will be set to the name of
      the authenticated user.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>AVENGER_MODE</b></dt>
  <dd class="It-tag">Set to &quot;rcpt&quot; when testing whether a recipient
      should receive mail. Set to &quot;mail&quot; (possibly after an
      &quot;rcpt&quot; check fails) when checking whether to relay mail
      (possibly on behalf of a local user).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>AVUSER</b></dt>
  <dd class="It-tag">The effective local username for which avenger is being
      run. Ordinarily, this will be the same as:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<dl class="Bl-tag">
  <dt class="It-tag">$USER${PREFIX+$SEPARATOR}$PREFIX\</dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">${SUFFIX+$SEPARATOR}$SUFFIX</dt>
  <dd class="It-tag"></dd>
</dl>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
However, for special avenger files like <i>unknown</i> and <i>default</i>, it
  can contain useful information, because unlike the <b>RECIPIENT_LOCAL</b>
  environment variable, <b>AVUSER</b> reflects substitutions from the Mail
  Avenger <i>domains</i> and <i>aliases</i> files.</div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT</b></dt>
  <dd class="It-tag">This variable contains the name of the client machine, as
      typically reported in &quot;Received:&quot; headers. Its value has the
      form:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">[<i>user</i><b>@</b>]<i>host</i></div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<i>user</i> is the user name for the connection reported by the client, if the
  client supports the RFC 1413 identification protocol, otherwise it is omitted.
  <i>host</i> is a verified DNS hostname for the IP, if asmtpd could find one.
  Otherwise, it is simply the numeric IP address.</div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_COLONSPACE</b></dt>
  <dd class="It-tag">Set to 1 if the client included a space between the colon
      in the command &quot;MAIL FROM:&quot; or &quot;RCPT TO:&quot; and the
      subsequent &quot;&lt;&quot; that begins an email address.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_DNSFAIL</b></dt>
  <dd class="It-tag">If <b>AllowDNSFail</b> is set to 1 in the
      <i>asmtpd.conf</i> file and resolving the client's IP to a hostname
      returns a temporary error, then this variable will be set to a description
      of the error.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_HELO</b></dt>
  <dd class="It-tag">Set to the argument the client supplied to the SMTP
      &quot;HELO&quot; or &quot;EHLO&quot; command.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_IP</b></dt>
  <dd class="It-tag">Set to the IP address of the client.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_NAME</b></dt>
  <dd class="It-tag">Set to the verified DNS name of the client, if asmtpd can
      find one.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_NETHOPS</b></dt>
  <dd class="It-tag">Set to the number of network hops between the server and
      the client, if asmtpd can get the client or its firewall to return an ICMP
      destination unreachable (type 3 packet) in response to a UDP probe.
      Whether or not this is set will depend on firewall configurations.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_NETPATH</b></dt>
  <dd class="It-tag">Set to as many intermediary network hops as asmtpd can
      determine between the server and the client. How close to the client
      asmtpd can probe will depend on firewalls.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_PIPELINING</b></dt>
  <dd class="It-tag">Set to 1 if the client wrote data after the SMTP
      <b>HELO</b> or <b>EHLO</b> command, before receiving its response. A
      correct SMTP client should not &quot;pipeline&quot; commands until after
      receiving the result of the <b>HELO</b> command and verifying that the
      server accepts pipelined commands.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_PORT</b></dt>
  <dd class="It-tag">The TCP port number of the client.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_POST</b></dt>
  <dd class="It-tag">Set to 1 if the client sent a &quot;POST&quot; command at
      some point during the SMTP session. &quot;POST&quot; is not a valid SMTP
      command; it is an HTTP command. However, one technique for sending spam
      involves exploiting an open web proxy to &quot;post&quot; an SMTP session
      to a mail server. The initial HTTP headers (including the HTTP post
      command) simply cause SMTP syntax errors, while the body of the POST
      command contains SMTP commands. By checking the <b>CLIENT_POST</b>
      environment variable, you to reject mail sent in this way.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_REVIP</b></dt>
  <dd class="It-tag">The value of <b>CLIENT_IP</b> with the order of the bytes
      reversed. Suitable for prepending to &quot;.in-addr.arpa&quot; or an RBL
      domain to perform a DNS lookup based on IP address.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_SYNFP</b></dt>
  <dd class="It-tag">Contains a fingerprint, abstracting the contents of the
      initial TCP SYN packet the client sent to establish the TCP connection.
      The exact contents of SYN packets depends on the operating system and
      version of the client, and can therefore reveal interesting information
      about the type of client connecting to your mail server. The format of the
      fingerprint is:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><i>wwww</i><b>:</b><i>ttt</i><b>:</b><i>D</i><b>:</b><i>ss</i><b>:</b><i>OOO</i></div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
Where the fields are as follows:
<dl class="Bl-tag">
  <dt class="It-tag"><i>wwww</i></dt>
  <dd class="It-tag">the initial TCP window size</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>ttt</i></dt>
  <dd class="It-tag">the IP ttl of the received packet</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>D</i></dt>
  <dd class="It-tag">the IP &quot;don't fragment&quot; bit</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>ss</i></dt>
  <dd class="It-tag">total size of the SYN packet (including IP header)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>OOO</i></dt>
  <dd class="It-tag">a comma-separated list of TCP options, as follows:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<dl class="Bl-tag">
  <dt class="It-tag"><b>N</b></dt>
  <dd class="It-tag">NOP option</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>W</b><i>nnn</i></dt>
  <dd class="It-tag">window scaling option with value <i>nnn</i></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>M</b><i>nnn</i></dt>
  <dd class="It-tag">maximum segment size value <i>nnn</i></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>S</b></dt>
  <dd class="It-tag">Selective ACK OK</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>T</b></dt>
  <dd class="It-tag">timestamp option</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>T0</b></dt>
  <dd class="It-tag">timestamp option with value zero</dd>
</dl>
</div>
<div style="margin-left: 4.00ex;"></div>
</div>
<div style="margin-left: 4.00ex;"></div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>CLIENT_SYNOS</b></dt>
  <dd class="It-tag">If asmtpd can guess the client's operating system based on
      <b>CLIENT_SYNFP</b>, it will set <b>CLIENT_SYNOS</b> to the value of that
      guess. For example, to greylist mail from Windows machines, you can run:
    <div style="height: 1.00em;">&#x00A0;</div>
    <pre>
   match -q &quot;*Windows*&quot; &quot;$CLIENT_SYNOS&quot; &amp;&amp; greylist
    </pre>
  </dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>DATA_BYTES</b></dt>
  <dd class="It-tag">This variable is not really an avenger variable, as it is
      only available in <b>bodytest</b> commands. It specifies the number of
      bytes of message transfered in the SMTP DATA command, but after converting
      CR NL sequences to NL. Roughly speaking this is how many bytes are in the
      message including all headers after the X-Avenger:, SPF-Received, or
      Received: header.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>ETCDIR</b></dt>
  <dd class="It-tag">The value of <b>EtcDir</b> from the asmtpd configuration
      file (or <i>/etc/avenger</i> by default).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>EXT</b></dt>
  <dd class="It-tag">When avenger runs on behalf of a user <b>EXT</b> is set to
      the part of the address that determines the suffix of the <i>rcpt</i> or
      <i>mail</i> file. For example, suppose <b>Separator</b> is &quot;-&quot;
      and the recipient is <b>list-subscribe@</b><i>host</i>, where <i>host</i>
      is not a virtual domain. If the <b>AliasFile</b> contains:
    <div style="height: 1.00em;">&#x00A0;</div>
    <pre>
    list: user-mylist
    </pre>
    <div style="height: 1.00em;">&#x00A0;</div>
    Then avenger will be run on behalf of &quot;user&quot; (because alias
      expansion yields <b>user-mylist-subscribe</b>). <b>EXT</b> will be set to
      <b>mylist-subscribe</b>.
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that <b>EXT</b> is empty when there is no suffix, and that it is equal
      to the name of the system file being processed when avenger is run on a
      system file. Like <b>RECIPIENT</b>, this variable is not set for
      <b>bodytest</b> commands.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>HOST</b></dt>
  <dd class="It-tag">Set to the name of the local host, as specified by the
      <b>HostName</b> directive in <i>avenger.conf</i>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>MAIL_ERROR</b></dt>
  <dd class="It-tag">This variable is set when the SPF disposition of the sender
      is <b>fail</b>, or when asmtpd is unable to send a bounce message to the
      sender address. In either case, Mail Avenger will reject the mail if the
      script falls through to the default.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>MSGID</b></dt>
  <dd class="It-tag">A randomly generated string for this message, which can be
      useful to correlate calls to rcpt scripts with bodytest scripts. Note this
      is unrelated to the Message-ID header in the message, but does show up in
      the Received header that Mail Avenger inserts.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>MYIP</b></dt>
  <dd class="It-tag">IP address of local end of SMTP TCP connection.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>MYPORT</b></dt>
  <dd class="It-tag">TCP port number of local end of SMTP TCP connection.
      Ordinarily this will be 25.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>RECIPIENT</b></dt>
  <dd class="It-tag">The envelope recipient of the message. Note that this
      environment variable is not present for <b>bodytest</b> programs, since
      such programs may be run on behalf of multiple users.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>RECIPIENT_HOST</b></dt>
  <dd class="It-tag">The domain part of <b>RECIPIENT</b>, folded to
      lower-case--i.e., <i>host</i> when <b>RECIPIENT</b> is
      <i>local</i><b>@</b> <i>host</i>. Not present for <b>bodytest</b>
      programs, as noted in the description of <b>RECIPIENT</b>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>RECIPIENT_LOCAL</b></dt>
  <dd class="It-tag">The local part of <b>RECIPIENT</b>, folded to
      lower-case--i.e., <i>local</i> when <b>RECIPIENT</b> is
      <i>local</i><b>@</b> <i>host</i>. Not present for <b>bodytest</b>
      programs, as noted in the description of <b>RECIPIENT</b>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SENDER</b></dt>
  <dd class="It-tag">The envolope sender of this mail message (i.e., the
      argument supplied by the client to the &quot;MAIL FROM:&quot; SMTP
      command.)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SENDER_HOST</b></dt>
  <dd class="It-tag">The hostname part of <b>SENDER</b>, converted to lower-case
      (i.e., <i>host</i> in <i>user</i><b>@</b><i>host</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SENDER_LOCAL</b></dt>
  <dd class="It-tag">The local part of <b>SENDER</b>, converted to lower-case
      (i.e., <i>user</i> in <i>user</i><b>@</b><i>host</i>).</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SENDER_MXES</b></dt>
  <dd class="It-tag">A list of DNS MX records for <b>SENDER_HOST</b>, if that
      hostname has any MX records.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SENDER_BOUNCERES</b></dt>
  <dd class="It-tag">For non-empty envelope senders, asmtpd attempts to see if
      it is possible to deliver bounce messages for the sender. If not,
      <b>SENDER_BOUNCERES</b> is set to a three-digit SMTP error code. If the
      first digit is 4, the error was temporary. If the first digit is 5, the
      error was permanent. Note that failure to accept bounce messages is
      considered a <b>MAIL_ERROR</b> as described above, and will cause mail to
      be rejected by default.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SEPARATOR</b></dt>
  <dd class="It-tag">The value of <b>Separator</b> from the asmtpd configuration
      file. There is no default ( <b>SEPARATOR</b> will not be set if no
      <b>Separator</b> is specified in the configuration file). However, it
      should be configured for &quot;+&quot; with sendmail and &quot;-&quot;
      with qmail.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SPF0</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SPF</b></dt>
  <dd class="It-tag">The result of performing an SPF check on the message. Will
      be one of: <b>none</b>, <b>neutral</b>, <b>pass</b>, <b>fail</b>,
      <b>softfail</b>, <b>error</b>, or <b>unknown</b>. Note that <b>SPF0</b>
      and <b>SPF</b> are synonymous, but <b>SPF</b> is deprecated as a future
      release of Mail Avenger will make <b>SPF</b> synonymous with
    <b>SPF1</b>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SPF1</b></dt>
  <dd class="It-tag">Also the result of performing an SPF check on the message,
      but returns different names for the results, to be compatible with newer
      revisions of the SPF protocol specification. The new names are
      <b>None</b>, <b>Neutral</b>, <b>Pass</b>, <b>Fail</b>, <b>SoftFail</b>,
      <b>TempError</b>, and <b>PermError</b>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SPF_EXPL</b></dt>
  <dd class="It-tag">The explanation string that goes along with a bad SPF
      status.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_CIPHER</b></dt>
  <dd class="It-tag">If the Mail Avenger has been compiled with support for the
      STARTTLS command (using the <b>--enable-ssl</b> option to
      &quot;configure&quot;), and the client is communicating over SSL/TLS, this
      variable will contain a textual description of the algorithm.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_CIPHER_BITS</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_ALG_BITS</b></dt>
  <dd class="It-tag"><b>SSL_CIPHER_BITS</b> contains the number of secret key
      bits used by the SSL/TLS ciphers. <b>SSL_ALG_BITS</b> is the number of
      bits used by the algorithm. For example, if you are using 128-bit RC4 with
      88 bits sent in cleartext, <b>SSL_CIPHER_BITS</b> will only be 40, since
      that is the effective security, while <b>SSL_ALG_BITS</b> will be
    128.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_ISSUER</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_ISSUER_DN</b></dt>
  <dd class="It-tag">If the client has successfully authenticated itself using
      an SSL certificate, <b>SSL_ISSUER</b> will be set to the certificate
      signer's common name, while <b>SSL_ISSUER_DN</b> will be set to a compact
      representation of the signer's full distinguished name. The full
      distinguished name is in the form output by the command:
    <div style="height: 1.00em;">&#x00A0;</div>
    <pre>
        openssl x509 -noout -issuer -in cert.pem
    </pre>
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that this variable is mostly useful if the <b>SSLCAcert</b> file you
      have given to Mail Avenger contains more than one certificate authority,
      or signs other CA certificates. Mail Avenger will not accept client
      certificates if it does not recognize the signer of the certificate.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_SUBJECT</b></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_SUBJECT_DN</b></dt>
  <dd class="It-tag">If the client has successfully authenticated itself using
      an SSL certificate, <b>SSL_SUBJECT</b> will be set to the client's common
      name in the certificate, while <b>SSL_SUBJECT_DN</b> will be set to a
      compact representation of the client's full distinguished name. The full
      distinguished name is in the form output by the command:
    <div style="height: 1.00em;">&#x00A0;</div>
    <pre>
        openssl x509 -noout -subject -in cert.pem
    </pre>
  </dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>SSL_VERSION</b></dt>
  <dd class="It-tag">The version of the SSL/TLS protocol in use.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>UFLINE</b></dt>
  <dd class="It-tag">An mbox &quot;From &quot; line suitable for prepending to
      the message before passing the message to a delivery program. (This is
      mostly useful for bodytest rules.)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>USER</b></dt>
  <dd class="It-tag">The name of the user under which avenger is running.</dd>
</dl>
<h1 class="Sh" title="Sh" id="AVENGER/ASMTPD_INTERFACE"><a class="selflink" href="#AVENGER/ASMTPD_INTERFACE">AVENGER/ASMTPD
  INTERFACE</a></h1>
avenger is just a simple shell script. You can inspect the file to see what it
  is doing. Most of the interesting operations happen in either asmtpd, or in
  external programs spawned from avenger. This section documents the interface
  between asmtpd and avenger.
<div class="Pp"></div>
avenger inherits a unix-domain socket connected to asmtpd on its standard input
  and output. It sends commands to asmtpd over this socket, and similarly reads
  replies from it. In order to avoid mixing messages to and from asmtpd with the
  output of other programs you run, however, the avenger shell script
  reorganizes its file descriptors so that all communication to and from asmtpd
  happens over file descriptor number 3.
<div class="Pp"></div>
Each command consists of a single line, followed by a newline (except the
  <b>return</b> command, which can optionally take multiple lines). There may or
  may not be a reply, possibly depending on the outcome of the command. Most
  replies consist of zero or more lines of the form
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><i>VARIABLE</i><b>=</b><i>value</i></div>
<div class="Pp"></div>
<i>VARIABLE</i> is typically a variable name that was supplied as part of the
  command. The avenger shell script records results by setting the environment
  variable <i>VARIABLE</i> to <i>value</i>, so that it can be accessed by
  subsequent lines of the script.
<div class="Pp"></div>
Replies are sent in the order in which the corresponding commands were received.
  However, asmtpd executes requests asynchronously. Thus, one can perform
  several concurrent operations (such as DNS requests or SPF tests) by simply
  writing multiple commands to asmtpd before receiving any of the responses.
<div class="Pp"></div>
The &quot;.&quot; command is a no-op, but asmtpd echoes the &quot;.&quot; back
  to avenger as the reply. This allows one to synchronize the avenger process's
  state after issuing one or more commands. For example, one might issue several
  DNS lookups to check various RBLs (real-time blackhole lists), then issue a
  <i>.</i> command, then wait for replies. When the <i>.</i> comes back, all
  previous commands will also have completed. The avenger <b>setvars</b> command
  simply sends a &quot;.&quot;, then loops until it reads back the
  &quot;.&quot;, setting variables from any previous commands whose replies it
  reads in the process.
<div class="Pp"></div>
The following commands are available:
<dl class="Bl-tag">
  <dt class="It-tag"><b>.</b></dt>
  <dd class="It-tag">The <b>.</b> command is simply echoed back by asmtpd.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>bodytest</b> <i>command</i></dt>
  <dd class="It-tag">Ends the current avenger script. Specifies that asmtpd
      should receive the entire body of the message, then run <i>command</i>
      (under the same user ID as the current avenger script) with the entire
      mail message as its standard input. asmtpd then replies to the SMTP
      &quot;DATA&quot; command based on the exit status of <i>command</i> as
      follows:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<dl class="Bl-tag">
  <dt class="It-tag">0</dt>
  <dd class="It-tag">If <i>command</i> exits with status 0, asmtpd will reply to
      the &quot;DATA&quot; command with success (SMTP code 250), and will pass
      the message to sendmail (or whatever you have configured as
      <b>Sendmail</b> in <i>asmtpd.conf</i>) for delivery.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">99</dt>
  <dd class="It-tag">If <i>command</i> exits with status 99, asmtpd will still
      reply to the &quot;DATA&quot; command with a successful 250 reply code,
      but will not spool the data. Either <i>command</i> must have done
      something with the data, or the message will be lost.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">100 (also 64, 65, 70, 76, 77, 78, 112)</dt>
  <dd class="It-tag">If <i>command</i> exits with status 100 (or any of the
      above exit statuses), avenger will reject the mail with a hard SMTP error
      (code 554). If <i>command</i> wrote output to its standard output, this
      output will be passed back to the mail client. Otherwise, asmtpd will
      supply the text &quot;message contents rejected.&quot;</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">111 (or any other exit status)</dt>
  <dd class="It-tag">If <i>command</i> exits with status 111, the result is the
      same as exit status 100, except that asmtpd will use a temporary error
      code (451) instead of 554.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag">signal</dt>
  <dd class="It-tag">If <i>command</i> exits abnormally because of a signal,
      asmtpd will also use 451, but in this case will not pass the program's
      output back to the client. It will instead pass back a description of the
      problem.</dd>
</dl>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
Note that asmtpd can only run one <b>bodytest</b> command per message. If there
  are multiple recipients of a message, all must run the same <b>bodytest</b>
  under the same user ID. If two users wish to run different <b>bodytest</b>
  commands, or even run the same command under different user IDs, asmtpd will
  defer the second SMTP &quot;RCPT&quot; command with the message:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;">452 send a separate copy of the message to
  this user</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
This will cause the mail client to re-send the message later to the second user.
  To avoid forcing clients to send multiple copies of messages, you can place
  <b>bodytest</b> commands in system wide files (such as the <i>default</i> rule
  file), or use a <b>redirect</b> command to redirect to the <b>AvengerUser</b>,
  so that commands for multiple users can be run under the <b>AvengerUser</b>
  user ID.
<div style="height: 1.00em;">&#x00A0;</div>
Note that file descriptor 0 inherited by <i>command</i> is opened for both
  reading and writing. Thus, it is possible to modify the message before it is
  spooled by the local MTA. The command <i>edinplace</i>(1) is useful for
  running messages through spam filters that annotate messages before spooling
  them.</div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>dns-a</b> <i>VARIABLE</i> <i>domain-name</i></dt>
  <dd class="It-tag">Requests that asmtpd perform a DNS lookup for A (IPv4
      address) records on <i>domain-name</i>. If such an A record exists, the
      reply is a list of one or more IP addresses:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><i>VARIABLE</i><b>=</b><i>IP-address</i>
  ...</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
If no such A record exists, the reply is simply:
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><i>VARIABLE</i><b>=</b></div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
With the standard avenger script, this sets <i>VARIABLE</i> to the empty string.
  If there is a temporary error in DNS name resolution, there is no reply, and
  hence with the default avenger script <i>VARIABLE</i> will remain unset.
<div style="height: 1.00em;">&#x00A0;</div>
When checking such things as RBLs, it is advisable not to reject mail because of
  a temporary DNS error. You can use the shell construct ${
  <i>VARIABLE</i>-<i>default</i>}$ to return $ <i>VARIABLE</i> when
  <i>VARIABLE</i> is set, and <i>default</i> when <i>VARIABLE</i> is not set.
  Similarly ${ <i>VARIABLE</i>+<i>set</i>} returns <i>set</i> if <i>VARIABLE</i>
  is set, and the empty string otherwise.
<div style="height: 1.00em;">&#x00A0;</div>
For example, if bad-senders.org contained an RBL of undesirable sender hosts:
<div style="height: 1.00em;">&#x00A0;</div>
<pre>
    echo dns-a BADSENDER &quot;$SENDER_HOST&quot;.bad-senders.org &gt;&amp;3
    setvars
    test -n &quot;$BADSENDER&quot; &amp;&amp; reject &quot;$SENDER_HOST is a bad sender&quot;
    test -z &quot;${BADSENDER+set}&quot; \
        &amp;&amp; defer &quot;$SENDER_HOST.bad-senders.org: DNS error&quot;
</pre>
<div style="height: 1.00em;">&#x00A0;</div>
Note that when using the avenger script, there is already a function <b>rbl</b>
  to check RBLs.</div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>dns-mx</b> <i>VARIABLE</i> <i>domain-name</i></dt>
  <dd class="It-tag">Similar to <b>dns-a</b>, but looks up MX records. A
      successful reply is of the form:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><i>VARIABLE</i><b>=</b><i>priority-1</i><b>:</b><i>host-1</i>
  [ <i>priority-2</i><b>:</b><i>host-2</i> ...]</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
Where <i>priority-1</i> is the MX priority of <i>host-1</i>. As before, an empty
  string indicates no MX records exist, and no reply indicates an error.</div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>dns-ptr</b> <i>VARIABLE</i> <i>IP-address</i></dt>
  <dd class="It-tag">Returns a list of verified DNS hostnames for
      <i>IP-address</i>. As before, an empty string for <i>VARIABLE</i>
      indicates no PTR records exist, and no reply indicates an error.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>dns-txt</b> <i>VARIABLE</i> <i>domain-name</i></dt>
  <dd class="It-tag">Similar to the other <b>dns</b> commands, but looks up a
      record of type TXT. If multiple TXT records exist, returns only one.
      Places some restrictions on the TXT records, for example will not return
      one that contains a newline character.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>netpath</b> <i>VARIABLE</i> <i>IP-address</i></dt>
  <dd class="It-tag">Maps out the network hops to <i>IP-address</i> (this is
      similar to the traceroute system utility, but more efficient). The reply
      is of the form:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><i>VARIABLE</i><b>=</b><i>#hops</i>
  <i>hop1</i> <i>hop2</i> ...</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<i>#hops</i> is the total number of network hops to <i>IP-address</i> if asmtpd
  can figure this out. (It won't always be able to if <i>IP-address</i> is
  behind a firewall.) If asmtpd cannot figure this out, the value is -1.
  <i>hop1</i> and the remaining arguments are the addresses of routers along the
  way to <i>IP-address</i>.</div>
<dl class="Bl-tag">
  <dt class="It-tag"><b>redirect</b> <i>local</i></dt>
  <dd class="It-tag">Terminates the current avenger process, and instead
      processes the mail as though it is being sent to <i>local</i>. This
      command is only available in &quot;rcpt&quot; mode, as opposed to
      &quot;mail&quot; mode (in which asmtpd runs avenger to see if it should
      relay mail for a local user on a non-local client machine).
    <div style="height: 1.00em;">&#x00A0;</div>
     <i>local</i> can be a local user name, or a local user name followed by the
      separator character and an extension. The name is mapped using the
      <i>aliases</i> (specified by <b>AliasFile</b> in <i>asmtpd.conf</i>).
    <div style="height: 1.00em;">&#x00A0;</div>
    Note that while the <b>AvengerUser</b> user can redirect to other users,
      ordinary users can only redirect to themselves or the
    <b>AvengerUser</b>.</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>return</b> <i>code</i> <i>explanation</i></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"> or</dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>return</b> <i>code</i><b>-</b><i>explanation</i></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>code</i><b>-</b><i>explanation</i></dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><i>code</i><b> </b><i>explanation</i></dt>
  <dd class="It-tag">Specifies the SMTP reponse desired. Also avoids further
      processing of the message with system-wide default rulesets (as typically
      happens when avenger simply exits with status 0). <i>code</i> must be a
      three digit number beginning 2, 4, or 5. (usually 250 for success, 451 to
      defer mail, and 554 to reject mail).
    <div style="height: 1.00em;">&#x00A0;</div>
    The first form of this command (with a space between <i>code</i> and
      <i>explanation</i>) gives a single line explanation along with the result
      code. In the second form, avenger specifies a multi-line response. In this
      case all but the last line must contain a <b>-</b> between the <i>code</i>
      and <i>explanation</i>, while the last line must contain a space. (Note
      that the <b>return</b> keyword only appears on the first line; after
      starting to issue a <b>return</b> command, no further commands can be
      issued.)</dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>spf</b> <i>VARIABLE</i> <i>SPF-mechanism</i> ...</dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>spf0</b> <i>VARIABLE</i> <i>SPF-mechanism</i> ...</dt>
  <dd class="It-tag"></dd>
</dl>
<dl class="Bl-tag">
  <dt class="It-tag"><b>spf1</b> <i>VARIABLE</i> <i>SPF-mechanism</i> ...</dt>
  <dd class="It-tag">Evaluates the mail client based on SPF mechanisms. It will
      return:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><i>VARIABLE</i><b>=</b><i>disposition</i></div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">&#x00A0;</div>
where, for <b>spf0</b>, <i>disposition</i> is one of: <b>none</b>,
  <b>neutral</b>, <b>pass</b>, <b>fail</b>, <b>softfail</b>, <b>error</b>, or
  <b>unknown</b> (though the disposition <b>none</b> is actually impossible).
  For <b>spf1</b>, the equivalent <i>disposition</i> names are <b>None</b>,
  <b>Neutral</b>, <b>Pass</b>, <b>Fail</b>, <b>SoftFail</b>, <b>TempError</b>,
  <b>PermError</b>. (Currently <b>spf</b> is a synonym for <b>spf0</b>, but it
  is recommended that you avoid using <b>spf</b> as in a future release it may
  become an alias for <b>spf1</b>.)
<div style="height: 1.00em;">&#x00A0;</div>
As an example, suppose that your username is &quot;joe&quot;, <b>Separator</b>
  is &quot;+&quot;, and you have subscribed to a number of yahoo mailing lists
  using email address &quot;joe+yahoo&quot;. If spammers started sending mail to
  &quot;joe+yahoo&quot;, you would want to reject all mail to that address
  except that originating from yahoo's computers. Yahoo's computers might
  correspond to anything ending &quot;.yahoo.com&quot; or sharing a 24-bit
  IP-address prefix with any of yahoo.com's MX records. This can be accomplished
  with the following script in <i></i><i>$HOME</i><i>/.avenger/rcpt+yahoo</i>:
<div style="height: 1.00em;">&#x00A0;</div>
<pre>
    echo spf YAHOO ptr:yahoo.com mx:yahoo.com/24 -all &gt;&amp;3
    setvars
    case &quot;$YAHOO&quot; in
    fail)
        reject &quot;Sorry, this private alias for Yahoo lists only&quot;
        ;;
    error)
        defer &quot;Sorry, temporary DNS error&quot;
        ;;
    esac
</pre>
</div>
<h1 class="Sh" title="Sh" id="EXAMPLES"><a class="selflink" href="#EXAMPLES">EXAMPLES</a></h1>
If you never use your email address as an envelope sender, you can reject all
  bounces to that address with these commands in your <i>rcpt</i> file:
<div class="Pp"></div>
<pre>
    test -z &quot;$SENDER&quot; \
        &amp;&amp; reject &quot;&lt;$RECIPIENT&gt; not a valid sender;&quot; \
        &quot; should not receive bounces&quot;
</pre>
<div class="Pp"></div>
The following script runs spamassassin (a popular spam filter, available from
  &lt;http://www.spamassassin.org/&gt;) on the body of a message, unless the
  sender of the message has an SPF disposition of pass or is already going to be
  rejected by default.
<div class="Pp"></div>
<pre>
    # The next line immediately falls through to the default reject
    # disposition when mail has an SPF disposition of fail or the
    # sender does not accept bounce messages.
    errcheck
    test &quot;$SPF&quot; = pass \
        || bodytest edinplace -x 111 spamassassin -e 100
</pre>
<div class="Pp"></div>
The following script immediately accepts any mail from any machine at MIT or NYU
  (provided MAIL_ERROR is not set), &quot;greylists&quot; machines not in one of
  those domains, and if the greylist passes, falls through to the the default,
  system-wide rules:
<div class="Pp"></div>
<pre>
    errcheck
    spf TRUSTED ptr:nyu.edu ptr:mit.edu ?all
    setvars
    test pass = &quot;$TRUSTED&quot; &amp;&amp; accept Trusted sender OK
    greylist_delay=5m
    greylist
</pre>
<div class="Pp"></div>
The following script rejects mail from clients that have issued an SMTP
  &quot;POST&quot; command (which doesn't exist) or used aggressive, premature
  pipelining of commands. If the client put a space after the colon in the MAIL
  FROM: or RCPT TO: SMTP commands, it greylists the message using a key that
  includes the SYN fingerprint and first 24-bits of the IP address. If the SPF
  disposition of the message is error, it defers the message. If the SPF
  disposition of the message is softfail or none, it runs the body of the
  message through spamassassin.
<div class="Pp"></div>
<pre>
    errcheck
    test -n &quot;$CLIENT_POST&quot; -o -n &quot;$CLIENT_PIPELINING&quot; \
        &amp;&amp; reject &quot;no spam please&quot;
    test -n &quot;$CLIENT_COLONSPACE&quot; \
        &amp;&amp; greylist &quot;${CLIENT_IP%.*} $CLIENT_SYNFP $SENDER&quot;
    case &quot;$SPF&quot; in
        error)
            defer &quot;Temporary error in SPF record processing&quot;
            ;;
        softfail|none)
            bodytest edinplace -x 111 spamassassin -e 100
            ;;
    esac
</pre>
<div class="Pp"></div>
If you set your <b>MACUTIL_SENDER</b> environment variable to be
  &quot;user+bounce+*@your.host.com&quot; and send mail with <b>macutil</b>
  <b>--sendmail</b>, you can create the following <i>rcpt+bounce+default</i> to
  accept mail only to valid bounce addresses.
<div class="Pp"></div>
<pre>
    macutil --check &quot;$SUFFIX&quot; &gt; /dev/null \
        || reject &quot;&lt;$RECIPIENT&gt;.. user unknown&quot;
</pre>
<div class="Pp"></div>
In conjunction with this script, you may want to reject bounce messages to your
  regular email addresss with your <i>rcpt</i> script, as described in the first
  example.
<div class="Pp"></div>
This example is slightly more complicated, and shows how to use a bodytest to
  reject mail based on message contents. The goal of this set-up is to check
  each message with the ClamAV anti-virus software (from
  &lt;http://www.clamav.net/&gt;) and the spamassassin mail filter. If the
  message contains a virus or is flagged as spam, it should be rejected with an
  explanation of the problem. We construct a shell script,
  <i></i><i>$HOME</i><i>/.avenger/body</i>, to run these tests on message
  bodies. The script can be invoked with the line
<div style="height: 1.00em;">&#x00A0;</div>
<div style="margin-left: 4.00ex;"><b>bodytest
  </b><b>$HOME</b><b>/.avenger/body</b></div>
<div class="Pp"></div>
in your <i></i><i>$HOME</i><i>/.avenger/rcpt</i> file. Or, alternatively the
  script could be configured to run in the system-wide
  <i>/etc/avenger/default</i> file (in which case you want to make sure that the
  <b>AvengerUser</b> can write its own home directory, so as to store
  spamassassin files). The script is as follows:
<div class="Pp"></div>
<pre>
    #!/bin/sh
    out=&quot;`clamscan -i --no-summary --mbox -  2&gt;&amp;1`&quot;
    if test &quot;$?&quot; = 1; then
        echo This message appears to be infected with a virus
        printf &quot;%s\n&quot; &quot;$out&quot; \
            | sed -e '/Warning:/d' -e 's/^[^:]*: //' | sort -u
        exit 100
    fi
    out=&quot;`edinplace -x 111 spamassassin -e 100`&quot;
    case &quot;$?&quot; in
        0)
            exit 0
            ;;
        100)
            echo Sorry, spamassassin has flagged your message as spam
            while read a b c; do
                test &quot;$a $b&quot; = &quot;Content analysis&quot; &amp;&amp; break
            done
            read a
            read a
            read a
            while read a b c; do
                case &quot;$a&quot; in
                &quot;&quot;)
                    break
                    ;;
                -*)
                    ;;
                [0-9]*)
                    printf &quot;  %s\n&quot; &quot;$c&quot;
                    ;;
                *)
                    printf &quot;    %s\n&quot; &quot;$a $b $c&quot;
                    ;;
                esac
            done
            exit 100
            ;;
        *)
            if test -n &quot;$out&quot;; then
                echo spamassassin failure:
                printf &quot;%s\n&quot; &quot;$out&quot;
            else
                echo system error in spamassassin
            fi
            exit 111
            ;;
    esac
</pre>
<div class="Pp"></div>
The first half of this script runs the clamscan virus checker, storing the
  output in variable out. clamscan exits with code 1 when a virus is found,
  exits 0 on success, and uses other error codes to indicate various system
  errors. We only want to reject mail if clamscan exits with code 1. When this
  happens, we take the output of clamscan, format it in a more pleasing way
  (stripping out warnings), and send it to standard output. An example of an
  SMTP transaction using this bodytest and detecting a virus will look like this
  (tested with the special EICAR test string that flags a positive with most
  virus checkers):
<div class="Pp"></div>
<pre>
    DATA
    354 enter mail, end with &quot;.&quot; on a line by itself
    Subject: eicar test
    X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
    .
    554-This message appears to be infected with a virus
    554 Eicar-Test-Signature FOUND
</pre>
<div class="Pp"></div>
If the virus check fails, the script runs the message through spamassassin to
  check for spam. Note that spamassassin modifies the mail message, so that we
  must run it with edinplace. Note also that clamscan will read to the end of
  the input file, but this is okay since edinplace rewinds its standard input.
  We use the <b>-e</b> flag to tell spamassassin to exit 100 on spam. Then, if
  spamassassin exits 0, we accept the mail. If it exits with anything but 100,
  something went wrong and we temporarily defer the mail. Note that it might
  also be possible to accept the mail at this point, but since spamassassin
  edits the file in place, the message may be truncated if spamassassin exits
  unexpectedly.
<div class="Pp"></div>
If spamassassin exits 100, we reject the mail. We also report on why
  spamassassin has rejected the mail. Here again we take advantage of the fact
  that edinplace rewinds its standard input both before and after processing a
  message. Because the file descriptor has been rewound, we can start processing
  the message one line at a time with the shell script. Spamassassin by default
  (if you have not configred it with &quot;report_safe 0&quot;) contains a spam
  report like this:
<div class="Pp"></div>
<pre>
 Content analysis details:   (11.7 points, 5.0 required)
  pts rule name        description
 ---- --------------- --------------------------------------------------
  1.0 RATWARE_RCVD_AT Bulk email fingerprint (Received @) found
  4.2 X_MESSAGE_INFO  Bulk email fingerprint (X-Message-Info) found
  0.0 MONEY_BACK      BODY: Money back guarantee
  0.5 BIZ_TLD         URI: Contains a URL in the BIZ top-level domain
  0.6 URIBL_SBL       Contains a URL listed in the SBL blocklist
                      [URIs: crocpeptide.biz]
  0.5 URIBL_WS_SURBL  Contains a URL listed in the WS SURBL blocklist
                      [URIs: crocpeptide.biz]
 ...
</pre>
<div class="Pp"></div>
We skip over the headers, and for each result, print it to the SMTP session.
  Negative/whitelist results (those starting -), we do not report, and comment
  lines (not starting with a number) we print indented. A typical SMTP session
  looks like this (using the special GTUBE test line that triggers spam
  filters):
<div class="Pp"></div>
<pre>
    DATA
    354 enter mail, end with &quot;.&quot; on a line by itself
    Subject: gtube test
    XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X
    .
    554-Sorry, spamassassin has flagged your message as spam
    554-  Missing Date: header
    554   BODY: Generic Test for Unsolicited Bulk Email
</pre>
<div class="Pp"></div>
Here's an example of how to use SSL client certificates for authentication. If
  you have a private CA with common name &quot;My CA&quot; that signs the
  certificates of all your authorized mail clients, you can place the following
  in <i>/etc/avenger/relay</i> to permit those clients to relay:
<div class="Pp"></div>
<pre>
    test &quot;My CA&quot; = &quot;$SSL_ISSUER&quot; \
        &amp;&amp; accept &quot;Relaying permitted for client $SSL_SUBJECT&quot;
    reject &quot;relaying denied&quot;
</pre>
<h1 class="Sh" title="Sh" id="FILES"><a class="selflink" href="#FILES">FILES</a></h1>
<i>/usr/local/libexec/avenger</i>, <i>/etc/avenger/default</i>,
  <i></i><i>$HOME</i> <i>/.avenger/rcpt</i>,
  <i></i><i>$HOME</i><i>/.avenger/rcpt*</i>
  <i></i><i>$HOME</i><i>/.avenger/mail</i>,
  <i></i><i>$HOME</i><i>/.avenger/mail*</i>
<h1 class="Sh" title="Sh" id="SEE_ALSO"><a class="selflink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<i>dbutil</i>(1), <i>deliver</i>(1), <i>edinplace</i>(1), <i>escape</i>(1),
  <i>macutil</i>(1), <i>match</i>(1), <i>synos</i>(1), <i>asmtpd.conf</i>(5),
  <i>asmtpd</i>(8), <i>avenger.local</i>(8)
<div class="Pp"></div>
The Mail Avenger home page: &lt;http://www.mailavenger.org/&gt;.
<h1 class="Sh" title="Sh" id="BUGS"><a class="selflink" href="#BUGS">BUGS</a></h1>
avenger (and the configuration files it reads) are shell scripts. In a shell
  script, it is sometimes tempting to use &quot;echo ...&quot; where one should
  instead use the command &quot;printf '%s\n' ...&quot;. (The later just prints
  its argument to standard output, while the former interprets various
  &quot;\&quot; escape codes.)
<div class="Pp"></div>
In shell scripts, one must be careful about variables containing shell
  metacharacters. For example, it is not safe to run something like:
<div class="Pp"></div>
<pre>
        bodytest &quot;echo $VAR &gt; $PWD/log&quot;
</pre>
<div class="Pp"></div>
if variable &quot;VAR&quot; has untrusted contents that might contain characters
  like &quot;&gt;&quot; or &quot;;&quot;. The reason is that $VAR will be
  expanded and sent back to the SMTP server, which will then pass the expansion
  to the shell to execute the bodytest. ($VAR effectively gets expanded twice.)
  The escape utility can be used to avoid these problems. For example:
<div class="Pp"></div>
<pre>
        bodytest echo `escape &quot;$VAR&quot;` &quot;&gt;&quot; $PWD/log
</pre>
<div class="Pp"></div>
It is easy to forget to call <b>setvars</b> after a <b>dns</b>, <b>rbl</b>, or
  <b>spf</b> command.
<h1 class="Sh" title="Sh" id="AUTHOR"><a class="selflink" href="#AUTHOR">AUTHOR</a></h1>
David Mazieres</div>
<table class="foot">
  <tr>
    <td class="foot-date">2013-07-13</td>
    <td class="foot-os">Mail Avenger 0.8.4</td>
  </tr>
</table>
</body>
</html>
