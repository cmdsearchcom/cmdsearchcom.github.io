<!-- Creator     : groff version 1.22.3 -->
<!-- CreationDate: Sun Aug 27 15:59:02 2017 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title></title>
</head>
<body>

<hr>


<p>CLSYNC(1) User Manuals CLSYNC(1)</p>

<p style="margin-top: 1em">NAME <br>
clsync - live sync tool, written in GNU C</p>

<p style="margin-top: 1em">SYNOPSIS <br>
clsync [ ... ] -- [ sync-handler-arguments ]</p>

<p style="margin-top: 1em">DESCRIPTION <br>
clsync executes sync-handler with appropriate arguments on
FS events in directory watch-dir using the inotify(7) or
other FS monitoring subsystems.</p>

<p style="margin-top: 1em">OPTIONS <br>
This options can be passed as arguments or to be used in the
configuration file.</p>

<p style="margin-top: 1em">To disable numeric option set to
zero: <br>
=0</p>

<p style="margin-top: 1em">To disable string option (for
example path to file) set to empty string: <br>
=</p>

<p style="margin-top: 1em">Also you can use previously set
values while setting new options. Substring %option_name%
will be substituted with previously set value of option
option_name. (see CONFIGURATION <br>
FILE)</p>

<p style="margin-top: 1em">sync-handler-arguments applies
only to modes: <br>
simple, direct, shell, rsyncdirect, rsyncshell</p>

<p style="margin-top: 1em">To set sync-handler-arguments in
config file use &rsquo;--&rsquo;. An example: <br>
-- = -aH --exclude-from %EXCLUDE-LIST%
--include-from=%INCLUDE-LIST% --exclude &rsquo;*&rsquo;
%watch-dir%/ %destination-dir%/</p>

<p style="margin-top: 1em">-W, --watch-dir watch-dir <br>
Root directory to be monitored by clsync.</p>

<p style="margin-top: 1em">Required.</p>

<p style="margin-top: 1em">-S, --sync-handler sync-handler
<br>
Path to sync-handler to be used for syncing by clsync. (see
--mode)</p>

<p style="margin-top: 1em">Is required for all modes except
&quot;direct&quot; and &quot;rsyncdirect&quot; [see SYNC
HANDLER MODES]</p>

<p style="margin-top: 1em">-R, --rules-file rules-file <br>
Path to file with filter rules of objects to be monitored.
(see RULES)</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-D, --destination-dir
destination-directory <br>
Defines directory to sync to for modes
&quot;rsyncdirect&quot;, &quot;rsyncso&quot; and
&quot;so&quot;. (see --mode)</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-M, --mode mode <br>
Sets syncing mode. Possible values: <br>
simple <br>
calls sync-handler for every event <br>
direct <br>
calls sync-handler for every sync with passing files lists
as arguments <br>
shell <br>
calls sync-handler for every sync with passing files lists
in a file <br>
rsyncdirect <br>
calls rsync by path sync-handler directly <br>
rsyncshell <br>
calls sync-handler that supposed to run rsync for every sync
(recommended mode)&quot; <br>
rsyncso <br>
loads shared object by path sync-handler with dlopen(3) and
calls function clsyncapi_rsync function for every sync <br>
so <br>
loads shared object by path sync-handler with dlopen(3) and
calls function clsyncapi_sync function for every sync</p>

<p style="margin-top: 1em">See SYNC HANDLER MODES</p>

<p style="margin-top: 1em">Required.</p>

<p style="margin-top: 1em">-b, --background <br>
Daemonize, forcing clsync to fork() on start.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-H, --config-file
config-file-path <br>
Use configuration from file config-file-path (see
CONFIGURATION FILE).</p>

<p style="margin-top: 1em">Set to &quot;/NULL/&quot; if no
config files should be read.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-K, --config-block
config-block-name <br>
Use configuration block with name config-block-name (see
CONFIGURATION FILE).</p>

<p style="margin-top: 1em">The default value is
&quot;default&quot;.</p>

<p style="margin-top: 1em">--config-block-inherits
config-parent-block-name <br>
Use configuration block with name config-parent-block-name
as parent for config-block-name (see CONFIGURATION FILE).
Options from config-parent-block-name will be inher&acirc;
<br>
ited to config-block-name.</p>

<p style="margin-top: 1em">The default value is
&quot;default&quot;.</p>

<p style="margin-top: 1em">--custom-signals custom-signals
<br>
Set a list of signals and corresponding config block names.
The config block will be use on catching the corresponding
signal.</p>

<p style="margin-top: 1em">Format is <br>

signal:config-block-name[,signal:config-block-name[,...]]</p>

<p style="margin-top: 1em">For example: <br>
--custom-signals=29:debug,28:normal <br>
In this line signals &quot;28&quot; and &quot;29&quot; will
be added to the sighandler. And clsync will use options from
config block &quot;debug&quot; on signal 29 and
&quot;normal&quot; on signal 28.</p>

<p style="margin-top: 1em">To reset all custom signals use
the 0-th signal (e.g. &quot;--custom-signals=0&quot;).</p>

<p style="margin-top: 1em">The default value is
&quot;&quot;.</p>

<p style="margin-top: 1em">-z, --pid-file path-to-pidfile
<br>
Writes pid to file by path path-to-pidfile.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--status-file status-file-path
<br>
Write status description into file with path
status-file-path.</p>

<p style="margin-top: 1em">Possible statuses: <br>
starting <br>
initializing subsystems and marking file tree with FS
monitor subsystem <br>
initsync <br>
processing initial syncing <br>
running <br>
waiting for events or syncing <br>
synchandler error <br>
waiting between synchandler execution tries (after a
failure) [is used only while --threading=off] <br>
rehashing <br>
reloading configuration files <br>
thread gc <br>
running threads&rsquo; garbage collector <br>
preexit <br>
executing the --pre-exit-hook <br>
terminating <br>
running the last iteration (if required) and preparing to
die <br>
exiting <br>
executing the --exit-hook and cleaning up [for
valgrind(1)]</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-r, --retries number-of-tries
<br>
Tries limit to sync with sync-handler.</p>

<p style="margin-top: 1em">clsync will die after
number-of-tries tries.</p>

<p style="margin-top: 1em">To try infinite set
&quot;0&quot;.</p>

<p style="margin-top: 1em">Delay between tries is equal to
--delay-sync value.</p>

<p style="margin-top: 1em">The default value is
&quot;1&quot;.</p>

<p style="margin-top: 1em">--ignore-failures <br>
Don&rsquo;t die on sync failures.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--exit-on-sync-skip <br>
Exit if some event could be skipped due to any reason.</p>

<p style="margin-top: 1em">For example FreeBSD has a very
short BSM event queue (1024). So it may be overflowed and
some events can not climb to the queue. This option forces
clsync to exit if the <br>
queue had been overflowed.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-p, --threading threading-mode
<br>
Use pthreads(7) to parallelize syncing processes. For
example if clsync (with --threading=off) is already syncing
a huge file then all other syncs will be suspended until
<br>
the huge file syncing finish. To prevent this suspends you
can use &quot;safe&quot; or &quot;full&quot; threading
mode.</p>

<p style="margin-top: 1em">Possbile values: <br>
off <br>
disable threading for syncing processes. <br>
safe <br>
parallelize syncs but suspend syncings of object that are
already syncing in another process (until the process
finish). <br>
full <br>
parallelize syncs without suspendings.</p>

<p style="margin-top: 1em">Characteristics: <br>
off <br>
New modifications won&rsquo;t be synced until old ones
finish. <br>
safe <br>
Theoretically is the best way. But may utilize of lot of CPU
if there&rsquo;s a lot of simultaneous parallel syncs. (also
this way is not well tested) <br>
full <br>
May cause multiple simultaneous syncing of the same file,
which in turn can cause bug inside sync-handler (see
below).</p>

<p style="margin-top: 1em">If you&rsquo;re running clsync
with option --threading=full in conjunction with rsync with
option --backup, you may catch a bug due to nonatomicity of
rsync&rsquo;s file replace oper&acirc; <br>
ation. (see DIAGNOSTICS)</p>

<p style="margin-top: 1em">The default value is
&quot;off&quot;.</p>

<p style="margin-top: 1em">-Y, --output log-destination
<br>
Sets destination for log writing (errors, warnings, infos
and debugging).</p>

<p style="margin-top: 1em">Possible values: <br>
stderr <br>
stdout <br>
syslog</p>

<p style="margin-top: 1em">The default value is
&quot;stderr&quot;.</p>

<p style="margin-top: 1em">--one-file-system <br>
Don&rsquo;t follow to different devices&rsquo; mount points.
This option just adds option &quot;FTS_XDEV&quot; for
fts_open(3) function.</p>

<p style="margin-top: 1em">Warning! If you&rsquo;re using
this option (but no --exclude-mount-points) clsync will
write neither includes nor excludes of content of mount
points. <br>
This may cause problems e.g. you&rsquo;re using rsync for
sync-handler without similar option
&quot;--one-file-system&quot;.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-X, --exclude-mount-points <br>
Forces --one-file-system but also add excludes to do not
sync mount points.</p>

<p style="margin-top: 1em">This requires to do stat(2)
syscalls on every dir and can reduce performance.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--socket socket-path <br>
Create a control socket by path socket-path.</p>

<p style="margin-top: 1em">This&rsquo;s very experimental
feature.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--socket-own
socket-owner-user[:socket-owner-group] <br>
Sets the control socket owner user (and group).</p>

<p style="margin-top: 1em">Is not set by default</p>

<p style="margin-top: 1em">--socket-mod socket-mode <br>
Sets the control socket mode [see chmod(2)].</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--standby-file standby-file-path
<br>
Sets file to path that should be checked before every sync.
If file exists the sync will be suspended until the file is
deleted. It may be useful if you need freeze desti&acirc;
<br>
nation directory while running some scripts.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--max-iterations
iterations-count <br>
Sets synchronization iterations limit. One iteration means
one sync-handler execution.</p>

<p style="margin-top: 1em">iterations-count <br>
set to 0 means no limit (infinite loop).</p>

<p style="margin-top: 1em">set to 1 means that only initial
sync will be done</p>

<p style="margin-top: 1em">set to n means that only initial
sync and (n-1) sync-ups after that will be done</p>

<p style="margin-top: 1em">Hint: This option may be useful
in conjunction with --exit-on-no-events to prevent infinite
sync-up processes.</p>

<p style="margin-top: 1em">The default value is
&quot;0&quot;.</p>

<p style="margin-top: 1em">--modification-signature
signature-mask <br>
Sets file/dir modification recheck signature. If file is not
modified (according to the signature) then don&rsquo;t sync
it.</p>

<p style="margin-top: 1em">See struct stat in lstat(2) for
possible fields.</p>

<p style="margin-top: 1em">For example reasonable
signature-mask-s can be
&quot;dev,ino,mode,uid,gid,rdev,size,atime,mtime,ctime&quot;
(there&rsquo;s an alias for that &acirc; &quot;*&quot;) or
&quot;uid,gid&quot;.</p>

<p style="margin-top: 1em">Examples of use cases: <br>
chown/chmod <br>
If you&rsquo;re using clsync for fixing file/dir privileges
[using chown(1) and/or chmod(1)] than reasonable signature
will be &quot;uid,gid&quot;.</p>

<p style="margin-top: 1em">Full example: clsync -w5 -t5 -T5
-x1 -W /var/www/site.example.org/root -Mdirect -Schown --uid
0 --gid 0 -Ysyslog -b1 --modification-signature uid,gid --
<br>
--from=root www-data:www-data %INCLUDE-LIST% <br>
bi-directional syncing <br>
If you&rsquo;re going to setup bi-directional syncing then
you may use --modification-signature &quot;*&quot; to
prevent sync loop between servers. <br>
Not enough CPU <br>
If rsync eats too many CPU with rechecking hashsums of files
on their dry open()/close() due to some hacky script (for
example &quot;chown -R www-data:www-data&quot; <br>
in cron) then you can use --modification-signature
&quot;dev,ino,mode,uid,gid,rdev,size,atime,mtime&quot;
(without &quot;blksize&quot;, &quot;blocks&quot;,
&quot;nlink&quot; and &quot;ctime&quot;).</p>

<p style="margin-top: 1em">Warning! This option may eat a
lot of memory on huge file trees.</p>

<p style="margin-top: 1em">This option cannot be used
together with &quot;--cancel-syscalls=mon_stat&quot;</p>

<p style="margin-top: 1em">To disable file/dir modification
rechecking use empty value &acirc; &quot;&quot;.</p>

<p style="margin-top: 1em">The default value is
&quot;&quot;.</p>

<p style="margin-top: 1em">-k, --timeout-sync sync-timeout
<br>
Sets timeout for syncing processes. clsync will die if
syncing process alive more than sync-timeout seconds.</p>

<p style="margin-top: 1em">Set &quot;0&quot; to disable the
timeout.</p>

<p style="margin-top: 1em">The default value is
&quot;86400&quot; [&quot;24 hours&quot;].</p>

<p style="margin-top: 1em">-w, --delay-sync
additional-delay <br>
Sets the minimal delay (in seconds) between syncs.</p>

<p style="margin-top: 1em">The default value is
&quot;30&quot;.</p>

<p style="margin-top: 1em">-t, --delay-collect
ordinary-delay <br>
Sets the delay (in seconds) to collect events about ordinary
files and directories.</p>

<p style="margin-top: 1em">The default value is
&quot;30&quot;.</p>

<p style="margin-top: 1em">-T, --delay-collect-bigfile
bigfiles-delay <br>
Sets the delay (in seconds) to collect events about
&quot;big files&quot; (see --threshold-bigfile).</p>

<p style="margin-top: 1em">The default value is
&quot;1800&quot;.</p>

<p style="margin-top: 1em">-B, --threshold-bigfile
filesize-threshold <br>
Sets file size threshold (in bytes) that separates ordinary
files from &quot;big files&quot;. Events about &quot;big
files&quot; are processed in another queue with a separate
collecting <br>
delay. This is supposed to be used as a means of unloading
IO resources.</p>

<p style="margin-top: 1em">To disable detection of
&quot;big files&quot; set &quot;0&quot; (zero). This can
improve perfomance by removing necessity in extra lstat()
syscall.</p>

<p style="margin-top: 1em">The default value is
&quot;134217728&quot; [&quot;128 MiB&quot;].</p>

<p style="margin-top: 1em">--cancel-syscalls syscalls-mask
<br>
Sets syscalls to be bypassed. This may be used for to
squeeze more performance.</p>

<p style="margin-top: 1em">Possible values: <br>
mon_stat <br>
Skip lstat() calls while handling files/dirs events. This
makes unpossible to determine files sizes (that is used by
--threshold-bigfile option) and to use <br>
option --modification-signature.</p>

<p style="margin-top: 1em">You can combine this values
using commas.</p>

<p style="margin-top: 1em">To disable this option just use
empty value &acirc; &quot;&quot;.</p>

<p style="margin-top: 1em">The default value is
&quot;&quot;.</p>

<p style="margin-top: 1em">-L, --lists-dir tmpdir-path <br>
Sets directory path to output temporary events-lists
files.</p>

<p style="margin-top: 1em">See SYNC HANDLER MODES.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--have-recursive-sync <br>
Use action &quot;recursivesync&quot; instead of
&quot;synclist&quot; for directories that were just marked
(see SYNC HANDLER MODES case shell).</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--synclist-simplify <br>
Removes the first 3 parameters in list files of action
&quot;synclist&quot; (see SYNC HANDLER MODES case
shell).</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--rsync-inclimit
rsync-includes-line-limit <br>
Sets soft limit for lines count in files by path
rsync-listpath. Unfortunately, rsync works very slowly with
huge &quot;--include-from&quot; files. So, clsync splits
that list with <br>
approximately rsync-includes-line-limit lines per list if
it&rsquo;s too big, and executes by one rsync instance per
list part. Use value &quot;0&quot; to disable the limit.</p>

<p style="margin-top: 1em">The default value is
&quot;20000&quot;.</p>

<p style="margin-top: 1em">--rsync-prefer-include <br>
Forces clsync to prefer a &quot;lot of includes&quot; method
instead of a &quot;excludes+includes&quot; for rsync on
recursive syncing.</p>

<p style="margin-top: 1em">See cases rsyncshell,
rsyncdirect and rsyncso of SYNC HANDLER MODES.</p>

<p style="margin-top: 1em">This option is not
recommended.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-x, --ignore-exitcode exitcode
<br>
Forces clsync to do not process exitcode exitcode of
sync-handler as an error. You can set multiple ignores by
passing this option multiple times.</p>

<p style="margin-top: 1em">Recommended values for rsync
case is &quot;24&quot;. You can set multiple values with
listing a lot of &quot;-x&quot; options (e.g. &quot;-x 23 -x
24&quot;) or via commas (e.g. &quot;-x 23,24&quot;). To drop
the <br>
list use zero exitcode (e.g. &quot;-x 0&quot;). For example
you can use &quot;-x 0,23&quot; to drop the list and set
&quot;23&quot;-th exitcode to be ignored.</p>

<p style="margin-top: 1em">Is not set by default (or
equally is set to &quot;0&quot;).</p>

<p style="margin-top: 1em">-U, --dont-unlink-lists <br>
Do not delete list-files after sync-handler has
finished.</p>

<p style="margin-top: 1em">This may be used for debugging
purposes.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--fts-experimental-optimization
<br>
Enable experimental features to optimize file tree scanning
while using fts(3). The features will be enabled by default
after appropriate testing.</p>

<p style="margin-top: 1em">At the moment the option
doesn&rsquo;t do anything but can be used in future.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-F, --full-initialsync <br>
Ignore filter rules from rules-file on initial sync.</p>

<p style="margin-top: 1em">This may be useful for quick
start or e.g. if it&rsquo;s required to sync
&quot;/var/log/&quot; tree but not sync every change from
there.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--only-initialsync <br>
Exit after initial syncing on clsync start.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--exit-on-no-events <br>
Exit if there&rsquo;s no events. Works like
--only-initialsync, but also syncs events collected while
the initial syncing.</p>

<p style="margin-top: 1em">Unlike --only-initialsync this
option uses FS monitor subsystem to monitor for new events
while the initial syncing. This may reduce performance. On
the other hand this <br>
way may be used to be sure, that everything is synced at the
moment before clsync will exit.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--skip-initialsync <br>
Skip initial syncing on clsync start.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--exit-hook
path-of-exit-hook-program <br>
Sets path of program to be executed on clsync exit.</p>

<p style="margin-top: 1em">If this parameter is set then
clsync will exec on exit: <br>
path-of-exit-hook-program label</p>

<p style="margin-top: 1em">The execution will be skipped if
initial sync wasn&rsquo;t complete.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--pre-exit-hook
path-of-pre-exit-hook-program <br>
Sets path of program to be executed before the last sync
iteration (see --max-iterations, --exit-on-no-events and
SIGNALS).</p>

<p style="margin-top: 1em">If this parameter is set then
clsync will exec on exit: <br>
path-of-pre-exit-hook-program label</p>

<p style="margin-top: 1em">The execution will be skipped if
initial sync wasn&rsquo;t complete.</p>

<p style="margin-top: 1em">If clsync finishes due to
--exit-on-no-events and --pre-exit-hook is set then the
pre-exit hook will be executed and additional sync iteration
will be triggered.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-v, --verbose <br>
This option is supposed to increase verbosity. But at the
moment there&rsquo;s no &quot;verbose output&quot; in the
code, so the option does nothing. :)</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-d, --debug <br>
Increases debugging output. This may be supplied multiple
times for more debugging information, up to a maximum of
five &quot;d&quot; flags (more will do nothing), for example
&quot;-d <br>
-d -d -d -d&quot; or &quot;-d5&quot; (equivalent cases)</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--dump-dir <br>
Directory to write clsync&rsquo;s instance information by
signal 29 (see SIGNALS). The directory shouldn&rsquo;t
exists before dumping.</p>

<p style="margin-top: 1em">Is set to
&quot;/tmp/clsync-dump-%label%&quot; by default.</p>

<p style="margin-top: 1em">-q, --quiet <br>
Suppresses error messages.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--monitor monitor-subsystem <br>
Switches FS monitor subsystem.</p>

<p style="margin-top: 1em">Possible values: <br>
inotify <br>
inotify(7) [Linux, (FreeBSD via libinotify)]</p>

<p style="margin-top: 1em">Native, fast, reliable and well
tested Linux FS monitor subsystem.</p>

<p style="margin-top: 1em">There&rsquo;s no essential
performance profit to use &quot;inotify&quot; instead of
&quot;kevent&quot; on FreeBSD using &quot;libinotify&quot;.
It backends to &quot;kevent&quot; anyway.</p>

<p style="margin-top: 1em">FreeBSD users: The libinotify on
FreeBSD is still not ready and unusable for clsync to sync a
lot of files and directories.</p>

<p style="margin-top: 1em">gio <br>
Use gio library.</p>

<p style="margin-top: 1em">Crossplatform and tested library
that backends to kqueue on FreeBSD and inotify on Linux. See
inotify and kqueue sections here for details.</p>

<p style="margin-top: 1em">Not well tested. Use with
caution!</p>

<p style="margin-top: 1em">kqueue <br>
kqueue(2) [FreeBSD, (Linux via libkqueue)]</p>

<p style="margin-top: 1em">A *BSD kernel event notification
mechanism (inc. timer, sockets, files etc).</p>

<p style="margin-top: 1em">This monitor subsystem cannot
determine file creation event, but it can determine a
directory where something happened. So clsync is have to
rescan whole dir <br>
every time on any content change. Moreover, kqueue requires
an open() on every watched file/dir. But FreeBSD
doesn&rsquo;t allow to open() symlink itself (without <br>
following) and it&rsquo;s highly invasively to open() pipes
and devices. So clsync just won&rsquo;t call open() on
everything except regular files and directories. Con&acirc;
<br>
sequently, clsync cannot determine if something changed in
symlink/pipe/socket and so on. However it still can
determine if it will be created or deleted by <br>
watching the parent directory and rescaning it on every
appropriate event.</p>

<p style="margin-top: 1em">Also this API requires to open
every monitored file and directory. So it may produce a huge
amount of file descriptors. Be sure that kern.maxfiles is
big <br>
enough (in FreeBSD).</p>

<p style="margin-top: 1em">CPU/HDD expensive way.</p>

<p style="margin-top: 1em">Not well tested. Use with
caution!</p>

<p style="margin-top: 1em">Linux users: The libkqueue on
Linux is not working. He-he :)</p>

<p style="margin-top: 1em">bsm <br>
bsm(3) [FreeBSD]</p>

<p style="margin-top: 1em">Basic Security Module (BSM)
Audit API.</p>

<p style="margin-top: 1em">This is not a FS monitor
subsystem, actually. It&rsquo;s just an API to access to
audit information (inc. logs). clsync can setup audit to
watch FS events and <br>
report it into log. After that clsync will just parse the
log via auditpipe(4) [FreeBSD].</p>

<p style="margin-top: 1em">Reliable, but hacky way. It
requires global audit reconfiguration that may hopple audit
analysis.</p>

<p style="margin-top: 1em">Warning! FreeBSD has a limit for
queued events. In default FreeBSD kernel it&rsquo;s only
1024 events. So choose one of: <br>
- To patch the kernel to increase the limit. <br>
- Don&rsquo;t use clsync on systems with too many file
events. <br>
- Use bsm_prefetch mode (but there&rsquo;s no guarantee in
this case anyway). <br>
See also option --exit-on-sync-skip.</p>

<p style="margin-top: 1em">Not well tested. Use with
caution! Also file /etc/security/audit_control will be
overwritten with: <br>
#clsync</p>

<p style="margin-top: 1em">dir:/var/audit <br>
flags:fc,fd,fw,fm,cl <br>
minfree:0 <br>
naflags:fc,fd,fw,fm,cl <br>
policy:cnt <br>
filesz:1M <br>
unless it&rsquo;s already starts with &quot;#clsync0
(&quot;0 is a new line character).</p>

<p style="margin-top: 1em">bsm_prefetch <br>
The same as bsm but all BSM events will be prefetched by an
additional thread to prevent BSM queue overflow. This may
utilize a lot of memory on systems with <br>
a high FS events frequency.</p>

<p style="margin-top: 1em">However the thread may be not
fast enough to unload the kernel BSM queue. So it may
overflow anyway.</p>

<p style="margin-top: 1em">The default value on Linux is
&quot;inotify&quot;. The default value on FreeBSD is
&quot;kqueue&quot;.</p>

<p style="margin-top: 1em">-l, --label label <br>
Sets a label for this instance of clsync. The label will be
passed to sync-handler every execution.</p>

<p style="margin-top: 1em">The default value is
&quot;nolabel&quot;.</p>

<p style="margin-top: 1em">-h, --help <br>
Outputs options list and exits with exitcode
&quot;0&quot;.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">-V, --version <br>
Outputs clsync version and exits with exitcode
&quot;0&quot;.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--cgroup-group-name
cg-group-name <br>
Set cgroup group name [see cgroup_new_cgroup()].</p>

<p style="margin-top: 1em">Is set to
&quot;clsync/%PID%&quot; by default.</p>

<p style="margin-top: 1em">SECURITY OPTIONS <br>
--secure-splitting <br>
Implies &quot;--splitting=process --check-execvp-arguments
--seccomp-filter --forbid-devices&quot;</p>

<p style="margin-top: 1em">-u, --uid uid <br>
Drop user privileges to uid uid with setuid(2)</p>

<p style="margin-top: 1em">If there&rsquo;s a
capabilities(7) support then the default value is
&quot;nobody&quot; (or &quot;65534&quot; if
&quot;nobody&quot; not found), otherwise the option is not
set by default;</p>

<p style="margin-top: 1em">-g, --gid gid <br>
Drop group privileges to gid gid with setgid(2)</p>

<p style="margin-top: 1em">If there&rsquo;s a
capabilities(7) support then the default value is
&quot;nogroup&quot; (or &quot;65534&quot; if
&quot;nogroup&quot; not found), otherwise the option is not
set by default;</p>

<p style="margin-top: 1em">--privileged-uid
sync-handler-uid <br>
An user ID to be used for the privileged process (see
--splitting=process).</p>

<p style="margin-top: 1em">The default value is
&quot;$UID&quot;.</p>

<p style="margin-top: 1em">--privileged-gid
sync-handler-gid <br>
A group ID to be used for the privileged process (see
--splitting=process).</p>

<p style="margin-top: 1em">The default value is
&quot;$GID&quot;.</p>

<p style="margin-top: 1em">--sync-handler-uid
sync-handler-uid <br>
An user ID to be used for sync-handler.</p>

<p style="margin-top: 1em">See --preserve-capabilities.</p>

<p style="margin-top: 1em">The default value is same as for
--privileged-uid.</p>

<p style="margin-top: 1em">--sync-handler-gid
sync-handler-gid <br>
A group ID to be used for sync-handler.</p>

<p style="margin-top: 1em">See --preserve-capabilities.</p>

<p style="margin-top: 1em">The default value is same as for
--privileged-gid.</p>

<p style="margin-top: 1em">-C, --preserve-capabilities
capabilities-list <br>
[Linux only, requires capabilities]</p>

<p style="margin-top: 1em">Use capset(2) and prctl(2) to
preserve &quot;CAP_DAC_READ_SEARCH&quot;,
&quot;CAP_SETUID&quot; or/and &quot;CAP_SETGID&quot; [see
capabilities(7)] Linux capability for process using fts(3),
inotify(7) <br>
and execve(2). This allows the preservation of enough FS
privileges to watch a file tree and execute the sync-handler
with required uid and gid [see --sync-handler-uid <br>
and --sync-handler-gid] after dropping privileges via
setuid(2) and setgid(2) [see --uid and --gid]</p>

<p style="margin-top: 1em">Possible values: <br>
CAP_DAC_READ_SEARCH <br>
To bypass FS read checks (for fts and inotify). <br>
CAP_SETUID <br>
To be able to use setuid(2) before execve(2) on the
sync-handler. <br>
CAP_SETGID <br>
To be able to use setgid(2) before execve(2) on the
sync-handler. <br>
CAP_KILL <br>
To be able to kill setuid()-ed processes</p>

<p style="margin-top: 1em">Any combinations of this values
are also supported. The list may be presented as a comma
separated values, like: <br>
CAP_DAC_READ_SEARCH,CAP_SETUID,CAP_SETGID</p>

<p style="margin-top: 1em">The default value is
&quot;CAP_DAC_READ_SEARCH,CAP_SETUID,CAP_SETGID,CAP_KILL&quot;
if the clsync runner have such privileges.</p>

<p style="margin-top: 1em">--inherit-capabilities <br>
[Linux only, requires capabilities]</p>

<p style="margin-top: 1em">Sets a mode for capabilities
inheriting.</p>

<p style="margin-top: 1em">Possible values: <br>
permitted <br>
Inherits all permitted capabilities <br>
dont-touch <br>
Don&rsquo;t change inheritable capabilities set <br>
clsync <br>
Use clsync&rsquo;s effective capabilities set <br>
empty <br>
Reset all capabilities</p>

<p style="margin-top: 1em">The default value is
&quot;empty&quot;.</p>

<p style="margin-top: 1em">--splitting splitting-type <br>
Split the process/thread to privileged and non-privileged.
This&rsquo;s an additional way to secure your system from
any bug in clsync while running it with capabilities or root
<br>
privileges. But clsync may utilize in few times more CPU
resources. So it&rsquo;s a performance vs security trade
off.</p>

<p style="margin-top: 1em">You can essentialy reduce the
overhead with using &quot;high load locks&quot;
(&quot;--enable-highload-locks&quot; of
&quot;./configure&quot; file).</p>

<p style="margin-top: 1em">If you&rsquo;re using this
option and running the sync-handler with the root user then
it&rsquo;s highly recommended to enable
--check-execvp-arguments, too. Otherwise in case of <br>
clsync security bug a hacker will be able to use execvp()
with any arguments with root privileges.</p>

<p style="margin-top: 1em">Possible values: <br>
off <br>
Disable this feature <br>
thread <br>
[Linux only, requires capabilities]</p>

<p style="margin-top: 1em">Creates a separate thread for
privileged operations.</p>

<p style="margin-top: 1em">It&rsquo;s highly recommended to
enable --seccomp-filter in this case. But that will forbid
--threading. <br>
process <br>
More secure and portable way, but uses separate process and:
<br>
- forbids fanotify (that is not implemented yet anyway);
<br>
- more complex code (and higher probability of error). <br>
- slower due to copying data between private and shared
memory pages.</p>

<p style="margin-top: 1em">Recommended.</p>

<p style="margin-top: 1em">Is set to &quot;off&quot; by
default.</p>

<p style="margin-top: 1em">--check-execvp-arguments <br>
[Requires --splitting=[thread|process]] <br>
[Blocks --mode=direct]</p>

<p style="margin-top: 1em">Enables execvp() arguments
recheck in the privileged process (in case of their
substitution to any exploit-given arguments).</p>

<p style="margin-top: 1em">This option doesn&rsquo;t
utilize a lot of CPU resources but forbids run-time changing
of sync-handler-arguments and hook file paths.</p>

<p style="margin-top: 1em">This option cannot be used in
conjunction with --mode=direct due to an arbitrary number of
arguments in this mode.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--add-permitted-hook-files
[hook-path0,[hook-path1[,...]]] <br>
[Requires --check-execvp-arguments]</p>

<p style="margin-top: 1em">Adds paths to the list of
permitted hook paths to bypass --check-execvp-arguments
checks. It may be required if you&rsquo;re going to change
the hooks in run-time using --cus&acirc; <br>
tom-signals or --socket.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--seccomp-filter <br>
[Linux only]</p>

<p style="margin-top: 1em">Use seccomp filter to forbid
syscalls that shouldn&rsquo;t be used by clsync.</p>

<p style="margin-top: 1em">Forbid all syscalls for
non-privileged process/thread, but <br>
futex inotify_init1 alert stat fstat lstat open write close
wait4 unlink tgkill clock_gettime rt_sigreturn brk mmap
munmap wait4 rmdir exit_group select read <br>
rt_sigprocmask rt_sigaction nanosleep</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--permit-mprotect <br>
[Requires --seccomp-filter]</p>

<p style="margin-top: 1em">Permits mprotect(2) syscall.</p>

<p style="margin-top: 1em">This syscall is required by
pthread_create(3), so it&rsquo;s required for
--threading.</p>

<p style="margin-top: 1em">Makes --shm-mprotect to be
useless.</p>

<p style="margin-top: 1em">Also it enables ability to
change memory of privileged thread from non-privileged, so
using of --splitting=thread with this option is useless,
too.</p>

<p style="margin-top: 1em">Is set to &quot;0&quot; by
default if --splitting is set. Otherwise &quot;1&quot;.</p>

<p style="margin-top: 1em">--shm-mprotect <br>
[Requires --splitting=process]</p>

<p style="margin-top: 1em">Forbid writing or reading
to/from shared memory when it shouldn&rsquo;t be.
mprotect(2) is used for the protection.</p>

<p style="margin-top: 1em">This option is useless while
--permit-mprotect is enabled.</p>

<p style="margin-top: 1em">--chroot chroot-directory <br>
clsync chroot()-s [see chroot(2)] to directory
chroot-directory before any syncing processes.</p>

<p style="margin-top: 1em">This option may be used in
conjunction with --uid, --gid or/and --pivot-root for
security reasons.</p>

<p style="margin-top: 1em">Remember! If you&rsquo;re
chroot()-ing somewhere, the sync-handler will be limited by
the chroot-environment, too. If you&rsquo;re using rsync
then you may want to &quot;mount --bind&quot; some <br>
directories to the chroot-directory.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--pivot-root pivot-root-way <br>
[Linux only, requires --chroot]</p>

<p style="margin-top: 1em">Sets a way of using
pivot_root(2) syscall to the chroot-directory (to umount(2)
old rootfs).</p>

<p style="margin-top: 1em">Possible values: <br>
auto <br>
Creates a directory &quot;/dev/shm/clsync-rootfs&quot;,
unshare(2)-ing the mount namespace, mount(2)-s the
chroot-directory to the directory and then <br>
pivot_root(2)-ing, chroot(2)-ing and umount(2)-ing old
rootfs. Directory &quot;/dev/shm/clsync-rootfs&quot;
won&rsquo;t be deleted after clsync finish. <br>
auto-ro <br>
The same as auto but mounts the directory with read-only
option (MS_RDONLY). <br>
direct <br>
unshare(2)-ing the mount namespace, pivot_root(2)-ing,
chroot(2)-ing and umount(2)-ing old rootfs. Directory
&quot;old_root&quot; should be created in chroot-directory
<br>
before running clsync in this mode. <br>
off <br>
Don&rsquo;t pivot_root(2).</p>

<p style="margin-top: 1em">The default value is
&quot;off&quot;. If --chroot is used then recommended value
is &quot;auto-ro&quot;.</p>

<p style="margin-top: 1em">--mountpoints
[mountpoint[,mountpoint[,mountpoint]]] <br>
[Linux only]</p>

<p style="margin-top: 1em">Umount (with MNT_DETACH)
everything except listed mountpoints.</p>

<p style="margin-top: 1em">Supposed to be used for security
reasons as an alternative to --pivot-root option.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--detach-network
detach-network-mode <br>
[Linux only]</p>

<p style="margin-top: 1em">Removes network in clsync
instance.</p>

<p style="margin-top: 1em">Possible values: <br>
everywhere <br>
Removes network for all processes. <br>
non-privileged <br>
Removes network from non-privileged process if option
--process-splitting is enabled, otherwise doesn&rsquo;t do
anything. <br>
off <br>
Don&rsquo;t do anything.</p>

<p style="margin-top: 1em">The default value is
&quot;non-privileged&quot;.</p>

<p style="margin-top: 1em">--detach-ipc <br>
[Linux only]</p>

<p style="margin-top: 1em">Make an own IPC namespace.</p>

<p style="margin-top: 1em">Is set by default.</p>

<p style="margin-top: 1em">--detach-miscellanea <br>
[Linux only]</p>

<p style="margin-top: 1em">unshare(2) on everything not
listed above.</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">--forbid-devices <br>
[Linux only]</p>

<p style="margin-top: 1em">Forbid any access to all devices
except listed ones: <br>
read access to: <br>
/dev/console <br>
/dev/zero <br>
/dev/urandom <br>
/dev/random <br>
write access to: <br>
/dev/console <br>
/dev/null</p>

<p style="margin-top: 1em">Is not set by default.</p>

<p style="margin-top: 1em">PERFORMANCE <br>
Recommendations to improve the perfomance: <br>
- Disable thread/process splitting. <br>
- Don&rsquo;t use clsync rules (use rules on sync-handler
side) or/and use option &quot;--full-initialsync&quot; <br>
- Use option &quot;-B0&quot;. <br>
- Use option &quot;--cancel-syscalls=mon_stat&quot;. <br>
- Use option &quot;-p safe&quot; or &quot;-p full&quot;.
<br>
- Disable debugging with &quot;-d0&quot; or better disable
debugging support at all with &quot;./configure&quot; option
&quot;--enable-debug=no&quot; <br>
- Don&rsquo;t use option &quot;--exclude-mount-points&quot;
<br>
- Free memory for disk cache</p>

<p style="margin-top: 1em">You shouldn&rsquo;t follow all
this recommendation blindfold. You should use only the ideas
that fixes performance problems in your specific use case.
And only if it&rsquo;s necessary.</p>

<p style="margin-top: 1em">SYNC HANDLER MODES <br>
clsync executes sync-handler that supposed to take care of
the actual syncing process. Therefore clsync is only a
convenient way to run a syncing script.</p>

<p style="margin-top: 1em">clsync can run sync-handler in
seven ways. Which way will be used depends on specified mode
(see --mode)</p>

<p style="margin-top: 1em">sync-handler-arguments are used
only in modes: <br>
simple <br>
direct <br>
shell <br>
rsyncdirect <br>
rsyncshell</p>

<p style="margin-top: 1em">If sync-handler-arguments are
not set then the default setting is used (see below).</p>

<p style="margin-top: 1em">case simple <br>
Executes for every syncing file/dir: <br>
sync-handler sync-handler-arguments</p>

<p style="margin-top: 1em">Default sync-handler-arguments
are: <br>
sync %label% %EVENT-MASK% %INCLUDE-LIST%</p>

<p style="margin-top: 1em">In this case, sync-handler is
supposed to non-recursively sync file or directory by path
%INCLUDE-LIST%. With %EVENT-MASK% it&rsquo;s passed bitmask
of events with the file or <br>
directory (see
&quot;/usr/include/linux/inotify.h&quot;).</p>

<p style="margin-top: 1em">Additional substitutions: <br>
%EVENT-MASK% <br>
Is replaced by integer of events IDs. <br>
%INCLUDE-LIST% <br>
Is replaced by absolute path of a file/dir to be synced.</p>

<p style="margin-top: 1em">case direct <br>
Executes for every sync: <br>
sync-handler sync-handler-arguments</p>

<p style="margin-top: 1em">Default sync-handler-arguments
are: <br>
%INCLUDE-LIST% %destination-dir%/</p>

<p style="margin-top: 1em">Additional substitutions: <br>
%INCLUDE-LIST% <br>
Is replaced by a list of relative paths of files/dirs to be
synced.</p>

<p style="margin-top: 1em">case shell <br>
Executes for every sync (if recursivesync is not used
instead): <br>
sync-handler sync-handler-arguments</p>

<p style="margin-top: 1em">Default sync-handler-arguments
are: <br>
synclist %label% %INCLUDE-LIST-PATH%</p>

<p style="margin-top: 1em">Default sync-handler-arguments
for initial sync if --have-recursive-sync is set are: <br>
initialsync %label% %INCLUDE-LIST%</p>

<p style="margin-top: 1em">In this case, sync-handler is
supposed to non-recursively sync files and directories from
list in a file by path %INCLUDE-LIST-PATH% on
&quot;synclist&quot;.</p>

<p style="margin-top: 1em">Also sync-handler is supposed to
recursively sync data from directory by path
%INCLUDE-LIST-PATH% with manual excluding extra files on
&quot;initialsync&quot;.</p>

<p style="margin-top: 1em">Additional substitutions: <br>
%TYPE% <br>
Is replaced by &quot;sync&quot;/&quot;initialsync&quot;.
<br>
%INCLUDE-LIST-PATH% <br>
Is replaced by the path of the include list file. <br>
%INCLUDE-LIST% <br>
Is replaced by a list of relative paths of files/dirs to be
synced.</p>

<p style="margin-top: 1em">Not recommended. Not well
tested.</p>

<p style="margin-top: 1em">case rsyncdirect <br>
Executes for every sync: <br>
sync-handler sync-handler-arguments</p>

<p style="margin-top: 1em">sync-handler is supposed to be a
path to rsync binary.</p>

<p style="margin-top: 1em">Default sync-handler-arguments
are: <br>
-aH --delete --exclude-from %EXCLUDE-LIST-PATH%
--include-from %INCLUDE-LIST-PATH% --exclude=&rsquo;*&rsquo;
%watch-dir%/ %destination-dir%/ <br>
if option --rsync--prefer-include is not set and <br>
-aH --delete --include-from %INCLUDE-LIST-PATH%
--exclude=&rsquo;*&rsquo; %watch-dir%/ %destination-dir%/
<br>
if the option is set</p>

<p style="margin-top: 1em">Error code &quot;24&quot; from
sync-handler will be ignored in this case. We also recommend
to ignore exitcode &quot;23&quot;.</p>

<p style="margin-top: 1em">Additional substitutions: <br>
%INCLUDE-LIST-PATH% <br>
Is replaced by the path of the include list file <br>
%EXCLUDE-LIST-PATH% <br>
Is replaced by the path of the exclude list file <br>
%RSYNC-ARGS% <br>
Is replaced by default sync-handler-arguments, but without
&quot;%watch-dir%/ %destination-dir%/&quot;</p>

<p style="margin-top: 1em">Recommended case.</p>

<p style="margin-top: 1em">case rsyncshell <br>
Executes for every sync: <br>
sync-handler sync-handler-arguments</p>

<p style="margin-top: 1em">Default sync-handler-arguments
are: <br>
rsynclist %label% %INCLUDE-LIST-PATH%
[%EXCLUDE-LIST-PATH%]</p>

<p style="margin-top: 1em">In this case, sync-handler is
supposed to run &quot;rsync&quot; application with
parameters:</p>

<p style="margin-top: 1em">-aH --delete-before
--include-from %INCLUDE-LIST-PATH% --exclude
&rsquo;*&rsquo;</p>

<p style="margin-top: 1em">if option --rsync-prefer-include
is enabled.</p>

<p style="margin-top: 1em">And with parameters:</p>

<p style="margin-top: 1em">-aH --delete-before
--exclude-from %EXCLUDE-LIST-PATH% --include-from
%INCLUDE-LIST-PATH% --exclude &rsquo;*&rsquo;</p>

<p style="margin-top: 1em">if option --rsync-prefer-include
is disabled.</p>

<p style="margin-top: 1em">Additional substitutions: <br>
%INCLUDE-LIST-PATH% <br>
Is replaced by the path of the rsync include list file <br>
%EXCLUDE-LIST-PATH% <br>
Is replaced by the path of the rsync exclude list file</p>

<p style="margin-top: 1em">Recommended case.</p>

<p style="margin-top: 1em">case rsyncso <br>
In this case there&rsquo;s no direct exec*() calling. In
this case clsync loads sync-handler as a shared library with
dlopen(3) and calls function &quot;int clsyncapi_rsync(const
<br>
char *inclist, const char *exclist)&quot; from it for every
sync. <br>
inclist is a path to file with rules for
&quot;--include-from&quot; option of rsync. This argument is
always not NULL. <br>
exclist is a path to file with rules for
&quot;--exclude-from&quot; option of rsync. This argument is
NULL if --rsync-prefer-include is set. <br>
Excludes takes precedence over includes.</p>

<p style="margin-top: 1em">Also may be defined functions
&quot;int clsyncapi_init(ctx_t *, indexes_t *)&quot; and
&quot;int clsyncapi_deinit()&quot; to initialize and
deinitialize the syncing process by this shared <br>
object.</p>

<p style="margin-top: 1em">To fork the process should be
used function &quot;pid_t clsyncapi_fork(ctx_t *)&quot;
instead of &quot;pid_t fork()&quot; to make clsync be able
to kill the child.</p>

<p style="margin-top: 1em">See example file
&quot;clsync-synchandler-rsyncso.c&quot;.</p>

<p style="margin-top: 1em">Recommended case.</p>

<p style="margin-top: 1em">case so <br>
In this case there&rsquo;s no direct exec*() calling. In
this case clsync loads sync-handler as a shared library with
dlopen(3) and calls function &quot;int clsyncapi_sync(int n,
<br>
api_eventinfo_t *ei)&quot; from it for every sync. n is
number of elements of ei. ei is an array of structures with
information about what and how to sync (see below).</p>

<p style="margin-top: 1em">api_eventinfo_t is a structure:
<br>
struct api_eventinfo { <br>
uint32_t evmask; // event bitmask for file/dir by path path.
<br>
uint32_t flags; // flags of &quot;how to sync&quot; the
file/dir <br>
size_t path_len; // strlen(path) <br>
const char *path; // the path to file/dir need to be synced
<br>
eventobjtype_t objtype_old; // type of object by path path
before the event. <br>
eventobjtype_t objtype_new; // type of object by path path
after the event. <br>
}; <br>
typedef struct api_eventinfo api_eventinfo_t;</p>

<p style="margin-top: 1em">The event bitmask (evmask)
values can be learned from
&quot;/usr/include/linux/inotify.h&quot;.</p>

<p style="margin-top: 1em">There may be next flags&rsquo;
values (flags): <br>
enum eventinfo_flags { <br>
EVIF_NONE = 0x00000000, // No modifier <br>
EVIF_RECURSIVELY = 0x00000001 // sync the file/dir
recursively <br>
}; <br>
Flag &quot;EVIF_RECURSIVELY&quot; may be used if option
--have-recursive-sync is set.</p>

<p style="margin-top: 1em">Is that a file or directory by
path path can be determined with objtype_old and
objtype_new. <br>
objtype_old reports about which type was the object by the
path before the event. <br>
objtype_new reports about which type became the object by
the path after the event.</p>

<p style="margin-top: 1em">objtype_old and objtype_new have
type eventobjtype_t.</p>

<p style="margin-top: 1em">enum eventobjtype { <br>
EOT_UNKNOWN = 0, // Unknown <br>
EOT_DOESNTEXIST = 1, // Doesn&rsquo;t exist (not created yet
or already deleted) <br>
EOT_FILE = 2, // File <br>
EOT_DIR = 3, // Directory <br>
} typedef enum eventobjtype eventobjtype_t;</p>

<p style="margin-top: 1em">Also may be defined functions
&quot;int clsyncapi_init(options_t *, indexes_t *)&quot; and
&quot;int clsyncapi_deinit()&quot; to initialize and
deinitialize the syncing process by this shared <br>
object.</p>

<p style="margin-top: 1em">To fork the process should be
used function &quot;pid_t clsyncapi_fork(options_t *)&quot;
instead of &quot;pid_t fork()&quot; to make clsync be able
to kill the child.</p>

<p style="margin-top: 1em">See example file
&quot;clsync-synchandler-so.c&quot;.</p>

<p style="margin-top: 1em">Recommended case.</p>

<p style="margin-top: 1em">ENVIRONMENT VARIABLES <br>
Output variables - variables that are set by clsync before
calling sync-handler.</p>

<p style="margin-top: 1em">Output variables <br>
CLSYNC_STATUS - clsync&rsquo;s status (see possible statuses
in description of --status-file)</p>

<p style="margin-top: 1em">CLSYNC_ITERATION - count of done
synchronizaton iterations after initial sync see
--max-iterations option</p>

<p style="margin-top: 1em">RULES <br>
Filter rules can be used to set which events clsync should
monitor and which events it should ignore.</p>

<p style="margin-top: 1em">Caution! This rules
doesn&rsquo;t guarantee that filtered file/dir won&rsquo;t
be synced. This can occur because file or directory can
appear in the moment of sync-handler running (or after <br>
it but before the sync-handler will reach the directory), so
it&rsquo;ll be too late to add an exclusion. If you need a
guarantee of file syncing preventing you can use internal
filter <br>
rules of the sync-handler program (for example, rsync has
options &quot;--exclude&quot;, &quot;--exclude-from&quot;
and &quot;--filter&quot;) or use disable any
&quot;recursive&quot; syncs in clsync (and remove
&quot;-av&quot; <br>
option of rsync if it&rsquo;s used). To disable recursive
syncs you can use: <br>
simple <br>
Already non-recursive <br>
direct <br>
Already non-recursive <br>
shell <br>
Don&rsquo;t enable option --have-recursive-sync. <br>
rsyncdirect <br>
Use option --rsync-prefer-include and set
sync-handler-arguments to -lptgoD --delete --include-from
%INCLUDE-LIST-PATH% --exclude=&rsquo;*&rsquo; %watch-dir%/
%destina&acirc; <br>
tion-dir%/ <br>
rsyncshell <br>
Use option --rsync-prefer-include. <br>
rsyncso <br>
Use option --rsync-prefer-include. <br>
so <br>
Don&rsquo;t enable option --have-recursive-sync.</p>

<p style="margin-top: 1em">Filter rules can be placed into
rules-file with one rule per line.</p>

<p style="margin-top: 1em">Rule format:
[+-][fdw*]regexp</p>

<p style="margin-top: 1em">+ - means include; - - means
exclude; f - means file; d - means directory; w - means
walking to directory; * - means all.</p>

<p style="margin-top: 1em">For example: -*^/[Tt]est</p>

<p style="margin-top: 1em">It&rsquo;s not recommended to
use w rules in modes &quot;rsyncdirect&quot;,
&quot;rsyncshell&quot; and &quot;rsyncso&quot;. rsync(1)
allows one to set syncing and walking only together in
&quot;--include&quot; rules <br>
(&quot;--files-from&quot; is not appropriate due to problem
with syncing files deletions). So there may be problems with
clsync&rsquo;s w rules in this cases.</p>

<p style="margin-top: 1em">More examples:</p>

<p style="margin-top: 1em">Syncing pwdb files and
sshd_config (non-rsync case): <br>
+f^/passwd$ <br>
+f^/group$ <br>
+f^/shadow$ <br>
+f^/ssh/sshd_config$ <br>
+w^$ <br>
+w^/ssh$ <br>
-*</p>

<p style="margin-top: 1em">Syncing pwdb files and
sshd_config (rsync case): <br>
+f^/passwd$ <br>
+f^/group$ <br>
+f^/shadow$ <br>
+f^/ssh/sshd_config$ <br>
+d^$ <br>
+d^/ssh$ <br>
-*</p>

<p style="margin-top: 1em">Syncing /srv/lxc tree (rsync
case): <br>
-d/sess(ion)?s?$ <br>
-f/tmp/ <br>
+*</p>

<p style="margin-top: 1em">SIGNALS <br>
1 - (HUP) rereads filter rules</p>

<p style="margin-top: 1em">2 - (INT) exits without waiting
of syncing processes (&quot;hard kill&quot;, kills
children)</p>

<p style="margin-top: 1em">3 - (QUIT) waits for current
syncing processes and exit (&quot;soft kill&quot;, waits for
children)</p>

<p style="margin-top: 1em">10 - runs threads&rsquo; GC
function</p>

<p style="margin-top: 1em">12 - runs full resync</p>

<p style="margin-top: 1em">15 - (TERM) exits without
waiting of syncing processes (&quot;hard kill&quot;, kills
children)</p>

<p style="margin-top: 1em">16 - interrupts sleep()/select()
and wait() [for debugging and internal uses]</p>

<p style="margin-top: 1em">29 - dump information to
dump-dir [for debugging]</p>

<p style="margin-top: 1em">If you need to kill clsync but
leave children then you can use 9-th (KILL) signal.</p>

<p style="margin-top: 1em">DIAGNOSTICS <br>
Initial rsync process works very slow on clsync start <br>
Probably there&rsquo;s too huge exclude list is passed to
rsync. This can happened if you&rsquo;re excluding with
regex in clsync&rsquo;s rules a lot of thousands files. They
will be <br>
passed to rsync&rsquo;s exclude list one by one.</p>

<p style="margin-top: 1em">To diagnose it, you can use
&quot;-U&quot; option and look into rsync-exclude-listpath
file (see SYNC HANDLER case d)</p>

<p style="margin-top: 1em">To prevent this, it&rsquo;s
recommended to write such rules for rsync directly (not via
clsync).</p>

<p style="margin-top: 1em">For example, often problem is
with PHP&rsquo;s session files. You shouldn&rsquo;t exclude
them in clsync&rsquo;s rules with &quot;-f/sess_.*&quot;,
but you should exclude it in rsync directly (e.g <br>
with &Acirc;&laquo;--exclude
&quot;sess_*&quot;&Acirc;&raquo;).</p>

<p style="margin-top: 1em">The following diagnostics may be
issued on stderr:</p>

<p style="margin-top: 1em">Error: Cannot
inotify_add_watch() on [...]: No space left on device
(errno: 28) <br>
Not enough inotify watching descriptors is allowed. It can
be fixed by increasing value of &quot;sysctl
fs.inotify.max_user_watches&quot;</p>

<p style="margin-top: 1em">Error: Got non-zero exitcode
exitcode [...] <br>
sync-handler returned non-zero exitcode. Probably, you
should process exitcodes in it or your syncer process
didn&rsquo;t worked well. I case of using rsync, you can
find the <br>
exitcodes meanings in man 1 rsync.</p>

<p style="margin-top: 1em">If exitcode equals to 23 and
you&rsquo;re using clsync in conjunction with rsync, this
may happend, for example in next cases:</p>

<p style="margin-top: 1em">- Not enough space on
destination.</p>

<p style="margin-top: 1em">- You&rsquo;re running clsync
with --threading=full and rsync with --backup. See a
bugreport
&acirc;&uml;https://bugzilla.samba.org/show_bug.cgi?id=10081&acirc;&copy;.</p>

<p style="margin-top: 1em">To confirm the problem, you can
try to add &quot;return 0&quot; or &quot;exit 0&quot; into
your sync-handler.</p>

<p style="margin-top: 1em">Bad system call <br>
If --use-seccomp option is enabled then the error is
probably caused by using of forbidden syscall. It&rsquo;s a
clsync bug or hack attack attempt.</p>

<p style="margin-top: 1em">To get support see SUPPORT.</p>

<p style="margin-top: 1em">CONFIGURATION FILE <br>
clsync supports configuration file.</p>

<p style="margin-top: 1em">By default clsync tries to read
next files (in specified order): <br>
~/.clsync.conf <br>
/etc/clsync/clsync.conf</p>

<p style="margin-top: 1em">This may be overrided with
option --config-file.</p>

<p style="margin-top: 1em">clsync reads only one
configuration file. In other words, if option --config-file
is not set and file ~/.clsync.conf is accessible and
parsable, clsync will not try to open <br>
/etc/clsync/clsync.conf. Command line options have
precedence over config file options.</p>

<p style="margin-top: 1em">Configuration file is parsed
with glib&rsquo;s g_key_file_* API. That means, that config
should consits from groups (blocks) of key-value lines as in
the example: <br>
[default] <br>
background = 1 <br>
mode = rsyncshell <br>
debug = 0 <br>
output = syslog <br>
label = default <br>
pid-file = /var/run/clsync-%label%.pid</p>

<p style="margin-top: 1em">[debug] <br>
config-block-inherits = default <br>
debug = 5 <br>
background = 0 <br>
output = stderr</p>

<p style="margin-top: 1em">[test] <br>
mode=rsyncdirect <br>
debug=3</p>

<p style="margin-top: 1em">Also glib&rsquo;s gkf API
doesn&rsquo;t support multiple assignments. If you need to
list some values (e.g. exitcodes) just list them with commas
in single assignment (e.g. &quot;ignore-exit&acirc; <br>
code=23,24&quot;).</p>

<p style="margin-top: 1em">In this example there&rsquo;re 3
blocks are set - &quot;default&quot;, &quot;debug&quot; and
&quot;test&quot;. And block &quot;debug&quot; inherited
setup of block &quot;default&quot; except options
&quot;debug&quot;, &quot;background&quot; and
&quot;out&acirc; <br>
put&quot;.</p>

<p style="margin-top: 1em">By default clsync uses block
with name &quot;default&quot;. Block name can be set by
option --config-block.</p>

<p style="margin-top: 1em">CLUSTERING <br>
Not implemented yet. Don&rsquo;t try to use cluster
functionality.</p>

<p style="margin-top: 1em">Not described yet.</p>

<p style="margin-top: 1em">EXAMPLES <br>
Mirroring a directory: <br>
clsync -Mrsyncdirect -W/path/to/source_dir
-D/path/to/destination_dir</p>

<p style="margin-top: 1em">Syncing
&rsquo;authorized_keys&rsquo; files: <br>
mkdir -p /etc/clsync/rules <br>
printf
&quot;+w^$0^[^/]+$0^[^/]+/.ssh$0^[^/]+/.ssh/authorized_keys$0&quot;
&gt; /etc/clsync/rules/authorized_files_only <br>
clsync -Mdirect -Scp -W/mnt/master/home/ -D/home
-R/etc/clsync/rules/authorized_files_only -- -Pfp --parents
%INCLUDE-LIST% %destination-dir%</p>

<p style="margin-top: 1em">Mirroring a directory, but
faster: <br>
clsync -w5 -t5 -T5 -Mrsyncdirect -W/path/to/source_dir
-D/path/to/destination_dir</p>

<p style="margin-top: 1em">Instant mirroring of a
directory: <br>
clsync -w0 -t0 -T0 -Mrsyncdirect -W/path/to/source_dir
-D/path/to/destination_dir</p>

<p style="margin-top: 1em">Making two directories
synchronous: <br>
clsync -Mrsyncdirect --background -z /var/run/clsync0.pid
--output syslog -Mrsyncdirect -W/path/to/dir1
-D/path/to/dir2 --modification-signature &rsquo;*&rsquo;
<br>
clsync -Mrsyncdirect --background -z /var/run/clsync1.pid
--output syslog -Mrsyncdirect -W/path/to/dir2
-D/path/to/dir1 --modification-signature &rsquo;*&rsquo;</p>

<p style="margin-top: 1em">Fixing privileges of a web-site:
<br>
clsync -w3 -t3 -T3 -x1 -W/var/www/site.example.org/root
-Mdirect -Schown --uid 0 --gid 0 -Ysyslog -b1
--modification-signature uid,gid -- --from=root
www-data:www-data <br>
%INCLUDE-LIST%</p>

<p style="margin-top: 1em">&rsquo;Atomic&rsquo; sync: <br>
clsync --exit-on-no-events --max-iterations=20
--mode=rsyncdirect -W/var/www_new -Srsync -- %RSYNC-ARGS%
/var/www_new/ /var/www/</p>

<p style="margin-top: 1em">Moving a web-server: <br>
clsync --exit-on-no-events --max-iterations=20
--pre-exit-hook=/root/stop-here.sh
--exit-hook=/root/start-there.sh --mode=rsyncdirect
--ignore-exitcode=23,24 --retries=3 <br>
-W /var/www -S rsync -- %RSYNC-ARGS% /var/www/
rsync://clsync@another-host/var/www/</p>

<p style="margin-top: 1em">Copying files to slave-nodes
using pdcp(1): <br>
clsync -Msimple -S pdcp -W /opt/global -b -Y syslog -- -a
%INCLUDE-LIST% %INCLUDE-LIST%</p>

<p style="margin-top: 1em">Copying files to slave-nodes
using uftp(1): <br>
clsync -Mdirect -S uftp -W/opt/global --background=1
--output=syslog -- -M 248.225.233.1 %INCLUDE-LIST%</p>

<p style="margin-top: 1em">A dry running to see rsync(1)
arguments that clsync will use: <br>
clsync -Mrsyncdirect -S echo -W/path/to/source_dir
-D/path/to/destination_dir</p>

<p style="margin-top: 1em">An another dry running to look
how clsync will call pdcp(1): <br>
clsync -Msimple -S echo -W /opt/global -b0 -- pdcp -a
%INCLUDE-LIST% %INCLUDE-LIST%</p>

<p style="margin-top: 1em">More working examples you can
try out in &quot;/usr/share/doc/clsync/examples/&quot;
directory. Copy this directory somewhere (e.g. into
&quot;/tmp&quot;). And try to run
&quot;clsync-start-rsync.sh&quot; in <br>
there. Any files/directories modifications in
&quot;testdir/from&quot; will be synced to
&quot;testdir/to&quot; in a few seconds.</p>

<p style="margin-top: 1em">AUTHOR <br>
Dmitry Yu Okunev &lt;dyokunev@ut.mephi.ru&gt; 0x8E30679C</p>

<p style="margin-top: 1em">SUPPORT <br>
You can get support on official IRC-channel in Freenode
&quot;#clsync&quot; or on github&rsquo;s issue tracking
system of the clsync repository
&acirc;&uml;https://github.com/xaionaro/clsync&acirc;&copy;.</p>

<p style="margin-top: 1em">Don&rsquo;t be afraid to ask
about clsync configuration, ;).</p>

<p style="margin-top: 1em">SEE ALSO <br>
rsync(1), pthreads(7), inotify(7) kqueue(2)</p>

<p style="margin-top: 1em">Linux JULY 2013 CLSYNC(1)</p>
<hr>
</body>
</html>
